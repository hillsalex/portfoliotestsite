function defineClass(e,t,i){function o(){}if(e&&(o.prototype=e.prototype,t.prototype=new o,t.prototype.constructor=t,t.superClass=e),i)for(var s in i)t.prototype[s]=i[s];return t}function array_to_object(e){for(var t={},i=0;i<e.length;i++)t[e[i]]="";return t}function setNamespace(e,t,i){t instanceof Element&&(t.hasAttribute("id")?t.setAttribute("id",e.toString().replace(" ","")+"__"+t.getAttribute("id")):t.hasAttribute("DEF")&&i&&t.setAttribute("id",e.toString().replace(" ","")+"__"+t.getAttribute("DEF"))),t.hasChildNodes()&&Array.forEach(t.childNodes,function(t){setNamespace(e,t,i)})}!function(e){"function"==typeof define&&define.amd?define(["jquery"],e):"object"==typeof exports?module.exports=e:e(jQuery)}(function(e){function t(t){var r=t||window.event,a=d.call(arguments,1),h=0,_=0,f=0,u=0,c=0,m=0;if(t=e.event.fix(r),t.type="mousewheel","detail"in r&&(f=-1*r.detail),"wheelDelta"in r&&(f=r.wheelDelta),"wheelDeltaY"in r&&(f=r.wheelDeltaY),"wheelDeltaX"in r&&(_=-1*r.wheelDeltaX),"axis"in r&&r.axis===r.HORIZONTAL_AXIS&&(_=-1*f,f=0),h=0===f?_:f,"deltaY"in r&&(f=-1*r.deltaY,h=f),"deltaX"in r&&(_=r.deltaX,0===f&&(h=-1*_)),0!==f||0!==_){if(1===r.deltaMode){var p=e.data(this,"mousewheel-line-height");h*=p,f*=p,_*=p}else if(2===r.deltaMode){var g=e.data(this,"mousewheel-page-height");h*=g,f*=g,_*=g}if(u=Math.max(Math.abs(f),Math.abs(_)),(!n||n>u)&&(n=u,o(r,u)&&(n/=40)),o(r,u)&&(h/=40,_/=40,f/=40),h=Math[h>=1?"floor":"ceil"](h/n),_=Math[_>=1?"floor":"ceil"](_/n),f=Math[f>=1?"floor":"ceil"](f/n),l.settings.normalizeOffset&&this.getBoundingClientRect){var x=this.getBoundingClientRect();c=t.clientX-x.left,m=t.clientY-x.top}return t.deltaX=_,t.deltaY=f,t.deltaFactor=n,t.offsetX=c,t.offsetY=m,t.deltaMode=0,a.unshift(t,h,_,f),s&&clearTimeout(s),s=setTimeout(i,200),(e.event.dispatch||e.event.handle).apply(this,a)}}function i(){n=null}function o(e,t){return l.settings.adjustOldDeltas&&"mousewheel"===e.type&&t%120===0}var s,n,r=["wheel","mousewheel","DOMMouseScroll","MozMousePixelScroll"],a="onwheel"in document||document.documentMode>=9?["wheel"]:["mousewheel","DomMouseScroll","MozMousePixelScroll"],d=Array.prototype.slice;if(e.event.fixHooks)for(var h=r.length;h;)e.event.fixHooks[r[--h]]=e.event.mouseHooks;var l=e.event.special.mousewheel={version:"3.1.12",setup:function(){if(this.addEventListener)for(var i=a.length;i;)this.addEventListener(a[--i],t,!1);else this.onmousewheel=t;e.data(this,"mousewheel-line-height",l.getLineHeight(this)),e.data(this,"mousewheel-page-height",l.getPageHeight(this))},teardown:function(){if(this.removeEventListener)for(var i=a.length;i;)this.removeEventListener(a[--i],t,!1);else this.onmousewheel=null;e.removeData(this,"mousewheel-line-height"),e.removeData(this,"mousewheel-page-height")},getLineHeight:function(t){var i=e(t),o=i["offsetParent"in e.fn?"offsetParent":"parent"]();return o.length||(o=e("body")),parseInt(o.css("fontSize"),10)||parseInt(i.css("fontSize"),10)||16},getPageHeight:function(t){return e(t).height()},settings:{adjustOldDeltas:!0,normalizeOffset:!0}};e.fn.extend({mousewheel:function(e){return e?this.bind("mousewheel",e):this.trigger("mousewheel")},unmousewheel:function(e){return this.unbind("mousewheel",e)}})}),!function(){"use strict";function e(e){return e.split("").reverse().join("")}function t(e,t){return e.substring(0,t.length)===t}function i(e,t){return e.slice(-1*t.length)===t}function o(e,t,i){if((e[t]||e[i])&&e[t]===e[i])throw new Error(t)}function s(e){return"number"==typeof e&&isFinite(e)}function n(e,t){var i=Math.pow(10,t);return(Math.round(e*i)/i).toFixed(t)}function r(t,i,o,r,a,d,h,l,_,f,u,c){var m,p,g,x=c,v="",y="";return d&&(c=d(c)),s(c)?(t!==!1&&0===parseFloat(c.toFixed(t))&&(c=0),0>c&&(m=!0,c=Math.abs(c)),t!==!1&&(c=n(c,t)),c=c.toString(),-1!==c.indexOf(".")?(p=c.split("."),g=p[0],o&&(v=o+p[1])):g=c,i&&(g=e(g).match(/.{1,3}/g),g=e(g.join(e(i)))),m&&l&&(y+=l),r&&(y+=r),m&&_&&(y+=_),y+=g,y+=v,a&&(y+=a),f&&(y=f(y,x)),y):!1}function a(e,o,n,r,a,d,h,l,_,f,u,c){var m,p="";return u&&(c=u(c)),c&&"string"==typeof c?(l&&t(c,l)&&(c=c.replace(l,""),m=!0),r&&t(c,r)&&(c=c.replace(r,"")),_&&t(c,_)&&(c=c.replace(_,""),m=!0),a&&i(c,a)&&(c=c.slice(0,-1*a.length)),o&&(c=c.split(o).join("")),n&&(c=c.replace(n,".")),m&&(p+="-"),p+=c,p=p.replace(/[^0-9\.\-.]/g,""),""===p?!1:(p=Number(p),h&&(p=h(p)),s(p)?p:!1)):!1}function d(e){var t,i,s,n={};for(t=0;t<_.length;t+=1)if(i=_[t],s=e[i],void 0===s)n[i]="negative"!==i||n.negativeBefore?"mark"===i&&"."!==n.thousand?".":!1:"-";else if("decimals"===i){if(!(s>=0&&8>s))throw new Error(i);n[i]=s}else if("encoder"===i||"decoder"===i||"edit"===i||"undo"===i){if("function"!=typeof s)throw new Error(i);n[i]=s}else{if("string"!=typeof s)throw new Error(i);n[i]=s}return o(n,"mark","thousand"),o(n,"prefix","negative"),o(n,"prefix","negativeBefore"),n}function h(e,t,i){var o,s=[];for(o=0;o<_.length;o+=1)s.push(e[_[o]]);return s.push(i),t.apply("",s)}function l(e){return this instanceof l?void("object"==typeof e&&(e=d(e),this.to=function(t){return h(e,r,t)},this.from=function(t){return h(e,a,t)})):new l(e)}var _=["decimals","thousand","mark","prefix","postfix","encoder","decoder","negativeBefore","negative","edit","undo"];window.wNumb=l}(),function(e){"use strict";function t(t){return t instanceof e||e.zepto&&e.zepto.isZ(t)}function i(t,i){return"string"==typeof t&&0===t.indexOf("-inline-")?(this.method=i||"html",this.target=this.el=e(t.replace("-inline-","")||"<div/>"),!0):void 0}function o(t){if("string"==typeof t&&0!==t.indexOf("-")){this.method="val";var i=document.createElement("input");return i.name=t,i.type="hidden",this.target=this.el=e(i),!0}}function s(e){return"function"==typeof e?(this.target=!1,this.method=e,!0):void 0}function n(e,i){return t(e)&&!i?(e.is("input, select, textarea")?(this.method="val",this.target=e.on("change.liblink",this.changeHandler)):(this.target=e,this.method="html"),!0):void 0}function r(e,i){return t(e)&&("function"==typeof i||"string"==typeof i&&e[i])?(this.method=i,this.target=e,!0):void 0}function a(t,i,o){var s=this,n=!1;if(this.changeHandler=function(t){var i=s.formatInstance.from(e(this).val());return i===!1||isNaN(i)?(e(this).val(s.lastSetValue),!1):void s.changeHandlerMethod.call("",t,i)},this.el=!1,this.formatInstance=o,e.each(l,function(e,o){return n=o.call(s,t,i),!n}),!n)throw new RangeError("(Link) Invalid Link.")}function d(e){this.items=[],this.elements=[],this.origin=e}function h(t,i,o,s){0===t&&(t=this.LinkDefaultFlag),this.linkAPI||(this.linkAPI={}),this.linkAPI[t]||(this.linkAPI[t]=new d(this));var n=new a(i,o,s||this.LinkDefaultFormatter);n.target||(n.target=e(this)),n.changeHandlerMethod=this.LinkConfirm(t,n.el),this.linkAPI[t].push(n,n.el),this.LinkUpdate(t)}var l=[i,o,s,n,r];a.prototype.set=function(e){var t=Array.prototype.slice.call(arguments),i=t.slice(1);this.lastSetValue=this.formatInstance.to(e),i.unshift(this.lastSetValue),("function"==typeof this.method?this.method:this.target[this.method]).apply(this.target,i)},d.prototype.push=function(e,t){this.items.push(e),t&&this.elements.push(t)},d.prototype.reconfirm=function(e){var t;for(t=0;t<this.elements.length;t+=1)this.origin.LinkConfirm(e,this.elements[t])},d.prototype.remove=function(){var e;for(e=0;e<this.items.length;e+=1)this.items[e].target.off(".liblink");for(e=0;e<this.elements.length;e+=1)this.elements[e].remove()},d.prototype.change=function(e){if(this.origin.LinkIsEmitting)return!1;this.origin.LinkIsEmitting=!0;var t,i=Array.prototype.slice.call(arguments,1);for(i.unshift(e),t=0;t<this.items.length;t+=1)this.items[t].set.apply(this.items[t],i);this.origin.LinkIsEmitting=!1},e.fn.Link=function(t){var i=this;if(t===!1)return i.each(function(){this.linkAPI&&(e.map(this.linkAPI,function(e){e.remove()}),delete this.linkAPI)});if(void 0===t)t=0;else if("string"!=typeof t)throw new Error("Flag must be string.");return{to:function(e,o,s){return i.each(function(){h.call(this,t,e,o,s)})}}}}(window.jQuery||window.Zepto),function(e){"use strict";function t(t){return e.grep(t,function(i,o){return o===e.inArray(i,t)})}function i(e,t){return Math.round(e/t)*t}function o(e){return"number"==typeof e&&!isNaN(e)&&isFinite(e)}function s(e){var t=Math.pow(10,7);return Number((Math.round(e*t)/t).toFixed(7))}function n(e,t,i){e.addClass(t),setTimeout(function(){e.removeClass(t)},i)}function r(e){return Math.max(Math.min(e,100),0)}function a(t){return e.isArray(t)?t:[t]}function d(e){var t=e.split(".");return t.length>1?t[1].length:0}function h(e,t){return 100/(t-e)}function l(e,t){return 100*t/(e[1]-e[0])}function _(e,t){return l(e,e[0]<0?t+Math.abs(e[0]):t-e[0])}function f(e,t){return t*(e[1]-e[0])/100+e[0]}function u(e,t){for(var i=1;e>=t[i];)i+=1;return i}function c(e,t,i){if(i>=e.slice(-1)[0])return 100;var o,s,n,r,a=u(i,e);return o=e[a-1],s=e[a],n=t[a-1],r=t[a],n+_([o,s],i)/h(n,r)}function m(e,t,i){if(i>=100)return e.slice(-1)[0];var o,s,n,r,a=u(i,t);return o=e[a-1],s=e[a],n=t[a-1],r=t[a],f([o,s],(i-n)*h(n,r))}function p(e,t,o,s){if(100===s)return s;var n,r,a=u(s,e);return o?(n=e[a-1],r=e[a],s-n>(r-n)/2?r:n):t[a-1]?e[a-1]+i(s-e[a-1],t[a-1]):s}function g(e,t,i){var s;if("number"==typeof t&&(t=[t]),"[object Array]"!==Object.prototype.toString.call(t))throw new Error("noUiSlider: 'range' contains invalid value.");if(s="min"===e?0:"max"===e?100:parseFloat(e),!o(s)||!o(t[0]))throw new Error("noUiSlider: 'range' value isn't numeric.");i.xPct.push(s),i.xVal.push(t[0]),s?i.xSteps.push(isNaN(t[1])?!1:t[1]):isNaN(t[1])||(i.xSteps[0]=t[1])}function x(e,t,i){return t?void(i.xSteps[e]=l([i.xVal[e],i.xVal[e+1]],t)/h(i.xPct[e],i.xPct[e+1])):!0}function v(e,t,i,o){this.xPct=[],this.xVal=[],this.xSteps=[o||!1],this.xNumSteps=[!1],this.snap=t,this.direction=i;var s,n=[];for(s in e)e.hasOwnProperty(s)&&n.push([e[s],s]);for(n.sort(function(e,t){return e[0]-t[0]}),s=0;s<n.length;s++)g(n[s][1],n[s][0],this);for(this.xNumSteps=this.xSteps.slice(0),s=0;s<this.xNumSteps.length;s++)x(s,this.xNumSteps[s],this)}function y(e,t){if(!o(t))throw new Error("noUiSlider: 'step' is not numeric.");e.singleStep=t}function b(t,i){if("object"!=typeof i||e.isArray(i))throw new Error("noUiSlider: 'range' is not an object.");if(void 0===i.min||void 0===i.max)throw new Error("noUiSlider: Missing 'min' or 'max' in 'range'.");t.spectrum=new v(i,t.snap,t.dir,t.singleStep)}function T(t,i){if(i=a(i),!e.isArray(i)||!i.length||i.length>2)throw new Error("noUiSlider: 'start' option is incorrect.");t.handles=i.length,t.start=i}function F(e,t){if(e.snap=t,"boolean"!=typeof t)throw new Error("noUiSlider: 'snap' option must be a boolean.")}function w(e,t){if(e.animate=t,"boolean"!=typeof t)throw new Error("noUiSlider: 'animate' option must be a boolean.")}function C(e,t){if("lower"===t&&1===e.handles)e.connect=1;else if("upper"===t&&1===e.handles)e.connect=2;else if(t===!0&&2===e.handles)e.connect=3;else{if(t!==!1)throw new Error("noUiSlider: 'connect' option doesn't match handle count.");e.connect=0}}function E(e,t){switch(t){case"horizontal":e.ort=0;break;case"vertical":e.ort=1;break;default:throw new Error("noUiSlider: 'orientation' option is invalid.")}}function S(e,t){if(!o(t))throw new Error("noUiSlider: 'margin' option must be numeric.");if(e.margin=e.spectrum.getMargin(t),!e.margin)throw new Error("noUiSlider: 'margin' option is only supported on linear sliders.")}function M(e,t){if(!o(t))throw new Error("noUiSlider: 'limit' option must be numeric.");if(e.limit=e.spectrum.getMargin(t),!e.limit)throw new Error("noUiSlider: 'limit' option is only supported on linear sliders.")}function N(e,t){switch(t){case"ltr":e.dir=0;break;case"rtl":e.dir=1,e.connect=[0,2,1,3][e.connect];break;default:throw new Error("noUiSlider: 'direction' option was not recognized.")}}function A(e,t){if("string"!=typeof t)throw new Error("noUiSlider: 'behaviour' must be a string containing options.");var i=t.indexOf("tap")>=0,o=t.indexOf("drag")>=0,s=t.indexOf("fixed")>=0,n=t.indexOf("snap")>=0;e.events={tap:i||n,drag:o,fixed:s,snap:n}}function I(e,t){if(e.format=t,"function"==typeof t.to&&"function"==typeof t.from)return!0;throw new Error("noUiSlider: 'format' requires 'to' and 'from' methods.")}function R(t){var i,o={margin:0,limit:0,animate:!0,format:K};return i={step:{r:!1,t:y},start:{r:!0,t:T},connect:{r:!0,t:C},direction:{r:!0,t:N},snap:{r:!1,t:F},animate:{r:!1,t:w},range:{r:!0,t:b},orientation:{r:!1,t:E},margin:{r:!1,t:S},limit:{r:!1,t:M},behaviour:{r:!0,t:A},format:{r:!1,t:I}},t=e.extend({connect:!1,direction:"ltr",behaviour:"tap",orientation:"horizontal"},t),e.each(i,function(e,i){if(void 0===t[e]){if(i.r)throw new Error("noUiSlider: '"+e+"' is required.");return!0}i.t(o,t[e])}),o.style=o.ort?"top":"left",o}function D(e,t,i){var o=e+t[0],s=e+t[1];return i?(0>o&&(s+=Math.abs(o)),s>100&&(o-=s-100),[r(o),r(s)]):[o,s]}function L(e){e.preventDefault();var t,i,o=0===e.type.indexOf("touch"),s=0===e.type.indexOf("mouse"),n=0===e.type.indexOf("pointer"),r=e;return 0===e.type.indexOf("MSPointer")&&(n=!0),e.originalEvent&&(e=e.originalEvent),o&&(t=e.changedTouches[0].pageX,i=e.changedTouches[0].pageY),(s||n)&&(n||void 0!==window.pageXOffset||(window.pageXOffset=document.documentElement.scrollLeft,window.pageYOffset=document.documentElement.scrollTop),t=e.clientX+window.pageXOffset,i=e.clientY+window.pageYOffset),r.points=[t,i],r.cursor=s,r}function V(t,i){var o=e("<div><div/></div>").addClass(Z[2]),s=["-lower","-upper"];return t&&s.reverse(),o.children().addClass(Z[3]+" "+Z[3]+s[i]),o}function P(e,t,i){switch(e){case 1:t.addClass(Z[7]),i[0].addClass(Z[6]);break;case 3:i[1].addClass(Z[6]);case 2:i[0].addClass(Z[7]);case 0:t.addClass(Z[6])}}function k(e,t,i){var o,s=[];for(o=0;e>o;o+=1)s.push(V(t,o).appendTo(i));return s}function X(t,i,o){return o.addClass([Z[0],Z[8+t],Z[4+i]].join(" ")),e("<div/>").appendTo(o).addClass(Z[1])}function B(t,i,o){function s(){return M[["width","height"][i.ort]]()}function h(e){var t,i=[A.val()];for(t=0;t<e.length;t+=1)A.trigger(e[t],i)}function l(e){return 1===e.length?e[0]:i.dir?e.reverse():e}function _(e){return function(t,i){A.val([e?null:i,e?i:null],!0)}}function f(t){var i=e.inArray(t,B);A[0].linkAPI&&A[0].linkAPI[t]&&A[0].linkAPI[t].change(V[i],N[i].children(),A)}function u(t,o){var s=e.inArray(t,B);return o&&o.appendTo(N[s].children()),i.dir&&i.handles>1&&(s=1===s?0:1),_(s)}function c(){var e,t;for(e=0;e<B.length;e+=1)this.linkAPI&&this.linkAPI[t=B[e]]&&this.linkAPI[t].reconfirm(t)}function m(e,t,o,s){return e=e.replace(/\s/g,q+" ")+q,t.on(e,function(e){return A.attr("disabled")?!1:A.hasClass(Z[14])?!1:(e=L(e),e.calcPoint=e.points[i.ort],void o(e,s))})}function p(e,t){var i,o=t.handles||N,n=!1,r=100*(e.calcPoint-t.start)/s(),a=o[0][0]!==N[0][0]?1:0;i=D(r,t.positions,o.length>1),n=b(o[0],i[a],1===o.length),o.length>1&&(n=b(o[1],i[a?0:1],!1)||n),n&&h(["slide"])}function g(t){e("."+Z[15]).removeClass(Z[15]),t.cursor&&e("body").css("cursor","").off(q),Y.off(q),A.removeClass(Z[12]),h(["set","change"])}function x(t,i){1===i.handles.length&&i.handles[0].children().addClass(Z[15]),t.stopPropagation(),m(Q.move,Y,p,{start:t.calcPoint,handles:i.handles,positions:[I[0],I[N.length-1]]}),m(Q.end,Y,g,null),t.cursor&&(e("body").css("cursor",e(t.target).css("cursor")),N.length>1&&A.addClass(Z[12]),e("body").on("selectstart"+q,!1))}function v(t){var o,r=t.calcPoint,a=0;t.stopPropagation(),e.each(N,function(){a+=this.offset()[i.style]}),a=a/2>r||1===N.length?0:1,r-=M.offset()[i.style],o=100*r/s(),i.events.snap||n(A,Z[14],300),b(N[a],o),h(["slide","set","change"]),i.events.snap&&x(t,{handles:[N[a]]})}function y(e){var t,i;if(!e.fixed)for(t=0;t<N.length;t+=1)m(Q.start,N[t].children(),x,{handles:[N[t]]});e.tap&&m(Q.start,M,v,{handles:N}),e.drag&&(i=M.find("."+Z[7]).addClass(Z[10]),e.fixed&&(i=i.add(M.children().not(i).children())),m(Q.start,i,x,{handles:N}))}function b(e,t,o){var s=e[0]!==N[0][0]?1:0,n=I[0]+i.margin,a=I[1]-i.margin,d=I[0]+i.limit,h=I[1]-i.limit;return N.length>1&&(t=s?Math.max(t,n):Math.min(t,a)),o!==!1&&i.limit&&N.length>1&&(t=s?Math.min(t,d):Math.max(t,h)),t=R.getStep(t),t=r(parseFloat(t.toFixed(7))),t===I[s]?!1:(e.css(i.style,t+"%"),e.is(":first-child")&&e.toggleClass(Z[17],t>50),I[s]=t,V[s]=R.fromStepping(t),f(B[s]),!0)}function T(e,t){var o,s,n;for(i.limit&&(e+=1),o=0;e>o;o+=1)s=o%2,n=t[s],null!==n&&n!==!1&&("number"==typeof n&&(n=String(n)),n=i.format.from(n),(n===!1||isNaN(n)||b(N[s],R.toStepping(n),o===3-i.dir)===!1)&&f(B[s]))}function F(e){if(A[0].LinkIsEmitting)return this;var t,o=a(e);return i.dir&&i.handles>1&&o.reverse(),i.animate&&-1!==I[0]&&n(A,Z[14],300),t=N.length>1?3:1,1===o.length&&(t=1),T(t,o),h(["set"]),this}function w(){var e,t=[];for(e=0;e<i.handles;e+=1)t[e]=i.format.to(V[e]);return l(t)}function C(){return e(this).off(q).removeClass(Z.join(" ")).empty(),delete this.LinkUpdate,delete this.LinkConfirm,delete this.LinkDefaultFormatter,delete this.LinkDefaultFlag,delete this.reappend,delete this.vGet,delete this.vSet,delete this.getCurrentStep,delete this.getInfo,delete this.destroy,o}function E(){var t=e.map(I,function(e,t){var i=R.getApplicableStep(e),o=d(String(i[2])),s=V[t],n=100===e?null:i[2],r=Number((s-i[2]).toFixed(o)),a=0===e?null:r>=i[1]?i[2]:i[0]||!1;return[[a,n]]});return l(t)}function S(){return o}var M,N,A=e(t),I=[-1,-1],R=i.spectrum,V=[],B=["lower","upper"].slice(0,i.handles);if(i.dir&&B.reverse(),t.LinkUpdate=f,t.LinkConfirm=u,t.LinkDefaultFormatter=i.format,t.LinkDefaultFlag="lower",t.reappend=c,A.hasClass(Z[0]))throw new Error("Slider was already initialized.");M=X(i.dir,i.ort,A),N=k(i.handles,i.dir,M),P(i.connect,A,N),y(i.events),t.vSet=F,t.vGet=w,t.destroy=C,t.getCurrentStep=E,t.getOriginalOptions=S,t.getInfo=function(){return[R,i.style,i.ort]},A.val(i.start)}function U(e){var t=R(e,this);return this.each(function(){B(this,t,e)})}function G(t){return this.each(function(){if(!this.destroy)return void e(this).noUiSlider(t);var i=e(this).val(),o=this.destroy(),s=e.extend({},o,t);e(this).noUiSlider(s),this.reappend(),o.start===s.start&&e(this).val(i)})}function z(){return this[0][arguments.length?"vSet":"vGet"].apply(this[0],arguments)}function O(t,i,o,s){if("range"===i||"steps"===i)return t.xVal;if("count"===i){var n,r=100/(o-1),a=0;for(o=[];(n=a++*r)<=100;)o.push(n);i="positions"}return"positions"===i?e.map(o,function(e){return t.fromStepping(s?t.getStep(e):e)}):"values"===i?s?e.map(o,function(e){return t.fromStepping(t.getStep(t.toStepping(e)))}):o:void 0}function j(i,o,s,n){var r=i.direction,a={},d=i.xVal[0],h=i.xVal[i.xVal.length-1],l=!1,_=!1,f=0;return i.direction=0,n=t(n.slice().sort(function(e,t){return e-t})),n[0]!==d&&(n.unshift(d),l=!0),n[n.length-1]!==h&&(n.push(h),_=!0),e.each(n,function(t){var r,d,h,u,c,m,p,g,x,v,y=n[t],b=n[t+1];if("steps"===s&&(r=i.xNumSteps[t]),r||(r=b-y),y!==!1&&void 0!==b)for(d=y;b>=d;d+=r){for(u=i.toStepping(d),c=u-f,g=c/o,x=Math.round(g),v=c/x,h=1;x>=h;h+=1)m=f+h*v,a[m.toFixed(5)]=["x",0];p=e.inArray(d,n)>-1?1:"steps"===s?2:0,!t&&l&&(p=0),d===b&&_||(a[u.toFixed(5)]=[d,p]),f=u}}),i.direction=r,a}function W(t,i,o,s,n,r){function a(e){return["-normal","-large","-sub"][e]}function d(e,i,o){return'class="'+i+" "+i+"-"+l+" "+i+a(o[1],o[0])+'" style="'+t+": "+e+'%"'}function h(e,t){o&&(e=100-e),t[1]=t[1]&&n?n(t[0],t[1]):t[1],_.append("<div "+d(e,"noUi-marker",t)+"></div>"),t[1]&&_.append("<div "+d(e,"noUi-value",t)+">"+r.to(t[0])+"</div>")}var l=["horizontal","vertical"][i],_=e("<div/>");return _.addClass("noUi-pips noUi-pips-"+l),e.each(s,h),_}var Y=e(document),H=e.fn.val,q=".nui",Q=window.navigator.pointerEnabled?{start:"pointerdown",move:"pointermove",end:"pointerup"}:window.navigator.msPointerEnabled?{start:"MSPointerDown",move:"MSPointerMove",end:"MSPointerUp"}:{start:"mousedown touchstart",move:"mousemove touchmove",end:"mouseup touchend"},Z=["noUi-target","noUi-base","noUi-origin","noUi-handle","noUi-horizontal","noUi-vertical","noUi-background","noUi-connect","noUi-ltr","noUi-rtl","noUi-dragable","","noUi-state-drag","","noUi-state-tap","noUi-active","","noUi-stacking"];v.prototype.getMargin=function(e){return 2===this.xPct.length?l(this.xVal,e):!1},v.prototype.toStepping=function(e){return e=c(this.xVal,this.xPct,e),this.direction&&(e=100-e),e},v.prototype.fromStepping=function(e){return this.direction&&(e=100-e),s(m(this.xVal,this.xPct,e))},v.prototype.getStep=function(e){return this.direction&&(e=100-e),e=p(this.xPct,this.xSteps,this.snap,e),this.direction&&(e=100-e),e},v.prototype.getApplicableStep=function(e){var t=u(e,this.xPct),i=100===e?2:1;return[this.xNumSteps[t-2],this.xVal[t-i],this.xNumSteps[t-i]]},v.prototype.convert=function(e){return this.getStep(this.toStepping(e))};var K={to:function(e){return e.toFixed(2)},from:Number};e.fn.val=function(t){function i(e){return e.hasClass(Z[0])?z:H}if(!arguments.length){var o=e(this[0]);return i(o).call(o)}var s=e.isFunction(t);return this.each(function(o){var n=t,r=e(this);s&&(n=t.call(this,o,r.val())),i(r).call(r,n)})},e.fn.noUiSlider=function(e,t){switch(e){case"step":return this[0].getCurrentStep();case"options":return this[0].getOriginalOptions()}return(t?G:U).call(this,e)},e.fn.noUiSlider_pips=function(t){var i=t.mode,o=t.density||1,s=t.filter||!1,n=t.values||!1,r=t.format||{to:Math.round},a=t.stepped||!1;return this.each(function(){var t=this.getInfo(),d=O(t[0],i,n,a),h=j(t[0],o,i,d);return e(this).append(W(t[1],t[2],t[0].direction,h,s,r))})}}(window.jQuery||window.Zepto),Array.forEach||(Array.forEach=function(e,t,i){for(var o=e.length,s=0;o>s;s++)s in e&&t.call(i,e[s],s,e)}),Array.map||(Array.map=function(e,t,i){for(var o=e.length,s=[],n=0;o>n;n++)n in e&&(s[n]=t.call(i,e[n],n,e));return s}),Array.filter||(Array.filter=function(e,t,i){for(var o=e.length,s=[],n=0;o>n;n++)if(n in e){var r=e[n];t.call(i,r,n,e)&&s.push(r)}return s});var x3dom={canvases:[]};x3dom.x3dNS="http://www.web3d.org/specifications/x3d-namespace",x3dom.x3dextNS="http://philip.html5.org/x3d/ext",x3dom.xsltNS="http://www.w3.org/1999/XSL/x3dom.Transform",x3dom.xhtmlNS="http://www.w3.org/1999/xhtml",x3dom.nodeTypes={},x3dom.nodeTypesLC={},x3dom.components={},x3dom.geoCache=[],x3dom.caps={PLATFORM:navigator.platform,AGENT:navigator.userAgent},x3dom.registerNodeType=function(e,t,i){x3dom.debug.logInfo("Registering nodetype ["+e+"] in component ["+t+"]"),void 0===x3dom.components[t]?(x3dom.debug.logInfo("Adding new component ["+t+"]"),x3dom.components[t]={}):x3dom.debug.logInfo("Using component ["+t+"]"),i._typeName=e,i._compName=t,x3dom.components[t][e]=i,x3dom.nodeTypes[e]=i,x3dom.nodeTypesLC[e.toLowerCase()]=i},x3dom.isX3DElement=function(e){return e.nodeType===Node.ELEMENT_NODE&&e.localName&&(x3dom.nodeTypes[e.localName]||x3dom.nodeTypesLC[e.localName.toLowerCase()]||"x3d"===e.localName.toLowerCase()||"websg"===e.localName.toLowerCase()||"scene"===e.localName.toLowerCase()||"route"===e.localName.toLowerCase())},x3dom.extend=function(e){function t(){}return t.prototype=e.prototype||e,new t},x3dom.getStyle=function(e,t){var i;return window&&window.getComputedStyle&&window.getComputedStyle(e,"")?i=window.getComputedStyle(e,"")[t]:e.currentStyle&&(t=t.replace(/\-(\w)/g,function(e,t){return t.toUpperCase()}),i=e.currentStyle[t]),i},x3dom.isa=function(e,t){function i(e){return e===t?!0:e.prototype&&e.prototype.constructor&&e.prototype.constructor.superClass?i(e.prototype.constructor.superClass):!1}return e?e.constructor===t?!0:void 0===e.constructor.superClass?!1:i(e.constructor.superClass):!1},x3dom.getGlobal=function(){return function(){return this}.call(null)},x3dom.isNumber=function(e){return!isNaN(parseFloat(e))&&isFinite(e)},x3dom.loadJS=function(src,path_prefix,blocking){var blocking=blocking===!1?blocking:!0;if(blocking){var req,url=path_prefix?path_prefix.trim()+src:src;req=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),req&&(req.open("GET",url,!1),req.send(null),eval(req.responseText))}else{var head=document.getElementsByTagName("HEAD").item(0),script=document.createElement("script"),loadpath=path_prefix?path_prefix.trim()+src:src;head?(x3dom.debug.logError("Trying to load external JS file: "+loadpath),script.type="text/javascript",script.src=loadpath,head.appendChild(script,head.firstChild)):alert("No document object found. Can't load components")}},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}(),x3dom.debug={INFO:"INFO",WARNING:"WARNING",ERROR:"ERROR",EXCEPTION:"EXCEPTION",isActive:!1,isFirebugAvailable:!1,isSetup:!1,isAppend:!1,numLinesLogged:0,maxLinesToLog:400,logContainer:null,setup:function(){if(!x3dom.debug.isSetup){try{void 0!==window.console.firebug&&(x3dom.debug.isFirebugAvailable=!0)}catch(e){x3dom.debug.isFirebugAvailable=!1}x3dom.debug.setupLogContainer(),x3dom.debug.isSetup=!0}},activate:function(e){x3dom.debug.isActive=!0,x3dom.debug.logContainer.style.display=e?"block":"none",x3dom.debug.isAppend||("Microsoft Internet Explorer"==navigator.appName?(x3dom.debug.logContainer.style.marginLeft="8px",document.documentElement.appendChild(x3dom.debug.logContainer)):document.body.appendChild(x3dom.debug.logContainer),x3dom.debug.isAppend=!0)},setupLogContainer:function(){x3dom.debug.logContainer=document.createElement("div"),x3dom.debug.logContainer.id="x3dom_logdiv",x3dom.debug.logContainer.style.border="2px solid olivedrab",x3dom.debug.logContainer.style.height="180px",x3dom.debug.logContainer.style.padding="4px",x3dom.debug.logContainer.style.overflow="auto",x3dom.debug.logContainer.style.whiteSpace="pre-wrap",x3dom.debug.logContainer.style.fontFamily="sans-serif",x3dom.debug.logContainer.style.fontSize="x-small",x3dom.debug.logContainer.style.color="#00ff00",x3dom.debug.logContainer.style.backgroundColor="black",x3dom.debug.logContainer.style.clear="both",x3dom.debug.logContainer.style.marginRight="10px"},doLog:function(e,t){if(x3dom.debug.isActive&&(x3dom.debug.numLinesLogged===x3dom.debug.maxLinesToLog&&(e="Maximum number of log lines (="+x3dom.debug.maxLinesToLog+") reached. Deactivating logging..."),!(x3dom.debug.numLinesLogged>x3dom.debug.maxLinesToLog))){var i=document.createElement("p");switch(i.style.margin=0,t){case x3dom.debug.INFO:i.style.color="#00ff00";break;case x3dom.debug.WARNING:i.style.color="#cd853f";break;case x3dom.debug.ERROR:i.style.color="#ff4500";break;case x3dom.debug.EXCEPTION:i.style.color="#ffff00";break;default:i.style.color="#00ff00"}try{i.innerHTML=t+": "+e,x3dom.debug.logContainer.insertBefore(i,x3dom.debug.logContainer.firstChild)}catch(o){void 0!==window.console.firebug&&window.console.warn(e)}if(x3dom.debug.isFirebugAvailable)switch(t){case x3dom.debug.INFO:window.console.info(e);break;case x3dom.debug.WARNING:window.console.warn(e);break;case x3dom.debug.ERROR:window.console.error(e);break;case x3dom.debug.EXCEPTION:window.console.debug(e)}x3dom.debug.numLinesLogged++}},logInfo:function(e){x3dom.debug.doLog(e,x3dom.debug.INFO)},logWarning:function(e){x3dom.debug.doLog(e,x3dom.debug.WARNING)},logError:function(e){x3dom.debug.doLog(e,x3dom.debug.ERROR)},logException:function(e){x3dom.debug.doLog(e,x3dom.debug.EXCEPTION)},assert:function(e,t){e||x3dom.debug.doLog("Assertion failed in "+x3dom.debug.assert.caller.name+": "+t,x3dom.debug.ERROR)},typeOf:function(e){var t=typeof e;return"object"!==t||e?t:"null"},exists:function(e,t,i){return i=i||"function",(e?this.typeOf(e[t]):"null")===i}},x3dom.debug.setup(),x3dom.ImageLoadManager={heap:[],complete:!1,activeDownloads:0,push:function(e){"webgl"==x3dom.caps.BACKEND&&void 0!=e._vf.url[0]&&(x3dom.debug.logInfo("[ImageLoadManager] Push image to queue: URL = "+e._vf.url[0]+" | Priority = "+e._vf.priority),x3dom.ImageLoadManager.heapUp(x3dom.ImageLoadManager.heap.push({priority:e._vf.priority,image:e._image,url:e._vf.url[0]})-1),x3dom.ImageLoadManager.complete&&(x3dom.ImageLoadManager.complete=!1,x3dom.ImageLoadManager.load()))},pop:function(){if(!x3dom.ImageLoadManager.isEmpty()){var e=x3dom.ImageLoadManager.heap[0],t=x3dom.ImageLoadManager.heap.pop();return x3dom.ImageLoadManager.heap.length>0&&(x3dom.ImageLoadManager.heap[0]=t,x3dom.ImageLoadManager.heapDown(0)),e}},load:function(){if("webgl"==x3dom.caps.BACKEND){for(x3dom.debug.logInfo("[ImageLoadManager] Start loading...");!x3dom.ImageLoadManager.isEmpty();){var e=x3dom.ImageLoadManager.pop();e.image.crossOrigin="",e.image.src=e.url,e.image.onload=x3dom.ImageLoadManager.onLoadFnc,x3dom.ImageLoadManager.activeDownloads++}x3dom.ImageLoadManager.complete=!0}},onLoadFnc:function(){var e=document.createEvent("HTMLEvents");e.initEvent("ImageLoadManager_Load",!0,!0),this.dispatchEvent(e)},getLeftChildIndex:function(e){return parseInt(2*e+1)},getRightChildIndex:function(e){return parseInt(2*e+2)},getParentIndex:function(e){return parseInt((e-1)/2)},heapUp:function(e){var t,i;0!=e&&(t=x3dom.ImageLoadManager.getParentIndex(e),x3dom.ImageLoadManager.heap[t].priority>x3dom.ImageLoadManager.heap[e].priority&&(i=x3dom.ImageLoadManager.heap[t],x3dom.ImageLoadManager.heap[t]=x3dom.ImageLoadManager.heap[e],x3dom.ImageLoadManager.heap[e]=i,x3dom.ImageLoadManager.heapUp(t)))},heapDown:function(e){var t,i,o,s;if(t=x3dom.ImageLoadManager.getLeftChildIndex(e),i=x3dom.ImageLoadManager.getRightChildIndex(e),i>=x3dom.ImageLoadManager.heap.length){if(t>=x3dom.ImageLoadManager.heap.length)return;o=t}else o=x3dom.ImageLoadManager.heap[t].priority<=x3dom.ImageLoadManager.heap[i].priority?t:i;x3dom.ImageLoadManager.heap[e].priority>x3dom.ImageLoadManager.heap[o].priority&&(s=x3dom.ImageLoadManager.heap[o],x3dom.ImageLoadManager.heap[o]=x3dom.ImageLoadManager.heap[e],x3dom.ImageLoadManager.heap[e]=s,x3dom.ImageLoadManager.heapDown(o))},isEmpty:function(){return 0==x3dom.ImageLoadManager.heap.length},toString:function(){for(var e="ImageLoadManager("+x3dom.ImageLoadManager.heap.length+") [",t=0;t<x3dom.ImageLoadManager.heap.length;t++)0!=t&&(e+=", "),e+=x3dom.ImageLoadManager.heap[t].priority+" - "+x3dom.ImageLoadManager.heap[t].url;return e+="]"},length:function(){return x3dom.ImageLoadManager.heap.length}},x3dom.Properties=function(){this.properties={}},x3dom.Properties.prototype.setProperty=function(e,t){x3dom.debug.logInfo("Properties: Setting property '"+e+"' to value '"+t+"'"),this.properties[e]=t},x3dom.Properties.prototype.getProperty=function(e,t){return this.properties[e]?this.properties[e]:t},x3dom.Properties.prototype.merge=function(e){for(var t in e.properties)this.properties[t]=e.properties[t]},x3dom.Properties.prototype.toString=function(){var e="";for(var t in this.properties)e+="Name: "+t+" Value: "+this.properties[t]+"\n";return e},x3dom.DoublyLinkedList=function(){this.length=0,this.first=null,this.last=null},x3dom.DoublyLinkedList.ListNode=function(e,t,i,o,s){this.point=e,this.point_index=t,this.normals=i,this.colors=o,this.texCoords=s,this.next=null,this.prev=null},x3dom.DoublyLinkedList.prototype.appendNode=function(e){null===this.first?(e.prev=e,e.next=e,this.first=e,this.last=e):(e.prev=this.last,e.next=this.first,this.first.prev=e,this.last.next=e,this.last=e),this.length++},x3dom.DoublyLinkedList.prototype.insertAfterNode=function(e,t){t.prev=e,t.next=e.next,e.next.prev=t,e.next=t,t.prev==this.last&&(this.last=t),this.length++},x3dom.DoublyLinkedList.prototype.deleteNode=function(e){this.length>1?(e.prev.next=e.next,e.next.prev=e.prev,e==this.first&&(this.first=e.next),e==this.last&&(this.last=e.prev)):(this.first=null,this.last=null),e.prev=null,e.next=null,this.length--},x3dom.DoublyLinkedList.prototype.getNode=function(e){var t=null;if(e>this.length)return t;for(var i=0;i<this.length;i++)if(t=0==i?this.first:t.next,i==e)return t},x3dom.DoublyLinkedList.prototype.invert=function(){var e=null,t=null;e=this.first;for(var i=0;i<this.length;i++)t=e.prev,e.prev=e.next,e.next=t,e=e.prev;t=this.first,this.first=this.last,this.last=t},x3dom.EarClipping={reversePointDirection:function(e,t){var i,o,s,n,r,a,d=0;if(e.length<3)return!1;for(var h=0;h<e.length;h++)i=(h+1)%e.length,o=(h+2)%e.length,n=e.getNode(h),r=e.getNode(i),a=e.getNode(o),"YZ"==t?(s=(r.point.y-n.point.y)*(a.point.z-r.point.z),s-=(r.point.z-n.point.z)*(a.point.y-r.point.y)):"XZ"==t?(s=(r.point.z-n.point.z)*(a.point.x-r.point.x),s-=(r.point.x-n.point.x)*(a.point.z-r.point.z)):(s=(r.point.x-n.point.x)*(a.point.y-r.point.y),s-=(r.point.y-n.point.y)*(a.point.x-r.point.x)),0>s?d--:s>0&&d++;
return 0>d?(e.invert(),!0):!1},getIndexes:function(e){var t=e.first.next,i=this.identifyPlane(t.prev.point,t.point,t.next.point),o=this.reversePointDirection(e,i),s=[];t=e.first.next;for(var n=null,r=0,a=!0;e.length>=3&&10>r;){n=t.next;for(var d=0;d<e.length;d++)this.isNotEar(e.getNode(d).point,t.prev.point,t.point,t.next.point,i)&&(a=!1);if(a&&(this.isKonvex(t.prev.point,t.point,t.next.point,i)?(s.push(t.prev.point_index,t.point_index,t.next.point_index),e.deleteNode(t)):r++),3==r&&this.reversePointDirection(e))for(var h=this.getIndexes(e).reverse(),d=0;d<h.length;d++)s.push(h[d]);t=n,a=!0}return o?s.reverse():s},getMultiIndexes:function(e){var t=e.first.next,i=this.identifyPlane(t.prev.point,t.point,t.next.point),o=this.reversePointDirection(e,i),s=new Object;s.indices=[],s.point=[],s.normals=[],s.colors=[],s.texCoords=[],t=e.first.next;for(var n=null,r=0,a=!0;e.length>=3&&10>r;){n=t.next;for(var d=0;d<e.length;d++)this.isNotEar(e.getNode(d).point,t.prev.point,t.point,t.next.point,i)&&(a=!1);if(a&&(this.isKonvex(t.prev.point,t.point,t.next.point,i)?(s.indices.push(t.prev.point_index,t.point_index,t.next.point_index),s.point.push(t.prev.point,t.point,t.next.point),t.normals&&s.normals.push(t.prev.normals,t.normals,t.next.normals),t.colors&&s.colors.push(t.prev.colors,t.colors,t.next.colors),t.texCoords&&s.texCoords.push(t.prev.texCoords,t.texCoords,t.next.texCoords),e.deleteNode(t)):r++),3==r&&this.reversePointDirection(e)){var h=this.getMultiIndexes(e);s.indices=s.indices.concat(h.indices.reverse()),s.point=s.point.concat(h.point.reverse()),s.normals=s.normals.concat(h.normals.reverse()),s.colors=s.colors.concat(h.colors.reverse()),s.texCoords=s.texCoords.concat(h.texCoords.reverse())}t=n,a=!0}return o?(s.indices=s.indices.reverse(),s.point=s.point.reverse(),s.normals=s.normals.reverse(),s.colors=s.colors.reverse(),s.texCoords=s.texCoords.reverse(),s):s},isNotEar:function(e,t,i,o,s){var n,r,a,d,h,l,_,f,u,c,m,p;return"YZ"==s?(h=e.y,l=e.z,_=t.y,f=t.z,u=i.y,c=i.z,m=o.y,p=o.z):"XZ"==s?(h=e.z,l=e.x,_=t.z,f=t.x,u=i.z,c=i.x,m=o.z,p=o.x):(h=e.x,l=e.y,_=t.x,f=t.y,u=i.x,c=i.y,m=o.x,p=o.y),n=(u-_)*(p-f)-(m-_)*(c-f),0!=n?(r=((u-h)*(p-l)-(m-h)*(c-l))/n,a=((m-h)*(f-l)-(_-h)*(p-l))/n,d=1-r-a,r>0&&a>0&&d>0):!1},isKonvex:function(e,t,i,o){var s,n,r,a,d,h;"YZ"==o?(s=e.y,n=e.z,r=t.y,a=t.z,d=i.y,h=i.z):"XZ"==o?(s=e.z,n=e.x,r=t.z,a=t.x,d=i.z,h=i.x):(s=e.x,n=e.y,r=t.x,a=t.y,d=i.x,h=i.y);var l=(r-s)*(h-n)-(a-n)*(d-s);return 0>l?!1:!0},identifyPlane:function(e,t,i){var o,s,n,r,a,d,h,l,_;o=t.x-e.x,s=t.y-e.y,n=t.z-e.z,r=i.x-e.x,a=i.y-e.y,d=i.z-e.z,h=s*d-n*a,l=n*r-o*d,_=o*a-s*r;var f=Math.max(Math.abs(h),Math.abs(l),Math.abs(_));return f==Math.abs(h)?"YZ":f==Math.abs(l)?"XZ":f==Math.abs(_)?"XY":"fehler"}},x3dom.X3DCanvas=function(e,t){var i=this;this.canvasIdx=t,this.initContext=function(e){x3dom.debug.logInfo("Initializing X3DCanvas for ["+e.id+"]");var t=x3dom.gfx_webgl(e);return t?t:(x3dom.debug.logError("No 3D context found..."),this.x3dElem.removeChild(e),null)},this.initFlashContext=function(e){x3dom.debug.logInfo("Initializing X3DObject for ["+e.id+"]");var t=x3dom.gfx_flash(e);return t},this.appendParam=function(e,t,i){var o=document.createElement("param");o.setAttribute("name",t),o.setAttribute("value",i),e.appendChild(o)},this.detectFlash=function(e,t){var i=e,o=t,s=0;if("object"==typeof navigator.plugins["Shockwave Flash"]){var n=navigator.plugins["Shockwave Flash"].description;s=n.substr(16,n.indexOf(".",16)-16)}else if("function"==typeof ActiveXObject)for(var r=10;o+1>r;r++)try{"object"==typeof new ActiveXObject("ShockwaveFlash.ShockwaveFlash."+r)&&(s=r+1)}catch(a){}return[s,i]},this.createInitFailedDiv=function(e){var t=document.createElement("div");t.style.width=e.getAttribute("width"),t.style.height=e.getAttribute("height"),t.style.backgroundColor="#C00",t.style.color="#FFF",t.style.fontSize="20px",t.style.fontWidth="bold",t.style.padding="10px 10px 10px 10px",t.style.display="inline-block",t.style.fontFamily="Arial",t.style.textAlign="center",t.appendChild(document.createTextNode("Your Browser does not support X3DOM")),t.appendChild(document.createElement("br")),t.appendChild(document.createTextNode("Read more about X3DOM Browser support on:")),t.appendChild(document.createElement("br"));var i=document.createElement("a");i.setAttribute("href","http://www.x3dom.org/?page_id=9"),i.appendChild(document.createTextNode("X3DOM | Browser Support")),t.appendChild(i),e.appendChild(t),x3dom.debug.logError("Your Browser does not support X3DOM!")},this.createFlashObject=function(e){var t=this.detectFlash(11,11);if(!t[0]||t[0]<t[1])return null;x3dom.debug.logInfo("Creating FlashObject for (X)3D element...");var i=e.getAttribute("id");if(null!==i)i="x3dom-"+i+"-object";else{var o=(new Date).getTime();i="x3dom-"+o+"-object"}var s=e.getAttribute("swfpath");null===s&&(s="x3dom.swf");var n=e.getAttribute("width");if(null==n)n=550;else{var r=n.indexOf("px");-1!=r&&(n=n.substr(0,r))}var a=e.getAttribute("height");if(null==a)a=400;else{var r=a.indexOf("px");-1!=r&&(a=a.substr(0,r))}var d=document.createElement("object");return d.setAttribute("width",n),d.setAttribute("height",a),d.setAttribute("id",i),this.appendParam(d,"menu","false"),this.appendParam(d,"quality","high"),this.appendParam(d,"wmode","gpu"),this.appendParam(d,"allowScriptAccess","always"),this.appendParam(d,"flashvars","width="+n+"&height="+a+"&canvasIdx="+this.canvasIdx),this.appendParam(d,"movie",s),e.appendChild(d),"Microsoft Internet Explorer"==navigator.appName?d.setAttribute("classid","clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"):(d.setAttribute("type","application/x-shockwave-flash"),d.setAttribute("data",s)),d},this.createHTMLCanvas=function(e){x3dom.debug.logInfo("Creating canvas for (X)3D element...");var t=document.createElement("canvas");t.setAttribute("class","x3dom-canvas");var o=e.getAttribute("style");o&&x3dom.debug.logInfo("Inline X3D styles detected");for(var s=["onmousedown","onmousemove","onmouseout","onmouseover","onmouseup","onclick","ondblclick","onkeydown","onkeypress","onkeyup","ontouchstart","ontouchmove","ontouchend","ontouchcancel","touchleave","ongesturestart","ongesturechange","ongestureend","MozTouchDown","MozTouchMove","MozTouchUp"],n=0;n<s.length;n++){var r=s[n],a=e.getAttribute(r);a&&(x3dom.debug.logInfo(r+", "+a),t.setAttribute(r,a))}e.__addEventListener||e.__removeEventListener||(e.__addEventListener=e.addEventListener,e.__removeEventListener=e.removeEventListener,e.addEventListener=function(e,t,o){var n,r=!1;for(n=0;n<s.length&&!r;n++)s[n]===e&&(r=!0);r?(x3dom.debug.logInfo("addEventListener for div.on"+e),i.canvas.addEventListener(e,t,o)):(x3dom.debug.logInfo("addEventListener for X3D.on"+e),this.__addEventListener(e,t,o))},e.removeEventListener=function(e,t,o){var n,r=!1;for(n=0;n<s.length&&!r;n++)s[n]===e&&(r=!0);r?(x3dom.debug.logInfo("removeEventListener for div.on"+e),i.canvas.removeEventListener(e,t,o)):(x3dom.debug.logInfo("removeEventListener for X3D.on"+e),this.__removeEventListener(e,t,o))}),e.appendChild(t);var d=e.getAttribute("id");if(null!==d)t.id="x3dom-"+d+"-canvas";else{var h=(new Date).getTime();t.id="x3dom-"+h+"-canvas"}var l=2,_=2;return null!==(l=e.getAttribute("width"))&&(t.style.width=l,t.setAttribute("width",l)),null!==(_=e.getAttribute("height"))&&(t.style.height=_,t.setAttribute("height",_)),t.setAttribute("tabindex","0"),t.focus(),t};var o=[0,0];if(this.watchForResize=function(){var e=[x3dom.getStyle(i.canvas,"width"),x3dom.getStyle(i.canvas,"height")];(o[0]!=e[0]||o[1]!=e[1])&&(o=e,i.x3dElem.setAttribute("width",e[0]),i.x3dElem.setAttribute("height",e[1]))},this.createStatDiv=function(){var e=document.createElement("div");return e.setAttribute("class","x3dom-statdiv"),e.innerHTML="0 fps",this.x3dElem.appendChild(e),e.oncontextmenu=e.onmousedown=function(e){return e.preventDefault(),e.stopPropagation(),e.returnValue=!1,!1},e},this.createProgressDiv=function(){var e=document.createElement("div");e.setAttribute("class","x3dom-progress");var t=document.createElement("strong");t.appendChild(document.createTextNode("Loading...")),e.appendChild(t);var i=document.createElement("span");return i.setAttribute("style","width: 25%;"),i.appendChild(document.createTextNode("Â ")),e.appendChild(i),this.x3dElem.appendChild(e),e.oncontextmenu=e.onmousedown=function(e){return e.preventDefault(),e.stopPropagation(),e.returnValue=!1,!1},e},this.isFlashReady=!1,this.x3dElem=e,this.backend="none","flash"==this.x3dElem.getAttribute("backend")){if(this.backend="flash",this.canvas=this.createFlashObject(e),null==this.canvas)return this.createInitFailedDiv(e),null;this.canvas.parent=this,this.gl=this.initFlashContext(this.canvas)}else if(this.backend="webgl",this.canvas=this.createHTMLCanvas(e),this.canvas.parent=this,this.gl=this.initContext(this.canvas),null==this.gl){if(x3dom.debug.logInfo("Fallback to Flash Renderer"),this.backend="flash",this.canvas=this.createFlashObject(e),null==this.canvas)return this.createInitFailedDiv(e),null;this.canvas.parent=this,this.gl=this.initFlashContext(this.canvas)}x3dom.caps.BACKEND=this.backend,this.fps_t0=(new Date).getTime(),this.doc=null,e.__setAttribute=e.setAttribute,e.setAttribute=function(e,t){switch(this.__setAttribute(e,t),e){case"width":i.canvas.setAttribute("width",t),i.doc._viewarea&&(i.doc._viewarea._width=parseInt(i.canvas.getAttribute("width"),0));break;case"height":i.canvas.setAttribute("height",t),i.doc._viewarea&&(i.doc._viewarea._height=parseInt(i.canvas.getAttribute("height"),0))}i.doc.needRender=!0};var s=e.getAttribute("runtimeEnabled");if(this.hasRuntime=null!==s?"true"==s.toLowerCase():e.hasRuntime,null===this.gl&&(this.hasRuntime=!1),this.showStat=e.getAttribute("showStat"),this.statDiv=this.createStatDiv(),this.statDiv.style.display=null!==this.showStat&&"true"==this.showStat?"inline":"none",this.showProgress=e.getAttribute("showProgress"),this.progressDiv=this.createProgressDiv(),this.progressDiv.style.display="inline",null!==this.canvas&&null!==this.gl&&this.hasRuntime&&"flash"!==this.backend){this.canvas.mouse_dragging=!1,this.canvas.mouse_button=0,this.canvas.mouse_drag_x=0,this.canvas.mouse_drag_y=0,this.canvas.isMulti=!1,this.canvas.oncontextmenu=function(e){return e.preventDefault(),e.stopPropagation(),e.returnValue=!1,!1},this.canvas.addEventListener("mousedown",function(e){switch(this.focus(),e.button){case 0:this.mouse_button=1;break;case 1:this.mouse_button=4;break;case 2:this.mouse_button=2;break;default:this.mouse_button=0}this.mouse_drag_x=e.offsetX||e.layerX||e.x,this.mouse_drag_y=e.offsetY||e.layerY||e.y,this.mouse_dragging=!0,e.shiftKey&&(this.mouse_button=1),e.ctrlKey&&(this.mouse_button=4),e.altKey&&(this.mouse_button=2),this.parent.doc.onMousePress(i.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button),this.parent.doc.needRender=!0,window.status=this.id+" DOWN: "+(e.offsetX||e.layerX||e.x)+", "+(e.offsetY||e.layerY||e.y),e.returnValue=!0},!1),this.canvas.addEventListener("mouseup",function(e){this.mouse_button=0,this.mouse_dragging=!1,this.parent.doc.onMouseRelease(i.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button),this.parent.doc.needRender=!0,e.returnValue=!0},!1),this.canvas.addEventListener("mouseover",function(e){this.mouse_button=0,this.mouse_dragging=!1,this.parent.doc.onMouseOver(i.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button),this.parent.doc.needRender=!0,e.returnValue=!0},!1),this.canvas.addEventListener("mouseout",function(e){this.mouse_button=0,this.mouse_dragging=!1,this.parent.doc.onMouseOut(i.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button),this.parent.doc.needRender=!0,e.returnValue=!0},!1),this.canvas.addEventListener("dblclick",function(e){this.mouse_button=0,this.mouse_drag_x=e.offsetX||e.layerX||e.x,this.mouse_drag_y=e.offsetY||e.layerY||e.y,this.mouse_dragging=!1,this.parent.doc.onDoubleClick(i.gl,this.mouse_drag_x,this.mouse_drag_y),this.parent.doc.needRender=!0,window.status=this.id+" DBL: "+(e.offsetX||e.layerX||e.x)+", "+(e.offsetY||e.layerY||e.y),e.returnValue=!0},!1),this.canvas.addEventListener("mousemove",function(e){e.shiftKey&&(this.mouse_button=1),e.ctrlKey&&(this.mouse_button=4),e.altKey&&(this.mouse_button=2),this.isMulti||(this.mouse_drag_x=e.offsetX||e.layerX||e.x,this.mouse_drag_y=e.offsetY||e.layerY||e.y,this.mouse_dragging?this.parent.doc.onDrag(i.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button):this.parent.doc.onMove(i.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button)),this.parent.doc.needRender=!0,e.returnValue=!0},!1),this.canvas.addEventListener("DOMMouseScroll",function(e){this.mouse_drag_y+=2*e.detail,this.parent.doc.onDrag(i.gl,this.mouse_drag_x,this.mouse_drag_y,2),this.parent.doc.needRender=!0,window.status=this.id+" SCROLL: "+e.detail,e.returnValue=!0},!1),this.canvas.addEventListener("mousewheel",function(e){this.mouse_drag_y-=.1*e.wheelDeltaY,this.parent.doc.onDrag(i.gl,this.mouse_drag_x,this.mouse_drag_y,2),this.parent.doc.needRender=!0,window.status=this.id+" SCROLL: "+e.detail,e.returnValue=!0},!1),this.canvas.addEventListener("keypress",function(e){var t=this.parent.x3dElem.getAttribute("keysEnabled");t&&"true"!==t.toLowerCase()||this.parent.doc.onKeyPress(e.charCode),this.parent.doc.needRender=!0,e.returnValue=!0},!0),this.canvas.addEventListener("keyup",function(e){var t=this.parent.x3dElem.getAttribute("keysEnabled");t&&"true"!==t.toLowerCase()||this.parent.doc.onKeyUp(e.keyCode),this.parent.doc.needRender=!0,e.returnValue=!0},!0),this.canvas.addEventListener("keydown",function(e){var t=this.parent.x3dElem.getAttribute("keysEnabled");t&&"true"!==t.toLowerCase()||this.parent.doc.onKeyDown(e.keyCode),this.parent.doc.needRender=!0,e.returnValue=!0},!0);var n={numTouches:0,lastDrag:new x3dom.fields.SFVec2f,lastMiddle:new x3dom.fields.SFVec2f,lastDistance:new x3dom.fields.SFVec2f,lastSquareDistance:0,lastAngle:0,calcAngle:function(e){var t=e.normalize().dot(new x3dom.fields.SFVec2f(1,0));return t=Math.acos(t),e.y<0&&(t=Math.PI+(Math.PI-t)),t}},r=[],a={touches:[],preventDefault:function(){}},d=function(e){if(e.preventDefault(),n.numTouches<1&&1==e.touches.length)n.numTouches=1,n.lastDrag=new x3dom.fields.SFVec2f(e.touches[0].screenX,e.touches[0].screenY);else if(n.numTouches<2&&e.touches.length>=2){n.numTouches=2;var t=new x3dom.fields.SFVec2f(e.touches[0].screenX,e.touches[0].screenY),i=new x3dom.fields.SFVec2f(e.touches[1].screenX,e.touches[1].screenY),o=i.subtract(t),s=o.multiply(.5).add(t),r=o.dot(o);n.lastDistance=o,n.lastMiddle=s,n.lastSquareDistance=r,n.lastAngle=n.calcAngle(o)}},h=function(e){e.preventDefault();for(var t=!0,i=0;i<r.length;++i)r[i]==e.streamId&&(t=!1);1==t&&(e.identifier=e.streamId,r.push(e.streamId),a.touches.push(e)),d(a)},l=function(e,t){if(e.preventDefault(),1==e.touches.length){var o=new x3dom.fields.SFVec2f(e.touches[0].screenX,e.touches[0].screenY),s=o.subtract(n.lastDrag);n.lastDrag=o;var r=x3dom.fields.SFMatrix4f.rotationY(s.x/100),a=x3dom.fields.SFMatrix4f.rotationX(s.y/100),d=r.mult(a);t.onMoveView(i.gl,null,d),t.needRender=!0}else if(e.touches.length>=2){var h=new x3dom.fields.SFVec2f(e.touches[0].screenX,e.touches[0].screenY),l=new x3dom.fields.SFVec2f(e.touches[1].screenX,e.touches[1].screenY),_=l.subtract(h),f=_.multiply(.5).add(h),u=_.dot(_),c=f.subtract(n.lastMiddle),m=u-n.lastSquareDistance,p=new x3dom.fields.SFVec3f(c.x/500,-c.y/500,m/1e5),g=n.calcAngle(_),x=n.lastAngle-g;n.lastAngle=g;var d=x3dom.fields.SFMatrix4f.rotationZ(x);n.lastMiddle=f,n.lastDistance=_,n.lastSquareDistance=u,t.onMoveView(i.gl,p,d),t.needRender=!0}};touchMoveHandlerW3C=function(e){l(e,this.parent.doc)};var _=function(e){e.preventDefault();for(var t=0;t<r.length;++t)r[t]==e.streamId&&(a.touches[t]=e);l(a,e.view.myThat.doc)},f=function(e){e.preventDefault(),2==n.numTouches&&1==e.touches.length&&(n.lastDrag=new x3dom.fields.SFVec2f(e.touches[0].screenX,e.touches[0].screenY)),e.touches.length<2&&(n.numTouches=e.touches.length)},u=function(e){e.preventDefault();for(var t=-1,i=0;i<r.length;++i)r[i]==e.streamId&&(t=i);-1!=t&&(r.splice(t,1),a.touches.splice(t,1)),f(a)};this.canvas.addEventListener("MozTouchDown",h,!0),this.canvas.addEventListener("MozTouchMove",_,!0),this.canvas.addEventListener("MozTouchUp",u,!0),this.canvas.addEventListener("touchstart",d,!0),this.canvas.addEventListener("touchmove",touchMoveHandlerW3C,!0),this.canvas.addEventListener("touchend",f,!0)}},x3dom.X3DCanvas.prototype.tick=function(){var e=(new Date).getTime(),t=1e3/(e-this.fps_t0);this.fps_t0=e;try{this.doc.advanceTime(e/1e3);var i=(new Date).getTime()-e;this.doc.needRender&&(1==this.x3dElem.runtime.isReady?this.x3dElem.runtime.enterFrame():(this.x3dElem.runtime.ready(),this.x3dElem.runtime.isReady=!0,this.x3dElem.runtime.enterFrame()),this.statDiv&&(this.statDiv.textContent=t.toFixed(2)+" fps",this.statDiv.appendChild(document.createElement("br")),this.statDiv.appendChild(document.createTextNode("anim: "+i))),"flash"==this.backend?this.isFlashReady&&(this.canvas.setFPS({fps:t}),this.doc.needRender=!1,this.doc.render(this.gl)):(this.doc.needRender=!1,this.doc.render(this.gl))),(this.statDiv||this.progressDiv)&&(this.statDiv&&this.doc.downloadCount&&(this.doc.needRender?(this.statDiv.appendChild(document.createElement("br")),this.statDiv.appendChild(document.createTextNode("#Loading: "+this.doc.downloadCount))):this.statDiv.textContent="#Loading: "+this.doc.downloadCount),this.progressDiv&&(this.progressDiv.childNodes[0].textContent="Loading: "+this.doc.downloadCount,this.progressDiv.style.display=this.doc.downloadCount>0?"inline":"none",window.myThat=this,window.myStopProgress=function(){window.myThat.doc.downloadCount=0,window.myThat.progressDiv.style.display="none"},window.setTimeout("window.myStopProgress()",1500)))}catch(o){throw x3dom.debug.logException(o),o}},x3dom.X3DCanvas.prototype.load=function(e,t,i){this.doc=new x3dom.X3DDocument(this.canvas,this.gl,i);var o=this;this.doc.onload=function(){x3dom.debug.logInfo("loaded '"+e+"'"),o.hasRuntime?!function t(){o.watchForResize(),o.tick(),window.requestAnimFrame(t,o)}():o.tick()},this.x3dElem.render=function(){o.hasRuntime?o.doc.needRender=!0:o.doc.render(o.gl)},this.x3dElem.context=o.gl.ctx3d,this.doc.onerror=function(){alert("Failed to load X3D document")},this.doc.load(e,t)},x3dom.runtime={},x3dom.Runtime=function(e,t){this.doc=e,this.canvas=t,this.isReady=!1},x3dom.Runtime.prototype.initialize=function(e,t){this.doc=e,this.canvas=t,this.config={},this.isReady=!1},x3dom.Runtime.prototype.ready=function(){x3dom.debug.logInfo("System ready.")},x3dom.Runtime.prototype.enterFrame=function(){},x3dom.Runtime.prototype.getActiveBindable=function(e){var t,i,o,s,n;if(t=this.canvas.doc._bindableBag._stacks,s=[],n=x3dom.nodeTypesLC[e.toLowerCase()],!n)return x3dom.debug.logError('No node of type "'+e+'" found'),null;for(i=0;i<t.length;i++)o=t[i].getActive(),void 0!==o._xmlNode&&x3dom.isa(o,n)&&s.push(o);return s[0]?s[0]._xmlNode:null},x3dom.Runtime.prototype.nextView=function(){var e=this.canvas.doc._scene.getViewpoint()._stack;e?e.switchTo("next"):x3dom.debug.logError("No valid ViewBindable stack.")},x3dom.Runtime.prototype.prevView=function(){var e=this.canvas.doc._scene.getViewpoint()._stack;e?e.switchTo("prev"):x3dom.debug.logError("No valid ViewBindable stack.")},x3dom.Runtime.prototype.viewpoint=function(){return this.canvas.doc._scene.getViewpoint()},x3dom.Runtime.prototype.pojectionMatrix=function(){return this.canvas.doc._viewarea.getProjectionMatrix()},x3dom.Runtime.prototype.lightMatrix=function(){this.canvas.doc._viewarea.getLightMatrix()},x3dom.Runtime.prototype.resetView=function(){this.canvas.doc._viewarea.resetView()},x3dom.Runtime.prototype.lightView=function(){return this.canvas.doc._nodeBag.lights.length>0?(this.canvas.doc._viewarea.animateTo(this.canvas.doc._viewarea.getLightMatrix()[0],this.canvas.doc._scene.getViewpoint()),!0):(x3dom.debug.logInfo("No lights to navigate to"),!1)},x3dom.Runtime.prototype.uprightView=function(){this.canvas.doc._viewarea.uprightView()},x3dom.Runtime.prototype.showAll=function(){this.canvas.doc._viewarea.showAll()},x3dom.Runtime.prototype.debug=function(e){return e===!0&&(this.canvas.doc._viewarea._visDbgBuf=!0,x3dom.debug.logContainer.style.display="block",this.canvas.doc.needRender=!0),e===!1&&(this.canvas.doc._viewarea._visDbgBuf=!1,x3dom.debug.logContainer.style.display="none",this.canvas.doc.needRender=!0),this.canvas.doc._viewarea._visDbgBuf},x3dom.Runtime.prototype.navigationType=function(){return this.canvas.doc._scene.getNavigationInfo().getType()},x3dom.Runtime.prototype.examine=function(){this.canvas.doc._scene.getNavigationInfo().setType("examine")},x3dom.Runtime.prototype.fly=function(){this.canvas.doc._scene.getNavigationInfo().setType("fly")},x3dom.Runtime.prototype.lookAt=function(){this.canvas.doc._scene.getNavigationInfo().setType("lookat")},x3dom.Runtime.prototype.lookAround=function(){this.canvas.doc._scene.getNavigationInfo().setType("lookaround")},x3dom.Runtime.prototype.walk=function(){this.canvas.doc._scene.getNavigationInfo().setType("walk")},x3dom.Runtime.prototype.game=function(){this.canvas.doc._scene.getNavigationInfo().setType("game")},x3dom.Runtime.prototype.togglePoints=function(){this.canvas.doc._viewarea._points=!this.canvas.doc._viewarea._points,this.canvas.doc.needRender=!0},x3dom.Runtime.prototype.pickMode=function(e){return e&&e.internal===!0?this.canvas.doc._scene._vf.pickMode:this.canvas.doc._scene._vf.pickMode.toLowerCase()},x3dom.Runtime.prototype.changePickMode=function(e){switch(e=e.toLowerCase()){case"idbuf":e="idBuf";break;case"textcoord":e="textCoord";break;case"color":e="color";break;case"box":e="box";break;default:x3dom.debug.logWarning("Switch pickMode to "+e+"unknown intersect type"),e=void 0}return void 0!==e?(this.canvas.doc._scene._vf.pickMode=e,x3dom.debug.logInfo("Switched pickMode to '"+e+"'."),!1):!0},x3dom.Runtime.prototype.speed=function(e){return e&&(this.canvas.doc._scene.getNavigationInfo()._vf.speed=e,x3dom.debug.logInfo("Changed navigation speed to "+this.canvas.doc._scene.getNavigationInfo()._vf.speed)),this.canvas.doc._scene.getNavigationInfo()._vf.speed},x3dom.Runtime.prototype.statistics=function(e){var t=this.canvas.statDiv;return t?e===!0?(t.style.display="inline",!0):e===!1?(t.style.display="none",!1):"none"!=t.style.display:void 0},x3dom.Runtime.prototype.processIndicator=function(e){var t=this.canvas.processDiv;return t?e===!0?(t.style.display="inline",!0):e===!1?(t.style.display="none",!1):"none"!=t.style.display:void 0},x3dom.Runtime.prototype.properties=function(){return this.canvas.doc.properties},x3dom.Runtime.prototype.backendName=function(){return this.canvas.backend},x3dom.detectActiveX=function(){var e=!1;if(window.ActiveXObject){var t=null;try{t=new ActiveXObject("AVALONATX.InstantPluginATXCtrl.1")}catch(i){}t&&(e=!0)}return e},x3dom.rerouteSetAttribute=function(e,t){e._setAttribute=e.setAttribute,e.setAttribute=function(i,o){var s=e.getAttribute("_x3domNode"),n=t.findNode(s);return n?n.parseField(i,o):0};for(var i=0;i<e.childNodes.length;i++){var o=e.childNodes[i];x3dom.rerouteSetAttribute(o,t)}},x3dom.insertActiveX=function(e){"undefined"==typeof x3dom.atxCtrlCounter&&(x3dom.atxCtrlCounter=0);var t=e.getAttribute("height"),i=e.getAttribute("width"),o=e.parentNode,s=document.createElement("div");s.setAttribute("id","x3dplaceholder");var n=o.insertBefore(s,e),r=document.createElement("div");r.style.display="none",o.appendChild(r),o.removeChild(e),r.appendChild(e);var a=document.createElement("object"),d="Avalon"+x3dom.atxCtrlCounter;x3dom.atxCtrlCounter++,a.setAttribute("id",d),a.setAttribute("classid","CLSID:F3254BA0-99FF-4D14-BD81-EDA9873A471E"),a.setAttribute("width",i?i:"500"),a.setAttribute("height",t?t:"500"),n.appendChild(a);var h=document.getElementById(d),l=h.getBrowser(),_=l.importDocument(e);l.replaceWorld(_),e.getBrowser=function(){return h.getBrowser()},x3dom.rerouteSetAttribute(e,l)},x3dom.userAgentFeature={supportsDOMAttrModified:!1},function(){var e=function(){var e,t,i,o,s,n=document.getElementsByTagName("X3D"),r=document.getElementsByTagName("webSG"),a=new x3dom.Properties,d=array_to_object(["showLog","showStat","showProgress","PrimitiveQuality","component","loadpath","disableDoubleClick","disableRightDrag","maxActiveDownloads"]);for(e=0;e<n.length;e++){for(a.setProperty("showLog",n[e].getAttribute("showLog")||"false"),a.setProperty("showStat",n[e].getAttribute("showStat")||"false"),a.setProperty("showProgress",n[e].getAttribute("showProgress")||"true"),a.setProperty("PrimitiveQuality",n[e].getAttribute("PrimitiveQuality")||"High"),i=n[e].getElementsByTagName("PARAM"),t=0;t<i.length;t++)i[t].getAttribute("name")in d&&a.setProperty(i[t].getAttribute("name"),i[t].getAttribute("value"));if(x3dom.debug.activate("true"===a.getProperty("showLog")?!0:!1),"undefined"!=typeof X3DOM_SECURITY_OFF&&X3DOM_SECURITY_OFF===!0&&(o=a.getProperty("components",n[e].getAttribute("components"))))for(s=a.getProperty("loadpath",n[e].getAttribute("loadpath")),o=o.trim().split(","),t=0;t<o.length;t++)x3dom.loadJS(o[t]+".js",s);if("undefined"!=typeof X3DOM_SECURITY_OFF&&X3DOM_SECURITY_OFF===!0&&n[e].getAttribute("src")){var h=document.createElement("scene"),l=document.createElement("Inline");l.setAttribute("url",n[e].getAttribute("src")),h.appendChild(l),n[e].appendChild(h)}}for(window.navigator.userAgent.match(/webkit/i)&&(x3dom.debug.logInfo("Active DOMAttrModifiedEvent workaround for webkit "),x3dom.userAgentFeature.supportsDOMAttrModified=!1),n=Array.map(n,function(e){return e.runtime=new x3dom.Runtime,e.hasRuntime=!0,e}),r=Array.map(r,function(e){return e.hasRuntime=!1,e}),e=0;e<r.length;e++)n.push(r[e]);void 0!==x3dom.versionInfo&&x3dom.debug.logInfo("X3Dom Version "+x3dom.versionInfo.version+", Revison "+x3dom.versionInfo.revision+", Date "+x3dom.versionInfo.date),x3dom.debug.logInfo("Found "+(n.length-r.length)+" X3D and "+r.length+" (experimental) WebSG nodes...");var _,f,u,c,m,p,g,x,v;for(e=0;e<n.length;e++)_=n[e],x3dom.detectActiveX()?x3dom.insertActiveX(_):(f=new x3dom.X3DCanvas(_,e),null!==f.gl?(x=(new Date).getTime(),n[e].runtime=new x3dom.Runtime(n[e],f),n[e].runtime.initialize(n[e],f),x3dom.runtime.ready&&(n[e].runtime.ready=x3dom.runtime.ready),f.load(n[e],e,a),n[e].runtime.statistics("true"===a.getProperty("showStat")?!0:!1),"true"===a.getProperty("showProgress")?("bar"===a.getProperty("showProgress")&&f.progressDiv.setAttribute("class","x3dom-progress bar"),n[e].runtime.processIndicator(!0)):n[e].runtime.processIndicator(!1),x3dom.canvases.push(f),v=(new Date).getTime()-x,x3dom.debug.logInfo("Time for setup and init of GL element no. "+e+": "+v+" ms.")):(u=document.createElement("div"),u.setAttribute("class","x3dom-nox3d"),c=document.createElement("p"),c.appendChild(document.createTextNode("WebGL is not yet supported in your browser. ")),m=document.createElement("a"),m.setAttribute("href","http://www.x3dom.org/?page_id=9"),m.appendChild(document.createTextNode("Follow link for a list of supported browsers... ")),u.appendChild(c),u.appendChild(m),f.x3dElem.appendChild(u),f.statDiv&&_.removeChild(f.statDiv),p=n[e].getAttribute("altImg")||null,p&&(g=new Image,g.src=p,_.style.backgroundImage="url("+p+")")));!function(e){var t=null;document.createEvent?(t=document.createEvent("Events"),t.initEvent(e,!0,!0),document.dispatchEvent(t)):document.createEventObject&&(t=document.createEventObject(),document.body.fireEvent("on"+e,t))}("load")},t=function(){for(var e=0;e<x3dom.canvases.length;e++)x3dom.canvases[e].doc.shutdown(x3dom.canvases[e].gl)};window.location.pathname.lastIndexOf(".xhtml")>0&&(document.__getElementById=document.getElementById,document.getElementById=function(e){var t=this.__getElementById(e);if(!t)for(var i=this.getElementsByTagName("*"),o=0;o<i.length&&!t;o++)i[o].getAttribute("id")===e&&(t=i[o]);return t}),window.addEventListener?(window.addEventListener("load",e,!1),window.addEventListener("unload",t,!1),window.addEventListener("reload",t,!1)):window.attachEvent&&(window.attachEvent("onload",e),window.attachEvent("onunload",t),window.attachEvent("onreload",t))}(),x3dom.gfx_webgl=function(){function e(e,t,i){this.ctx3d=e,this.canvas=t,this.name=i,this.cached_shader_programs={},this.cached_shaders={}}function t(t){for(var i=["moz-webgl","webkit-3d","experimental-webgl","webgl"],o=null,s={alpha:!0,depth:!0,stencil:!0,antialias:!0,premultipliedAlpha:!1},n=0;n<i.length;n++)try{if(o=t.getContext(i[n],s)){var r=new e(o,t,"webgl");try{o.getString?x3dom.debug.logInfo("\nVendor: "+o.getString(o.VENDOR)+", Renderer: "+o.getString(o.RENDERER)+", Version: "+o.getString(o.VERSION)+", ShadingLangV.: "+o.getString(o.SHADING_LANGUAGE_VERSION)+", \nExtensions: "+o.getString(o.EXTENSIONS)):(x3dom.debug.logInfo("\nVendor: "+o.getParameter(o.VENDOR)+", Renderer: "+o.getParameter(o.RENDERER)+", Version: "+o.getParameter(o.VERSION)+", ShadingLangV.: "+o.getParameter(o.SHADING_LANGUAGE_VERSION)),x3dom.caps.VENDOR=o.getParameter(o.VENDOR),x3dom.caps.VERSION=o.getParameter(o.VERSION),x3dom.caps.RENDERER=o.getParameter(o.RENDERER),x3dom.caps.SHADING_LANGUAGE_VERSION=o.getParameter(o.SHADING_LANGUAGE_VERSION),x3dom.caps.RED_BITS=o.getParameter(o.RED_BITS),x3dom.caps.GREEN_BITS=o.getParameter(o.GREEN_BITS),x3dom.caps.BLUE_BITS=o.getParameter(o.BLUE_BITS),x3dom.caps.ALPHA_BITS=o.getParameter(o.ALPHA_BITS),x3dom.caps.MAX_VERTEX_ATTRIBS=o.getParameter(o.MAX_VERTEX_ATTRIBS),x3dom.caps.MAX_VERTEX_TEXTURE_IMAGE_UNITS=o.getParameter(o.MAX_VERTEX_TEXTURE_IMAGE_UNITS),x3dom.caps.MAX_VARYING_VECTORS=o.getParameter(o.MAX_VARYING_VECTORS),x3dom.caps.MAX_VERTEX_UNIFORM_VECTORS=o.getParameter(o.MAX_VERTEX_UNIFORM_VECTORS),x3dom.caps.MAX_COMBINED_TEXTURE_IMAGE_UNITS=o.getParameter(o.MAX_COMBINED_TEXTURE_IMAGE_UNITS),x3dom.caps.MAX_TEXTURE_SIZE=o.getParameter(o.MAX_TEXTURE_SIZE),x3dom.caps.MAX_CUBE_MAP_TEXTURE_SIZE=o.getParameter(o.MAX_CUBE_MAP_TEXTURE_SIZE),x3dom.caps.NUM_COMPRESSED_TEXTURE_FORMATS=o.getParameter(o.NUM_COMPRESSED_TEXTURE_FORMATS),x3dom.caps.MAX_RENDERBUFFER_SIZE=o.getParameter(o.MAX_RENDERBUFFER_SIZE),x3dom.caps.MAX_VIEWPORT_DIMS=o.getParameter(o.MAX_VIEWPORT_DIMS),x3dom.caps.ALIASED_LINE_WIDTH_RANGE=o.getParameter(o.ALIASED_LINE_WIDTH_RANGE),x3dom.caps.ALIASED_POINT_SIZE_RANGE=o.getParameter(o.ALIASED_POINT_SIZE_RANGE),x3dom.caps.EXTENSIONS=o.getSupportedExtensions(),x3dom.caps.MOBILE=function(e){return/android.+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|e\-|e\/|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(di|rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|xda(\-|2|g)|yas\-|your|zeto|zte\-/i.test(e.substr(0,4))?!0:!1
}(navigator.userAgent||navigator.vendor||window.opera),x3dom.caps.MOBILE&&x3dom.debug.logWarning("Detect mobile Browser! Using low quality shaders!"))}catch(a){x3dom.debug.logWarning("Your browser probably supports an older WebGL version. Please try the mobile runtime instead:\nhttp://www.x3dom.org/x3dom/src_mobile/x3dom.js")}return r}}catch(d){}return null}function i(e,t){var i=e.createProgram(),o=e.createShader(e.VERTEX_SHADER),s=e.createShader(e.FRAGMENT_SHADER);e.shaderSource(o,d["vs-x3d-"+t].data),e.shaderSource(s,d["fs-x3d-"+t].data),e.compileShader(o),e.getShaderParameter(o,e.COMPILE_STATUS)||x3dom.debug.logError("VertexShader "+e.getShaderInfoLog(o)),e.compileShader(s),e.getShaderParameter(s,e.COMPILE_STATUS)||x3dom.debug.logError("FragmentShader "+e.getShaderInfoLog(s)),e.attachShader(i,o),e.attachShader(i,s),e.linkProgram(i);var n=e.getProgramInfoLog(i);return n&&x3dom.debug.logError(n),r(e,i)}function o(e){if(!s(e.width)||!s(e.height)){var t=document.createElement("canvas");t.width=n(e.width),t.height=n(e.height);var i=t.getContext("2d");i.drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),e=t}return e}function s(e){return 0===(e&e-1)}function n(e){--e;for(var t=1;32>t;t<<=1)e|=e>>t;return e+1}function r(e,t){var i={};i.bind=function(){e.useProgram(t)};var o,s=null,n=null,r=0,a=e.getProgramParameter(t,e.ACTIVE_UNIFORMS);for(r=0;a>r;++r){try{n=e.getActiveUniform(t,r)}catch(d){}o=e.getError(),0!==o&&x3dom.debug.logError("GL-Error: "+o),s=e.getUniformLocation(t,n.name);var h=n.name;switch(n.name.lastIndexOf("[0]")==n.name.length-3&&(x3dom.debug.logInfo(n.name),h=n.name.substr(0,n.name.length-3)),n.type){case e.SAMPLER_2D:i.__defineSetter__(h,function(t){return function(i){e.uniform1i(t,i)}}(s));break;case e.SAMPLER_CUBE:i.__defineSetter__(h,function(t){return function(i){e.uniform1i(t,i)}}(s));break;case e.BOOL:i.__defineSetter__(h,function(t){return function(i){e.uniform1i(t,i)}}(s));break;case e.FLOAT:i.__defineSetter__(h,function(t){return function(i){e.uniform1f(t,i)}}(s));break;case e.FLOAT_VEC2:i.__defineSetter__(h,function(t){return function(i){e.uniform2f(t,i[0],i[1])}}(s));break;case e.FLOAT_VEC3:i.__defineSetter__(h,function(t){return function(i){e.uniform3f(t,i[0],i[1],i[2])}}(s));break;case e.FLOAT_VEC4:i.__defineSetter__(h,function(t){return function(i){e.uniform4f(t,i[0],i[1],i[2],i[3])}}(s));break;case e.FLOAT_MAT2:i.__defineSetter__(h,function(t){return function(i){e.uniformMatrix2fv(t,!1,new Float32Array(i))}}(s));break;case e.FLOAT_MAT3:i.__defineSetter__(h,function(t){return function(i){e.uniformMatrix3fv(t,!1,new Float32Array(i))}}(s));break;case e.FLOAT_MAT4:i.__defineSetter__(h,function(t){return function(i){e.uniformMatrix4fv(t,!1,new Float32Array(i))}}(s));break;case e.INT:i.__defineSetter__(h,function(t){return function(i){e.uniform1i(t,i)}}(s));break;default:x3dom.debug.logWarning("GLSL program variable "+n.name+" has unknown type "+n.type)}}var l=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES);for(r=0;l>r;++r){try{n=e.getActiveAttrib(t,r)}catch(_){}o=e.getError(),0!==o&&x3dom.debug.logError("GL-Error: "+o),s=e.getAttribLocation(t,n.name),i[n.name]=s}return i}function a(e){var t=[0,!1],i=e.getLights(),o=i.length;o>0&&(t[0]=o>8?8:o);for(var s=0;o>s;s++)i[s]._vf.shadowIntensity>0&&(t[1]=!0);var n=e._scene.getNavigationInfo();return n._vf.headlight&&(t[0]+=1),t}e.prototype.getName=function(){return this.name};var d={};return d["vs-x3d-bg-texture"]={type:"vertex",data:"attribute vec3 position;varying vec2 fragTexCoord;void main(void) {    vec2 texCoord = (position.xy + 1.0) * 0.5;    fragTexCoord = texCoord;    gl_Position = vec4(position.xy, 0.0, 1.0);}"},d["vs-x3d-bg-texture-bgnd"]={type:"vertex",data:"attribute vec3 position;attribute vec2 texcoord;uniform mat4 modelViewProjectionMatrix;varying vec2 fragTexCoord;void main(void) {    fragTexCoord = texcoord.xy;    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);}"},d["fs-x3d-bg-texture"]={type:"fragment",data:"#ifdef GL_ES             \n  precision highp float; \n#endif                   \n\nuniform sampler2D tex;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    gl_FragColor = texture2D(tex, fragTexCoord);\n}"},d["vs-x3d-bg-textureCube"]={type:"vertex",data:"attribute vec3 position;uniform mat4 modelViewProjectionMatrix;varying vec3 fragNormal;void main(void) {    fragNormal = (vec4(normalize(position), 0.0)).xyz;    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);}"},d["fs-x3d-bg-textureCube"]={type:"fragment",data:"#ifdef GL_ES             \n  precision highp float; \n#endif                   \n\nuniform samplerCube tex;varying vec3 fragNormal;void main(void) {    vec3 normal = -reflect(normalize(fragNormal), vec3(0.0,0.0,1.0));    if (abs(normal.y) >= abs(normal.x) && abs(normal.y) >= abs(normal.z))        normal.x *= -1.0;    gl_FragColor = textureCube(tex, normal);}"},d["vs-x3d-vertexcolorUnlit"]={type:"vertex",data:"attribute vec3 position;attribute vec3 color;varying vec3 fragColor;uniform mat4 modelViewProjectionMatrix;void main(void) {    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);    gl_PointSize = 2.0;    fragColor = color;}"},d["fs-x3d-vertexcolorUnlit"]={type:"fragment",data:"#ifdef GL_ES             \n  precision highp float; \n#endif                   \n\nuniform vec3 diffuseColor;uniform float alpha;uniform float lightOn;varying vec3 fragColor;void main(void) {    gl_FragColor = vec4(fragColor, alpha);}"},d["vs-x3d-default"]={type:"vertex",data:"attribute vec3 position;uniform mat4 modelViewProjectionMatrix;void main(void) {    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);}"},d["fs-x3d-default"]={type:"fragment",data:"#ifdef GL_ES             \n  precision highp float; \n#endif                   \n\nstruct Material {   vec3  diffuseColor;   vec3  specularColor;   vec3  emissiveColor;   float shininess;   float transparency;   float ambientIntensity;};uniform Material material;void main(void) {    gl_FragColor = vec4(material.emissiveColor, 1.0);}"},d["vs-x3d-texcoordUnlit"]={type:"vertex",data:"attribute vec3 position;attribute vec2 texcoord;varying vec3 fragColor;uniform mat4 modelViewProjectionMatrix;void main(void) {    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);    fragColor = vec3(abs(texcoord.x), abs(texcoord.y), 0.0);}"},d["fs-x3d-texcoordUnlit"]={type:"fragment",data:"#ifdef GL_ES             \n  precision highp float; \n#endif                   \n\nuniform float alpha;varying vec3 fragColor;void main(void) {    gl_FragColor = vec4(fragColor, alpha);}"},d["vs-x3d-pick"]={type:"vertex",data:"attribute vec3 position;uniform mat4 modelMatrix;uniform mat4 modelViewProjectionMatrix;uniform vec3 wcMin;uniform vec3 wcMax;varying vec3 worldCoord;void main(void) {    worldCoord = (modelMatrix * vec4(position, 1.0)).xyz;    vec3 dia = wcMax - wcMin;    worldCoord = worldCoord - wcMin;    worldCoord.x /= dia.x;    worldCoord.y /= dia.y;    worldCoord.z /= dia.z;    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);}"},d["vs-x3d-pickIG"]={type:"vertex",data:"attribute vec3 position;uniform mat4 modelMatrix;uniform mat4 modelViewProjectionMatrix;uniform vec3 wcMin;uniform vec3 wcMax;varying vec3 worldCoord;uniform float indexed;uniform float imageGeometry;uniform vec3 IG_bboxMin;uniform vec3 IG_bboxMax;uniform float IG_coordTextureWidth;uniform float IG_coordTextureHeight;uniform float IG_indexTextureWidth;uniform float IG_indexTextureHeight;uniform sampler2D IG_indexTexture;uniform sampler2D IG_coordinateTexture;void main(void) {  if(imageGeometry == 1.0) {   vec2 IG_texCoord;  if(indexed == 1.0) {   vec2 halfPixel = vec2(0.5/IG_indexTextureWidth,0.5/IG_indexTextureHeight);   IG_texCoord = vec2(position.x*(256.0/IG_indexTextureWidth), position.y*(256.0/IG_indexTextureHeight)) + halfPixel;   vec2 IG_index = texture2D( IG_indexTexture, IG_texCoord ).rg;   IG_texCoord = IG_index * 0.996108948;  } else {    vec2 halfPixel = vec2(0.5/IG_coordTextureWidth, 0.5/IG_coordTextureHeight);   IG_texCoord = vec2(position.x*(256.0/IG_coordTextureWidth), position.y*(256.0/IG_coordTextureHeight)) + halfPixel;  }  vec3 pos = texture2D( IG_coordinateTexture, IG_texCoord ).rgb;   pos = pos * (IG_bboxMax - IG_bboxMin) + IG_bboxMin;     worldCoord = (modelMatrix * vec4(pos, 1.0)).xyz;  gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);  } else {      worldCoord = (modelMatrix * vec4(position, 1.0)).xyz;  gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);  }    vec3 dia = wcMax - wcMin;    worldCoord = worldCoord - wcMin;    worldCoord.x /= dia.x;    worldCoord.y /= dia.y;    worldCoord.z /= dia.z;}"},d["fs-x3d-pick"]={type:"fragment",data:"#ifdef GL_ES             \n  precision highp float; \n#endif                   \n\nuniform float alpha;varying vec3 worldCoord;void main(void) {    gl_FragColor = vec4(worldCoord, alpha);}"},d["vs-x3d-shadow"]={type:"vertex",data:"attribute vec3 position;uniform mat4 modelViewProjectionMatrix;varying vec4 projCoord;void main(void) {   projCoord = modelViewProjectionMatrix * vec4(position, 1.0);   gl_Position = projCoord;}"},d["fs-x3d-shadow"]={type:"fragment",data:"#ifdef GL_ES             \n  precision highp float; \n#endif                   \n\nvarying vec4 projCoord;void main(void) {    vec3 proj = (projCoord.xyz / projCoord.w);    vec4 outVal = vec4(0.0);    float toFixed = 255.0 / 256.0;    outVal.r = fract(proj.z * toFixed);    outVal.g = fract(proj.z * toFixed * 255.0);    outVal.b = fract(proj.z * toFixed * 255.0 * 255.0);    outVal.a = fract(proj.z * toFixed * 255.0 * 255.0 * 255.0);    gl_FragColor = outVal;}"},e.prototype.getShaderProgram=function(e,t){var i=[],o=null;if(this.cached_shader_programs[t[0]+t[1]])o=this.cached_shader_programs[t[0]+t[1]];else{for(var s=0;2>s;s++){if(!d[t[s]])return void x3dom.debug.logError("Cannot find shader "+t[s]);if(this.cached_shaders[t[s]])i[s]=this.cached_shaders[t[s]];else{if("vertex"==d[t[s]].type)i[s]=e.createShader(e.VERTEX_SHADER);else{if("fragment"!=d[t[s]].type)return void x3dom.debug.logError("Invalid shader type "+d[s].type);i[s]=e.createShader(e.FRAGMENT_SHADER)}e.shaderSource(i[s],d[t[s]].data),e.compileShader(i[s]),e.getShaderParameter(i[s],e.COMPILE_STATUS)||x3dom.debug.logError(0==s?"VertexShader "+e.getShaderInfoLog(i[s]):"FragmentShader "+e.getShaderInfoLog(i[s])),this.cached_shaders[t[s]]=i[s]}}o=e.createProgram(),e.attachShader(o,i[0]),e.attachShader(o,i[1]),e.linkProgram(o);var n=e.getProgramInfoLog(o);n&&x3dom.debug.logError(n),this.cached_shader_programs[t[0]+t[1]]=r(e,o),o=this.cached_shader_programs[t[0]+t[1]]}return o},e.prototype.generateVSMobile=function(e,t){var i=t._cf.appearance.node._cf.texture.node||x3dom.isa(t._cf.geometry.node,x3dom.nodeTypes.Text)?1:0,o=null!==t._cf.appearance.node._cf.textureTransform.node?1:0,s=void 0!==t._cf.geometry.node._cf.texCoord&&null!==t._cf.geometry.node._cf.texCoord.node&&t._cf.geometry.node._cf.texCoord.node._vf.mode&&"sphere"==t._cf.geometry.node._cf.texCoord.node._vf.mode.toLowerCase()?1:0,n=t._cf.appearance.node._cf.texture.node&&x3dom.isa(t._cf.appearance.node._cf.texture.node,x3dom.nodeTypes.X3DEnvironmentTextureNode)?1:0,r=x3dom.isa(t._cf.geometry.node,x3dom.nodeTypes.Text)||n||t._cf.appearance.node._cf.texture.node&&(1==t._cf.appearance.node._cf.texture.node._vf.origChannelCount||2==t._cf.appearance.node._cf.texture.node._vf.origChannelCount)?1:0,a=t._cf.geometry.node._mesh._colors[0].length>0||t._cf.geometry.node.getColorTexture()?t._cf.geometry.node._mesh._numColComponents:0,h=e.getLights().length+e._scene.getNavigationInfo()._vf.headlight,l=t.isSolid()?1:0,_=e._scene.getFog()._vf.visibilityRange>0?1:0,f=x3dom.isa(t._cf.geometry.node,x3dom.nodeTypes.ImageGeometry)?1:0,u=f?t._cf.geometry.node.numCoordinateTextures():0,c=f&&null!=t._cf.geometry.node.getIndexTexture()?1:0,m="vs-x3d-mobil-"+a+i+o+s+r+n+l+_+h+f+u+c;if(!d[m]){var p="";if(p+="attribute vec3 position;\n",p+="attribute vec3 normal;\n",p+="uniform mat4 modelViewMatrix;\n",p+="uniform mat4 normalMatrix;\n",p+="uniform mat4 modelViewProjectionMatrix;\n",p+="uniform vec3  diffuseColor;\n",p+="uniform vec3  specularColor;\n",p+="uniform vec3  emissiveColor;\n",p+="uniform float shininess;\n",p+="uniform float transparency;\n",p+="uniform float ambientIntensity;\n",p+="varying vec4 fragColor;\n",f){p+="uniform vec3 IG_bboxMin;",p+="uniform vec3 IG_bboxMax;",p+="uniform float IG_coordTextureWidth;",p+="uniform float IG_coordTextureHeight;",p+="uniform sampler2D IG_normalTexture;";for(var g=0;u>g;g++)p+="uniform sampler2D IG_coordinateTexture"+g+";";c&&(p+="uniform sampler2D IG_indexTexture;",p+="uniform float IG_indexTextureWidth;",p+="uniform float IG_indexTextureHeight;")}if(_&&(p+="uniform vec3  fogColor;\nuniform float fogType;\nuniform float fogRange;\nfloat calcFog(in vec3 eye) {\n   float f0 = 0.0;\n   if(fogType == 0.0) {\n       if(length(eye) < fogRange){\n           f0 = (fogRange-length(eye)) / fogRange;\n       }\n   }else{\n       if(length(eye) < fogRange){\n           f0 = exp(-length(eye) / (fogRange-length(eye) ) );\n       }\n   }\n   f0 = clamp(f0, 0.0, 1.0);\n   return f0;\n}"),h){for(var x=0;h>x;x++)p+="uniform float Light"+x+"_On;\n",p+="uniform float Light"+x+"_Type;\n",p+="uniform vec3  Light"+x+"_Location;\n",p+="uniform vec3  Light"+x+"_Direction;\n",p+="uniform vec3  Light"+x+"_Color;\n",p+="uniform vec3  Light"+x+"_Attenuation;\n",p+="uniform float Light"+x+"_Intensity;\n",p+="uniform float Light"+x+"_AmbientIntensity;\n",p+="uniform float Light"+x+"_BeamWidth;\n",p+="uniform float Light"+x+"_CutOffAngle;\n",p+="uniform float Light"+x+"_ShadowIntensity;\n";p+="void lighting(in float lType, in vec3 lLocation, in vec3 lDirection, in vec3 lColor, in vec3 lAttenuation,       in float lIntensity, in float lAmbientIntensity, in float lBeamWidth, in float lCutOffAngle,       in vec3 N, in vec3 V, inout vec3 ambient, inout vec3 diffuse, inout vec3 specular) {   vec3 L;\n   float spot = 1.0, attentuation = 1.0;\n   if(lType == 0.0) {\n       L = -normalize(lDirection);\n   }else{\n       L = normalize(lLocation - (-V));       float distance = length(L);       L /= distance;\n       attentuation = 1.0 / (lAttenuation.x + lAttenuation.y * distance + lAttenuation.z * (distance * distance));       attentuation *= max(0.0, dot(N, L));       if(lType == 2.0) {           float spotAngle = acos(max(0.0, dot(-L, normalize(lDirection))));           if(spotAngle >= lCutOffAngle) spot = 0.0;           else if(spotAngle <= lBeamWidth) spot = 1.0;           else spot = (spotAngle - lCutOffAngle ) / (lBeamWidth - lCutOffAngle);       }   }   vec3  H = normalize( L + V );\n   float NdotL = max(0.0, dot(N, L));\n   float NdotH = max(0.0, dot(N, H));\n   float ambientFactor  = lAmbientIntensity * ambientIntensity;   float diffuseFactor  = lIntensity * NdotL;   float specularFactor = lIntensity * NdotL * pow(NdotH, shininess*128.0);   ambient  += lColor * ambientFactor * attentuation * spot;   diffuse  += lColor * diffuseFactor * attentuation * spot;   specular += lColor * specularFactor * attentuation * spot;}"}if(a&&(p+=f?"uniform sampler2D IG_colorTexture;":3==a?"attribute vec3 color;":"attribute vec4 color;"),i&&(p+=f?"uniform sampler2D IG_texCoordTexture;":"attribute vec2 texcoord;\n",p+="varying vec2 fragTexcoord;\n",o&&(p+="uniform mat4 texTrafoMatrix;\n"),r||(p+="varying vec3 fragAmbient;\n",p+="varying vec3 fragDiffuse;\n"),n&&(p+="varying vec3 fragViewDir;\n",p+="varying vec3 fragNormal;\n",p+="uniform mat4 viewMatrix;\n")),p+="void main(void) {\n",f){c?(p+="vec2 halfPixel = vec2(0.5/IG_indexTextureWidth,0.5/IG_indexTextureHeight);",p+="vec2 IG_texCoord = vec2(position.x*(256.0/IG_indexTextureWidth), position.y*(256.0/IG_indexTextureHeight)) + halfPixel;",p+="vec2 IG_index = texture2D( IG_indexTexture, IG_texCoord ).rg;",p+="halfPixel = vec2(0.5/IG_coordTextureWidth,0.5/IG_coordTextureHeight);",p+="IG_texCoord = (IG_index * 0.996108948) + halfPixel;"):(p+="vec2 halfPixel = vec2(0.5/IG_coordTextureWidth, 0.5/IG_coordTextureHeight);",p+="vec2 IG_texCoord = vec2(position.x*(256.0/IG_coordTextureWidth), position.y*(256.0/IG_coordTextureHeight)) + halfPixel;"),p+="vec3 temp = vec3(0.0, 0.0, 0.0);",p+="vec3 vertPosition = vec3(0.0, 0.0, 0.0);";for(var g=0;u>g;g++)p+="temp = texture2D( IG_coordinateTexture"+g+", IG_texCoord ).rgb;",g&&(p+="temp /= ("+g+".0 * 256.0);"),p+="vertPosition += temp;";p+="vertPosition = vertPosition * (IG_bboxMax - IG_bboxMin) + IG_bboxMin;",p+="vec3 vertNormal = texture2D( IG_normalTexture, IG_texCoord ).rgb;",p+="vertNormal = vertNormal * 2.0 - 1.0;",i&&(p+="vec4 IG_doubleTexCoords = texture2D( IG_texCoordTexture, IG_texCoord );",p+="vec2 vertTexCoord;",p+="vertTexCoord.r = (IG_doubleTexCoords.r * 0.996108948) + (IG_doubleTexCoords.b * 0.003891051);",p+="vertTexCoord.g = (IG_doubleTexCoords.g * 0.996108948) + (IG_doubleTexCoords.a * 0.003891051);"),3==a?p+="vec3 vertColor = texture2D( IG_colorTexture, IG_texCoord ).rgb;":4==a&&(p+="vec4 vertColor = texture2D( IG_colorTexture, IG_texCoord ).rgba;")}else p+="vec3 vertNormal = normal;",p+="vec3 vertPosition = position;",3==a?p+="vec3 vertColor = color;":4==a&&(p+="vec4 vertColor = color;"),i&&(p+="vec2 vertTexCoord = texcoord;");if(p+="vec3 positionMV = (modelViewMatrix * vec4(vertPosition, 1.0)).xyz;\n",p+="vec3 normalMV = normalize( (normalMatrix * vec4(vertNormal, 0.0)).xyz );\n",p+="vec3 eye = -positionMV;\n",i&&(n?(p+="fragViewDir = (viewMatrix[3].xyz);\n",p+="fragNormal = normalMV;\n"):p+=s?" fragTexcoord = 0.5 + normalMV.xy / 2.0;\n":o?" fragTexcoord = (texTrafoMatrix * vec4(vertTexCoord, 1.0, 1.0)).xy;\n":" fragTexcoord = vertTexCoord;\n"),h){p+="vec3 ambient   = vec3(0.07, 0.07, 0.07);\n",p+="vec3 diffuse   = vec3(0.0, 0.0, 0.0);\n",p+="vec3 specular  = vec3(0.0, 0.0, 0.0);\n",l||(p+="if (dot(normalMV, eye) < 0.0) {\n",p+=" normalMV *= -1.0;\n",p+="}\n");for(var g=0;h>g;g++)p+=" lighting(Light"+g+"_Type,Light"+g+"_Location,Light"+g+"_Direction,Light"+g+"_Color,Light"+g+"_Attenuation,Light"+g+"_Intensity,Light"+g+"_AmbientIntensity,Light"+g+"_BeamWidth,Light"+g+"_CutOffAngle,normalMV, eye, ambient, diffuse, specular);\n";i&&r?(p+="fragColor.rgb = (emissiveColor + ambient*diffuseColor + diffuse*diffuseColor + specular*specularColor);\n",p+="fragColor.a = 1.0 - transparency;\n"):i&&!r?(p+="fragAmbient = ambient;\n",p+="fragDiffuse = diffuse;\n",p+="fragColor.rgb = (emissiveColor + specular*specularColor);\n",p+="fragColor.a = 1.0 - transparency;\n"):3==a?(p+="fragColor.rgb = vertColor;\n",p+="fragColor.a = 1.0 - transparency;\n"):4==a?p+="fragColor.rgba = vertColor;\n":(p+="fragColor.rgb = (emissiveColor + ambient*diffuseColor + diffuse*diffuseColor + specular*specularColor);\n",p+="fragColor.a = 1.0-transparency;\n")}else i&&!r?(p+="fragAmbient = vec3(1.0);\n",p+="fragDiffuse = vec3(1.0);\n",p+="fragColor.rgb = vec3(0.0);\n",p+="fragColor.a = 1.0 - transparency;\n"):3==a?(p+="fragColor.rgb = vertColor;\n",p+="fragColor.a = 1.0 - transparency;\n"):4==a?p+="fragColor.rgba = vertColor;\n":(p+="fragColor.rgb = diffuseColor + emissiveColor;\n;\n",p+="fragColor.a = 1.0-transparency;\n");_&&(p+="float f0 = calcFog(-positionMV);\n",p+="fragColor.rgb = fogColor * (1.0-f0) + f0 * (fragColor.rgb);\n"),p+="gl_Position = modelViewProjectionMatrix * vec4(vertPosition, 1.0);\n",p+="}\n",d[m]={},d[m].type="vertex",d[m].data=p}return m},e.prototype.generateFSMobile=function(e,t){var i=t._cf.appearance.node._cf.texture.node||x3dom.isa(t._cf.geometry.node,x3dom.nodeTypes.Text)?1:0,o=t._cf.appearance.node._cf.texture.node&&x3dom.isa(t._cf.appearance.node._cf.texture.node,x3dom.nodeTypes.X3DEnvironmentTextureNode)?1:0,s=x3dom.isa(t._cf.geometry.node,x3dom.nodeTypes.Text)||o||t._cf.appearance.node._cf.texture.node&&(1==t._cf.appearance.node._cf.texture.node._vf.origChannelCount||2==t._cf.appearance.node._cf.texture.node._vf.origChannelCount)?1:0,n="fs-x3d-mobil-"+i+o+s;if(!d[n]){var r="";r+="#ifdef GL_ES \n",r+="  precision highp float;\n",r+="#endif\n",r+="\n",i&&(o?(r+="uniform samplerCube tex;\n",r+="varying vec3 fragViewDir;\n",r+="varying vec3 fragNormal;\n",r+="uniform mat4 modelViewMatrixInverse;\n"):(r+="uniform sampler2D tex;           \n",r+="varying vec2 fragTexcoord;       \n"),s||(r+="varying vec3 fragAmbient;\n",r+="varying vec3 fragDiffuse;\n")),r+="varying vec4 fragColor;\n",r+="void main(void) {\n",r+="vec4 color = fragColor;\n",i&&(o?(r+="vec3 normal = normalize(fragNormal);\n",r+="vec3 viewDir = normalize(fragViewDir);\n",r+="vec3 reflected = reflect(viewDir, normal);\n",r+="reflected = (modelViewMatrixInverse * vec4(reflected,0.0)).xyz;\n",r+="vec4 texColor = textureCube(tex, reflected);\n"):r+="vec4 texColor = texture2D(tex, vec2(fragTexcoord.s, 1.0-fragTexcoord.t));\n",s?o?(r+="color.rgb = mix(color.rgb, texColor.rgb, vec3(0.75));\n",r+="color.a = texColor.a;\n"):(r+="color.rgb *= texColor.rgb;\n",r+="color.a *= texColor.a;\n"):(r+="color.rgb += fragAmbient*texColor.rgb + fragDiffuse*texColor.rgb;\n",r+="color.a *= texColor.a;\n")),r+="if (color.a <= 0.1) discard;\n",r+="gl_FragColor = color;\n",r+="}\n",d[n]={},d[n].type="fragment",d[n].data=r}return n},e.prototype.generateVS=function(e,t){var i=t._cf.appearance.node._shader&&x3dom.isa(t._cf.appearance.node._shader,x3dom.nodeTypes.CommonSurfaceShader)?1:0,o=t._cf.appearance.node._cf.texture.node||i||x3dom.isa(t._cf.geometry.node,x3dom.nodeTypes.Text)?1:0,s=i&&t._cf.appearance.node._shader.getNormalMap()?1:0,n=null!==t._cf.appearance.node._cf.textureTransform.node?1:0,r=void 0!==t._cf.geometry.node._cf.texCoord&&null!==t._cf.geometry.node._cf.texCoord.node&&t._cf.geometry.node._cf.texCoord.node._vf.mode&&"sphere"==t._cf.geometry.node._cf.texCoord.node._vf.mode.toLowerCase()?1:0,a=t._cf.appearance.node._cf.texture.node&&x3dom.isa(t._cf.appearance.node._cf.texture.node,x3dom.nodeTypes.X3DEnvironmentTextureNode)?1:0,h=t._cf.geometry.node._mesh._colors[0].length>0||t._cf.geometry.node.getColorTexture()?t._cf.geometry.node._mesh._numColComponents:0,l=e.getLights().length+e._scene.getNavigationInfo()._vf.headlight,_=e.getLightsShadow()?1:0,f=e._scene.getFog()._vf.visibilityRange>0?1:0,u=x3dom.isa(t._cf.geometry.node,x3dom.nodeTypes.ImageGeometry)?1:0,c=u?t._cf.geometry.node.numCoordinateTextures():0,m=u&&null!=t._cf.geometry.node.getIndexTexture()?1:0,p="vs-x3d-"+h+o+s+n+r+a+f+l+_+u+c+m;if(!d[p]){var i="";if(i+="attribute vec3 position;",i+="attribute vec3 normal;",i+="uniform mat4 modelViewMatrix;",i+="uniform mat4 normalMatrix;",i+="uniform mat4 modelViewProjectionMatrix;",i+="varying vec3 fragNormal;",u){i+="uniform vec3 IG_bboxMin;",i+="uniform vec3 IG_bboxMax;",i+="uniform float IG_coordTextureWidth;",i+="uniform float IG_coordTextureHeight;",m&&(i+="uniform sampler2D IG_indexTexture;",i+="uniform float IG_indexTextureWidth;",i+="uniform float IG_indexTextureHeight;");for(var g=0;c>g;g++)i+="uniform sampler2D IG_coordinateTexture"+g+";";i+="uniform sampler2D IG_normalTexture;",i+="uniform sampler2D IG_texCoordTexture;",i+="uniform sampler2D IG_colorTexture;"}if(h&&(3==h?(i+="attribute vec3 color;",i+="varying vec3 fragColor;"):(i+="attribute vec4 color;",i+="varying vec4 fragColor;")),o&&(i+="attribute vec2 texcoord;",i+="varying vec2 fragTexcoord;",n&&(i+="uniform mat4 texTrafoMatrix;"),s&&(i+="attribute vec3 tangent;",i+="attribute vec3 binormal;",i+="varying vec3 fragTangent;",i+="varying vec3 fragBinormal;"),a&&(i+="varying vec3 fragViewDir;\n",i+="uniform mat4 viewMatrix;\n")),(l||f)&&(i+="uniform vec3 eyePosition;",i+="varying vec3 fragEyePosition;",i+="varying vec3 fragPosition;",_&&(i+="uniform mat4 matPV;",i+="varying vec4 projCoord;")),i+="void main(void) {",u){m?(i+="vec2 halfPixel = vec2(0.5/IG_indexTextureWidth,0.5/IG_indexTextureHeight);",i+="vec2 IG_texCoord = vec2(position.x*(256.0/IG_indexTextureWidth), position.y*(256.0/IG_indexTextureHeight)) + halfPixel;",i+="vec2 IG_index = texture2D( IG_indexTexture, IG_texCoord ).rg;",i+="halfPixel = vec2(0.5/IG_coordTextureWidth,0.5/IG_coordTextureHeight);",i+="IG_texCoord = (IG_index * 0.996108948) + halfPixel;"):(i+="vec2 halfPixel = vec2(0.5/IG_coordTextureWidth, 0.5/IG_coordTextureHeight);",i+="vec2 IG_texCoord = vec2(position.x*(256.0/IG_coordTextureWidth), position.y*(256.0/IG_coordTextureHeight)) + halfPixel;"),i+="vec3 temp = vec3(0.0, 0.0, 0.0);",i+="vec3 vertPosition = vec3(0.0, 0.0, 0.0);";for(var g=0;c>g;g++)i+="temp = texture2D( IG_coordinateTexture"+g+", IG_texCoord ).rgb;",g&&(i+="temp /= ("+g+".0 * 256.0);"),i+="vertPosition += temp;";i+="vertPosition = vertPosition * (IG_bboxMax - IG_bboxMin) + IG_bboxMin;",i+="vec3 vertNormal = texture2D( IG_normalTexture, IG_texCoord ).rgb;",i+="vertNormal = vertNormal * 2.0 - 1.0;",o&&(i+="vec4 IG_doubleTexCoords = texture2D( IG_texCoordTexture, IG_texCoord );",i+="vec2 vertTexCoord;",i+="vertTexCoord.r = (IG_doubleTexCoords.r * 0.996108948) + (IG_doubleTexCoords.b * 0.003891051);",i+="vertTexCoord.g = (IG_doubleTexCoords.g * 0.996108948) + (IG_doubleTexCoords.a * 0.003891051);"),h&&(i+="fragColor = texture2D( IG_colorTexture, IG_texCoord ).rgb;"),i+="gl_PointSize = 2.0;"}else i+="vec3 vertNormal = normal;",o&&(i+="vec2 vertTexCoord = texcoord;"),i+="vec3 vertPosition = position;",i+="gl_PointSize = 2.0;",h&&(i+="fragColor = color;");i+="fragNormal = (normalMatrix * vec4(vertNormal, 0.0)).xyz;",(l||f)&&(i+="fragPosition = (modelViewMatrix * vec4(vertPosition, 1.0)).xyz;",i+="fragEyePosition = eyePosition - fragPosition;",_&&(i+="projCoord = matPV * vec4(vertPosition+0.5*normalize(vertNormal), 1.0);")),o&&(i+=a?"fragViewDir = (viewMatrix[3].xyz);\n":r?" fragTexcoord = 0.5 + fragNormal.xy / 2.0;":n?" fragTexcoord = (texTrafoMatrix * vec4(vertTexCoord, 1.0, 1.0)).xy;":" fragTexcoord = vertTexCoord;",s&&(i+="fragTangent  = (normalMatrix * vec4(tangent, 0.0)).xyz;",i+="fragBinormal = (normalMatrix * vec4(binormal, 0.0)).xyz;")),i+="gl_Position = modelViewProjectionMatrix * vec4(vertPosition, 1.0);",i+="}",d[p]={},d[p].type="vertex",d[p].data=i}return p},e.prototype.generateFS=function(e,t){var i=t._cf.geometry.node._mesh._colors[0].length>0||t._cf.geometry.node.getColorTexture()?t._cf.geometry.node._mesh._numColComponents:0,o=e.getLights().length+e._scene.getNavigationInfo()._vf.headlight,s=e.getLightsShadow()?1:0,n=e._scene.getFog()._vf.visibilityRange>0?1:0,r=(t.isSolid()?1:0,t._cf.appearance.node._cf.texture.node||x3dom.isa(t._cf.geometry.node,x3dom.nodeTypes.Text)?1:0),a=t._cf.appearance.node._cf.texture.node&&x3dom.isa(t._cf.appearance.node._cf.texture.node,x3dom.nodeTypes.X3DEnvironmentTextureNode)?1:0,h=x3dom.isa(t._cf.geometry.node,x3dom.nodeTypes.Text)||a||t._cf.appearance.node._cf.texture.node&&(1==t._cf.appearance.node._cf.texture.node._vf.origChannelCount||2==t._cf.appearance.node._cf.texture.node._vf.origChannelCount)?1:0,l=t._cf.appearance.node._shader&&x3dom.isa(t._cf.appearance.node._shader,x3dom.nodeTypes.CommonSurfaceShader)?1:0,_=l&&t._cf.appearance.node._shader.getDiffuseMap()?1:0,f=l&&t._cf.appearance.node._shader.getNormalMap()?1:0,u=l&&t._cf.appearance.node._shader.getSpecularMap()?1:0,c="fs-x3d-"+i+r+a+n+o+s+h+l+_+f+u;if(!d[c]){var m="struct Fog {   vec3  color;   float fogType;   float visibilityRange;};uniform Fog fog;float calcFog() {   float f0 = 0.0;   if(fog.fogType == 0.0) {       if(length(fragEyePosition) < fog.visibilityRange){           f0 = (fog.visibilityRange-length(fragEyePosition)) / fog.visibilityRange;       }   }else{       if(length(fragEyePosition) < fog.visibilityRange){           f0 = exp(-length(fragEyePosition) / (fog.visibilityRange-length(fragEyePosition) ) );       }   }   f0 = clamp(f0, 0.0, 1.0);   return f0;}",p="struct Light {\n   float on;\n   float type;\n   vec3  location;\n   vec3  direction;\n   vec3  color;\n   vec3  attenuation;\n   float intensity;\n   float ambientIntensity;\n   float beamWidth;\n   float cutOffAngle;\n   float shadowIntensity;\n};\nconst int NUMLIGHTS = "+o+";\nuniform Light light[9];\nvoid lighting(in Light light, in vec3 N, in vec3 V, inout vec3 ambient, inout vec3 diffuse, inout vec3 specular){   vec3 L;\n   float spot = 1.0, attentuation = 1.0;\n   if(light.type == 0.0) {\n       L = -normalize(light.direction);\n   }else{\n       L = normalize(light.location - fragPosition);       float distance = length(L);       L /= distance;\n       attentuation = 1.0 / (light.attenuation.x + light.attenuation.y * distance + light.attenuation.z * distance * distance);       attentuation *= max(0.0, dot(N, L));       if(light.type == 2.0) {           float spotAngle = acos(max(0.0, dot(-L, normalize(light.direction))));           if(spotAngle >= light.cutOffAngle) spot = 0.0;           else if(spotAngle <= light.beamWidth) spot = 1.0;           else spot = (spotAngle - light.cutOffAngle ) / (light.beamWidth - light.cutOffAngle);       }   }   vec3  H = normalize( L + V );\n   float NdotL = max(0.0, dot(N, L));\n   float NdotH = max(0.0, dot(N, H));\n   float ambientFactor  = light.ambientIntensity * material.ambientIntensity;   float diffuseFactor  = light.intensity * NdotL;   float specularFactor = light.intensity * NdotL * pow(NdotH, material.shininess*128.0);   ambient  += light.color * ambientFactor * attentuation * spot;   diffuse  += light.color * diffuseFactor * attentuation * spot;   specular += light.color * specularFactor * attentuation * spot;}",g="uniform sampler2D sh_tex;varying vec4 projCoord;float PCF_Filter(Light light, vec3 projectiveBiased, float filterWidth){    float stepSize = 2.0 * filterWidth / 3.0;    float blockerCount = 0.0;    projectiveBiased.x -= filterWidth;    projectiveBiased.y -= filterWidth;    for (float i=0.0; i<3.0; i++)    {        for (float j=0.0; j<3.0; j++)        {            projectiveBiased.x += (j*stepSize);            projectiveBiased.y += (i*stepSize);            vec4 zCol = texture2D(sh_tex, (1.0+projectiveBiased.xy)*0.5);            float fromFixed = 256.0 / 255.0;            float z = zCol.r * fromFixed;            z += zCol.g * fromFixed / (255.0);            z += zCol.b * fromFixed / (255.0 * 255.0);            z += zCol.a * fromFixed / (255.0 * 255.0 * 255.0);            if (z < projectiveBiased.z) blockerCount += 1.0;            projectiveBiased.x -= (j*stepSize);            projectiveBiased.y -= (i*stepSize);        }    }    float result = 1.0 - light.shadowIntensity * blockerCount / 9.0;    return result;}",x="struct Material {          \n   vec3  diffuseColor;     \n   vec3  specularColor;    \n   vec3  emissiveColor;    \n   float shininess;        \n   float transparency;     \n   float ambientIntensity; \n};                         \nuniform Material material; \n",l="";l+="#ifdef GL_ES             \n",l+="  precision highp float; \n",l+="#endif                   \n",l+="\n",l+=x,l+="uniform mat4 modelMatrix;",l+="uniform mat4 modelViewMatrix;",i&&(l+=3==i?"varying vec3 fragColor;  \n":"varying vec4 fragColor;  \n"),(r||l)&&(l+="varying vec2 fragTexcoord;       \n",!r&&!_||a?a&&(l+="uniform samplerCube tex;\n",l+="varying vec3 fragViewDir;\n",l+="uniform mat4 modelViewMatrixInverse;\n"):l+="uniform sampler2D tex;           \n",f&&(l+="uniform sampler2D bump;      \n",l+="varying vec3 fragTangent;    \n",l+="varying vec3 fragBinormal;   \n"),u&&(l+="uniform sampler2D spec;      \n")),o&&(l+="uniform float solid;             \n",l+="varying vec3 fragNormal;         \n",l+="varying vec3 fragPosition;       \n",l+="varying vec3 fragEyePosition;    \n",l+=p,s&&(l+=g)),n&&(l+=m,o||(l+="varying vec3 fragEyePosition;    \n")),l+="void main(void) {    \n",l+="vec3 rgb      = vec3(0.0, 0.0, 0.0); \n",l+="float alpha = 1.0 - material.transparency;\n",o?(l+="vec3 ambient   = vec3(0.07, 0.07, 0.07);\n",l+="vec3 diffuse   = vec3(0.0, 0.0, 0.0);\n",l+="vec3 specular  = vec3(0.0, 0.0, 0.0);\n",s&&(l+="float shadowed = 1.0;\n",l+="float oneShadowAlreadyExists = 0.0;\n"),l+="vec3 eye = normalize(-fragPosition);\n",l+="vec3 normal = normalize(fragNormal);\n",f&&(l+="vec3 t = normalize( fragTangent );\n",l+="vec3 b = normalize( fragBinormal );\n",l+="vec3 n = normalize( fragNormal );\n",l+="mat3 tangentToWorld = mat3(t, b, n);\n",l+="normal = texture2D( bump, vec2(fragTexcoord.x, 1.0-fragTexcoord.y) ).rgb;\n",l+="normal = 2.0 * normal - 1.0;\n",l+="normal = normalize( normal * tangentToWorld );\n",l+="normal.y = -normal.y;",l+="normal.x = -normal.x;"),l+="if (solid == 0.0 && dot(normal, eye) < 0.0) {\n",l+=" normal *= -1.0;\n",l+="}\n",l+="for(int i=0; i<NUMLIGHTS; i++) {\n",l+=" lighting(light[i], normal, eye, ambient, diffuse, specular);\n",s&&(l+=" if(light[i].shadowIntensity > 0.0 && oneShadowAlreadyExists == 0.0){\n",l+="     vec3 projectiveBiased = projCoord.xyz / projCoord.w;\n",l+="     shadowed = PCF_Filter(light[i], projectiveBiased, 0.002);\n",l+="     oneShadowAlreadyExists = 1.0;\n",l+=" }\n"),l+="}\n",u&&(l+="specular *= texture2D( spec, vec2(fragTexcoord.x, 1.0-fragTexcoord.y) ).rgb;\n"),r||_?(a?(l+="vec3 viewDir = normalize(fragViewDir);\n",l+="vec3 reflected = reflect(viewDir, normal);\n",l+="reflected = (modelViewMatrixInverse * vec4(reflected,0.0)).xyz;\n",l+="vec4 texColor = textureCube(tex, reflected);\n",l+="alpha *= texColor.a;\n"):(l+="vec2 texCoord = vec2(fragTexcoord.x, 1.0-fragTexcoord.y);\n",l+="vec4 texColor = texture2D(tex, texCoord);\n",l+="alpha *= texColor.a;\n"),h?(l+="   rgb = (material.emissiveColor + ambient*material.diffuseColor + diffuse*material.diffuseColor + specular*material.specularColor);\n",l+=a?"rgb = mix(rgb, texColor.rgb, vec3(0.75));\n":"rgb *= texColor.rgb;\n"):l+="   rgb = (material.emissiveColor + ambient*texColor.rgb + diffuse*texColor.rgb + specular*material.specularColor);\n"):i?(l+="rgb = diffuse*fragColor.rgb;\n",4==i&&(l+="alpha = fragColor.a;\n")):l+="rgb = (material.emissiveColor + ambient*material.diffuseColor + diffuse*material.diffuseColor + specular*material.specularColor);\n",s&&(l+="rgb *= shadowed;\n")):r?(l+="vec2 texCoord = vec2(fragTexcoord.x, 1.0-fragTexcoord.y);\n",l+="vec4 texColor = texture2D(tex, texCoord);\n",l+="rgb = texColor.rgb;\n",l+="alpha *= texColor.a;\n"):i?(l+="rgb = fragColor.rgb;\n",4==i&&(l+="alpha = fragColor.a;\n")):l+="rgb = material.diffuseColor + material.emissiveColor;\n",n&&(l+="float f0 = calcFog();\n",l+="rgb = fog.color * (1.0-f0) + f0 * (rgb);\n"),l+="if (alpha <= 0.1) discard;\n",l+="gl_FragColor = vec4(rgb, alpha);\n",l+="}\n",d[c]={},d[c].type="fragment",d[c].data=l
}return c},e.prototype.setupShape=function(e,t,s){var n,r,h,l,_=0,f=null;if(void 0!==t._webgl){var u=t._webgl.lightsAndShadow;t._webgl.lightsAndShadow=a(s);var c=t._webgl.lightsAndShadow[0]!=u[0]||t._webgl.lightsAndShadow[1]!=u[1]||t._dirty.shader;if(t._dirty.colors===!0&&void 0===t._webgl.shader.color&&t._cf.geometry.node._mesh._colors[0].length&&(c=!0),t._dirty.texture===!0||c)if(f=t._cf.appearance.node._cf.texture.node,void 0!==t._webgl.texture&&f&&!c)t.updateTexture(f,0,"false"),t._dirty.texture=!1;else{c=!0;var m=t._webgl.shader,p=0;for(p=0;void 0!==t._webgl.texture&&p<t._webgl.texture.length;p++)t._webgl.texture[p]&&e.deleteTexture(t._webgl.texture[p]);for(_=0;_<t._webgl.positions.length;_++)void 0!==m.position&&(e.deleteBuffer(t._webgl.buffers[5*_+1]),e.deleteBuffer(t._webgl.buffers[5*_+0])),void 0!==m.normal&&e.deleteBuffer(t._webgl.buffers[5*_+2]),void 0!==m.texcoord&&e.deleteBuffer(t._webgl.buffers[5*_+3]),void 0!==m.color&&e.deleteBuffer(t._webgl.buffers[5*_+4]);for(p=0;p<t._webgl.dynamicFields.length;p++){var g=t._webgl.dynamicFields[p];void 0!==m[g.name]&&e.deleteBuffer(g.buf)}}for(_=0;_<t._webgl.positions.length;_++)c||t._dirty.positions!==!0||(void 0!==t._webgl.shader.position&&(t._webgl.positions[_]=t._cf.geometry.node._mesh._positions[_],e.deleteBuffer(t._webgl.buffers[5*_+1]),l=e.createBuffer(),t._webgl.buffers[5*_+1]=l,e.bindBuffer(e.ARRAY_BUFFER,l),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t._webgl.buffers[5*_+0]),r=new Float32Array(t._webgl.positions[_]),e.bufferData(e.ARRAY_BUFFER,r,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,l),e.vertexAttribPointer(t._webgl.shader.position,3,e.FLOAT,!1,0,0),r=null),t._dirty.positions=!1),c||t._dirty.colors!==!0||(void 0!==t._webgl.shader.color&&(t._webgl.colors[_]=t._cf.geometry.node._mesh._colors[_],e.deleteBuffer(t._webgl.buffers[5*_+4]),n=e.createBuffer(),t._webgl.buffers[5*_+4]=n,h=new Float32Array(t._webgl.colors[_]),e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,h,e.STATIC_DRAW),e.vertexAttribPointer(t._webgl.shader.color,3,e.FLOAT,!1,0,0),h=null),t._dirty.colors=!1);if(!c)return}else if(!x3dom.isa(t._cf.geometry.node,x3dom.nodeTypes.Text)&&(!t._cf.geometry.node||t._cf.geometry.node._mesh._positions[0].length<1))return void x3dom.debug.logError("NO VALID MESH OR NO VERTEX POSITIONS SET!");if(t._dirty.positions=!1,t._dirty.normals=!1,t._dirty.texcoords=!1,t._dirty.colors=!1,t._dirty.indexes=!1,t._dirty.texture=!1,x3dom.isa(t._cf.geometry.node,x3dom.nodeTypes.Text)){var x=t._cf.geometry.node._cf.fontStyle.node,v=["SERIF"],y=32,b="PLAIN",T=1,F=!0,w="BEGIN",C="",E=!0,S=!0;if(null!==x){var M=x._vf.family.toString();switch(M=M.trim().replace(/\'/g,"").replace(/\,/," "),M=M.split(" "),v=Array.map(M,function(e){return"SANS"==e?"sans-serif":"SERIF"==e?"serif":"TYPEWRITER"==e?"monospace":""+e}).join(","),b=x._vf.style.toString().replace(/\'/g,""),b.toUpperCase()){case"PLAIN":b="normal";break;case"BOLD":b="bold";break;case"ITALIC":b="italic";break;case"BOLDITALIC":b="italic bold";break;default:b="normal"}switch(E=x._vf.leftToRight?"ltr":"rtl",S=x._vf.topToBottom,w=x._vf.justify.toString().replace(/\'/g,""),w.toUpperCase()){case"BEGIN":w="left";break;case"END":w="right";break;case"FIRST":w="left";break;case"MIDDLE":w="center";break;default:w="left"}y=x._vf.size,T=x._vf.spacing,F=x._vf.horizontal,C=x._vf.language}var N=t._cf.geometry.node._vf.string,A=document.createElement("canvas");A.dir=E,A.width=s._width,A.height=y,A.display="none",document.body.appendChild(A);var I=A.getContext("2d");I.font=b+" "+y+"px "+v;var R=I.measureText(N).width,D=I.measureText(N).height||A.height;A.width=Math.pow(2,Math.ceil(Math.log(R)/Math.log(2))),A.height=Math.pow(2,Math.ceil(Math.log(D)/Math.log(2))),I.fillStyle="rgba(0,0,0,0)",I.fillRect(0,0,I.canvas.width,I.canvas.height),I.fillStyle="white",I.lineWidth=2.5,I.strokeStyle="grey",I.textBaseline="top",I.font=b+" "+y+"px "+v,I.textAlign=w;var L=(I.canvas.width-R)/2,V=(I.canvas.height-y)/2;I.fillText(N,L,V);var P=e.createTexture();e.bindTexture(e.TEXTURE_2D,P),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,A),document.body.removeChild(A),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null);var k=R/100,X=D/100,B=1,U=0,G=1,z=0;t._cf.geometry.node._mesh._positions[0]=[-k,-X,0,k,-X,0,k,X,0,-k,X,0],t._cf.geometry.node._mesh._normals[0]=[0,0,1,0,0,1,0,0,1,0,0,1],t._cf.geometry.node._mesh._texCoords[0]=[U,z,G,z,G,B,U,B],t._cf.geometry.node._mesh._colors[0]=[],t._cf.geometry.node._mesh._indices[0]=[0,1,2,2,3,0],t._cf.geometry.node._mesh._invalidate=!0,t._cf.geometry.node._mesh._numFaces=2,t._cf.geometry.node._mesh._numCoords=4,t._webgl={positions:t._cf.geometry.node._mesh._positions,normals:t._cf.geometry.node._mesh._normals,texcoords:t._cf.geometry.node._mesh._texCoords,colors:t._cf.geometry.node._mesh._colors,indexes:t._cf.geometry.node._mesh._indices,texture:[P],textureFilter:[e.LINEAR],lightsAndShadow:a(s),imageGeometry:0,indexedImageGeometry:0},t._webgl.primType=e.TRIANGLES,t._webgl.shader=x3dom.caps.MOBILE?this.getShaderProgram(e,[this.generateVSMobile(s,t),this.generateFSMobile(s,t)]):this.getShaderProgram(e,[this.generateVS(s,t),this.generateFS(s,t)])}else{var O=this;f=t._cf.appearance.node._cf.texture.node,t.updateTexture=function(t,i,s){var n,r=this,a=void 0!==t._video&&null!==t._video&&void 0!==t._needPerFrameUpdate&&t._needPerFrameUpdate===!0;if(void 0===this._webgl.texture&&(this._webgl.texture=[]),void 0===this._webgl.textureFilter&&(r._webgl.textureFilter=[],r._webgl.textureFilter[i]=e.LINEAR),t._isCanvas&&t._canvas)n=e.createTexture(),r._webgl.texture[i]=n,e.bindTexture(e.TEXTURE_2D,n),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t._canvas),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null);else if(x3dom.isa(t,x3dom.nodeTypes.RenderedTexture))r._webgl.texture[i]=t._webgl.fbo.tex,e.bindTexture(e.TEXTURE_2D,t._webgl.fbo.tex),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null);else if(x3dom.isa(t,x3dom.nodeTypes.PixelTexture)){var d=new Uint8Array(t._vf.image.toGL()),h=e.NONE;switch(t._vf.image.comp){case 1:h=e.LUMINANCE;break;case 2:h=e.LUMINANCE_ALPHA;break;case 3:h=e.RGB;break;case 4:h=e.RGBA}n=e.createTexture(),r._webgl.texture[i]=n,e.bindTexture(e.TEXTURE_2D,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.texImage2D(e.TEXTURE_2D,0,h,t._vf.image.width,t._vf.image.height,0,h,e.UNSIGNED_BYTE,d)}else if(x3dom.isa(t,x3dom.nodeTypes.MultiTexture))for(var l=0;l<t.size();l++){var _=t.getTexture(l);if(!_)break;r.updateTexture(_,l,"false")}else if(x3dom.isa(t,x3dom.nodeTypes.MovieTexture)||a){if(n=e.createTexture(),!a){t._video=document.createElement("video"),t._video.setAttribute("autobuffer","true");var f=document.getElementsByTagName("body")[0];f.appendChild(t._video),t._video.style.visibility="hidden"}for(var u=0;u<t._vf.url.length;u++){var c=t._nameSpace.getURL(t._vf.url[u]);x3dom.debug.logInfo("Adding video file: "+c);var m=document.createElement("source");m.setAttribute("src",c),t._video.appendChild(m)}var p=function(){r._nameSpace.doc.needRender=!0,("index"==s||"coord"==s||"normal"==s||"texCoord"==s)&&(r._webgl.textureFilter[i]=e.NEAREST),e.bindTexture(e.TEXTURE_2D,n),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t._video),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,r._webgl.textureFilter[i]),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,r._webgl.textureFilter[i]),e.bindTexture(e.TEXTURE_2D,null)},g=function(){r._nameSpace.doc.needRender=!0,r._webgl.texture[i]=n,"coord"==s?(r._webgl.coordTextureWidth=t._video.clientWidth,r._webgl.coordTextureHeight=t._video.clientHeight):"index"==s&&(r._webgl.indexTextureWidth=t._video.clientWidth,r._webgl.indexTextureHeight=t._video.clientHeight),x3dom.debug.logInfo(n+" video tex url: "+t._vf.url),t._video.play(),t._intervalID=setInterval(p,16)},x=function(){clearInterval(t._intervalID),t._vf.loop===!0&&(t._video.play(),t._intervalID=setInterval(p,16))};t._video.addEventListener("canplaythrough",g,!0),t._video.addEventListener("ended",x,!0)}else if(x3dom.isa(t,x3dom.nodeTypes.X3DEnvironmentTextureNode))n=O.loadCubeMap(e,t.getTexUrl(),r._nameSpace.doc,!1),r._webgl.texture[i]=n;else{n=e.createTexture();var v=new Image;v.crossOrigin="",v.src=t._nameSpace.getURL(t._vf.url[0]),r._nameSpace.doc.downloadCount+=1,v.onload=function(){x3dom.ImageLoadManager.activeDownloads--,r._nameSpace.doc.needRender=!0,r._nameSpace.doc.downloadCount-=1,t._vf.scale&&(v=o(v)),r._webgl.texture[i]=n,"coord"==s?(r._webgl.coordTextureWidth=v.width,r._webgl.coordTextureHeight=v.height):"index"==s&&(r._webgl.indexTextureWidth=v.width,r._webgl.indexTextureHeight=v.height),r._webgl.textureFilter[i]="index"==s||"coord"==s||"normal"==s||"texCoord"==s||"color"==s?e.NEAREST:e.LINEAR,x3dom.debug.logInfo(n+" bind tex url: "+t._vf.url+"at unit: "+i),e.bindTexture(e.TEXTURE_2D,n),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,v),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,r._webgl.textureFilter[i]),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,r._webgl.textureFilter[i]),e.bindTexture(e.TEXTURE_2D,null),t._complete=!0},v.onerror=function(){r._nameSpace.doc.downloadCount-=1,x3dom.debug.logError("Can't load tex url: "+t._vf.url+" (at unit "+i+").")}}};var j=0,W=0;if(x3dom.isa(t._cf.geometry.node,x3dom.nodeTypes.ImageGeometry)&&(W=t._cf.geometry.node.numCoordinateTextures(),j=null!=t._cf.geometry.node.getIndexTexture()?1:0),s._scene._webgl.imageGeometry=W,t._webgl={positions:t._cf.geometry.node._mesh._positions,normals:t._cf.geometry.node._mesh._normals,texcoords:t._cf.geometry.node._mesh._texCoords,colors:t._cf.geometry.node._mesh._colors,indexes:t._cf.geometry.node._mesh._indices,lightsAndShadow:a(s),imageGeometry:W,indexedImageGeometry:j},f&&t.updateTexture(f,0,"false"),t._webgl.imageGeometry){var Y=1,H=t._cf.geometry.node.getIndexTexture();H&&t.updateTexture(H,Y++,"index");for(var q=0;W>q;q++){var Q=t._cf.geometry.node.getCoordinateTexture(q);Q&&t.updateTexture(Q,Y++,"coord")}var Z=t._cf.geometry.node.getNormalTexture(0);Z&&t.updateTexture(Z,Y++,"normal");var K=t._cf.geometry.node.getTexCoordTexture();K&&t.updateTexture(K,Y++,"texCoord");var $=t._cf.geometry.node.getColorTexture();$&&t.updateTexture($,Y++,"color")}if(x3dom.isa(t._cf.geometry.node,x3dom.nodeTypes.PointSet)||x3dom.isa(t._cf.geometry.node,x3dom.nodeTypes.Polypoint2D))t._webgl.primType=e.POINTS,t._webgl.shader=t._webgl.colors[0].length?this.getShaderProgram(e,["vs-x3d-vertexcolorUnlit","fs-x3d-vertexcolorUnlit"]):this.getShaderProgram(e,["vs-x3d-default","fs-x3d-default"]);else if(x3dom.isa(t._cf.geometry.node,x3dom.nodeTypes.IndexedLineSet)||x3dom.isa(t._cf.geometry.node,x3dom.nodeTypes.Circle2D)||x3dom.isa(t._cf.geometry.node,x3dom.nodeTypes.Arc2D)||x3dom.isa(t._cf.geometry.node,x3dom.nodeTypes.Polyline2D))t._webgl.primType=e.LINES,t._webgl.shader=t._webgl.colors[0].length?this.getShaderProgram(e,["vs-x3d-vertexcolorUnlit","fs-x3d-vertexcolorUnlit"]):this.getShaderProgram(e,["vs-x3d-default","fs-x3d-default"]);else{if(x3dom.isa(t._cf.geometry.node,x3dom.nodeTypes.ImageGeometry)){t._webgl.primType=[];for(var q=0;q<t._cf.geometry.node._vf.primType.length;q++)t._webgl.primType.push("POINTS"==t._cf.geometry.node._vf.primType[q].toUpperCase()?e.POINTS:"TRIANGLESTRIP"==t._cf.geometry.node._vf.primType[q].toUpperCase()?e.TRIANGLE_STRIP:e.TRIANGLES)}else t._webgl.primType=e.TRIANGLES;if(null!==t._cf.appearance.node._shader)if(x3dom.isa(t._cf.appearance.node._shader,x3dom.nodeTypes.CommonSurfaceShader)){var J=0,et=t._cf.appearance.node._shader,tt=et.getDiffuseMap(),it=et.getNormalMap(),ot=et.getSpecularMap();null!=tt&&t.updateTexture(tt,J++,"false"),null!=it&&t.updateTexture(it,J++,"false"),null!=ot&&t.updateTexture(ot,J++,"false"),x3dom.caps.MOBILE&&x3dom.debug.logWarning("No mobile shader for CommonSurfaceShader! Using high quality shader!"),t._webgl.shader=this.getShaderProgram(e,[this.generateVS(s,t),this.generateFS(s,t)])}else{var st="HACK"+t._objectID;d["vs-x3d-"+st]={},d["vs-x3d-"+st].type="vertex",d["vs-x3d-"+st].data=t._cf.appearance.node._shader._vertex._vf.url[0],d["fs-x3d-"+st]={},d["fs-x3d-"+st].type="fragment",d["fs-x3d-"+st].data=t._cf.appearance.node._shader._fragment._vf.url[0],x3dom.debug.logInfo("6"),t._webgl.shader=i(e,st),t._dirty.shader=!1}else t._webgl.shader=x3dom.caps.MOBILE?this.getShaderProgram(e,[this.generateVSMobile(s,t),this.generateFSMobile(s,t)]):this.getShaderProgram(e,[this.generateVS(s,t),this.generateFS(s,t)])}}t._dirty.shader=!1;var nt=t._webgl.shader;for(t._webgl.buffers=[],_=0;_<t._webgl.positions.length;_++){if(void 0!==nt.position){var rt=e.createBuffer();t._webgl.buffers[5*_+0]=rt;var at=new Uint16Array(t._webgl.indexes[_]);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,rt),e.bufferData(e.ELEMENT_ARRAY_BUFFER,at,e.STATIC_DRAW),at=null,l=e.createBuffer(),t._webgl.buffers[5*_+1]=l,e.bindBuffer(e.ARRAY_BUFFER,l),r=new Float32Array(t._webgl.positions[_]),e.bufferData(e.ARRAY_BUFFER,r,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,l),e.vertexAttribPointer(nt.position,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(nt.position),r=null}if(void 0!==nt.normal){var dt=e.createBuffer();t._webgl.buffers[5*_+2]=dt;var ht=new Float32Array(t._webgl.normals[_]);e.bindBuffer(e.ARRAY_BUFFER,dt),e.bufferData(e.ARRAY_BUFFER,ht,e.STATIC_DRAW),e.vertexAttribPointer(nt.normal,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(nt.normal),ht=null}if(void 0!==nt.texcoord){var lt=e.createBuffer();t._webgl.buffers[5*_+3]=lt;var _t=new Float32Array(t._webgl.texcoords[_]);e.bindBuffer(e.ARRAY_BUFFER,lt),e.bufferData(e.ARRAY_BUFFER,_t,e.STATIC_DRAW),e.vertexAttribPointer(nt.texcoord,t._cf.geometry.node._mesh._numTexComponents,e.FLOAT,!1,0,0),e.enableVertexAttribArray(nt.texcoord),_t=null}void 0!==nt.color&&(n=e.createBuffer(),t._webgl.buffers[5*_+4]=n,h=new Float32Array(t._webgl.colors[_]),e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,h,e.STATIC_DRAW),e.vertexAttribPointer(nt.color,t._cf.geometry.node._mesh._numColComponents,e.FLOAT,!1,0,0),e.enableVertexAttribArray(nt.color),h=null)}var ft=0;t._webgl.dynamicFields=[];for(var ut in t._cf.geometry.node._mesh._dynamicFields){var ct=t._cf.geometry.node._mesh._dynamicFields[ut];if(t._webgl.dynamicFields[ft]={buf:{},name:ut,numComponents:ct.numComponents},void 0!==nt[ut]){var mt=e.createBuffer();t._webgl.dynamicFields[ft++].buf=mt;var pt=new Float32Array(ct.value);e.bindBuffer(e.ARRAY_BUFFER,mt),e.bufferData(e.ARRAY_BUFFER,pt,e.STATIC_DRAW),e.vertexAttribPointer(nt[ut],ct.numComponents,e.FLOAT,!1,0,0),pt=null}}t._webgl._minFilterDic={NEAREST:e.NEAREST,LINEAR:e.LINEAR,NEAREST_MIPMAP_NEAREST:e.NEAREST_MIPMAP_NEAREST,NEAREST_MIPMAP_LINEAR:e.NEAREST_MIPMAP_LINEAR,LINEAR_MIPMAP_NEAREST:e.LINEAR_MIPMAP_NEAREST,LINEAR_MIPMAP_LINEAR:e.LINEAR_MIPMAP_LINEAR,AVG_PIXEL:e.LINEAR,AVG_PIXEL_AVG_MIPMAP:e.LINEAR_MIPMAP_LINEAR,AVG_PIXEL_NEAREST_MIPMAP:e.LINEAR_MIPMAP_NEAREST,DEFAULT:e.LINEAR_MIPMAP_LINEAR,FASTEST:e.NEAREST,NEAREST_PIXEL:e.NEAREST,NEAREST_PIXEL_AVG_MIPMAP:e.NEAREST_MIPMAP_LINEAR,NEAREST_PIXEL_NEAREST_MIPMAP:e.NEAREST_MIPMAP_NEAREST,NICEST:e.LINEAR_MIPMAP_LINEAR},t._webgl._magFilterDic={NEAREST:e.NEAREST,LINEAR:e.LINEAR,AVG_PIXEL:e.LINEAR,DEFAULT:e.LINEAR,FASTEST:e.NEAREST,NEAREST_PIXEL:e.NEAREST,NICEST:e.LINEAR},t._webgl._boundaryModesDic={CLAMP:e.CLAMP_TO_EDGE,CLAMP_TO_EDGE:e.CLAMP_TO_EDGE,CLAMP_TO_BOUNDARY:e.CLAMP_TO_EDGE,MIRRORED_REPEAT:e.MIRRORED_REPEAT,REPEAT:e.REPEAT}},e.prototype.setupScene=function(e,t){var i,o;if(void 0!==t._webgl){if(!t._dirty)return;void 0!==t._webgl.texture&&t._webgl.texture&&e.deleteTexture(t._webgl.texture),void 0!==t._webgl.shader.position&&(e.deleteBuffer(t._webgl.buffers[1]),e.deleteBuffer(t._webgl.buffers[0])),void 0!==t._webgl.shader.texcoord&&e.deleteBuffer(t._webgl.buffers[2]),t._webgl={}}t._dirty=!1;var s=t.getTexUrl(),r=0,a=1,d=1;if(s.length>0&&s[0].length>0)if(s.length>=6&&s[1].length>0&&s[2].length>0&&s[3].length>0&&s[4].length>0&&s[5].length>0)i=new x3dom.nodeTypes.Sphere,t._webgl={positions:i._mesh._positions[0],indexes:i._mesh._indices[0],buffers:[{},{}]},t._webgl.primType=e.TRIANGLES,t._webgl.shader=this.getShaderProgram(e,["vs-x3d-bg-textureCube","fs-x3d-bg-textureCube"]),t._webgl.texture=this.loadCubeMap(e,s,t._nameSpace.doc,!0);else{o=e.createTexture();var h=new Image;h.onload=function(){t._nameSpace.doc.needRender=!0,t._nameSpace.doc.downloadCount-=1,t._webgl.texture=o,e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!0),e.bindTexture(e.TEXTURE_2D,o),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,h),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.bindTexture(e.TEXTURE_2D,null),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1)},h.onerror=function(){t._nameSpace.doc.downloadCount-=1,x3dom.debug.logError("Can't load tex url: "+s[0])},h.src=t._nameSpace.getURL(s[0]),t._nameSpace.doc.downloadCount+=1,t._webgl={positions:[-a,-d,0,-a,d,0,a,-d,0,a,d,0],indexes:[0,1,2,3],buffers:[{},{}]},t._webgl.primType=e.TRIANGLE_STRIP,t._webgl.shader=this.getShaderProgram(e,["vs-x3d-bg-texture","fs-x3d-bg-texture"])}else if(t.getSkyColor().length>1||t.getGroundColor().length){i=new x3dom.nodeTypes.Sphere,t._webgl={positions:i._mesh._positions[0],texcoords:i._mesh._texCoords[0],indexes:i._mesh._indices[0],buffers:[{},{},{}],texture:{}},t._webgl.primType=e.TRIANGLES,t._webgl.shader=this.getShaderProgram(e,["vs-x3d-bg-texture-bgnd","fs-x3d-bg-texture"]);var l=n(t.getSkyColor().length+t.getGroundColor().length+2);l=512>l?512:l;var _=t._vf.groundAngle.length,f=[],u=[],c=[],m=[0];for(r=0;r<t._vf.skyColor.length;r++)c[r]=t._vf.skyColor[r];for(r=0;r<t._vf.skyAngle.length;r++)m[r+1]=t._vf.skyAngle[r];if(_>0){for(m[m.length-1]<Math.PI/2&&(m[m.length]=Math.PI/2-x3dom.fields.Eps,c[c.length]=c[c.length-1]),r=_-1;r>=0;r--)r==_-1&&Math.PI-t._vf.groundAngle[r]<=Math.PI/2&&(m[m.length]=Math.PI/2,c[c.length]=t._vf.groundColor[t._vf.groundColor.length-1]),m[m.length]=Math.PI-t._vf.groundAngle[r],c[c.length]=t._vf.groundColor[r+1];m[m.length]=Math.PI,c[c.length]=t._vf.groundColor[0]}else m[m.length-1]<Math.PI&&(m[m.length]=Math.PI,c[c.length]=c[c.length-1]);for(r=0;r<m.length;r++)m[r]/=Math.PI;x3dom.debug.assert(m.length==c.length);var p=new x3dom.nodeTypes.ColorInterpolator;for(p._vf.key=new x3dom.fields.MFFloat(m),p._vf.keyValue=new x3dom.fields.MFColor(c),r=0;l>r;r++){var g=r/(l-1);p._fieldWatchers.set_fraction[0].call(p,g),f[r]=p._vf.value_changed}for(f.reverse(),r=0;r<f.length;r++)u[3*r+0]=Math.floor(255*f[r].r),u[3*r+1]=Math.floor(255*f[r].g),u[3*r+2]=Math.floor(255*f[r].b);var x=new Uint8Array(u),v=e.RGB;l=x.length/3,o=e.createTexture(),t._webgl.texture=o,e.bindTexture(e.TEXTURE_2D,o),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.texImage2D(e.TEXTURE_2D,0,v,1,l,0,v,e.UNSIGNED_BYTE,x)}else t._webgl={};if(t._webgl.shader){var y=t._webgl.shader,b=e.createBuffer();t._webgl.buffers[1]=b,e.bindBuffer(e.ARRAY_BUFFER,b);var T=new Float32Array(t._webgl.positions);e.bufferData(e.ARRAY_BUFFER,T,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,b),e.vertexAttribPointer(y.position,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(y.position);var F=e.createBuffer();t._webgl.buffers[0]=F;var w=new Uint16Array(t._webgl.indexes);if(e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,F),e.bufferData(e.ELEMENT_ARRAY_BUFFER,w,e.STATIC_DRAW),T=null,w=null,void 0!==y.texcoord){var C=e.createBuffer();t._webgl.buffers[2]=C;var E=new Float32Array(t._webgl.texcoords);e.bindBuffer(e.ARRAY_BUFFER,C),e.bufferData(e.ARRAY_BUFFER,E,e.STATIC_DRAW),e.vertexAttribPointer(y.texcoord,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(y.texcoord),E=null}}t._webgl.render=function(e,i){var o=t._webgl.shader;if(o&&o.texcoord&&t._webgl.texture){e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT),e.frontFace(e.CCW),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.BLEND),o.bind(),o.tex||(o.tex=0),o.alpha=1,o.modelViewProjectionMatrix=i.toGL(),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,t._webgl.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t._webgl.buffers[0]),e.bindBuffer(e.ARRAY_BUFFER,t._webgl.buffers[1]),e.vertexAttribPointer(o.position,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(o.position),e.bindBuffer(e.ARRAY_BUFFER,t._webgl.buffers[2]),e.vertexAttribPointer(o.texcoord,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(o.texcoord);try{e.drawElements(t._webgl.primType,t._webgl.indexes.length,e.UNSIGNED_SHORT,0)}catch(s){x3dom.debug.logException("Render background: "+s)}e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),e.disableVertexAttribArray(o.position),e.disableVertexAttribArray(o.texcoord),e.clear(e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT)}else if(!o||!t._webgl.texture||void 0!==t._webgl.texture.textureCubeReady&&t._webgl.texture.textureCubeReady!==!0){var n=t.getSkyColor().toGL();n[3]=1-t.getTransparency(),e.clearColor(n[0],n[1],n[2],n[3]),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT)}else{e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT),e.frontFace(e.CCW),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.BLEND),o.bind(),o.tex||(o.tex=0),t._webgl.texture.textureCubeReady?(o.modelViewProjectionMatrix=i.toGL(),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_CUBE_MAP,t._webgl.texture),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,e.LINEAR)):(e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,t._webgl.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t._webgl.buffers[0]),e.bindBuffer(e.ARRAY_BUFFER,t._webgl.buffers[1]),e.vertexAttribPointer(o.position,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(o.position);try{e.drawElements(t._webgl.primType,t._webgl.indexes.length,e.UNSIGNED_SHORT,0)}catch(s){x3dom.debug.logException("Render background: "+s)}e.disableVertexAttribArray(o.position),t._webgl.texture.textureCubeReady?(e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_CUBE_MAP,null)):(e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null)),e.clear(e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT)}}},e.prototype.setupFgnds=function(e,t){if(void 0===t._fgnd){var i=1,o=1;t._fgnd={},t._fgnd._webgl={positions:[-i,-o,0,-i,o,0,i,-o,0,i,o,0],indexes:[0,1,2,3],buffers:[{},{}]},t._fgnd._webgl.primType=e.TRIANGLE_STRIP,t._fgnd._webgl.shader=this.getShaderProgram(e,["vs-x3d-bg-texture","fs-x3d-bg-texture"]);var s=t._fgnd._webgl.shader,n=e.createBuffer();t._fgnd._webgl.buffers[1]=n,e.bindBuffer(e.ARRAY_BUFFER,n);var r=new Float32Array(t._fgnd._webgl.positions);e.bufferData(e.ARRAY_BUFFER,r,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,n),e.vertexAttribPointer(s.position,3,e.FLOAT,!1,0,0);var a=e.createBuffer();t._fgnd._webgl.buffers[0]=a;var d=new Uint16Array(t._fgnd._webgl.indexes);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,a),e.bufferData(e.ELEMENT_ARRAY_BUFFER,d,e.STATIC_DRAW),r=null,d=null,t._fgnd._webgl.render=function(e,i){t._fgnd._webgl.texture=i,e.frontFace(e.CCW),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),s.bind(),s.tex||(s.tex=0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,t._fgnd._webgl.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t._fgnd._webgl.buffers[0]),e.bindBuffer(e.ARRAY_BUFFER,t._fgnd._webgl.buffers[1]),e.vertexAttribPointer(s.position,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(s.position);try{e.drawElements(t._fgnd._webgl.primType,t._fgnd._webgl.indexes.length,e.UNSIGNED_SHORT,0)}catch(o){x3dom.debug.logException("Render background: "+o)}e.disableVertexAttribArray(s.position),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null)}}},e.prototype.renderShadowPass=function(e,t,i,o){e.bindFramebuffer(e.FRAMEBUFFER,t._webgl.fboShadow.fbo),e.viewport(0,0,t._webgl.fboShadow.width,t._webgl.fboShadow.height),e.clearColor(1,1,1,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.depthFunc(e.LEQUAL),e.enable(e.DEPTH_TEST),e.enable(e.CULL_FACE),e.disable(e.BLEND);var s=t._webgl.shadowShader;s.bind();var n,r=t.drawableObjects.length;for(n=0;r>n;n++){var a=t.drawableObjects[n][0],d=t.drawableObjects[n][1];s.modelViewMatrix=i.mult(a).toGL(),s.modelViewProjectionMatrix=o.mult(a).toGL();for(var h=0;h<d._webgl.positions.length;h++){void 0!==s.position&&(e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,d._webgl.buffers[5*h+0]),e.bindBuffer(e.ARRAY_BUFFER,d._webgl.buffers[5*h+1]),e.vertexAttribPointer(s.position,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(s.position));try{if(d._webgl.indexes&&d._webgl.indexes[h])if(d._webgl.imageGeometry)for(var l=0,_=0;l<d._cf.geometry.node._vf.vertexCount.length;l++)e.drawArrays(d._webgl.primType[l],_,d._cf.geometry.node._vf.vertexCount[l]),_+=d._cf.geometry.node._vf.vertexCount[l];else e.drawElements(d._webgl.primType,d._webgl.indexes[h].length,e.UNSIGNED_SHORT,0)}catch(f){x3dom.debug.logException(d._DEF+" renderShadowPass(): "+f)}void 0!==s.position&&e.disableVertexAttribArray(s.position)}}e.flush(),e.bindFramebuffer(e.FRAMEBUFFER,null)},e.prototype.renderPickingPass=function(e,t,i,o,s,n,r,a,d){e.bindFramebuffer(e.FRAMEBUFFER,t._webgl.fboPick.fbo),e.viewport(0,0,t._webgl.fboPick.width,t._webgl.fboPick.height),e.clearColor(0,0,0,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.depthFunc(e.LEQUAL),e.enable(e.DEPTH_TEST),e.enable(e.CULL_FACE),e.disable(e.BLEND);var h;0===r?h=t._webgl.imageGeometry?t._webgl.pickShaderIG:t._webgl.pickShader:1===r?h=t._webgl.pickColorShader:2===r&&(h=t._webgl.pickTexCoordShader),h.bind();for(var l=0;l<t.drawableObjects.length;l++){var _=t.drawableObjects[l][0],f=t.drawableObjects[l][1];if(!(f._objectID<1||void 0===f._webgl)){if(h.modelMatrix=_.toGL(),h.modelViewProjectionMatrix=o.mult(_).toGL(),h.wcMin=s.toGL(),h.wcMax=n.toGL(),h.alpha=1-f._objectID/255,h.imageGeometry=0,f._webgl.imageGeometry){h.imageGeometry=1,h.IG_bboxMin=f._cf.geometry.node.getMin().toGL(),h.IG_bboxMax=f._cf.geometry.node.getMax().toGL(),h.IG_coordTextureWidth=f._webgl.coordTextureWidth,h.IG_coordTextureHeight=f._webgl.coordTextureHeight,f._webgl.indexedImageGeometry?(h.indexed=1,h.IG_indexTextureWidth=f._webgl.indexTextureWidth,h.IG_indexTextureHeight=f._webgl.indexTextureHeight,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,f._webgl.texture[1]),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,f._webgl.texture[2])):(h.indexed=0,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,f._webgl.texture[1])),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST);var u=0;f._cf.geometry.node.getIndexTexture()&&(h.IG_indexTexture||(h.IG_indexTexture=u++)),f._cf.geometry.node.getCoordinateTexture(0)&&(h.IG_coordinateTexture||(h.IG_coordinateTexture=u++))}for(var c=0;c<f._webgl.positions.length;c++){void 0!==h.position&&(e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,f._webgl.buffers[5*c+0]),e.bindBuffer(e.ARRAY_BUFFER,f._webgl.buffers[5*c+1]),e.vertexAttribPointer(h.position,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(h.position)),void 0!==h.color&&(e.bindBuffer(e.ARRAY_BUFFER,f._webgl.buffers[5*c+4]),e.vertexAttribPointer(h.color,f._cf.geometry.node._mesh._numColComponents,e.FLOAT,!1,0,0),e.enableVertexAttribArray(h.color)),void 0!==h.texcoord&&(e.bindBuffer(e.ARRAY_BUFFER,f._webgl.buffers[5*c+3]),e.vertexAttribPointer(h.texcoord,f._cf.geometry.node._mesh._numTexComponents,e.FLOAT,!1,0,0),e.enableVertexAttribArray(h.texcoord)),f.isSolid()?(e.enable(e.CULL_FACE),e.frontFace(f.isCCW()?e.CCW:e.CW)):e.disable(e.CULL_FACE);try{if(f._webgl.indexes&&f._webgl.indexes[c])if(f._webgl.imageGeometry)for(var m=0,p=0;m<f._cf.geometry.node._vf.vertexCount.length;m++)e.drawArrays(f._webgl.primType[m],p,f._cf.geometry.node._vf.vertexCount[m]),p+=f._cf.geometry.node._vf.vertexCount[m];else e.drawElements(f._webgl.primType,f._webgl.indexes[c].length,e.UNSIGNED_SHORT,0)}catch(g){x3dom.debug.logException(f._DEF+" renderPickingPass(): "+g)}void 0!==h.position&&e.disableVertexAttribArray(h.position),void 0!==h.color&&e.disableVertexAttribArray(h.color),void 0!==h.texcoord&&e.disableVertexAttribArray(h.texcoord)}}}e.flush();try{var x=a*t._webgl.pickScale,v=t._webgl.fboPick.height-1-d*t._webgl.pickScale,y=new Uint8Array(4);e.readPixels(x,v,1,1,e.RGBA,e.UNSIGNED_BYTE,y),t._webgl.fboPick.pixelData=y}catch(b){t._webgl.fboPick.pixelData=[],x3dom.debug.logException(b+" (cannot pick)")}e.bindFramebuffer(e.FRAMEBUFFER,null)},e.prototype.renderShape=function(e,t,o,s,n,r,a,d,h,l,_){if(void 0!==t._webgl){var f=null,u=o._scene,c=t._webgl.shader;c||(t._webgl.shader=i(h,"default"),c=t._webgl.shader),c.bind(),c.useText=x3dom.isa(t._cf.geometry.node,x3dom.nodeTypes.Text)?1:0,t._webgl.imageGeometry&&(c.IG_bboxMin=t._cf.geometry.node.getMin().toGL(),c.IG_bboxMax=t._cf.geometry.node.getMax().toGL(),c.IG_coordTextureWidth=t._webgl.coordTextureWidth,c.IG_coordTextureHeight=t._webgl.coordTextureHeight,t._webgl.indexedImageGeometry&&(c.IG_indexTextureWidth=t._webgl.indexTextureWidth,c.IG_indexTextureHeight=t._webgl.indexTextureHeight));var m=u.getFog();m&&(x3dom.caps.MOBILE?(c.fogColor=m._vf.color.toGL(),c.fogRange=m._vf.visibilityRange,c.fogType="LINEAR"==m._vf.fogType?0:1):(c["fog.color"]=m._vf.color.toGL(),c["fog.visibilityRange"]=m._vf.visibilityRange,c["fog.fogType"]="LINEAR"==m._vf.fogType?0:1));var p=t._cf.appearance.node._cf.material.node,g=t._cf.appearance.node._shader;if(null!==g&&x3dom.isa(g,x3dom.nodeTypes.CommonSurfaceShader)?(c["material.diffuseColor"]=g._vf.diffuseFactor.toGL(),c["material.specularColor"]=g._vf.specularFactor.toGL(),c["material.emissiveColor"]=g._vf.emissiveFactor.toGL(),c["material.shininess"]=g._vf.shininessFactor,c["material.ambientIntensity"]=(g._vf.ambientFactor.x+g._vf.ambientFactor.y+g._vf.ambientFactor.z)/3,c["material.transparency"]=1-g._vf.alphaFactor):(g=null,x3dom.caps.MOBILE?(c.diffuseColor=p._vf.diffuseColor.toGL(),c.specularColor=p._vf.specularColor.toGL(),c.emissiveColor=p._vf.emissiveColor.toGL(),c.shininess=p._vf.shininess,c.ambientIntensity=p._vf.ambientIntensity,c.transparency=p._vf.transparency):(c["material.diffuseColor"]=p._vf.diffuseColor.toGL(),c["material.specularColor"]=p._vf.specularColor.toGL(),c["material.emissiveColor"]=p._vf.emissiveColor.toGL(),c["material.shininess"]=p._vf.shininess,c["material.ambientIntensity"]=p._vf.ambientIntensity,c["material.transparency"]=p._vf.transparency)),c.alpha=1-p._vf.transparency,n>0){n>8&&(x3dom.debug.logWarning("Too many lights! Only 8 lights supported!"),n=8);
for(var x=0;n>x;x++)x3dom.isa(s[x],x3dom.nodeTypes.DirectionalLight)?x3dom.caps.MOBILE?(c["Light"+x+"_Type"]=0,c["Light"+x+"_On"]=s[x]._vf.on?1:0,c["Light"+x+"_Color"]=s[x]._vf.color.toGL(),c["Light"+x+"_Intensity"]=s[x]._vf.intensity,c["Light"+x+"_AmbientIntensity"]=s[x]._vf.ambientIntensity,c["Light"+x+"_Direction"]=r.multMatrixVec(s[x]._vf.direction).toGL(),c["Light"+x+"_Attenuation"]=[1,1,1],c["Light"+x+"_Location"]=[1,1,1],c["Light"+x+"_Radius"]=0,c["Light"+x+"_BeamWidth"]=0,c["Light"+x+"_CutOffAngle"]=0,c["Light"+x+"_shadowIntensity"]=s[x]._vf.shadowIntensity):(c["light["+x+"].type"]=0,c["light["+x+"].on"]=s[x]._vf.on?1:0,c["light["+x+"].color"]=s[x]._vf.color.toGL(),c["light["+x+"].intensity"]=s[x]._vf.intensity,c["light["+x+"].ambientIntensity"]=s[x]._vf.ambientIntensity,c["light["+x+"].direction"]=r.multMatrixVec(s[x]._vf.direction).toGL(),c["light["+x+"].attenuation"]=[1,1,1],c["light["+x+"].location"]=[1,1,1],c["light["+x+"].radius"]=0,c["light["+x+"].beamWidth"]=0,c["light["+x+"].cutOffAngle"]=0,c["light["+x+"].shadowIntensity"]=s[x]._vf.shadowIntensity):x3dom.isa(s[x],x3dom.nodeTypes.PointLight)?x3dom.caps.MOBILE?(c["Light"+x+"_Type"]=1,c["Light"+x+"_On"]=s[x]._vf.on?1:0,c["Light"+x+"_Color"]=s[x]._vf.color.toGL(),c["Light"+x+"_Intensity"]=s[x]._vf.intensity,c["Light"+x+"_AmbientIntensity"]=s[x]._vf.ambientIntensity,c["Light"+x+"_Direction"]=[1,1,1],c["Light"+x+"_Attenuation"]=s[x]._vf.attenuation.toGL(),c["Light"+x+"_Location"]=r.multMatrixPnt(s[x]._vf.location).toGL(),c["Light"+x+"_Radius"]=s[x]._vf.radius,c["Light"+x+"_BeamWidth"]=0,c["Light"+x+"_CutOffAngle"]=0,c["Light"+x+"_shadowIntensity"]=s[x]._vf.shadowIntensity):(c["light["+x+"].type"]=1,c["light["+x+"].on"]=s[x]._vf.on?1:0,c["light["+x+"].color"]=s[x]._vf.color.toGL(),c["light["+x+"].intensity"]=s[x]._vf.intensity,c["light["+x+"].ambientIntensity"]=s[x]._vf.ambientIntensity,c["light["+x+"].direction"]=[1,1,1],c["light["+x+"].attenuation"]=s[x]._vf.attenuation.toGL(),c["light["+x+"].location"]=r.multMatrixPnt(s[x]._vf.location).toGL(),c["light["+x+"].radius"]=s[x]._vf.radius,c["light["+x+"].beamWidth"]=0,c["light["+x+"].cutOffAngle"]=0,c["light["+x+"].shadowIntensity"]=s[x]._vf.shadowIntensity):x3dom.isa(s[x],x3dom.nodeTypes.SpotLight)&&(x3dom.caps.MOBILE?(c["Light"+x+"_Type"]=2,c["Light"+x+"_On"]=s[x]._vf.on?1:0,c["Light"+x+"_Color"]=s[x]._vf.color.toGL(),c["Light"+x+"_Intensity"]=s[x]._vf.intensity,c["Light"+x+"_AmbientIntensity"]=s[x]._vf.ambientIntensity,c["Light"+x+"_Direction"]=r.multMatrixVec(s[x]._vf.direction).toGL(),c["Light"+x+"_Attenuation"]=s[x]._vf.attenuation.toGL(),c["Light"+x+"_Location"]=r.multMatrixPnt(s[x]._vf.location).toGL(),c["Light"+x+"_Radius"]=s[x]._vf.radius,c["Light"+x+"_BeamWidth"]=s[x]._vf.beamWidth,c["Light"+x+"_CutOffAngle"]=s[x]._vf.cutOffAngle,c["Light"+x+"_shadowIntensity"]=s[x]._vf.shadowIntensity):(c["light["+x+"].type"]=2,c["light["+x+"].on"]=s[x]._vf.on?1:0,c["light["+x+"].color"]=s[x]._vf.color.toGL(),c["light["+x+"].intensity"]=s[x]._vf.intensity,c["light["+x+"].ambientIntensity"]=s[x]._vf.ambientIntensity,c["light["+x+"].direction"]=r.multMatrixVec(s[x]._vf.direction).toGL(),c["light["+x+"].attenuation"]=s[x]._vf.attenuation.toGL(),c["light["+x+"].location"]=r.multMatrixPnt(s[x]._vf.location).toGL(),c["light["+x+"].radius"]=s[x]._vf.radius,c["light["+x+"].beamWidth"]=s[x]._vf.beamWidth,c["light["+x+"].cutOffAngle"]=s[x]._vf.cutOffAngle,c["light["+x+"].shadowIntensity"]=s[x]._vf.shadowIntensity))}var v=u.getNavigationInfo();v._vf.headlight&&(n=n?n:0,x3dom.caps.MOBILE?(c["Light"+n+"_Type"]=0,c["Light"+n+"_On"]=1,c["Light"+n+"_Color"]=[1,1,1],c["Light"+n+"_Intensity"]=1,c["Light"+n+"_AmbientIntensity"]=0,c["Light"+n+"_Direction"]=[0,0,-1],c["Light"+n+"_Attenuation"]=[1,1,1],c["Light"+n+"_Location"]=[1,1,1],c["Light"+n+"_Radius"]=0,c["Light"+n+"_BeamWidth"]=0,c["Light"+n+"_CutOffAngle"]=0):(c["light["+n+"].type"]=0,c["light["+n+"].on"]=1,c["light["+n+"].color"]=[1,1,1],c["light["+n+"].intensity"]=1,c["light["+n+"].ambientIntensity"]=0,c["light["+n+"].direction"]=[0,0,-1],c["light["+n+"].attenuation"]=[1,1,1],c["light["+n+"].location"]=[1,1,1],c["light["+n+"].radius"]=0,c["light["+n+"].beamWidth"]=0,c["light["+n+"].cutOffAngle"]=0));var y=t._cf.appearance.node._shader;if(y)for(var b in y._vf)if(y._vf.hasOwnProperty(b)&&"language"!==b){var T=y._vf[b];try{c[b]=T.toGL()}catch(F){c[b]=T}}var w=r.mult(e);c.modelViewMatrix=w.toGL(),c.normalMatrix=w.inverse().transpose().toGL(),c.viewMatrix=r.toGL(),c.modelViewMatrixInverse=w.inverse().toGL(),c.modelViewProjectionMatrix=a.mult(e).toGL();for(var C=0;void 0!==t._webgl.texture&&C<t._webgl.texture.length;C++)if(t._webgl.texture[C]){t._cf.appearance.node._cf.texture.node&&(f=t._cf.appearance.node._cf.texture.node.getTexture(C)),f&&(c.origChannelCount=f._vf.origChannelCount);var E=h.REPEAT,S=h.REPEAT,M=h.LINEAR,N=h.LINEAR,A=!1;if(t._webgl.textureFilter&&(M=t._webgl.textureFilter[C],N=t._webgl.textureFilter[C]),f&&null!==f._cf.textureProperties.node){var I=f._cf.textureProperties.node;E=t._webgl._boundaryModesDic[I._vf.boundaryModeS.toUpperCase()],S=t._webgl._boundaryModesDic[I._vf.boundaryModeT.toUpperCase()],M=t._webgl._minFilterDic[I._vf.minificationFilter.toUpperCase()],N=t._webgl._magFilterDic[I._vf.magnificationFilter.toUpperCase()],I._vf.generateMipMaps===!0?(M==h.NEAREST&&(M=h.NEAREST_MIPMAP_NEAREST),M==h.LINEAR&&(M=h.LINEAR_MIPMAP_LINEAR),A=!0):((M==h.LINEAR_MIPMAP_LINEAR||M==h.LINEAR_MIPMAP_NEAREST)&&(M=h.LINEAR),(M==h.NEAREST_MIPMAP_LINEAR||M==h.NEAREST_MIPMAP_NEAREST)&&(M=h.NEAREST))}else f&&f._vf.repeatS===!1&&(E=h.CLAMP_TO_EDGE),f&&f._vf.repeatT===!1&&(S=h.CLAMP_TO_EDGE);if(t._webgl.texture[C].textureCubeReady&&f&&x3dom.isa(f,x3dom.nodeTypes.X3DEnvironmentTextureNode)?(h.activeTexture(l[C]),h.bindTexture(h.TEXTURE_CUBE_MAP,t._webgl.texture[C]),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_WRAP_S,E),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_WRAP_T,S),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_MAG_FILTER,N),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_MIN_FILTER,M),A&&h.generateMipmap(h.TEXTURE_CUBE_MAP)):(h.activeTexture(l[C]),h.bindTexture(h.TEXTURE_2D,t._webgl.texture[C]),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,E),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,S),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,N),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,M),A&&h.generateMipmap(h.TEXTURE_2D)),null!==t._cf.appearance.node._cf.textureTransform.node){var R=t._cf.appearance.node.texTransformMatrix();c.texTrafoMatrix=R.toGL()}if(t._webgl.imageGeometry){var D=1;t._cf.geometry.node.getIndexTexture()&&(c.IG_indexTexture||(c.IG_indexTexture=D++));for(var L=0;L<t._webgl.imageGeometry;L++)t._cf.geometry.node.getCoordinateTexture(L)&&(c["IG_coordinateTexture"+L]||(c["IG_coordinateTexture"+L]=D++));t._cf.geometry.node.getNormalTexture(0)&&(c.IG_normalTexture||(c.IG_normalTexture=D++)),t._cf.geometry.node.getTexCoordTexture()&&(c.IG_texCoordTexture||(c.IG_texCoordTexture=D++)),t._cf.geometry.node.getColorTexture()&&(c.IG_colorTexture||(c.IG_colorTexture=D++))}if(g){var V=0;g.getDiffuseMap()&&(c.tex||(c.tex=V++)),g.getNormalMap()&&(c.bump||(c.bump=V++)),g.getSpecularMap()&&(c.spec||(c.spec=V++))}else c.tex||(c.tex=0)}_&&(c.sh_tex||(c.sh_tex=C),h.activeTexture(l[C]),h.bindTexture(h.TEXTURE_2D,u._webgl.fboShadow.tex),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,h.LINEAR),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,h.LINEAR),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),c.matPV=d.mult(e).toGL());for(var P,k=0;k<t._webgl.dynamicFields.length;k++)P=t._webgl.dynamicFields[k],void 0!==c[P.name]&&(h.bindBuffer(h.ARRAY_BUFFER,P.buf),h.vertexAttribPointer(c[P.name],P.numComponents,h.FLOAT,!1,0,0),h.enableVertexAttribArray(c[P.name]));t.isSolid()?(h.enable(h.CULL_FACE),h.frontFace(t.isCCW()?h.CCW:h.CW)):h.disable(h.CULL_FACE),c.solid=t.isSolid()?1:0;for(var X=0;X<t._webgl.positions.length;X++){void 0!==c.position&&(h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,t._webgl.buffers[5*X+0]),h.bindBuffer(h.ARRAY_BUFFER,t._webgl.buffers[5*X+1]),h.vertexAttribPointer(c.position,3,h.FLOAT,!1,0,0),h.enableVertexAttribArray(c.position)),void 0!==c.normal&&(h.bindBuffer(h.ARRAY_BUFFER,t._webgl.buffers[5*X+2]),h.vertexAttribPointer(c.normal,3,h.FLOAT,!1,0,0),h.enableVertexAttribArray(c.normal)),void 0!==c.texcoord&&(h.bindBuffer(h.ARRAY_BUFFER,t._webgl.buffers[5*X+3]),h.vertexAttribPointer(c.texcoord,t._cf.geometry.node._mesh._numTexComponents,h.FLOAT,!1,0,0),h.enableVertexAttribArray(c.texcoord)),void 0!==c.color&&(h.bindBuffer(h.ARRAY_BUFFER,t._webgl.buffers[5*X+4]),h.vertexAttribPointer(c.color,t._cf.geometry.node._mesh._numColComponents,h.FLOAT,!1,0,0),h.enableVertexAttribArray(c.color));try{if(void 0!==o._points&&o._points)t._webgl.imageGeometry?h.drawElements(h.POINTS,t._cf.geometry.node._vf.vertexCount[0],h.UNSIGNED_SHORT,0):h.drawElements(h.POINTS,t._webgl.indexes[X].length,h.UNSIGNED_SHORT,0);else if(t._webgl.primType==h.POINTS)t._webgl.imageGeometry?h.drawArrays(h.POINTS,0,t._cf.geometry.node._vf.vertexCount[0]):h.drawArrays(h.POINTS,0,t._webgl.positions[X].length/3);else if(t._webgl.indexes&&t._webgl.indexes[X])if(t._webgl.imageGeometry)for(var L=0,B=0;L<t._cf.geometry.node._vf.vertexCount.length;L++)h.drawArrays(t._webgl.primType[L],B,t._cf.geometry.node._vf.vertexCount[L]),B+=t._cf.geometry.node._vf.vertexCount[L];else h.drawElements(t._webgl.primType,t._webgl.indexes[X].length,h.UNSIGNED_SHORT,0)}catch(U){x3dom.debug.logException(t._DEF+" renderScene(): "+U)}void 0!==c.position&&h.disableVertexAttribArray(c.position),void 0!==c.normal&&h.disableVertexAttribArray(c.normal),void 0!==c.texcoord&&h.disableVertexAttribArray(c.texcoord),void 0!==c.color&&h.disableVertexAttribArray(c.color)}if(t._webgl.indexes&&t._webgl.indexes[0])if(t._webgl.imageGeometry)for(var L=0;L<t._cf.geometry.node._vf.vertexCount.length;L++)this.numFaces+=t._cf.geometry.node._vf.vertexCount[L]/3;else this.numFaces+=t._cf.geometry.node._mesh._numFaces;if(t._webgl.imageGeometry)for(var L=0;L<t._cf.geometry.node._vf.vertexCount.length;L++)this.numCoords+=t._cf.geometry.node._vf.vertexCount[L];else this.numCoords+=t._cf.geometry.node._mesh._numCoords;for(C=0;void 0!==t._webgl.texture&&C<t._webgl.texture.length;C++)t._webgl.texture[C]&&(f=null,t._cf.appearance.node._cf.texture.node&&(f=t._cf.appearance.node._cf.texture.node.getTexture(C)),t._webgl.texture[C].textureCubeReady&&f&&x3dom.isa(f,x3dom.nodeTypes.X3DEnvironmentTextureNode)?(h.activeTexture(l[C]),h.bindTexture(h.TEXTURE_CUBE_MAP,null)):(h.activeTexture(l[C]),h.bindTexture(h.TEXTURE_2D,null)));for(_&&(h.activeTexture(l[C]),h.bindTexture(h.TEXTURE_2D,null)),k=0;k<t._webgl.dynamicFields.length;k++)P=t._webgl.dynamicFields[k],void 0!==c[P.name]&&h.disableVertexAttribArray(c[P.name])}},e.prototype.pickValue=function(e,t,i,o,s){var n=this.ctx3d,r=e._scene;if(null===n||null===r||!r._webgl||void 0===r.drawableObjects||!r.drawableObjects||"box"===r._vf.pickMode.toLowerCase())return!1;var a,d;arguments.length>4?(a=o,d=s):(a=e._last_mat_view,d=e._last_mat_scene);var h="color"===r._vf.pickMode.toLowerCase()?1:"texcoord"===r._vf.pickMode.toLowerCase()?2:0,l=r._lastMin,_=r._lastMax;this.renderPickingPass(n,r,a,d,l,_,h,t,i);var f=0;if(f>=0&&f<r._webgl.fboPick.pixelData.length){var u=new x3dom.fields.SFVec3f(0,0,0),c=h>0?1:255;u.x=r._webgl.fboPick.pixelData[f+0]/c,u.y=r._webgl.fboPick.pixelData[f+1]/c,u.z=r._webgl.fboPick.pixelData[f+2]/c,0===h&&(u=u.multComponents(_.subtract(l)).add(l));var m=255-r._webgl.fboPick.pixelData[f+3];m>0?(e._pickingInfo.pickPos=u,e._pickingInfo.pickObj=x3dom.nodeTypes.Shape.idMap.nodeID[m]):(e._pickingInfo.pickObj=null,e._pickingInfo.lastClickObj=null)}return!0},e.prototype.renderScene=function(e){var t=this.ctx3d,o=e._scene;if(null!==t&&null!==o){var s,n,r=e._doc._nodeBag.renderTextures,a=r.length;if(o._webgl){var d=Math.round(this.canvas.width*o._webgl.pickScale),h=Math.round(this.canvas.height*o._webgl.pickScale);(o._webgl._currFboWidth!==d||o._webgl._currFboHeight!==h)&&(o._webgl._currFboWidth=d,o._webgl._currFboHeight=h,o._webgl.fboPick=this.initFbo(t,d,h,!0),o._webgl.fboPick.pixelData=null,x3dom.debug.logInfo("Refreshed picking FBO to size ("+d+", "+h+")"))}else{for(o._webgl={},this.setupFgnds(t,o),o._webgl.pickScale=.5,o._webgl._currFboWidth=Math.round(this.canvas.width*o._webgl.pickScale),o._webgl._currFboHeight=Math.round(this.canvas.height*o._webgl.pickScale),o._webgl.fboPick=this.initFbo(t,o._webgl._currFboWidth,o._webgl._currFboHeight,!0),o._webgl.fboPick.pixelData=null,o._webgl.pickShader=i(t,"pick"),o._webgl.pickShaderIG=this.getShaderProgram(t,["vs-x3d-pickIG","fs-x3d-pick"]),o._webgl.pickColorShader=i(t,"vertexcolorUnlit"),o._webgl.pickTexCoordShader=i(t,"texcoordUnlit"),o._webgl.fboShadow=this.initFbo(t,1024,1024,!1),o._webgl.shadowShader=i(t,"shadow"),n=0;a>n;n++)s=r[n],s._webgl={},s._webgl.fbo=this.initFbo(t,s._vf.dimensions[0],s._vf.dimensions[1],!1);var l=x3dom.fields.SFVec3f.MAX(),_=x3dom.fields.SFVec3f.MIN();o.getVolume(l,_,!0),o._lastMin=l,o._lastMax=_}var f=o.getBackground();this.setupScene(t,f);var u,c;this.numFaces=0,this.numCoords=0,o.drawableObjects=null,o.drawableObjects=[],o.drawableObjects.LODs=[],o.drawableObjects.Billboards=[],u=(new Date).getTime(),o.collectDrawableObjects(x3dom.fields.SFMatrix4f.identity(),o.drawableObjects),c=(new Date).getTime()-u,this.canvas.parent.statDiv&&(this.canvas.parent.statDiv.appendChild(document.createElement("br")),this.canvas.parent.statDiv.appendChild(document.createTextNode("traverse: "+c)));var m=e.getViewMatrix();e._last_mat_view=m;var p=e.getWCtoCCMatrix();e._last_mat_scene=p,u=(new Date).getTime();var g,x,v,y,b,T=[],F=o.drawableObjects.length;for(g=0;F>g;g++)y=o.drawableObjects[g][0],b=o.drawableObjects[g][1],this.setupShape(t,b,e),v=b.getCenter(),v=y.multMatrixPnt(v),v=m.multMatrixPnt(v),T[g]=[g,v.z];for(T.sort(function(e,t){return e[1]-t[1]}),x=o.drawableObjects.Billboards.length,F=o.drawableObjects.LODs.length,(x||F)&&(v=new x3dom.fields.SFVec3f(0,0,0),v=m.inverse().multMatrixPnt(v)),g=0;F>g;g++)y=o.drawableObjects.LODs[g][0],b=o.drawableObjects.LODs[g][1],b&&(b._eye=y.inverse().multMatrixPnt(v));for(g=0;x>g;g++)if(y=o.drawableObjects.Billboards[g][0],b=o.drawableObjects.Billboards[g][1]){var w=m.mult(y);b._eye=y.inverse().multMatrixPnt(v),b._eyeViewUp=new x3dom.fields.SFVec3f(w._10,w._11,w._12),b._eyeLook=new x3dom.fields.SFVec3f(w._20,w._21,w._22)}c=(new Date).getTime()-u,this.canvas.parent.statDiv&&(this.canvas.parent.statDiv.appendChild(document.createElement("br")),this.canvas.parent.statDiv.appendChild(document.createTextNode("sort: "+c)));for(var C,E=e.getLights(),S=E.length,M=!1,N=0;S>N;N++)if(E[N]._vf.shadowIntensity>0&&!M){M=!0,u=(new Date).getTime();var A=e.getLightMatrix()[0];C=e.getWCtoLCMatrix(A),this.renderShadowPass(t,o,A,C),c=(new Date).getTime()-u,this.canvas.parent.statDiv&&(this.canvas.parent.statDiv.appendChild(document.createElement("br")),this.canvas.parent.statDiv.appendChild(document.createTextNode("shadow: "+c)))}for(n=0;a>n;n++)this.renderRTPass(t,e,r[n]);u=(new Date).getTime(),t.viewport(0,0,this.canvas.width,this.canvas.height),f._webgl.render(t,p),t.depthFunc(t.LEQUAL),t.enable(t.DEPTH_TEST),t.enable(t.CULL_FACE),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE),t.enable(t.BLEND);var I=[t.TEXTURE0,t.TEXTURE1,t.TEXTURE2,t.TEXTURE3,t.TEXTURE4,t.TEXTURE5,t.TEXTURE6,t.TEXTURE7];for(g=0,F=T.length;F>g;g++){var R=o.drawableObjects[T[g][0]],D=!1;R[1]._cf.appearance.node._cf.blendMode.node&&"none"===R[1]._cf.appearance.node._cf.blendMode.node._vf.srcFactor.toLowerCase()&&"none"===R[1]._cf.appearance.node._cf.blendMode.node._vf.destFactor.toLowerCase()&&(D=!0,t.disable(t.BLEND)),this.renderShape(R[0],R[1],e,E,S,m,p,C,t,I,M),D&&t.enable(t.BLEND)}t.disable(t.BLEND),t.disable(t.DEPTH_TEST),void 0!==e._visDbgBuf&&e._visDbgBuf&&(("idbuf"===o._vf.pickMode.toLowerCase()||"color"===o._vf.pickMode.toLowerCase()||"texcoord"===o._vf.pickMode.toLowerCase())&&(t.viewport(0,3*this.canvas.height/4,this.canvas.width/4,this.canvas.height/4),o._fgnd._webgl.render(t,o._webgl.fboPick.tex)),M&&(t.viewport(this.canvas.width/4,3*this.canvas.height/4,this.canvas.width/4,this.canvas.height/4),o._fgnd._webgl.render(t,o._webgl.fboShadow.tex))),t.flush(),c=(new Date).getTime()-u,this.canvas.parent.statDiv&&(this.canvas.parent.statDiv.appendChild(document.createElement("br")),this.canvas.parent.statDiv.appendChild(document.createTextNode("render: "+c)),this.canvas.parent.statDiv.appendChild(document.createElement("br")),this.canvas.parent.statDiv.appendChild(document.createTextNode("#Tris: "+this.numFaces)),this.canvas.parent.statDiv.appendChild(document.createElement("br")),this.canvas.parent.statDiv.appendChild(document.createTextNode("#Pnts: "+this.numCoords)))}},e.prototype.renderRTPass=function(e,t,i){var o,s,n=t._scene,r=null,a=i.getViewMatrix(),d=i.getWCtoCCMatrix(),h=t.getLightMatrix()[0],l=t.getWCtoLCMatrix(h),_=i._cf.excludeNodes.nodes.length,f=new Array(_);for(o=0;_>o;o++){var u=i._cf.excludeNodes.nodes[o]._vf.render;f[o]=void 0===u?-1:u===!0?1:0,i._cf.excludeNodes.nodes[o]._vf.render=!1}e.bindFramebuffer(e.FRAMEBUFFER,i._webgl.fbo.fbo),e.viewport(0,0,i._webgl.fbo.width,i._webgl.fbo.height),null===i._cf.background.node?(e.clearColor(0,0,0,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT)):i._cf.background.node===n.getBackground()?(r=n.getBackground(),r._webgl.render(e,d)):(r=i._cf.background.node,this.setupScene(e,r),r._webgl.render(e,d)),e.depthFunc(e.LEQUAL),e.enable(e.DEPTH_TEST),e.enable(e.CULL_FACE),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE),e.enable(e.BLEND);var c,m,p=t.getLights(),g=p.length,x=!1,v=[e.TEXTURE0,e.TEXTURE1,e.TEXTURE2,e.TEXTURE3,e.TEXTURE4,e.TEXTURE5,e.TEXTURE6,e.TEXTURE7],y=i._cf.scene.node;if(y&&y!==n)for(y.drawableObjects=[],y.collectDrawableObjects(x3dom.fields.SFMatrix4f.identity(),y.drawableObjects),s=y.drawableObjects.length,o=0;s>o;o++)c=y.drawableObjects[o][0],m=y.drawableObjects[o][1],(void 0===m._vf.render||m._vf.render!==!1)&&(this.setupShape(e,m,t),this.renderShape(c,m,t,p,g,a,d,l,e,v,x));else for(s=n.drawableObjects.length,o=0;s>o;o++)c=n.drawableObjects[o][0],m=n.drawableObjects[o][1],(void 0===m._vf.render||m._vf.render!==!1)&&this.renderShape(c,m,t,p,g,a,d,l,e,v,x);for(e.disable(e.BLEND),e.disable(e.DEPTH_TEST),e.flush(),e.bindFramebuffer(e.FRAMEBUFFER,null),o=0;_>o;o++)0!==f[o]&&(i._cf.excludeNodes.nodes[o]._vf.render=!0)},e.prototype.shutdown=function(e){var t,i,o=this.ctx3d;if(null!==o&&null!==i&&i&&null!==i.drawableObjects){i=e._scene,i.collectDrawableObjects(x3dom.fields.SFMatrix4f.identity(),i.drawableObjects);var s=i.getBackground();void 0!==s._webgl.texture&&s._webgl.texture&&o.deleteTexture(s._webgl.texture),void 0!==s._webgl.shader.position&&(o.deleteBuffer(s._webgl.buffers[1]),o.deleteBuffer(s._webgl.buffers[0]));for(var n=0,r=i.drawableObjects.length;r>n;n++){for(var a=i.drawableObjects[n][1],d=a._webgl.shader,h=0;void 0!==a._webgl.texture&&h<a._webgl.texture.length;h++)a._webgl.texture[h]&&o.deleteTexture(a._webgl.texture[h]);for(var l=0;l<a._webgl.positions.length;l++)void 0!==d.position&&(o.deleteBuffer(a._webgl.buffers[5*l+1]),o.deleteBuffer(a._webgl.buffers[5*l+0])),void 0!==d.normal&&o.deleteBuffer(a._webgl.buffers[5*l+2]),void 0!==d.texcoord&&o.deleteBuffer(a._webgl.buffers[5*l+3]),void 0!==d.color&&o.deleteBuffer(a._webgl.buffers[5*l+4]);for(var _=0;_<a._webgl.dynamicFields.length;_++)t=a._webgl.dynamicFields[_],void 0!==d[t.name]&&o.deleteBuffer(t.buf);a._webgl=null}}},e.prototype.loadCubeMap=function(e,t,i,o){var s=e.createTexture();e.bindTexture(e.TEXTURE_CUBE_MAP,s),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,e.LINEAR),e.bindTexture(e.TEXTURE_CUBE_MAP,null);var n;n=o?[e.TEXTURE_CUBE_MAP_POSITIVE_Z,e.TEXTURE_CUBE_MAP_NEGATIVE_Z,e.TEXTURE_CUBE_MAP_POSITIVE_Y,e.TEXTURE_CUBE_MAP_NEGATIVE_Y,e.TEXTURE_CUBE_MAP_POSITIVE_X,e.TEXTURE_CUBE_MAP_NEGATIVE_X]:[e.TEXTURE_CUBE_MAP_NEGATIVE_Z,e.TEXTURE_CUBE_MAP_POSITIVE_Z,e.TEXTURE_CUBE_MAP_NEGATIVE_Y,e.TEXTURE_CUBE_MAP_POSITIVE_Y,e.TEXTURE_CUBE_MAP_NEGATIVE_X,e.TEXTURE_CUBE_MAP_POSITIVE_X],s.pendingTextureLoads=-1,s.textureCubeReady=!1;for(var r=0;r<n.length;r++){var a=n[r],d=new Image;s.pendingTextureLoads++,i.downloadCount+=1,d.onload=function(t,o,s,n){return function(){e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,n),e.bindTexture(e.TEXTURE_CUBE_MAP,t),e.texImage2D(o,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,s),e.bindTexture(e.TEXTURE_CUBE_MAP,null),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),t.pendingTextureLoads--,i.downloadCount-=1,t.pendingTextureLoads<0&&(t.textureCubeReady=!0,x3dom.debug.logInfo("Loading CubeMap finished..."),i.needRender=!0)}}(s,a,d,o&&(1>=r||r>=4)),d.onerror=function(){i.downloadCount-=1,x3dom.debug.logError("Can't load CubeMap!")},d.src=t[r]}return s},e.prototype.emptyTexImage2D=function(e,t,i,o,s,n){try{e.texImage2D(e.TEXTURE_2D,0,t,i,o,0,s,n,null)}catch(r){var a=3;switch(t){case e.DEPTH_COMPONENT:a=3;break;case e.ALPHA:a=1;break;case e.RGB:a=3;break;case e.RGBA:a=4;break;case e.LUMINANCE:a=1;break;case e.LUMINANCE_ALPHA:a=2}var d=new Uint8Array(i*o*a);e.texImage2D(e.TEXTURE_2D,0,t,i,o,0,s,n,d)}},e.prototype.initTex=function(e,t,i,o){var s=e.createTexture();return e.bindTexture(e.TEXTURE_2D,s),this.emptyTexImage2D(e,e.RGBA,t,i,e.RGBA,e.UNSIGNED_BYTE),o?(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST)):(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR)),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),s.width=t,s.height=i,s},e.prototype.initFbo=function(e,t,i,o){var s=0,n=e.createFramebuffer(),r=e.createRenderbuffer(),a=this.initTex(e,t,i,o);e.bindFramebuffer(e.FRAMEBUFFER,n),e.bindRenderbuffer(e.RENDERBUFFER,r),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,t,i),e.bindRenderbuffer(e.RENDERBUFFER,null),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,a,0),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,r),e.bindFramebuffer(e.FRAMEBUFFER,null),s=e.checkFramebufferStatus(e.FRAMEBUFFER),x3dom.debug.logInfo("FBO-Status: "+s);var d={};return d.fbo=n,d.rbo=r,d.tex=a,d.width=t,d.height=i,d},t}(),x3dom.bridge={setFlashReady:function(e,t){var i=x3dom.canvases[t];i.isFlashReady=!0,x3dom.debug.logInfo("Flash is ready for rendering ("+e+")")},onMouseDown:function(e,t,i,o){var s=x3dom.canvases[o];s.doc.onMousePress(s.gl,e,t,i),s.doc.needRender=!0},onMouseUp:function(e,t,i,o){var s=x3dom.canvases[o];s.doc.onMouseRelease(s.gl,e,t,i),s.doc.needRender=!0},onMouseOver:function(e,t,i,o){var s=x3dom.canvases[o];s.doc.onMouseOver(s.gl,e,t,i),s.doc.needRender=!0},onMouseOut:function(e,t,i,o){var s=x3dom.canvases[o];s.doc.onMouseOut(s.gl,e,t,i),s.doc.needRender=!0},onDoubleClick:function(e,t,i){var o=x3dom.canvases[i];o.doc.onDoubleClick(o.gl,e,t),o.doc.needRender=!0,x3dom.debug.logInfo("dblClick")},onMouseDrag:function(e,t,i,o){var s=x3dom.canvases[o];s.doc.onDrag(s.gl,e,t,i),s.doc.needRender=!0},onMouseMove:function(e,t,i,o){var s=x3dom.canvases[o];s.doc.onMove(s.gl,e,t,i),s.doc.needRender=!0},onMouseWheel:function(e,t,i,o){var s=x3dom.canvases[o];s.doc.onDrag(s.gl,e,t,i),s.doc.needRender=!0},onKeyDown:function(e,t){var i=x3dom.canvases[t],o=i.x3dElem.getAttribute("keysEnabled");o&&"true"!==o.toLowerCase()||i.doc.onKeyPress(e),i.doc.needRender=!0}},x3dom.gfx_flash=function(){function e(e,t){this.object=e,this.name=t}function t(t){return new e(t,"flash")}return e.prototype.getName=function(){return this.name},e.prototype.renderScene=function(e){var t=e._scene;this.setupScene(t,e);var i=t.getBackground();this.setupBackground(i),t.drawableObjects=null,t.drawableObjects=[],t.drawableObjects.LODs=[],t.drawableObjects.Billboards=[],t.collectDrawableObjects(x3dom.fields.SFMatrix4f.identity(),t.drawableObjects);var o=t.drawableObjects.length;if(o>0)for(var s=[],n=0;o>n;n++){var r=t.drawableObjects[n][0],a=t.drawableObjects[n][1];void 0!=s[a._objectID]?s[a._objectID]++:s[a._objectID]=0,this.setupShape(a,r,s[a._objectID])}this.object.renderScene()},e.prototype.setupScene=function(e,t){var i=t.getViewMatrix();this.object.setViewMatrix({viewMatrix:i.toGL()});var o=t.getProjectionMatrix();this.object.setProjectionMatrix({projectionMatrix:o.toGL()});var s=e.getNavigationInfo();s._vf.headlight&&this.object.setLights({idx:0,type:0,on:1,color:[1,1,1],intensity:1,ambientIntensity:0,direction:[0,0,1],attenuation:[1,1,1],location:[1,1,1],radius:0,beamWidth:0,cutOffAngle:0});for(var n=t.getLights(),r=0;r<n.length;r++)n[r]._dirty&&(x3dom.isa(n[r],x3dom.nodeTypes.DirectionalLight)?x3dom.debug.logInfo(n[r]._lightID):x3dom.isa(n[r],x3dom.nodeTypes.PointLight)||x3dom.isa(n[r],x3dom.nodeTypes.SpotLight),n[r]._dirty=!1)},e.prototype.setupBackground=function(e){e._dirty&&(this.object.setBackground({texURLs:e.getTexUrl(),skyAngle:e._vf.skyAngle,skyColor:e.getSkyColor().toGL(),groundAngle:e._vf.groundAngle,groundColor:e.getGroundColor().toGL(),transparency:e.getTransparency()}),e._dirty=!1)},e.prototype.setupShape=function(e,t,i){return x3dom.isa(e._cf.geometry.node,x3dom.nodeTypes.PointSet)?void x3dom.debug.logError("Flash backend don't support PointSets yet"):x3dom.isa(e._cf.geometry.node,x3dom.nodeTypes.IndexedLineSet)?void x3dom.debug.logError("Flash backend don't support LineSets yet"):void(x3dom.isa(e._cf.geometry.node,x3dom.nodeTypes.Text)?this.setupText(e,t,i):this.setupIndexedFaceSet(e,t,i))},e.prototype.setupIndexedFaceSet=function(e,t,i){if(this.object.setMeshTransform({id:e._objectID,refID:i,transform:t.toGL()}),0==i){var o=x3dom.isa(e._cf.geometry.node,x3dom.nodeTypes.ImageGeometry);if(e._dirty.indexes===!0){if(!o)for(var s=0;s<e._cf.geometry.node._mesh._indices.length;s++)this.object.setMeshIndices({id:e._objectID,idx:s,indices:e._cf.geometry.node._mesh._indices[s]});e._dirty.indexes=!1}if(e._dirty.positions===!0){if(o)this.object.setMeshVerticesTexture({id:e._objectID,idx:0,bboxMin:e._cf.geometry.node.getMin().toGL(),bboxMax:e._cf.geometry.node.getMax().toGL(),bboxCenter:e._cf.geometry.node.getCenter(),primType:e._cf.geometry.node._vf.primType,vertexCount:e._cf.geometry.node._vf.vertexCount,coordinateTexture0:e._cf.geometry.node.getCoordinateTextureURL(0),coordinateTexture1:e._cf.geometry.node.getCoordinateTextureURL(1)});else for(var s=0;s<e._cf.geometry.node._mesh._positions.length;s++)this.object.setMeshVertices({id:e._objectID,idx:s,vertices:e._cf.geometry.node._mesh._positions[s]});e._dirty.positions=!1}if(e._dirty.normals===!0){if(o)this.object.setMeshNormalsTexture({id:e._objectID,idx:0,normalTexture:e._cf.geometry.node.getNormalTextureURL(0)});else if(e._cf.geometry.node._mesh._normals[0].length)for(var s=0;s<e._cf.geometry.node._mesh._normals.length;s++)this.object.setMeshNormals({id:e._objectID,idx:s,normals:e._cf.geometry.node._mesh._normals[s]});e._dirty.normals=!1}if(e._dirty.colors===!0){if(!o&&e._cf.geometry.node._mesh._colors[0].length)for(var s=0;s<e._cf.geometry.node._mesh._colors.length;s++)this.object.setMeshColors({id:e._objectID,idx:s,colors:e._cf.geometry.node._mesh._colors[s],components:e._cf.geometry.node._mesh._numColComponents});e._dirty.colors=!1}if(e._dirty.texcoords===!0){if(o)this.object.setMeshTexCoordsTexture({id:e._objectID,idx:0,texCoordTexture:e._cf.geometry.node.getTexCoordTextureURL()});else if(e._cf.geometry.node._mesh._texCoords[0].length)for(var s=0;s<e._cf.geometry.node._mesh._texCoords.length;s++)this.object.setMeshTexCoords({id:e._objectID,idx:s,texCoords:e._cf.geometry.node._mesh._texCoords[s]});e._dirty.texcoords=!1}if(e._dirty.material===!0){var n=e._cf.appearance.node._cf.material.node;this.object.setMeshMaterial({id:e._objectID,ambientIntensity:n._vf.ambientIntensity,diffuseColor:n._vf.diffuseColor.toGL(),emissiveColor:n._vf.emissiveColor.toGL(),shininess:n._vf.shininess,specularColor:n._vf.specularColor.toGL(),transparency:n._vf.transparency}),e._dirty.material=!1}if(e._dirty.texture===!0){var r=e._cf.appearance.node._cf.texture.node;if(r){var a=void 0!==r._video&&null!==r._video&&void 0!==r._needPerFrameUpdate&&r._needPerFrameUpdate===!0;x3dom.isa(r,x3dom.nodeTypes.PixelTexture)?this.object.setPixelTexture({id:e._objectID,width:r._vf.image.width,height:r._vf.image.height,comp:r._vf.image.comp,pixels:r._vf.image.toGL()}):r._isCanvas&&r._canvas||(x3dom.isa(r,x3dom.nodeTypes.ComposedCubeMapTexture)?this.object.setCubeTexture({id:e._objectID,texURLs:r.getTexUrl()}):x3dom.isa(r,x3dom.nodeTypes.MultiTexture)?x3dom.debug.logError("Flash backend don't support MultiTextures yet"):x3dom.isa(r,x3dom.nodeTypes.MovieTexture)||a?x3dom.debug.logError("Flash backend don't support MovieTextures yet"):this.object.setMeshTexture({id:e._objectID,origChannelCount:r._vf.origChannelCount,repeatS:r._vf.repeatS,repeatT:r._vf.repeatT,url:r._vf.url[0]}))}e._dirty.texture=!1}if(this.object.setMeshSolid({id:e._objectID,solid:e.isSolid()}),void 0!==e._cf.geometry.node._cf.texCoord&&null!==e._cf.geometry.node._cf.texCoord.node&&!x3dom.isa(e._cf.geometry.node._cf.texCoord.node,x3dom.nodeTypes.X3DTextureNode)&&e._cf.geometry.node._cf.texCoord.node._vf.mode){var d=e._cf.geometry.node._cf.texCoord.node._vf.mode;this.object.setSphereMapping("sphere"==d.toLowerCase()?{id:e._objectID,sphereMapping:1}:{id:e._objectID,sphereMapping:0})}else this.object.setSphereMapping({id:e._objectID,sphereMapping:0})}},e.prototype.setupText=function(e,t,i){if(this.object.setMeshTransform({id:e._objectID,refID:i,transform:t.toGL()}),0==i){if(e._dirty.text===!0){var o=e._cf.geometry.node._cf.fontStyle.node;this.object.setText(null===o?{id:e._objectID,text:e._cf.geometry.node._vf.string,fontFamily:["SERIF"],fontStyle:"PLAIN",fontAlign:"BEGIN",fontSize:32,fontSpacing:1,fontHorizontal:!0,fontLanguage:"",fontLeftToRight:!0,fontTopToBottom:!0}:{id:e._objectID,text:e._cf.geometry.node._vf.string,fontFamily:o._vf.family.toString(),fontStyle:o._vf.style.toString(),fontAlign:o._vf.justify.toString(),fontSize:o._vf.size,fontSpacing:o._vf.spacing,fontHorizontal:o._vf.horizontal,fontLanguage:o._vf.language,fontLeftToRight:o._vf.leftToRight,fontTopToBottom:o._vf.topToBottom}),e._dirty.text=!1}if(e._dirty.material===!0){var s=e._cf.appearance.node._cf.material.node;this.object.setMeshMaterial({id:e._objectID,ambientIntensity:s._vf.ambientIntensity,diffuseColor:s._vf.diffuseColor.toGL(),emissiveColor:s._vf.emissiveColor.toGL(),shininess:s._vf.shininess,specularColor:s._vf.specularColor.toGL(),transparency:s._vf.transparency}),e._dirty.material=!1}this.object.setMeshSolid({id:e._objectID,solid:e.isSolid()})}},e.prototype.pickValue=function(e){var t=e._scene;if(null===this.object||null===t||void 0===t.drawableObjects||!t.drawableObjects||"box"===t._vf.pickMode.toLowerCase())return!1;var i="color"===t._vf.pickMode.toLowerCase()?1:"texcoord"===t._vf.pickMode.toLowerCase()?2:0,o=this.object.pickValue({pickMode:i});return o.objID>0?(e._pickingInfo.pickPos=new x3dom.fields.SFVec3f(o.pickPosX,o.pickPosY,o.pickPosZ),e._pickingInfo.pickObj=x3dom.nodeTypes.Shape.idMap.nodeID[o.objID]):(e._pickingInfo.pickObj=null,e._pickingInfo.lastClickObj=null),!0},e.prototype.shutdown=function(){},t}(),x3dom.X3DDocument=function(e,t,i){this.properties=i,this.canvas=e,this.ctx=t,this.needRender=!0,this._scene=null,this._viewarea=null,this._nodeBag={timer:[],lights:[],clipPlanes:[],followers:[],trans:[],renderTextures:[],viewarea:[]},this.downloadCount=0,this.onload=function(){},this.onerror=function(){}},x3dom.X3DDocument.prototype.load=function(e,t){function i(){if(0===s.length)return n._setup(o[e],o,t),void n.onload();var r=s.shift();
!x3dom.isX3DElement(r)||"x3d"!==r.localName.toLowerCase()&&"websg"!==r.localName.toLowerCase()||(o[r]=r,i())}var o={},s=[e],n=this;i()},x3dom.findScene=function(e){for(var t=[],i=0;i<e.childNodes.length;i++){var o=e.childNodes[i];o&&o.localName&&"scene"===o.localName.toLowerCase()&&t.push(o)}return t.length>1?(x3dom.debug.logError("X3D element has more than one Scene child (has "+e.childNodes.length+")."),null):t[0]},x3dom.X3DDocument.prototype._setup=function(e){var t=this,i={onAttrModified:function(e){if("_x3domNode"in e.target){e.target._x3domNode.updateField(e.attrName,e.newValue),t.needRender=!0}},onNodeRemoved:function(e){if("_x3domNode"in e.target.parentNode&&"_x3domNode"in e.target){var i=e.target.parentNode._x3domNode,o=e.target._x3domNode;i&&(i.removeChild(o),t.needRender=!0)}},onNodeInserted:function(e){if("_x3domNode"in e.target.parentNode){if("Inline"==e.target.parentNode.tagName||"INLINE"==e.target.parentNode.tagName||"inline"==e.target.parentNode.tagName)return;var i=e.target.parentNode._x3domNode,o=e.target;if(i._nameSpace){var s=i._nameSpace.setupTree(o);i.addChild(s,o.getAttribute("containerField")),t.needRender=!0}else x3dom.debug.logWarning("No _nameSpace in onNodeInserted")}}};e.addEventListener("DOMNodeRemoved",i.onNodeRemoved,!0),e.addEventListener("DOMNodeInserted",i.onNodeInserted,!0),x3dom.userAgentFeature.supportsDOMAttrModified===!0&&e.addEventListener("DOMAttrModified",i.onAttrModified,!0);var o=x3dom.findScene(e);this._bindableBag=new x3dom.BindableBag(this);var s=new x3dom.NodeNameSpace("scene",t),n=s.setupTree(o);this._scene=n,this._bindableBag.setRefNode(n),this._viewarea=new x3dom.Viewarea(this,n),this._viewarea._width=this.canvas.width,this._viewarea._height=this.canvas.height},x3dom.X3DDocument.prototype.advanceTime=function(e){var t,i;if(this._nodeBag.timer.length)for(this.needRender=!0,i=0;i<this._nodeBag.timer.length;i++)this._nodeBag.timer[i].onframe(e);if(this._nodeBag.followers.length)for(t=this,i=0;i<this._nodeBag.followers.length;i++)this.needRender|=this._nodeBag.followers[i].tick(e);if(this._nodeBag.trans.length)for(t=this,i=0;i<this._nodeBag.trans.length;i++)this.needRender|=this._nodeBag.trans[i].tick(e);if(this._nodeBag.viewarea.length)for(t=this,i=0;i<this._nodeBag.viewarea.length;i++)this.needRender|=this._nodeBag.viewarea[i].tick(e)},x3dom.X3DDocument.prototype.render=function(e){e&&this._viewarea&&e.renderScene(this._viewarea)},x3dom.X3DDocument.prototype.onMove=function(e,t,i,o){e&&this._viewarea&&(e.pickValue(this._viewarea,t,i),this._viewarea.onMove(t,i,o))},x3dom.X3DDocument.prototype.onMoveView=function(e,t,i){e&&this._viewarea&&this._viewarea.onMoveView(t,i)},x3dom.X3DDocument.prototype.onDrag=function(e,t,i,o){e&&this._viewarea&&(e.pickValue(this._viewarea,t,i),this._viewarea.onDrag(t,i,o))},x3dom.X3DDocument.prototype.onMousePress=function(e,t,i,o){if(e&&this._viewarea){var s=x3dom.fields.SFVec3f.MAX(),n=x3dom.fields.SFVec3f.MIN();this._viewarea._scene.getVolume(s,n,!0),this._viewarea._scene._lastMin=s,this._viewarea._scene._lastMax=n,e.pickValue(this._viewarea,t,i),this._viewarea.onMousePress(t,i,o)}},x3dom.X3DDocument.prototype.onMouseRelease=function(e,t,i,o){e&&this._viewarea&&(e.pickValue(this._viewarea,t,i),this._viewarea.onMouseRelease(t,i,o))},x3dom.X3DDocument.prototype.onMouseOver=function(e,t,i,o){e&&this._viewarea&&(e.pickValue(this._viewarea,t,i),this._viewarea.onMouseOver(t,i,o))},x3dom.X3DDocument.prototype.onMouseOut=function(e,t,i,o){e&&this._viewarea&&(e.pickValue(this._viewarea,t,i),this._viewarea.onMouseOut(t,i,o))},x3dom.X3DDocument.prototype.onDoubleClick=function(e,t,i){e&&this._viewarea&&this._viewarea.onDoubleClick(t,i)},x3dom.X3DDocument.prototype.onTouchMove=function(e){e&&this._viewarea&&x3dom.debug.logWarning("onTouchMove not implemented")},x3dom.X3DDocument.prototype.onKeyDown=function(e){switch(e){case 37:this._viewarea.strafeLeft();break;case 38:this._viewarea.moveFwd();break;case 39:this._viewarea.strafeRight();break;case 40:this._viewarea.moveBwd()}},x3dom.X3DDocument.prototype.onKeyUp=function(e){var t=null;switch(e){case 27:window.history.back();break;case 33:t=this._scene.getViewpoint()._stack,t?t.switchTo("next"):x3dom.debug.logError("No valid ViewBindable stack.");break;case 34:t=this._scene.getViewpoint()._stack,t?t.switchTo("prev"):x3dom.debug.logError("No valid ViewBindable stack.");break;case 37:break;case 38:break;case 39:break;case 40:}},x3dom.X3DDocument.prototype.onKeyPress=function(e){var t=this._scene.getNavigationInfo();switch(e){case 32:var i=this.canvas.parent.statDiv;i&&(i.style.display="none"==i.style.display?"inline":"none"),x3dom.debug.logInfo("a: show all | d: show helper buffers | s: light view | m: toggle render mode | p: intersect type | r: reset view | e: examine mode | f: fly mode | w: walk mode | l: lookAt mode | g: game mode | u: upright position");break;case 43:t._vf.speed=2*t._vf.speed,x3dom.debug.logInfo("Changed navigation speed to "+t._vf.speed);break;case 45:t._vf.speed=.5*t._vf.speed,x3dom.debug.logInfo("Changed navigation speed to "+t._vf.speed);break;case 97:this._viewarea.showAll();break;case 100:this._viewarea._visDbgBuf=void 0===this._viewarea._visDbgBuf?!0:!this._viewarea._visDbgBuf,x3dom.debug.logContainer.style.display=this._viewarea._visDbgBuf===!0?"block":"none";break;case 101:t.setType("examine",this._viewarea);break;case 102:t.setType("fly",this._viewarea);break;case 103:t.setType("game",this._viewarea);break;case 108:t.setType("lookat",this._viewarea);break;case 109:this._viewarea._points=void 0===this._viewarea._points?!0:!this._viewarea._points;break;case 111:t.setType("lookaround",this._viewarea);break;case 112:switch(this._scene._vf.pickMode.toLowerCase()){case"idbuf":this._scene._vf.pickMode="color";break;case"color":this._scene._vf.pickMode="texCoord";break;case"texcoord":this._scene._vf.pickMode="box";break;default:this._scene._vf.pickMode="idBuf"}x3dom.debug.logInfo("Switch pickMode to '"+this._scene._vf.pickMode+"'.");break;case 114:this._viewarea.resetView();break;case 115:this._nodeBag.lights.length>0&&this._viewarea.animateTo(this._viewarea.getLightMatrix()[0],this._scene.getViewpoint());break;case 117:this._viewarea.uprightView();break;case 119:t.setType("walk",this._viewarea)}},x3dom.X3DDocument.prototype.shutdown=function(e){e&&e.shutdown(this._viewarea)},x3dom.MatrixMixer=function(e,t){0===arguments.length?(this._beginTime=0,this._endTime=0):(this._beginTime=e,this._endTime=t),this._beginMat=x3dom.fields.SFMatrix4f.identity(),this._beginInvMat=x3dom.fields.SFMatrix4f.identity(),this._beginLogMat=x3dom.fields.SFMatrix4f.identity(),this._endMat=x3dom.fields.SFMatrix4f.identity(),this._endLogMat=x3dom.fields.SFMatrix4f.identity()},x3dom.MatrixMixer.prototype.calcFraction=function(e){var t=(e-this._beginTime)/(this._endTime-this._beginTime);return(Math.sin(t*Math.PI-Math.PI/2)+1)/2},x3dom.MatrixMixer.prototype.setBeginMatrix=function(e){this._beginMat.setValues(e),this._beginInvMat=e.inverse(),this._beginLogMat=x3dom.fields.SFMatrix4f.zeroMatrix()},x3dom.MatrixMixer.prototype.setEndMatrix=function(e){this._endMat.setValues(e),this._endLogMat=e.mult(this._beginInvMat).log()},x3dom.MatrixMixer.prototype.mix=function(e){var t=x3dom.fields.SFMatrix4f.zeroMatrix();if(e<=this._beginTime)t.setValues(this._beginLogMat);else if(e>=this._endTime)t.setValues(this._endLogMat);else{var i=this.calcFraction(e);t=this._endLogMat.addScaled(this._beginLogMat,-1),t=t.multiply(i).add(this._beginLogMat)}return t=t.exp().mult(this._beginMat)},x3dom.Viewarea=function(e,t){this._doc=e,this._scene=t,e._nodeBag.viewarea.push(this),this._pickingInfo={pickPos:{},pickObj:null,lastObj:null,lastClickObj:null},this._rotMat=x3dom.fields.SFMatrix4f.identity(),this._transMat=x3dom.fields.SFMatrix4f.identity(),this._movement=new x3dom.fields.SFVec3f(0,0,0),this._needNavigationMatrixUpdate=!0,this._deltaT=0,this._pitch=0,this._yaw=0,this._eyePos=new x3dom.fields.SFVec3f(0,0,0),this._width=400,this._height=300,this._dx=0,this._dy=0,this._lastX=-1,this._lastY=-1,this._pressX=-1,this._pressY=-1,this._lastButton=0,this._pick=new x3dom.fields.SFVec3f(0,0,0),this._lastTS=0,this._mixer=new x3dom.MatrixMixer,this._geoCache=[]},x3dom.Viewarea.prototype.tick=function(e){var t=!1;if(this._mixer._beginTime>0)if(t=!0,e>=this._mixer._beginTime)if(e<=this._mixer._endTime){var i=this._mixer.mix(e);this._scene.getViewpoint().setView(i)}else this._mixer._beginTime=0,this._mixer._endTime=0,this._scene.getViewpoint().setView(this._mixer._endMat);else this._scene.getViewpoint().setView(this._mixer._beginMat);var o=this.navigateTo(e);return this._lastTS=e,t||o},x3dom.Viewarea.prototype.navigateTo=function(e){var t=this._scene.getNavigationInfo(),i="game"===t._vf.type[0].toLowerCase()||this._lastButton>0&&("fly"===t._vf.type[0].toLowerCase()||"walk"===t._vf.type[0].toLowerCase()||"looka"===t._vf.type[0].toLowerCase().substr(0,5));if(this._deltaT=e-this._lastTS,i){var o=.25,s=1.6,n=.75;t._vf.avatarSize.length>2&&(o=t._vf.avatarSize[0],s=t._vf.avatarSize[1],n=t._vf.avatarSize[2]);var r=this.getViewMatrix(),a=0,d=2&this._lastButton?-1:1;d*=this._deltaT*t._vf.speed;var h=Math.PI*this._deltaT*(this._pressX-this._lastX)/this._width,l=Math.PI*this._deltaT*(this._pressY-this._lastY)/this._height;if(this._needNavigationMatrixUpdate===!0){this._needNavigationMatrixUpdate=!1,this._rotMat=x3dom.fields.SFMatrix4f.identity(),this._transMat=x3dom.fields.SFMatrix4f.identity(),this._movement=new x3dom.fields.SFVec3f(0,0,0);var _=0,f=Math.asin(r._02),u=Math.cos(f);Math.abs(u)>1e-4&&(_=Math.atan2(-r._12/u,r._22/u)),this._flyMat=r.inverse(),this._from=this._flyMat.e3(),this._at=this._from.subtract(this._flyMat.e2()),this._up=new x3dom.fields.SFVec3f(0,1,0),this._pitch=180*_/Math.PI,this._yaw=180*f/Math.PI,this._eyePos=this._from.negate()}var c=null,m=null,p=null;if("game"===t._vf.type[0].toLowerCase()){this._pitch+=this._dy,this._yaw+=this._dx,this._pitch>=89&&(this._pitch=89),this._pitch<=-89&&(this._pitch=-89),this._yaw>=360&&(this._yaw-=360),this._yaw<0&&(this._yaw=360+this._yaw),this._dx=0,this._dy=0;var g=x3dom.fields.SFMatrix4f.rotationX(this._pitch/180*Math.PI),x=x3dom.fields.SFMatrix4f.rotationY(this._yaw/180*Math.PI),v=x3dom.fields.SFMatrix4f.translation(this._eyePos);this._flyMat=g.mult(x).mult(v);var y=this._flyMat.inverse(),b=y.e3();return m=new x3dom.fields.SFVec3f(0,-1,0),c=b.add(m),m=y.e0().cross(m).normalize(),p=x3dom.fields.SFMatrix4f.lookAt(b,c,m),p=p.inverse(),this._scene._nameSpace.doc.ctx.pickValue(this,this._width/2,this._height/2,p,this.getProjectionMatrix().mult(p)),this._pickingInfo.pickObj&&(a=this._pickingInfo.pickPos.subtract(b).length(),b.y+=s-a,y.setTranslate(b),this._eyePos=y.e3().negate(),this._flyMat=y.inverse(),this._pickingInfo.pickObj=null),this._scene.getViewpoint().setView(this._flyMat),i}var T=x3dom.fields.Quaternion.axisAngle(this._up,h),F=T.toMatrix(),w=x3dom.fields.SFMatrix4f.translation(this._from);w=w.mult(F),F=x3dom.fields.SFMatrix4f.translation(this._from.negate()),w=w.mult(F),this._at=w.multMatrixPnt(this._at);var C=this._at.subtract(this._from).normalize(),E=C.cross(this._up).normalize(),S=E.cross(C).normalize();T=x3dom.fields.Quaternion.axisAngle(E,l),F=T.toMatrix(),w=x3dom.fields.SFMatrix4f.translation(this._from),w=w.mult(F),F=x3dom.fields.SFMatrix4f.translation(this._from.negate()),w=w.mult(F),this._at=w.multMatrixPnt(this._at),"looka"!==t._vf.type[0].toLowerCase().substr(0,5)&&(this._scene._nameSpace.doc.ctx.pickValue(this,this._width/2,this._height/2),this._pickingInfo.pickObj&&(a=this._pickingInfo.pickPos.subtract(this._from).length(),d>0&&o>=a&&(d=0)),C=this._at.subtract(this._from).normalize().multiply(d),this._at=this._at.add(C),this._from=this._from.add(C),"walk"===t._vf.type[0].toLowerCase()&&(c=this._from.addScaled(S,-1),m=E.cross(S.negate()).normalize(),p=x3dom.fields.SFMatrix4f.lookAt(this._from,c,m),p=p.inverse(),this._scene._nameSpace.doc.ctx.pickValue(this,this._width/2,this._height/2,p,this.getProjectionMatrix().mult(p)),this._pickingInfo.pickObj&&(a=this._pickingInfo.pickPos.subtract(this._from).length(),this._at=this._at.add(S.multiply(s-a)),this._from=this._from.add(S.multiply(s-a)))),this._pickingInfo.pickObj=null),this._flyMat=x3dom.fields.SFMatrix4f.lookAt(this._from,this._at,S),this._scene.getViewpoint().setView(this._flyMat.inverse())}return i},x3dom.Viewarea.prototype.moveFwd=function(){var e=this._scene.getNavigationInfo();if("game"===e._vf.type[0].toLowerCase()){var t=.25,i=1.6;e._vf.avatarSize.length>2&&(t=e._vf.avatarSize[0],i=e._vf.avatarSize[1]);var o=5*this._deltaT*e._vf.speed,s=this._yaw/180*Math.PI,n=this._pitch/180*Math.PI,r=0,a=this._flyMat.inverse();this._scene._nameSpace.doc.ctx.pickValue(this,this._width/2,this._height/2),this._pickingInfo.pickObj&&(r=this._pickingInfo.pickPos.subtract(a.e3()).length(),2*t>=r||(this._eyePos.x-=Math.sin(s)*o,this._eyePos.z+=Math.cos(s)*o,this._eyePos.y+=Math.sin(n)*o))}},x3dom.Viewarea.prototype.moveBwd=function(){var e=this._scene.getNavigationInfo();if("game"===e._vf.type[0].toLowerCase()){var t=5*this._deltaT*e._vf.speed,i=this._yaw/180*Math.PI,o=this._pitch/180*Math.PI;this._eyePos.x+=Math.sin(i)*t,this._eyePos.z-=Math.cos(i)*t,this._eyePos.y-=Math.sin(o)*t}},x3dom.Viewarea.prototype.strafeRight=function(){var e=this._scene.getNavigationInfo();if("game"===e._vf.type[0].toLowerCase()){var t=5*this._deltaT*e._vf.speed,i=this._yaw/180*Math.PI;this._eyePos.x-=Math.cos(i)*t,this._eyePos.z-=Math.sin(i)*t}},x3dom.Viewarea.prototype.strafeLeft=function(){var e=this._scene.getNavigationInfo();if("game"===e._vf.type[0].toLowerCase()){var t=5*this._deltaT*e._vf.speed,i=this._yaw/180*Math.PI;this._eyePos.x+=Math.cos(i)*t,this._eyePos.z+=Math.sin(i)*t}},x3dom.Viewarea.prototype.animateTo=function(e,t,i){var o=this._scene.getNavigationInfo();if(x3dom.isa(e,x3dom.nodeTypes.Viewpoint)&&(e=e.getViewMatrix()),"teleport"!==o._vf.transitionType[0].toLowerCase()&&"game"!==o.getType()){if(!t||!x3dom.isa(t,x3dom.nodeTypes.Viewpoint))return;t=t.getCurrentTransform().mult(t.getViewMatrix()).mult(this._transMat).mult(this._rotMat),this._mixer._beginTime=this._lastTS,this._mixer._endTime=arguments.length>=3?this._lastTS+i:this._lastTS+o._vf.transitionTime,this._mixer.setBeginMatrix(t),this._mixer.setEndMatrix(e)}else this._scene.getViewpoint().setView(e);this._rotMat=x3dom.fields.SFMatrix4f.identity(),this._transMat=x3dom.fields.SFMatrix4f.identity(),this._movement=new x3dom.fields.SFVec3f(0,0,0),this._needNavigationMatrixUpdate=!0},x3dom.Viewarea.prototype.getLights=function(){return this._doc._nodeBag.lights},x3dom.Viewarea.prototype.getLightsShadow=function(){for(var e=this._doc._nodeBag.lights,t=0;t<e.length;t++)if(e[t]._vf.shadowIntensity>0)return!0},x3dom.Viewarea.prototype.getViewpointMatrix=function(){var e=this._scene.getViewpoint(),t=e.getCurrentTransform();return e.getViewMatrix().mult(t.inverse())},x3dom.Viewarea.prototype.getViewMatrix=function(){return this.getViewpointMatrix().mult(this._transMat).mult(this._rotMat)},x3dom.Viewarea.prototype.getLightMatrix=function(){var e,t=this._doc._nodeBag.lights,i=t.length;if(i>0){var o=x3dom.fields.SFVec3f.MAX(),s=x3dom.fields.SFVec3f.MIN(),n=this._scene.getVolume(o,s,!0);if(n){var r=[],a=this._scene.getViewpoint(),d=a.getFieldOfView(),h=s.subtract(o),l=h.y/2/Math.tan(d/2)+h.z/2,_=h.x/2/Math.tan(d/2)+h.z/2;for(h=o.add(h.multiply(.5)),e=0;i>e;e++){if(x3dom.isa(t[e],x3dom.nodeTypes.PointLight))h=h.subtract(t[e]._vf.location).normalize();else{var f=t[e]._vf.direction.normalize().negate();h=h.add(f.multiply(1.2*(l>_?l:_)))}r[e]=t[e].getViewMatrix(h)}return r}}return[this.getViewMatrix()]},x3dom.Viewarea.prototype.getWCtoLCMatrix=function(e){var t,i=this.getProjectionMatrix();return t=0===arguments.length?this.getLightMatrix()[0]:e,i.mult(t)},x3dom.Viewarea.prototype.getProjectionMatrix=function(){var e=this._scene.getViewpoint();return e.getProjectionMatrix(this._width/this._height)},x3dom.Viewarea.prototype.getWCtoCCMatrix=function(){var e=this.getViewMatrix(),t=this.getProjectionMatrix();return t.mult(e)},x3dom.Viewarea.prototype.getCCtoWCMatrix=function(){var e=this.getWCtoCCMatrix();return e.inverse()},x3dom.Viewarea.prototype.calcViewRay=function(e,t){var i=this.getCCtoWCMatrix(),o=e/(this._width-1)*2-1,s=(this._height-1-t)/(this._height-1)*2-1,n=i.multFullMatrixPnt(new x3dom.fields.SFVec3f(o,s,-1)),r=i.multFullMatrixPnt(new x3dom.fields.SFVec3f(o,s,1)),a=r.subtract(n);return new x3dom.fields.Line(n,a)},x3dom.Viewarea.prototype.showAll=function(){var e=x3dom.fields.SFVec3f.MAX(),t=x3dom.fields.SFVec3f.MIN(),i=this._scene.getVolume(e,t,!0);if(i){var o=this._scene.getViewpoint(),s=o.getFieldOfView(),n=t.subtract(e),r=n.y/2/Math.tan(s/2)+n.z/2,a=n.x/2/Math.tan(s/2)+n.z/2;n=e.add(n.multiply(.5)),n.z+=r>a?r:a,this.animateTo(x3dom.fields.SFMatrix4f.translation(n.multiply(-1)),o)}},x3dom.Viewarea.prototype.resetView=function(){var e=this._scene.getNavigationInfo();"teleport"!==e._vf.transitionType[0].toLowerCase()&&"game"!==e.getType()?(this._mixer._beginTime=this._lastTS,this._mixer._endTime=this._lastTS+e._vf.transitionTime,this._mixer.setBeginMatrix(this.getViewMatrix()),this._scene.getViewpoint().resetView(),this._mixer.setEndMatrix(this._scene.getViewpoint().getViewMatrix())):this._scene.getViewpoint().resetView(),this._rotMat=x3dom.fields.SFMatrix4f.identity(),this._transMat=x3dom.fields.SFMatrix4f.identity(),this._movement=new x3dom.fields.SFVec3f(0,0,0),this._needNavigationMatrixUpdate=!0},x3dom.Viewarea.prototype.uprightView=function(){var e=this.getViewMatrix().inverse(),t=e.e3(),i=t.subtract(e.e2()),o=new x3dom.fields.SFVec3f(0,1,0),s=e.e2().cross(o).normalize(),n=s.cross(o).normalize();i=t.add(n),e=x3dom.fields.SFMatrix4f.lookAt(t,i,o),e=e.inverse(),this.animateTo(e,this._scene.getViewpoint())},x3dom.Viewarea.prototype.callEvtHandler=function(e,t,i){i.target=e._xmlNode;var o=e._xmlNode[t];try{if("function"==typeof o)o.call(e._xmlNode,i);else{var s=e._xmlNode.getAttribute(t),n=new Function("event",s);n.call(e._xmlNode,i)}var r=e._listeners[i.type];if(r)for(var a=0;a<r.length;a++)r[a].call(e._xmlNode,i)}catch(d){x3dom.debug.logException(d)}return i.cancelBubble},x3dom.Viewarea.prototype.checkEvents=function(e,t,i,o,s){var n=this,r=!0,a={target:{},type:s.substr(2,s.length-2),button:o,layerX:t,layerY:i,worldX:n._pick.x,worldY:n._pick.y,worldZ:n._pick.z,hitPnt:n._pick.toGL(),hitObject:e._xmlNode?e._xmlNode:null,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0}};try{var d=e;d._xmlNode[s]||d._xmlNode.hasAttribute(s)||d._listeners[a.type]||(d=d._cf.geometry.node),n.callEvtHandler(d,s,a)===!0&&(r=!1)}catch(h){x3dom.debug.logException(h)}var l=function(e){Array.forEach(e._parentNodes,function(e){e._xmlNode&&(e._xmlNode[s]||e._xmlNode.hasAttribute(s)||e._listeners[a.type])&&n.callEvtHandler(e,s,a)===!0&&(r=!1),x3dom.isa(e,x3dom.nodeTypes.Anchor)&&"onclick"===s?(e.handleTouch(),r=!1):r&&l(e)})};r&&l(e)},x3dom.Viewarea.prototype.initMouseState=function(){this._deltaT=0,this._dx=0,this._dy=0,this._lastX=-1,this._lastY=-1,this._pressX=-1,this._pressY=-1,this._lastButton=0,this._needNavigationMatrixUpdate=!0},x3dom.Viewarea.prototype.onMousePress=function(e,t,i){this._needNavigationMatrixUpdate=!0,this.prepareEvents(e,t,i,"onmousedown"),this._pickingInfo.lastClickObj=this._pickingInfo.pickObj,this._dx=0,this._dy=0,this._lastX=e,this._lastY=t,this._pressX=e,this._pressY=t,this._lastButton=i},x3dom.Viewarea.prototype.onMouseRelease=function(e,t,i){var o,s=3,n=this._scene.getNavigationInfo();if("box"!==this._scene._vf.pickMode.toLowerCase())this.prepareEvents(e,t,i,"onmouseup"),this._pickingInfo.pickObj&&this._pickingInfo.pickObj===this._pickingInfo.lastClickObj&&this.prepareEvents(e,t,i,"onclick");else{var r=(new Date).getTime(),a=this.calcViewRay(e,t),d=this._scene.doIntersect(a),h=a.hitObject;d&&h&&(this._pick.setValues(a.hitPoint),this.checkEvents(h,e,t,i,"onclick"),x3dom.debug.logInfo("Hit '"+h._xmlNode.localName+"/ "+h._DEF+"' at dist="+a.dist.toFixed(4)),x3dom.debug.logInfo("Ray hit at position "+this._pick));var l=(new Date).getTime()-r;if(x3dom.debug.logInfo("Picking time (box): "+l+"ms"),!d){o=this.getViewMatrix().e2().negate();var _=o.dot(a.pos.negate())/o.dot(a.dir);this._pick=a.pos.add(a.dir.multiply(_))}}if(this._pickingInfo.pickObj&&"lookat"===n._vf.type[0].toLowerCase()&&this._pressX===e&&this._pressY===t){var f=2&this._lastButton?-1:1,u=this._pickingInfo.pickPos.subtract(this._from).length()/s,c=new x3dom.fields.SFMatrix4f;c.setValues(this.getViewMatrix()),c=c.inverse();{var m=c.e3();m.subtract(c.e2()),c.e1()}o=this._pickingInfo.pickPos.subtract(m);var p=o.length();o=o.normalize();var g=new x3dom.fields.SFVec3f(0,1,0),x=m.addScaled(o,p),v=o.cross(g).normalize();o=v.cross(g).normalize(),0>f&&(u=2*(.5+p+u));var y=x.addScaled(o,u);c=x3dom.fields.SFMatrix4f.lookAt(y,x,g),c=c.inverse(),u=y.subtract(m).length();var b=Math.log(u/n._vf.speed);this.animateTo(c,this._scene.getViewpoint(),b)}this._dx=0,this._dy=0,this._lastX=e,this._lastY=t,this._lastButton=i},x3dom.Viewarea.prototype.onMouseOver=function(e,t){this._dx=0,this._dy=0,this._lastButton=0,this._lastX=e,this._lastY=t,this._deltaT=0},x3dom.Viewarea.prototype.onMouseOut=function(e,t){this._dx=0,this._dy=0,this._lastButton=0,this._lastX=e,this._lastY=t,this._deltaT=0},x3dom.Viewarea.prototype.onDoubleClick=function(){if("true"!==this._doc.properties.getProperty("disableDoubleClick","false")){var e=this._scene.getNavigationInfo();if(!(e._vf.type[0].length<=1||"none"==e._vf.type[0].toLowerCase())&&"color"!==this._scene._vf.pickMode.toLowerCase()&&"texcoord"!==this._scene._vf.pickMode.toLowerCase()){var t=this._scene.getViewpoint();t._vf.centerOfRotation.setValues(this._pick),x3dom.debug.logInfo("New center of Rotation:  "+this._pick);var i=this.getViewMatrix().inverse(),o=i.e3(),s=this._pick,n=i.e1(),r=i.e0().cross(n).normalize(),a=r.dot(this._pick.subtract(o));o=s.addScaled(r,-a),i=x3dom.fields.SFMatrix4f.lookAt(o,s,n),x3dom.debug.logInfo("New camera position:  "+o),this.animateTo(i.inverse(),t)}}},x3dom.Viewarea.prototype.handleMoveEvt=function(e,t,i){if(this.prepareEvents(e,t,i,"onmousemove"),this._pickingInfo.pickObj!==this._pickingInfo.lastObj){if(this._pickingInfo.lastObj){var o=this._pickingInfo.pickObj;this._pickingInfo.pickObj=this._pickingInfo.lastObj,this.prepareEvents(e,t,i,"onmouseout"),this._pickingInfo.pickObj=o}this._pickingInfo.pickObj&&this.prepareEvents(e,t,i,"onmouseover"),this._pickingInfo.lastObj=this._pickingInfo.pickObj}},x3dom.Viewarea.prototype.onMove=function(e,t,i){this.handleMoveEvt(e,t,i),(this._lastX<0||this._lastY<0)&&(this._lastX=e,this._lastY=t),this._dx=e-this._lastX,this._dy=t-this._lastY,this._lastX=e,this._lastY=t},x3dom.Viewarea.prototype.onMoveView=function(e,t){var i=this._scene.getNavigationInfo(),o=this._scene.getViewpoint();if("examine"===i._vf.type[0].toLowerCase()){if(e){var s=1+Math.abs(this._movement.z);e=e.multiply(s),this._movement=this._movement.add(e),this._transMat=o.getViewMatrix().inverse().mult(x3dom.fields.SFMatrix4f.translation(this._movement)).mult(o.getViewMatrix())}t&&(this._rotMat=t.mult(this._rotMat))}},x3dom.Viewarea.prototype.onDrag=function(e,t,i){this.handleMoveEvt(e,t,i);var o=this._scene.getNavigationInfo();if(!(o._vf.type[0].length<=1||"none"===o._vf.type[0].toLowerCase())){var s,n,r,a,d,h=e-this._lastX,l=t-this._lastY,_=this._scene.getViewpoint();if("examine"===o._vf.type[0].toLowerCase()){if(1&i){var f=2*l*Math.PI/this._width,u=2*h*Math.PI/this._height,c=this.getViewMatrix(),m=x3dom.fields.SFMatrix4f.rotationX(f),p=x3dom.fields.SFMatrix4f.rotationY(u),g=_.getCenterOfRotation();c.setTranslate(new x3dom.fields.SFVec3f(0,0,0)),this._rotMat=this._rotMat.mult(x3dom.fields.SFMatrix4f.translation(g)).mult(c.inverse()).mult(m).mult(p).mult(c).mult(x3dom.fields.SFMatrix4f.translation(g.negate()))}if(4&i&&(s=x3dom.fields.SFVec3f.MAX(),n=x3dom.fields.SFVec3f.MIN(),r=this._scene.getVolume(s,n,!0),a=r?n.subtract(s).length():10,a=a<x3dom.fields.Eps?1:a,d=new x3dom.fields.SFVec3f(a*h/this._width,a*-l/this._height,0),this._movement=this._movement.add(d),this._transMat=_.getViewMatrix().inverse().mult(x3dom.fields.SFMatrix4f.translation(this._movement)).mult(_.getViewMatrix())),2&i){if("true"===this._doc.properties.getProperty("disableRightDrag","false"))return;s=x3dom.fields.SFVec3f.MAX(),n=x3dom.fields.SFVec3f.MIN(),r=this._scene.getVolume(s,n,!0),a=r?n.subtract(s).length():10,a=a<x3dom.fields.Eps?1:a,d=new x3dom.fields.SFVec3f(0,0,a*(h+l)/this._height),this._movement=this._movement.add(d),this._transMat=_.getViewMatrix().inverse().mult(x3dom.fields.SFMatrix4f.translation(this._movement)).mult(_.getViewMatrix())}}this._dx=h,this._dy=l,this._lastX=e,this._lastY=t}},x3dom.Viewarea.prototype.prepareEvents=function(e,t,i,o){var s="idbuf"===this._scene._vf.pickMode.toLowerCase()||"color"===this._scene._vf.pickMode.toLowerCase()||"texcoord"===this._scene._vf.pickMode.toLowerCase();if(s){var n=this._pickingInfo.pickObj;n&&(this._pick.setValues(this._pickingInfo.pickPos),this.checkEvents(n,e,t,i,o),"onclick"===o&&(x3dom.debug.logInfo('Hit "'+n._xmlNode.localName+"/ "+n._DEF+'"'),x3dom.debug.logInfo("Ray hit at position "+this._pick)))}},x3dom.Mesh=function(e){this._parent=e,this._min=new x3dom.fields.SFVec3f(0,0,0),this._max=new x3dom.fields.SFVec3f(0,0,0),this._invalidate=!0,this._numFaces=0,this._numCoords=0,this._positions=[],this._normals=[],this._texCoords=[],this._colors=[],this._indices=[],this._positions[0]=[],this._normals[0]=[],this._texCoords[0]=[],this._colors[0]=[],this._indices[0]=[]},x3dom.Mesh.prototype._dynamicFields={},x3dom.Mesh.prototype._numTexComponents=2,x3dom.Mesh.prototype._numColComponents=3,x3dom.Mesh.prototype._lit=!0,x3dom.Mesh.prototype._min={},x3dom.Mesh.prototype._max={},x3dom.Mesh.prototype._invalidate=!0,x3dom.Mesh.prototype._numFaces=0,x3dom.Mesh.prototype._numCoords=0,x3dom.Mesh.prototype.setMeshData=function(e,t,i,o,s){this._positions[0]=e,this._normals[0]=t,this._texCoords[0]=i,this._colors[0]=o,this._indices[0]=s,this._invalidate=!0,this._numFaces=this._indices[0].length/3,this._numCoords=this._positions[0].length/3},x3dom.Mesh.prototype.getBBox=function(e,t,i){if(this._invalidate===!0&&i===!0){var o=this._positions[0],s=o.length;s>3?(this._min=new x3dom.fields.SFVec3f(o[0],o[1],o[2]),this._max=new x3dom.fields.SFVec3f(o[0],o[1],o[2])):(this._min=new x3dom.fields.SFVec3f(0,0,0),this._max=new x3dom.fields.SFVec3f(0,0,0));for(var n=3;s>n;n+=3)this._min.x>o[n+0]&&(this._min.x=o[n+0]),this._min.y>o[n+1]&&(this._min.y=o[n+1]),this._min.z>o[n+2]&&(this._min.z=o[n+2]),this._max.x<o[n+0]&&(this._max.x=o[n+0]),this._max.y<o[n+1]&&(this._max.y=o[n+1]),this._max.z<o[n+2]&&(this._max.z=o[n+2]);this._invalidate=!1}e.setValues(this._min),t.setValues(this._max)},x3dom.Mesh.prototype.getCenter=function(){var e=new x3dom.fields.SFVec3f(0,0,0),t=new x3dom.fields.SFVec3f(0,0,0);this.getBBox(e,t,!0);var i=e.add(t).multiply(.5);return i},x3dom.Mesh.prototype.doIntersect=function(e){var t=new x3dom.fields.SFVec3f(0,0,0),i=new x3dom.fields.SFVec3f(0,0,0);this.getBBox(t,i,!0);var o=e.intersect(t,i);return o&&e.enter<e.dist&&(e.dist=e.enter,e.hitObject=this._parent,e.hitPoint=e.pos.add(e.dir.multiply(e.enter))),o},x3dom.Mesh.prototype.calcNormals=function(e){var t,i,o=0,s=0,n=0,r=void 0!==this._multiIndIndices&&this._multiIndIndices.length,a=this._positions[0],d=r?this._multiIndIndices:this._indices[0],h=[],l=[],_=null;for(n=void 0!==this._posSize&&this._posSize>a.length?this._posSize/3:a.length/3,n=3*(n-Math.floor(n)>0?Math.floor(n+1):n),o=0;n>o;++o)l[o]=[];for(n=d.length,o=0;n>o;o+=3)r?(t=new x3dom.fields.SFVec3f(a[3*o],a[3*o+1],a[3*o+2]).subtract(new x3dom.fields.SFVec3f(a[3*(o+1)],a[3*(o+1)+1],a[3*(o+1)+2])),i=new x3dom.fields.SFVec3f(a[3*(o+1)],a[3*(o+1)+1],a[3*(o+1)+2]).subtract(new x3dom.fields.SFVec3f(a[3*(o+2)],a[3*(o+2)+1],a[3*(o+2)+2]))):(t=new x3dom.fields.SFVec3f(a[3*d[o]],a[3*d[o]+1],a[3*d[o]+2]).subtract(new x3dom.fields.SFVec3f(a[3*d[o+1]],a[3*d[o+1]+1],a[3*d[o+1]+2])),i=new x3dom.fields.SFVec3f(a[3*d[o+1]],a[3*d[o+1]+1],a[3*d[o+1]+2]).subtract(new x3dom.fields.SFVec3f(a[3*d[o+2]],a[3*d[o+2]+1],a[3*d[o+2]+2]))),_=t.cross(i).normalize(),e<=x3dom.fields.Eps?(h[3*o]=h[3*(o+1)]=h[3*(o+2)]=_.x,h[3*o+1]=h[3*(o+1)+1]=h[3*(o+2)+1]=_.y,h[3*o+2]=h[3*(o+1)+2]=h[3*(o+2)+2]=_.z):(l[d[o]].push(_),l[d[o+1]].push(_),l[d[o+2]].push(_));if(e>x3dom.fields.Eps)for(o=0;o<a.length;o+=3){if(_=new x3dom.fields.SFVec3f(0,0,0),r)for(n=l[d[o/3]].length,s=0;n>s;++s)_=_.add(l[d[o/3]][s]);else for(n=l[o/3].length,s=0;n>s;++s)_=_.add(l[o/3][s]);_=_.normalize(),h[o]=_.x,h[o+1]=_.y,h[o+2]=_.z}r&&(this._multiIndIndices=[]),this._normals[0]=h},x3dom.Mesh.prototype.splitMesh=function(){var e=65535;if(!(this._positions[0].length/3<=e)){var t=this._positions[0],i=this._normals[0],o=this._texCoords[0],s=this._colors[0],n=this._indices[0],r=0;do{this._positions[r]=[],this._normals[r]=[],this._texCoords[r]=[],this._colors[r]=[],this._indices[r]=[];var a=n.length-(r+1)*e<0?!1:!0;if(this._indices[r]=a?n.slice(r*e,(r+1)*e):n.slice(r*e),r)for(var d=r*e,h=0,l=this._indices[r].length;l>h;h++)this._indices[r][h]-=d;this._positions[r]=a?t.slice(r*e*3,3*(r+1)*e):t.slice(r*e*3),i.length&&(this._normals[r]=a?i.slice(r*e*3,3*(r+1)*e):i.slice(r*e*3)),o.length&&(this._texCoords[r]=a?o.slice(r*e*this._numTexComponents,this._numTexComponents*(r+1)*e):o.slice(r*e*this._numTexComponents)),s.length&&(this._colors[r]=a?s.slice(r*e*this._numColComponents,this._numColComponents*(r+1)*e):s.slice(r*e*this._numColComponents))}while(t.length>++r*e*3)}},x3dom.Mesh.prototype.calcTexCoords=function(e){if(this._texCoords[0]=[],"sphere-local"===e.toLowerCase())for(var t=0,i=0,o=this._normals[0].length;o>t;t+=3)this._texCoords[0][i++]=.5+this._normals[0][t]/2,this._texCoords[0][i++]=.5+this._normals[0][t+1]/2;else{var s=new x3dom.fields.SFVec3f(0,0,0),n=new x3dom.fields.SFVec3f(0,0,0);this.getBBox(s,n,!0);var r=n.subtract(s),a=0,d=1;r.x>=r.y?r.x>=r.z?(a=0,d=r.y>=r.z?1:2):(a=2,d=0):r.y>=r.z?(a=1,d=r.x>=r.z?0:2):(a=2,d=1);var h=1,l=1,_=0,f=0;switch(a){case 0:h=r.x,_=s.x;break;case 1:h=r.y,_=s.y;break;case 2:h=r.z,_=s.z}switch(d){case 0:l=r.x,f=s.x;break;case 1:l=r.y,f=s.y;break;case 2:l=r.z,f=s.z}for(var u=0,c=0,m=this._positions[0].length;m>u;u+=3)this._texCoords[0][c++]=(this._positions[0][u+a]-_)/h,this._texCoords[0][c++]=(this._positions[0][u+d]-f)/l}},x3dom.fields={},x3dom.fields.Eps=1e-6,x3dom.fields.SFMatrix4f=function(e,t,i,o,s,n,r,a,d,h,l,_,f,u,c,m){0===arguments.length?(this._00=1,this._01=0,this._02=0,this._03=0,this._10=0,this._11=1,this._12=0,this._13=0,this._20=0,this._21=0,this._22=1,this._23=0,this._30=0,this._31=0,this._32=0,this._33=1):(this._00=e,this._01=t,this._02=i,this._03=o,this._10=s,this._11=n,this._12=r,this._13=a,this._20=d,this._21=h,this._22=l,this._23=_,this._30=f,this._31=u,this._32=c,this._33=m)},x3dom.fields.SFMatrix4f.prototype.e0=function(){var e=new x3dom.fields.SFVec3f(this._00,this._10,this._20);return e.normalize()},x3dom.fields.SFMatrix4f.prototype.e1=function(){var e=new x3dom.fields.SFVec3f(this._01,this._11,this._21);return e.normalize()},x3dom.fields.SFMatrix4f.prototype.e2=function(){var e=new x3dom.fields.SFVec3f(this._02,this._12,this._22);return e.normalize()},x3dom.fields.SFMatrix4f.prototype.e3=function(){return new x3dom.fields.SFVec3f(this._03,this._13,this._23)},x3dom.fields.SFMatrix4f.identity=function(){return new x3dom.fields.SFMatrix4f(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)},x3dom.fields.SFMatrix4f.zeroMatrix=function(){return new x3dom.fields.SFMatrix4f(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)},x3dom.fields.SFMatrix4f.translation=function(e){return new x3dom.fields.SFMatrix4f(1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1)},x3dom.fields.SFMatrix4f.rotationX=function(e){var t=Math.cos(e),i=Math.sin(e);return new x3dom.fields.SFMatrix4f(1,0,0,0,0,t,-i,0,0,i,t,0,0,0,0,1)},x3dom.fields.SFMatrix4f.rotationY=function(e){var t=Math.cos(e),i=Math.sin(e);return new x3dom.fields.SFMatrix4f(t,0,i,0,0,1,0,0,-i,0,t,0,0,0,0,1)},x3dom.fields.SFMatrix4f.rotationZ=function(e){var t=Math.cos(e),i=Math.sin(e);
return new x3dom.fields.SFMatrix4f(t,-i,0,0,i,t,0,0,0,0,1,0,0,0,0,1)},x3dom.fields.SFMatrix4f.scale=function(e){return new x3dom.fields.SFMatrix4f(e.x,0,0,0,0,e.y,0,0,0,0,e.z,0,0,0,0,1)},x3dom.fields.SFMatrix4f.lookAt=function(e,t,i){var o=e.subtract(t).normalize(),s=i.normalize().cross(o);if(s.dot(s)<x3dom.fields.Eps)return x3dom.debug.logWarning("View matrix is linearly dependent."),x3dom.fields.SFMatrix4f.translation(e);var n=o.cross(s.normalize()).normalize(),r=x3dom.fields.SFMatrix4f.identity();return r.setValue(s,n,o,e),r},x3dom.fields.SFMatrix4f.prototype.setTranslate=function(e){this._03=e.x,this._13=e.y,this._23=e.z},x3dom.fields.SFMatrix4f.prototype.setScale=function(e){this._00=e.x,this._11=e.y,this._22=e.z},x3dom.fields.SFMatrix4f.parseRotation=function(e){var t=/^([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)$/.exec(e),i=+t[1],o=+t[2],s=+t[3],n=+t[4],r=Math.sqrt(i*i+o*o+s*s);0===r?(i=1,o=s=0):(i/=r,o/=r,s/=r);var a=Math.cos(n),d=Math.sin(n),h=1-a;return new x3dom.fields.SFMatrix4f(h*i*i+a,h*i*o+d*s,h*i*s-d*o,0,h*i*o-d*s,h*o*o+a,h*o*s+d*i,0,h*i*s+d*o,h*o*s-d*i,h*s*s+a,0,0,0,0,1).transpose()},x3dom.fields.SFMatrix4f.parse=function(e){var t=!1,i=/matrix.*\((.+)\)/;i.exec(e)&&(e=RegExp.$1,t=!0);var o=Array.map(e.split(/[,\s]+/),function(e){return+e});return o.length>=16?t?new x3dom.fields.SFMatrix4f(o[0],o[4],o[8],o[12],o[1],o[5],o[9],o[13],o[2],o[6],o[10],o[14],o[3],o[7],o[11],o[15]):new x3dom.fields.SFMatrix4f(o[0],o[1],o[2],o[3],o[4],o[5],o[6],o[7],o[8],o[9],o[10],o[11],o[12],o[13],o[14],o[15]):6===o.length?new x3dom.fields.SFMatrix4f(o[0],o[1],0,o[4],o[2],o[3],0,o[5],0,0,1,0,0,0,0,1):(x3dom.debug.logWarning("SFMatrix4f - can't parse string: "+e),x3dom.fields.SFMatrix4f.identity())},x3dom.fields.SFMatrix4f.prototype.mult=function(e){return new x3dom.fields.SFMatrix4f(this._00*e._00+this._01*e._10+this._02*e._20+this._03*e._30,this._00*e._01+this._01*e._11+this._02*e._21+this._03*e._31,this._00*e._02+this._01*e._12+this._02*e._22+this._03*e._32,this._00*e._03+this._01*e._13+this._02*e._23+this._03*e._33,this._10*e._00+this._11*e._10+this._12*e._20+this._13*e._30,this._10*e._01+this._11*e._11+this._12*e._21+this._13*e._31,this._10*e._02+this._11*e._12+this._12*e._22+this._13*e._32,this._10*e._03+this._11*e._13+this._12*e._23+this._13*e._33,this._20*e._00+this._21*e._10+this._22*e._20+this._23*e._30,this._20*e._01+this._21*e._11+this._22*e._21+this._23*e._31,this._20*e._02+this._21*e._12+this._22*e._22+this._23*e._32,this._20*e._03+this._21*e._13+this._22*e._23+this._23*e._33,this._30*e._00+this._31*e._10+this._32*e._20+this._33*e._30,this._30*e._01+this._31*e._11+this._32*e._21+this._33*e._31,this._30*e._02+this._31*e._12+this._32*e._22+this._33*e._32,this._30*e._03+this._31*e._13+this._32*e._23+this._33*e._33)},x3dom.fields.SFMatrix4f.prototype.multMatrixPnt=function(e){return new x3dom.fields.SFVec3f(this._00*e.x+this._01*e.y+this._02*e.z+this._03,this._10*e.x+this._11*e.y+this._12*e.z+this._13,this._20*e.x+this._21*e.y+this._22*e.z+this._23)},x3dom.fields.SFMatrix4f.prototype.multMatrixVec=function(e){return new x3dom.fields.SFVec3f(this._00*e.x+this._01*e.y+this._02*e.z,this._10*e.x+this._11*e.y+this._12*e.z,this._20*e.x+this._21*e.y+this._22*e.z)},x3dom.fields.SFMatrix4f.prototype.multFullMatrixPnt=function(e){var t=this._30*e.x+this._31*e.y+this._32*e.z+this._33;return t&&(t=1/t),new x3dom.fields.SFVec3f((this._00*e.x+this._01*e.y+this._02*e.z+this._03)*t,(this._10*e.x+this._11*e.y+this._12*e.z+this._13)*t,(this._20*e.x+this._21*e.y+this._22*e.z+this._23)*t)},x3dom.fields.SFMatrix4f.prototype.transpose=function(){return new x3dom.fields.SFMatrix4f(this._00,this._10,this._20,this._30,this._01,this._11,this._21,this._31,this._02,this._12,this._22,this._32,this._03,this._13,this._23,this._33)},x3dom.fields.SFMatrix4f.prototype.negate=function(){return new x3dom.fields.SFMatrix4f(-this._00,-this._01,-this._02,-this._03,-this._10,-this._11,-this._12,-this._13,-this._20,-this._21,-this._22,-this._23,-this._30,-this._31,-this._32,-this._33)},x3dom.fields.SFMatrix4f.prototype.multiply=function(e){return new x3dom.fields.SFMatrix4f(e*this._00,e*this._01,e*this._02,e*this._03,e*this._10,e*this._11,e*this._12,e*this._13,e*this._20,e*this._21,e*this._22,e*this._23,e*this._30,e*this._31,e*this._32,e*this._33)},x3dom.fields.SFMatrix4f.prototype.add=function(e){return new x3dom.fields.SFMatrix4f(this._00+e._00,this._01+e._01,this._02+e._02,this._03+e._03,this._10+e._10,this._11+e._11,this._12+e._12,this._13+e._13,this._20+e._20,this._21+e._21,this._22+e._22,this._23+e._23,this._30+e._30,this._31+e._31,this._32+e._32,this._33+e._33)},x3dom.fields.SFMatrix4f.prototype.addScaled=function(e,t){return new x3dom.fields.SFMatrix4f(this._00+t*e._00,this._01+t*e._01,this._02+t*e._02,this._03+t*e._03,this._10+t*e._10,this._11+t*e._11,this._12+t*e._12,this._13+t*e._13,this._20+t*e._20,this._21+t*e._21,this._22+t*e._22,this._23+t*e._23,this._30+t*e._30,this._31+t*e._31,this._32+t*e._32,this._33+t*e._33)},x3dom.fields.SFMatrix4f.prototype.setValues=function(e){this._00=e._00,this._01=e._01,this._02=e._02,this._03=e._03,this._10=e._10,this._11=e._11,this._12=e._12,this._13=e._13,this._20=e._20,this._21=e._21,this._22=e._22,this._23=e._23,this._30=e._30,this._31=e._31,this._32=e._32,this._33=e._33},x3dom.fields.SFMatrix4f.prototype.setValue=function(e,t,i,o){this._00=e.x,this._01=t.x,this._02=i.x,this._10=e.y,this._11=t.y,this._12=i.y,this._20=e.z,this._21=t.z,this._22=i.z,this._30=0,this._31=0,this._32=0,arguments.length>3&&(this._03=o.x,this._13=o.y,this._23=o.z,this._33=1)},x3dom.fields.SFMatrix4f.prototype.toGL=function(){return[this._00,this._10,this._20,this._30,this._01,this._11,this._21,this._31,this._02,this._12,this._22,this._32,this._03,this._13,this._23,this._33]},x3dom.fields.SFMatrix4f.prototype.sqrt=function(){var e,t,i,o=x3dom.fields.SFMatrix4f.identity(),s=x3dom.fields.SFMatrix4f.identity(),n=x3dom.fields.SFMatrix4f.identity(),r=x3dom.fields.SFMatrix4f.identity();for(r.setValues(this),e=0;6>e;e++)o=r.inverse(),n=s.inverse(),t=Math.abs(Math.pow(r.det()*s.det(),-.125)),i=1/t,r=r.multiply(t),r=r.addScaled(n,i),r=r.multiply(.5),s=s.multiply(t),s=s.addScaled(o,i),s=s.multiply(.5);return r},x3dom.fields.SFMatrix4f.prototype.normInfinity=function(){var e=0,t=0;return(e=Math.abs(this._00))>t&&(t=e),(e=Math.abs(this._01))>t&&(t=e),(e=Math.abs(this._02))>t&&(t=e),(e=Math.abs(this._03))>t&&(t=e),(e=Math.abs(this._10))>t&&(t=e),(e=Math.abs(this._11))>t&&(t=e),(e=Math.abs(this._12))>t&&(t=e),(e=Math.abs(this._13))>t&&(t=e),(e=Math.abs(this._20))>t&&(t=e),(e=Math.abs(this._21))>t&&(t=e),(e=Math.abs(this._22))>t&&(t=e),(e=Math.abs(this._23))>t&&(t=e),(e=Math.abs(this._30))>t&&(t=e),(e=Math.abs(this._31))>t&&(t=e),(e=Math.abs(this._32))>t&&(t=e),(e=Math.abs(this._33))>t&&(t=e),t},x3dom.fields.SFMatrix4f.prototype.equals=function(e){var t=1e-12;return Math.abs(this._00-e._00)<t&&Math.abs(this._01-e._01)<t&&Math.abs(this._02-e._02)<t&&Math.abs(this._03-e._03)<t&&Math.abs(this._10-e._10)<t&&Math.abs(this._11-e._11)<t&&Math.abs(this._12-e._12)<t&&Math.abs(this._13-e._13)<t&&Math.abs(this._20-e._20)<t&&Math.abs(this._21-e._21)<t&&Math.abs(this._22-e._22)<t&&Math.abs(this._23-e._23)<t&&Math.abs(this._30-e._30)<t&&Math.abs(this._31-e._31)<t&&Math.abs(this._32-e._32)<t&&Math.abs(this._33-e._33)<t},x3dom.fields.SFMatrix4f.prototype.getTransform=function(e,t,i){var o,s,n,r,a,d,h=new x3dom.fields.SFVec3f(this._03,this._13,this._23),l=new x3dom.fields.SFVec3f(1,1,1);s=Math.asin(this._02),d=Math.cos(s),Math.abs(d)>1e-4?(r=this._22/d,a=-this._12/d,o=Math.atan2(a,r),r=this._00/d,a=-this._01/d,n=Math.atan2(a,r)):(o=0,r=this._11,a=this._10,n=Math.atan2(a,r));var _=new x3dom.fields.Quaternion(-Math.cos((o-n)/2)*Math.sin(s/2),Math.sin((o-n)/2)*Math.sin(s/2),-Math.sin((o+n)/2)*Math.cos(s/2),Math.cos((o+n)/2)*Math.cos(s/2));e.x=h.x,e.y=h.y,e.z=h.z,t.x=_.x,t.y=_.y,t.z=_.z,t.w=_.w,i.x=l.x,i.y=l.y,i.z=l.z},x3dom.fields.SFMatrix4f.prototype.log=function(){var e=12,t=0,i=0,o=1e-12,s=x3dom.fields.SFMatrix4f.identity(),n=x3dom.fields.SFMatrix4f.identity(),r=x3dom.fields.SFMatrix4f.identity();for(s.setValues(this),n.setValues(this),n._00-=1,n._11-=1,n._22-=1,n._33-=1;n.normInfinity()>.5;)s=s.sqrt(),n.setValues(s),n._00-=1,n._11-=1,n._22-=1,n._33-=1,t++;for(s._00-=1,s._11-=1,s._22-=1,s._33-=1,s=s.negate(),r.setValues(s),n.setValues(s),i=1;n.normInfinity()>o&&e>i;)n=n.mult(s),i++,r=r.addScaled(n,1/i);return r=r.multiply(-1*(1<<t))},x3dom.fields.SFMatrix4f.prototype.exp=function(){var e=6,t=x3dom.fields.SFMatrix4f.identity(),i=x3dom.fields.SFMatrix4f.identity(),o=x3dom.fields.SFMatrix4f.identity(),s=x3dom.fields.SFMatrix4f.identity(),n=1,r=0,a=1;for(t.setValues(this),n+=Math.floor(Math.log(t.normInfinity()/.693)),0>n&&(n=0),t=t.multiply(1/(1<<n)),r=1;e>=r;r++)a*=(e-r+1)/(r*(2*e-r+1)),s=t.mult(s),o=o.addScaled(s,a),i=r%2?i.addScaled(s,-a):i.addScaled(s,a);for(s=i.inverse().mult(o),r=0;n>r;r++)s=s.mult(s);return s},x3dom.fields.SFMatrix4f.prototype.det3=function(e,t,i,o,s,n,r,a,d){var h=e*s*d+t*n*r+i*o*a-e*n*a-t*o*d-i*s*r;return h},x3dom.fields.SFMatrix4f.prototype.det=function(){var e,t,i,o,s,n,r,a,d,h,l,_,f,u,c,m;e=this._00,s=this._10,d=this._20,f=this._30,t=this._01,n=this._11,h=this._21,u=this._31,i=this._02,r=this._12,l=this._22,c=this._32,o=this._03,a=this._13,_=this._23,m=this._33;var p=+e*this.det3(n,r,a,h,l,_,u,c,m)-s*this.det3(t,i,o,h,l,_,u,c,m)+d*this.det3(t,i,o,n,r,a,u,c,m)-f*this.det3(t,i,o,n,r,a,h,l,_);return p},x3dom.fields.SFMatrix4f.prototype.inverse=function(){var e,t,i,o,s,n,r,a,d,h,l,_,f,u,c,m;e=this._00,s=this._10,d=this._20,f=this._30,t=this._01,n=this._11,h=this._21,u=this._31,i=this._02,r=this._12,l=this._22,c=this._32,o=this._03,a=this._13,_=this._23,m=this._33;var p=this.det();return 0===Math.abs(p)?(x3dom.debug.logWarning("Invert matrix: singular matrix, no inverse!"),x3dom.fields.SFMatrix4f.identity()):(p=1/p,new x3dom.fields.SFMatrix4f(+this.det3(n,r,a,h,l,_,u,c,m)*p,-this.det3(t,i,o,h,l,_,u,c,m)*p,+this.det3(t,i,o,n,r,a,u,c,m)*p,-this.det3(t,i,o,n,r,a,h,l,_)*p,-this.det3(s,r,a,d,l,_,f,c,m)*p,+this.det3(e,i,o,d,l,_,f,c,m)*p,-this.det3(e,i,o,s,r,a,f,c,m)*p,+this.det3(e,i,o,s,r,a,d,l,_)*p,+this.det3(s,n,a,d,h,_,f,u,m)*p,-this.det3(e,t,o,d,h,_,f,u,m)*p,+this.det3(e,t,o,s,n,a,f,u,m)*p,-this.det3(e,t,o,s,n,a,d,h,_)*p,-this.det3(s,n,r,d,h,l,f,u,c)*p,+this.det3(e,t,i,d,h,l,f,u,c)*p,-this.det3(e,t,i,s,n,r,f,u,c)*p,+this.det3(e,t,i,s,n,r,d,h,l)*p))},x3dom.fields.SFMatrix4f.prototype.toString=function(){return"[SFMatrix4f "+this._00+", "+this._01+", "+this._02+", "+this._03+"; "+this._10+", "+this._11+", "+this._12+", "+this._13+"; "+this._20+", "+this._21+", "+this._22+", "+this._23+"; "+this._30+", "+this._31+", "+this._32+", "+this._33+"]"},x3dom.fields.SFMatrix4f.prototype.setValueByStr=function(e){var t=!1,i=/matrix.*\((.+)\)/;i.exec(e)&&(e=RegExp.$1,t=!0);var o=Array.map(e.split(/[,\s]+/),function(e){return+e});return o.length>=16?t?(this._00=o[0],this._01=o[4],this._02=o[8],this._03=o[12],this._10=o[1],this._11=o[5],this._12=o[9],this._13=o[13],this._20=o[2],this._21=o[6],this._22=o[10],this._23=o[14],this._30=o[3],this._31=o[7],this._32=o[11],this._33=o[15]):(this._00=o[0],this._01=o[1],this._02=o[2],this._03=o[3],this._10=o[4],this._11=o[5],this._12=o[6],this._13=o[7],this._20=o[8],this._21=o[9],this._22=o[10],this._23=o[11],this._30=o[12],this._31=o[13],this._32=o[14],this._33=o[15]):6===o.length?(this._00=o[0],this._01=o[1],this._02=0,this._03=o[4],this._10=o[2],this._11=o[3],this._12=0,this._13=o[5],this._20=0,this._21=0,this._22=1,this._23=0,this._30=0,this._31=0,this._32=0,this._33=1):x3dom.debug.logWarning("SFMatrix4f - can't parse string: "+e),this},x3dom.fields.SFVec2f=function(e,t){0===arguments.length?this.x=this.y=0:(this.x=e,this.y=t)},x3dom.fields.SFVec2f.parse=function(e){var t=/^([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)$/.exec(e);return new x3dom.fields.SFVec2f(+t[1],+t[2])},x3dom.fields.SFVec2f.prototype.setValues=function(e){this.x=e.x,this.y=e.y},x3dom.fields.SFVec2f.prototype.add=function(e){return new x3dom.fields.SFVec2f(this.x+e.x,this.y+e.y)},x3dom.fields.SFVec2f.prototype.subtract=function(e){return new x3dom.fields.SFVec2f(this.x-e.x,this.y-e.y)},x3dom.fields.SFVec2f.prototype.negate=function(){return new x3dom.fields.SFVec2f(-this.x,-this.y)},x3dom.fields.SFVec2f.prototype.dot=function(e){return this.x*e.x+this.y*e.y},x3dom.fields.SFVec2f.prototype.reflect=function(e){var t=2*this.dot(e);return new x3dom.fields.SFVec2f(this.x-t*e.x,this.y-t*e.y)},x3dom.fields.SFVec2f.prototype.normalize=function(){var e=this.length();return e&&(e=1/e),new x3dom.fields.SFVec2f(this.x*e,this.y*e)},x3dom.fields.SFVec2f.prototype.multComponents=function(e){return new x3dom.fields.SFVec2f(this.x*e.x,this.y*e.y)},x3dom.fields.SFVec2f.prototype.multiply=function(e){return new x3dom.fields.SFVec2f(this.x*e,this.y*e)},x3dom.fields.SFVec2f.prototype.divide=function(e){var t=e?1/e:1;return new x3dom.fields.SFVec2f(this.x*t,this.y*t)},x3dom.fields.SFVec2f.prototype.equals=function(e,t){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t},x3dom.fields.SFVec2f.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},x3dom.fields.SFVec2f.prototype.toGL=function(){return[this.x,this.y]},x3dom.fields.SFVec2f.prototype.toString=function(){return"{ x "+this.x+" y "+this.y+" }"},x3dom.fields.SFVec2f.prototype.setValueByStr=function(e){var t=/^([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)$/.exec(e);return this.x=+t[1],this.y=+t[2],this},x3dom.fields.SFVec3f=function(e,t,i){0===arguments.length?this.x=this.y=this.z=0:(this.x=e,this.y=t,this.z=i)},x3dom.fields.SFVec3f.copy=function(e){return new x3dom.fields.SFVec3f(e.x,e.y,e.z)},x3dom.fields.SFVec3f.MIN=function(){return new x3dom.fields.SFVec3f(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE)},x3dom.fields.SFVec3f.MAX=function(){return new x3dom.fields.SFVec3f(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},x3dom.fields.SFVec3f.parse=function(e){try{var t=/^([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)$/.exec(e);return new x3dom.fields.SFVec3f(+t[1],+t[2],+t[3])}catch(i){var o=x3dom.fields.SFColor.colorParse(e);return new x3dom.fields.SFVec3f(o.r,o.g,o.b)}},x3dom.fields.SFVec3f.prototype.setValues=function(e){this.x=e.x,this.y=e.y,this.z=e.z},x3dom.fields.SFVec3f.prototype.add=function(e){return new x3dom.fields.SFVec3f(this.x+e.x,this.y+e.y,this.z+e.z)},x3dom.fields.SFVec3f.prototype.addScaled=function(e,t){return new x3dom.fields.SFVec3f(this.x+t*e.x,this.y+t*e.y,this.z+t*e.z)},x3dom.fields.SFVec3f.prototype.subtract=function(e){return new x3dom.fields.SFVec3f(this.x-e.x,this.y-e.y,this.z-e.z)},x3dom.fields.SFVec3f.prototype.negate=function(){return new x3dom.fields.SFVec3f(-this.x,-this.y,-this.z)},x3dom.fields.SFVec3f.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},x3dom.fields.SFVec3f.prototype.cross=function(e){return new x3dom.fields.SFVec3f(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x)},x3dom.fields.SFVec3f.prototype.reflect=function(e){var t=2*this.dot(e);return new x3dom.fields.SFVec3f(this.x-t*e.x,this.y-t*e.y,this.z-t*e.z)},x3dom.fields.SFVec3f.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},x3dom.fields.SFVec3f.prototype.normalize=function(){var e=this.length();return e&&(e=1/e),new x3dom.fields.SFVec3f(this.x*e,this.y*e,this.z*e)},x3dom.fields.SFVec3f.prototype.multComponents=function(e){return new x3dom.fields.SFVec3f(this.x*e.x,this.y*e.y,this.z*e.z)},x3dom.fields.SFVec3f.prototype.multiply=function(e){return new x3dom.fields.SFVec3f(this.x*e,this.y*e,this.z*e)},x3dom.fields.SFVec3f.prototype.divide=function(e){var t=e?1/e:1;return new x3dom.fields.SFVec3f(this.x*t,this.y*t,this.z*t)},x3dom.fields.SFVec3f.prototype.equals=function(e,t){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t},x3dom.fields.SFVec3f.prototype.toGL=function(){return[this.x,this.y,this.z]},x3dom.fields.SFVec3f.prototype.toString=function(){return"{ x "+this.x+" y "+this.y+" z "+this.z+" }"},x3dom.fields.SFVec3f.prototype.setValueByStr=function(e){try{var t=/^([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)$/.exec(e);this.x=+t[1],this.y=+t[2],this.z=+t[3]}catch(i){var o=x3dom.fields.SFColor.colorParse(e);this.x=o.r,this.y=o.g,this.z=o.b}return this},x3dom.fields.Quaternion=function(e,t,i,o){this.x=e,this.y=t,this.z=i,this.w=o},x3dom.fields.Quaternion.prototype.multiply=function(e){return new x3dom.fields.Quaternion(this.w*e.x+this.x*e.w+this.y*e.z-this.z*e.y,this.w*e.y+this.y*e.w+this.z*e.x-this.x*e.z,this.w*e.z+this.z*e.w+this.x*e.y-this.y*e.x,this.w*e.w-this.x*e.x-this.y*e.y-this.z*e.z)},x3dom.fields.Quaternion.parseAxisAngle=function(e){var t=/^([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)$/.exec(e);return x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(+t[1],+t[2],+t[3]),+t[4])},x3dom.fields.Quaternion.axisAngle=function(e,t){var i=e.length();if(i>x3dom.fields.Eps){var o=Math.sin(t/2)/i,s=Math.cos(t/2);return new x3dom.fields.Quaternion(e.x*o,e.y*o,e.z*o,s)}return new x3dom.fields.Quaternion(0,0,0,1)},x3dom.fields.Quaternion.prototype.toMatrix=function(){var e=this.x*this.x,t=this.x*this.y,i=this.x*this.z,o=this.y*this.y,s=this.y*this.z,n=this.z*this.z,r=this.w*this.x,a=this.w*this.y,d=this.w*this.z;return new x3dom.fields.SFMatrix4f(1-2*(o+n),2*(t-d),2*(i+a),0,2*(t+d),1-2*(e+n),2*(s-r),0,2*(i-a),2*(s+r),1-2*(e+o),0,0,0,0,1)},x3dom.fields.Quaternion.prototype.toAxisAngle=function(){var e=0,t=0,i=0,o=0,s=0,n=this;return this.w>1&&(n=x3dom.fields.Quaternion.normalize(this)),s=2*Math.acos(n.w),o=Math.sqrt(1-n.w*n.w),o<x3dom.fields.Eps?(e=n.x,t=n.y,i=n.z):(e=n.x/o,t=n.y/o,i=n.z/o),[new x3dom.fields.SFVec3f(e,t,i),s]},x3dom.fields.Quaternion.prototype.angle=function(){return 2*Math.acos(this.w)},x3dom.fields.Quaternion.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},x3dom.fields.Quaternion.prototype.add=function(e){return new x3dom.fields.Quaternion(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)},x3dom.fields.Quaternion.prototype.subtract=function(e){return new x3dom.fields.Quaternion(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)},x3dom.fields.Quaternion.prototype.setValues=function(e){this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w},x3dom.fields.Quaternion.prototype.equals=function(e,t){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.w-e.w)<t},x3dom.fields.Quaternion.prototype.multScalar=function(e){return new x3dom.fields.Quaternion(this.x*e,this.y*e,this.z*e,this.w*e)},x3dom.fields.Quaternion.prototype.normalize=function(e){var t=this.dot(e),i=1;return t&&(i=1/Math.sqrt(t)),new x3dom.fields.Quaternion(this.x*i,this.y*i,this.z*i,this.w*i)},x3dom.fields.Quaternion.prototype.negate=function(){return new x3dom.fields.Quaternion(-this.x,-this.y,-this.z,-this.w)},x3dom.fields.Quaternion.prototype.inverse=function(){return new x3dom.fields.Quaternion(-this.x,-this.y,-this.z,this.w)},x3dom.fields.Quaternion.prototype.slerp=function(e,t){var i,o=this.dot(e);0>o?(o=-o,i=e.negate()):i=new x3dom.fields.Quaternion(e.x,e.y,e.z,e.w);var s,n;if(1-o>1e-5){var r=Math.acos(o),a=Math.sin(r);s=Math.sin((1-t)*r)/a,n=Math.sin(t*r)/a}else s=1-t,n=t;return this.multScalar(s).add(i.multScalar(n))},x3dom.fields.Quaternion.rotateFromTo=function(e,t){var i=e.normalize(),o=t.normalize(),s=i.dot(o);if(s>.99999)return new x3dom.fields.Quaternion(0,0,0,1);if(-.99999>s){var n=new x3dom.fields.SFVec3f(1,0,0),r=i.cross(n);return r.length()<1e-5&&(n.x=0,n.y=1,n.z=0,r=i.cross(n)),r=r.normalize(),x3dom.fields.Quaternion.axisAngle(r,Math.PI)}var a=e.cross(t);a=a.normalize();var d=Math.sqrt(.5*(1-s));return a=a.multiply(d),d=Math.sqrt(.5*(1+s)),new x3dom.fields.Quaternion(a.x,a.y,a.z,d)},x3dom.fields.Quaternion.prototype.toString=function(){return"(("+this.x+", "+this.y+", "+this.z+"), "+this.w+")"},x3dom.fields.Quaternion.prototype.setValueByStr=function(e){var t=/^([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)$/.exec(e),i=x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(+t[1],+t[2],+t[3]),+t[4]);return this.x=i.x,this.y=i.y,this.z=i.z,this.w=i.w,this},x3dom.fields.SFColor=function(e,t,i){0===arguments.length?this.r=this.g=this.b=0:(this.r=e,this.g=t,this.b=i)},x3dom.fields.SFColor.parse=function(e){try{var t=/^([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)$/.exec(e);return new x3dom.fields.SFColor(+t[1],+t[2],+t[3])}catch(i){return x3dom.fields.SFColor.colorParse(e)}},x3dom.fields.SFColor.prototype.setHSV=function(){x3dom.debug.logWarning("SFColor.setHSV() NYI")},x3dom.fields.SFColor.prototype.getHSV=function(){var e=0,t=0,i=0;return x3dom.debug.logWarning("SFColor.getHSV() NYI"),[e,t,i]},x3dom.fields.SFColor.prototype.setValues=function(e){this.r=e.r,this.g=e.g,this.b=e.b},x3dom.fields.SFColor.prototype.equals=function(e,t){return Math.abs(this.r-e.r)<t&&Math.abs(this.g-e.g)<t&&Math.abs(this.b-e.b)<t},x3dom.fields.SFColor.prototype.add=function(e){return new x3dom.fields.SFColor(this.r+e.r,this.g+e.g,this.b+e.b)},x3dom.fields.SFColor.prototype.subtract=function(e){return new x3dom.fields.SFColor(this.r-e.r,this.g-e.g,this.b-e.b)},x3dom.fields.SFColor.prototype.multiply=function(e){return new x3dom.fields.SFColor(this.r*e,this.g*e,this.b*e)},x3dom.fields.SFColor.prototype.toGL=function(){return[this.r,this.g,this.b]},x3dom.fields.SFColor.prototype.toString=function(){return"{ r "+this.r+" g "+this.g+" b "+this.b+" }"},x3dom.fields.SFColor.prototype.setValueByStr=function(e){try{var t=/^([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)$/.exec(e);this.r=+t[1],this.g=+t[2],this.b=+t[3]}catch(i){var o=x3dom.fields.SFColor.colorParse(e);this.r=o.r,this.g=o.g,this.b=o.b}return this},x3dom.fields.SFColor.colorParse=function(e){var t=0,i=0,o=0,s={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};if(s[e]&&(e="#"+s[e]),e.substr&&"#"===e.substr(0,1)){e=e.substr(1);var n=e.length;6===n?(t=parseInt("0x"+e.substr(0,2),16)/255,i=parseInt("0x"+e.substr(2,2),16)/255,o=parseInt("0x"+e.substr(4,2),16)/255):3===n&&(t=parseInt("0x"+e.substr(0,1),16)/15,i=parseInt("0x"+e.substr(1,1),16)/15,o=parseInt("0x"+e.substr(2,1),16)/15)}return new x3dom.fields.SFColor(t,i,o)},x3dom.fields.SFImage=function(e,t,i,o){0===arguments.length?(this.width=this.height=this.comp=0,this.array=[]):(this.width=e,this.height=t,this.comp=i,o.map(function(e){this.array.push(e)},this.array))},x3dom.fields.SFImage.parse=function(e){var t=new x3dom.fields.SFImage;return t.setValueByStr(e),t},x3dom.fields.SFImage.prototype.setValueByStr=function(e){var t=e.match(/(\w+)/g),i=t.length,o=0,s="0123456789ABCDEF";if(this.array=[],!(i>2))return this.width=0,this.height=0,void(this.comp=0);this.width=+t[0],this.height=+t[1],this.comp=+t[2],o=2*this.comp;for(var n,r=3;i>r;r++)if(t[r].substr){if("x"!==t[r].substr(1,1).toLowerCase()){for(var a="",d=parseInt(t[r],10);0!==d;)a=s.charAt(d%16)+a,d>>=4;for(n=a.length;a.length<o;)a="0"+a;t[r]="0x"+a}if("x"===t[r].substr(1,1).toLowerCase()){t[r]=t[r].substr(2),n=t[r].length;var h,l,_,f;n===o&&(1===this.comp?(h=parseInt("0x"+t[r].substr(0,2),16),this.array.push(h)):2===this.comp?(h=parseInt("0x"+t[r].substr(0,2),16),l=parseInt("0x"+t[r].substr(2,2),16),this.array.push(h,l)):3===this.comp?(h=parseInt("0x"+t[r].substr(0,2),16),l=parseInt("0x"+t[r].substr(2,2),16),_=parseInt("0x"+t[r].substr(4,2),16),this.array.push(h,l,_)):4===this.comp&&(h=parseInt("0x"+t[r].substr(0,2),16),l=parseInt("0x"+t[r].substr(2,2),16),_=parseInt("0x"+t[r].substr(4,2),16),f=parseInt("0x"+t[r].substr(6,2),16),this.array.push(h,l,_,f)))}}},x3dom.fields.SFImage.prototype.toGL=function(){var e=[];return Array.map(this.array,function(t){e.push(t)}),e},x3dom.fields.MFColor=function(e){if(0===arguments.length);else{var t=this;e.map(function(e){t.push(e)},this)}},x3dom.fields.MFColor.prototype=x3dom.extend([]),x3dom.fields.MFColor.parse=function(e){for(var t=e.match(/([+\-0-9eE\.]+)/g),i=[],o=0,s=t.length;s>o;o+=3)i.push(new x3dom.fields.SFColor(+t[o+0],+t[o+1],+t[o+2]));return new x3dom.fields.MFColor(i)},x3dom.fields.MFColor.prototype.setValueByStr=function(e){for(;this.length;)this.pop();for(var t=e.match(/([+\-0-9eE\.]+)/g),i=0,o=t.length;o>i;i+=3)this.push(new x3dom.fields.SFColor(+t[i+0],+t[i+1],+t[i+2]))},x3dom.fields.MFColor.prototype.toGL=function(){var e=[];return Array.map(this,function(t){e.push(t.r),e.push(t.g),e.push(t.b)}),e},x3dom.fields.SFColorRGBA=function(e,t,i,o){0===arguments.length?this.r=this.g=this.b=this.a=0:(this.r=e,this.g=t,this.b=i,this.a=o)},x3dom.fields.SFColorRGBA.parse=function(e){try{var t=/^([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)$/.exec(e);return new x3dom.fields.SFColorRGBA(+t[1],+t[2],+t[3],+t[4])}catch(i){return x3dom.fields.SFColorRGBA.colorParse(e)}},x3dom.fields.SFColorRGBA.prototype.setValues=function(e){this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a},x3dom.fields.SFColorRGBA.prototype.equals=function(e,t){return Math.abs(this.r-e.r)<t&&Math.abs(this.g-e.g)<t&&Math.abs(this.b-e.b)<t&&Math.abs(this.a-e.a)<t},x3dom.fields.SFColorRGBA.prototype.toGL=function(){return[this.r,this.g,this.b,this.a]},x3dom.fields.SFColorRGBA.prototype.toString=function(){return"{ r "+this.r+" g "+this.g+" b "+this.b+" a "+this.a+" }"},x3dom.fields.SFColorRGBA.prototype.setValueByStr=function(e){try{var t=/^([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)$/.exec(e);this.r=+t[1],this.g=+t[2],this.b=+t[3],this.a=+t[4]}catch(i){var o=x3dom.fields.SFColorRGBA.colorParse(e);this.r=o.r,this.g=o.g,this.b=o.b,this.a=o.a}return this},x3dom.fields.MFColorRGBA=function(e){if(0===arguments.length);else{var t=this;e.map(function(e){t.push(e)},this)}},x3dom.fields.MFColorRGBA.prototype=x3dom.extend([]),x3dom.fields.MFColorRGBA.parse=function(e){for(var t=e.match(/([+\-0-9eE\.]+)/g),i=[],o=0,s=t.length;s>o;o+=4)i.push(new x3dom.fields.SFColorRGBA(+t[o+0],+t[o+1],+t[o+2],+t[o+3]));return new x3dom.fields.MFColorRGBA(i)},x3dom.fields.MFColorRGBA.prototype.setValueByStr=function(e){for(;this.length;)this.pop();for(var t=e.match(/([+\-0-9eE\.]+)/g),i=0,o=t.length;o>i;i+=4)this.push(new x3dom.fields.SFColor(+t[i+0],+t[i+1],+t[i+2],+t[i+3]))},x3dom.fields.MFColorRGBA.prototype.toGL=function(){var e=[];return Array.map(this,function(t){e.push(t.r),e.push(t.g),e.push(t.b),e.push(t.a)}),e},x3dom.fields.MFRotation=function(e){if(0===arguments.length);else{var t=this;e.map(function(e){t.push(e)},this)}},x3dom.fields.MFRotation.prototype=x3dom.extend([]),x3dom.fields.MFRotation.parse=function(e){for(var t=e.match(/([+\-0-9eE\.]+)/g),i=[],o=0,s=t.length;s>o;o+=4)i.push(x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(+t[o+0],+t[o+1],+t[o+2]),+t[o+3]));return new x3dom.fields.MFRotation(i)},x3dom.fields.MFRotation.prototype.setValueByStr=function(e){for(;this.length;)this.pop();for(var t=e.match(/([+\-0-9eE\.]+)/g),i=0,o=t.length;o>i;i+=4)this.push(x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(+t[i+0],+t[i+1],+t[i+2]),+t[i+3]))},x3dom.fields.MFRotation.prototype.toGL=function(){var e=[];return e},x3dom.fields.MFVec3f=function(e){if(0===arguments.length);else{var t=this;e.map(function(e){t.push(e)},this)}},x3dom.fields.MFVec3f.copy=function(e){var t=new x3dom.fields.MFVec3f;return e.map(function(e){t.push(x3dom.fields.SFVec3f.copy(e))},this),t},x3dom.fields.MFVec3f.prototype=x3dom.extend([]),x3dom.fields.MFVec3f.parse=function(e){for(var t=e.match(/([+\-0-9eE\.]+)/g),i=[],o=0,s=t.length;s>o;o+=3)i.push(new x3dom.fields.SFVec3f(+t[o+0],+t[o+1],+t[o+2]));return new x3dom.fields.MFVec3f(i)},x3dom.fields.MFVec3f.prototype.setValueByStr=function(e){for(;this.length;)this.pop();for(var t=e.match(/([+\-0-9eE\.]+)/g),i=0,o=t.length;o>i;i+=3)this.push(new x3dom.fields.SFVec3f(+t[i+0],+t[i+1],+t[i+2]))},x3dom.fields.MFVec3f.prototype.toGL=function(){var e=[];return Array.map(this,function(t){e.push(t.x),e.push(t.y),e.push(t.z)}),e},x3dom.fields.MFVec2f=function(e){if(0===arguments.length);else{var t=this;e.map(function(e){t.push(e)},this)}},x3dom.fields.MFVec2f.prototype=x3dom.extend([]),x3dom.fields.MFVec2f.parse=function(e){for(var t=e.match(/([+\-0-9eE\.]+)/g),i=[],o=0,s=t.length;s>o;o+=2)i.push(new x3dom.fields.SFVec2f(+t[o+0],+t[o+1]));return new x3dom.fields.MFVec2f(i)},x3dom.fields.MFVec2f.prototype.setValueByStr=function(e){for(;this.length;)this.pop();for(var t=e.match(/([+\-0-9eE\.]+)/g),i=0,o=t.length;o>i;i+=2)this.push(new x3dom.fields.SFVec2f(+t[i+0],+t[i+1]))},x3dom.fields.MFVec2f.prototype.toGL=function(){var e=[];return Array.map(this,function(t){e.push(t.x),e.push(t.y)}),e},x3dom.fields.MFInt32=function(e){if(0===arguments.length);else{var t=this;
e.map(function(e){t.push(e)},this)}},x3dom.fields.MFInt32.prototype=x3dom.extend([]),x3dom.fields.MFInt32.parse=function(e){for(var t=e.match(/([+\-]?\d+\s*){1},?\s*/g),i=[],o=0,s=t.length;s>o;++o)i.push(parseInt(t[o],10));return new x3dom.fields.MFInt32(i)},x3dom.fields.MFInt32.prototype.setValueByStr=function(e){for(;this.length;)this.pop();for(var t=e.match(/([+\-]?\d+\s*){1},?\s*/g),i=0,o=t.length;o>i;++i)this.push(parseInt(t[i],10))},x3dom.fields.MFInt32.prototype.toGL=function(){var e=[];return Array.map(this,function(t){e.push(t)}),e},x3dom.fields.MFFloat=function(e){if(0===arguments.length);else{var t=this;e.map(function(e){t.push(e)},this)}},x3dom.fields.MFFloat.prototype=x3dom.extend([]),x3dom.fields.MFFloat.parse=function(e){for(var t=e.match(/([+\-0-9eE\.]+)/g),i=[],o=0,s=t.length;s>o;o++)i.push(+t[o]);return new x3dom.fields.MFFloat(i)},x3dom.fields.MFFloat.prototype.setValueByStr=function(e){for(;this.length;)this.pop();for(var t=e.match(/([+\-0-9eE\.]+)/g),i=0,o=t.length;o>i;i++)this.push(+t[i])},x3dom.fields.MFFloat.prototype.toGL=function(){var e=[];return Array.map(this,function(t){e.push(t)}),e},x3dom.fields.MFString=function(e){if(0===arguments.length);else{var t=this;e.map(function(e){t.push(e)},this)}},x3dom.fields.MFString.parse=function(e){var t=[];if(e.length&&'"'==e[0])for(var i,o=/"((?:[^\\"]|\\\\|\\")*)"/g;i=o.exec(e);){var s=i[1].replace(/\\([\\"])/,"$1");void 0!==s&&t.push(s)}else t.push(e);return new x3dom.fields.MFString(t)},x3dom.fields.MFString.prototype=x3dom.extend([]),x3dom.fields.MFString.prototype.setValueByStr=function(e){for(var t=this;t.length;)t.pop();if(e.length&&'"'==e[0])for(var i,o=/"((?:[^\\"]|\\\\|\\")*)"/g;i=o.exec(e);){var s=i[1].replace(/\\([\\"])/,"$1");void 0!==s&&t.push(s)}else t.push(e);return this},x3dom.fields.MFString.prototype.toString=function(){for(var e="",t=0;t<this.length;t++)e=e+this[t]+" ";return e},x3dom.fields.SFNode=function(e){this.type=e,this.node=null},x3dom.fields.SFNode.prototype.hasLink=function(e){return e?this.node===e:this.node},x3dom.fields.SFNode.prototype.addLink=function(e){return this.node=e,!0},x3dom.fields.SFNode.prototype.rmLink=function(e){return this.node===e?(this.node=null,!0):!1},x3dom.fields.MFNode=function(e){this.type=e,this.nodes=[]},x3dom.fields.MFNode.prototype.hasLink=function(e){if(!e)return this.length>0;for(var t=0,i=this.nodes.length;i>t;t++)if(this.nodes[t]===e)return!0;return!1},x3dom.fields.MFNode.prototype.addLink=function(e){return this.nodes.push(e),!0},x3dom.fields.MFNode.prototype.rmLink=function(e){for(var t=0,i=this.nodes.length;i>t;t++)if(this.nodes[t]===e)return this.nodes.splice(t,1),!0;return!1},x3dom.fields.MFNode.prototype.length=function(){return this.nodes.length},x3dom.fields.Line=function(e,t){if(0===arguments.length)this.pos=new x3dom.fields.SFVec3f(0,0,0),this.dir=new x3dom.fields.SFVec3f(0,0,1);else{this.pos=new x3dom.fields.SFVec3f(e.x,e.y,e.z);var i=t.length();i&&(i=1/i),this.dir=new x3dom.fields.SFVec3f(t.x*i,t.y*i,t.z*i)}this.enter=0,this.exit=0,this.hitObject=null,this.hitPoint={},this.dist=Number.MAX_VALUE},x3dom.fields.Line.prototype.toString=function(){var e="Line: ["+this.pos.toString()+"; "+this.dir.toString()+"]";return e},x3dom.fields.Line.prototype.intersect=function(e,t){var i,o,s,n=0,r=Number.MAX_VALUE;if(this.dir.x>x3dom.fields.Eps)i=1/this.dir.x,o=(e.x-this.pos.x)*i,s=(t.x-this.pos.x)*i,r>s&&(r=s),o>n&&(n=o);else if(this.dir.x<-x3dom.fields.Eps)i=1/this.dir.x,o=(t.x-this.pos.x)*i,s=(e.x-this.pos.x)*i,r>s&&(r=s),o>n&&(n=o);else if(this.pos.x<e.x||this.pos.x>t.x)return!1;if(this.dir.y>x3dom.fields.Eps){if(i=1/this.dir.y,o=(e.y-this.pos.y)*i,s=(t.y-this.pos.y)*i,r>s&&(r=s),o>n&&(n=o),n-r>=x3dom.fields.Eps)return!1}else if(this.dir.y<-x3dom.fields.Eps){if(i=1/this.dir.y,o=(t.y-this.pos.y)*i,s=(e.y-this.pos.y)*i,r>s&&(r=s),o>n&&(n=o),n-r>=x3dom.fields.Eps)return!1}else if(this.pos.y<e.y||this.pos.y>t.y)return!1;if(this.dir.z>x3dom.fields.Eps)i=1/this.dir.z,o=(e.z-this.pos.z)*i,s=(t.z-this.pos.z)*i,r>s&&(r=s),o>n&&(n=o);else if(this.dir.z<-x3dom.fields.Eps)i=1/this.dir.z,o=(t.z-this.pos.z)*i,s=(e.z-this.pos.z)*i,r>s&&(r=s),o>n&&(n=o);else if(this.pos.z<e.z||this.pos.z>t.z)return!1;return this.enter=n,this.exit=r,n-r<x3dom.fields.Eps},x3dom.NodeNameSpace=function(e,t){this.name=e,this.doc=t,this.baseURL="",this.defMap={},this.parent=null,this.childSpaces=[]},x3dom.NodeNameSpace.prototype.addNode=function(e,t){this.defMap[t]=e,e._nameSpace=this},x3dom.NodeNameSpace.prototype.removeNode=function(){var e=this.defMap.name;delete this.defMap.name,e&&(e._nameSpace=null)},x3dom.NodeNameSpace.prototype.getNamedNode=function(e){return this.defMap[e]},x3dom.NodeNameSpace.prototype.getNamedElement=function(e){var t=this.defMap[e];return t?t._xmlNode:null},x3dom.NodeNameSpace.prototype.addSpace=function(e){this.childSpaces.push(e),e.parent=this},x3dom.NodeNameSpace.prototype.removeSpace=function(e){this.childSpaces.push(e),e.parent=null},x3dom.NodeNameSpace.prototype.setBaseURL=function(e){var t=e.lastIndexOf("/");this.baseURL=t>=0?e.substr(0,t+1):"",x3dom.debug.logInfo("setBaseURL: "+this.baseURL)},x3dom.NodeNameSpace.prototype.getURL=function(e){return void 0!==e&&e.length?"/"===e[0]||e.indexOf(":")>=0?e:this.baseURL+e:""},x3dom.setElementAttribute=function(e,t){this.getAttribute(e);this.__setAttribute(e,t),this._x3domNode.updateField(e,t),this._x3domNode._nameSpace.doc.needRender=!0},x3dom.NodeNameSpace.prototype.setupTree=function(e){var t;if(x3dom.isX3DElement(e)){if(e._x3domNode)return void x3dom.debug.logWarning("Tree is already initialized");if(x3dom.userAgentFeature.supportsDOMAttrModified!==!1||void 0===e.tagName||e.__setAttribute||(e.__setAttribute=e.setAttribute,e.setAttribute=x3dom.setElementAttribute),void 0===e.tagName||e.__addEventListener||e.__removeEventListener||(e.__addEventListener=e.addEventListener,e.addEventListener=function(e,t,i){this._x3domNode._listeners[e]||(this._x3domNode._listeners[e]=[]),this._x3domNode._listeners[e].push(t),x3dom.debug.logInfo("addEventListener for "+this.tagName+".on"+e),this.__addEventListener(e,t,i)},e.__removeEventListener=e.removeEventListener,e.removeEventListener=function(e,t,i){var o=this._x3domNode._listeners[e];if(o)for(var s=0;s<o.length;s++)o[s]==t&&(o.splice(s,1),x3dom.debug.logInfo("removeEventListener for "+this.tagName+".on"+e));this.__removeEventListener(e,t,i)}),e.hasAttribute("USE"))return t=this.defMap[e.getAttribute("USE")],null===t&&x3dom.debug.logWarning("Could not USE: "+e.getAttribute("USE")),t;if("route"===e.localName.toLowerCase()){var i=e,o=this.defMap[i.getAttribute("fromNode")],s=this.defMap[i.getAttribute("toNode")];return o&&s?(o.setupRoute(i.getAttribute("fromField"),s,i.getAttribute("toField")),null):(x3dom.debug.logWarning("Broken route - can't find all DEFs for "+i.getAttribute("fromNode")+" -> "+i.getAttribute("toNode")),null)}var n=x3dom.nodeTypesLC[e.localName.toLowerCase()];if(void 0!==n){var r={doc:this.doc,xmlNode:e};t=new n(r),t._nameSpace=this,e.hasAttribute("DEF")?(t._DEF=e.getAttribute("DEF"),this.defMap[t._DEF]=t):e.hasAttribute("id")&&(t._DEF=e.getAttribute("id"),this.defMap[t._DEF]=t),t._xmlNode=e,e._x3domNode=t;var a=this;return Array.forEach(e.childNodes,function(e){var i=a.setupTree(e);i&&t.addChild(i,e.getAttribute("containerField"))}),t.nodeChanged(),t}x3dom.debug.logInfo("Unrecognised X3D element &lt;"+e.localName+"&gt;.")}else e.localName&&(x3dom.debug.logInfo("Unrecognised X3D element &lt;"+e.localName+"&gt;."),t=null);return t},x3dom.registerNodeType("X3DNode","Core",defineClass(null,function(){this._DEF=null,this._nameSpace=null,this._vf={},this._cf={},this._fieldWatchers={},this._parentNodes=[],this._listeners={},this._childNodes=[],this.addField_SFNode("metadata",x3dom.nodeTypes.X3DMetadataObject)},{type:function(){return this.constructor},typeName:function(){return this.constructor._typeName},addChild:function(e,t){if(e){var i=null;if(t)i=this._cf[t];else for(var o in this._cf)if(this._cf.hasOwnProperty(o)){var s=this._cf[o];if(x3dom.isa(e,s.type)){i=s;break}}if(i&&i.addLink(e))return e._parentNodes.push(this),this._childNodes.push(e),e.parentAdded(this),!0}return!1},removeChild:function(e){if(e)for(var t in this._cf)if(this._cf.hasOwnProperty(t)){var i=this._cf[t];if(i.rmLink(e)){for(var o=0,s=e._parentNodes.length;s>o;o++)e._parentNodes[o]===this&&(e._parentNodes.splice(o,1),e.parentRemoved(this));for(var n=0,r=this._childNodes.length;r>n;n++)if(this._childNodes[n]===e)return this._childNodes.splice(n,1),!0}}return!1},parentAdded:function(){},parentRemoved:function(){for(var e=0,t=this._childNodes.length;t>e;e++)this._childNodes[e]&&this._childNodes[e].parentRemoved(this)},getCurrentTransform:function(){return this._parentNodes.length>=1?this.transformMatrix(this._parentNodes[0].getCurrentTransform()):x3dom.fields.SFMatrix4f.identity()},transformMatrix:function(e){return e},getVolume:function(e,t,i){for(var o=!1,s=0,n=this._childNodes.length;n>s;s++)if(this._childNodes[s]){var r=x3dom.fields.SFVec3f.MAX(),a=x3dom.fields.SFVec3f.MIN();o=this._childNodes[s].getVolume(r,a,i)||o,o&&(e.x>r.x&&(e.x=r.x),e.y>r.y&&(e.y=r.y),e.z>r.z&&(e.z=r.z),t.x<a.x&&(t.x=a.x),t.y<a.y&&(t.y=a.y),t.z<a.z&&(t.z=a.z))}return o},find:function(e){for(var t=0;t<this._childNodes.length;t++)if(this._childNodes[t]){if(this._childNodes[t].constructor==e)return this._childNodes[t];var i=this._childNodes[t].find(e);if(i)return i}return null},findAll:function(e){for(var t=[],i=0;i<this._childNodes.length;i++)this._childNodes[i]&&(this._childNodes[i].constructor==e&&t.push(this._childNodes[i]),t=t.concat(this._childNodes[i].findAll(e)));return t},findParentProperty:function(e,t){var i=this[e];if(!i&&t&&this._xmlNode&&(i=this._xmlNode[e]),!i)for(var o=0,s=this._parentNodes.length;s>o&&!(i=this._parentNodes[o].findParentProperty(e,t));o++);return i},findX3DDoc:function(){return this._nameSpace.doc},collectDrawableObjects:function(e,t){for(var i=0;i<this._childNodes.length;i++)if(this._childNodes[i]){var o=this._childNodes[i].transformMatrix(e);this._childNodes[i].collectDrawableObjects(o,t)}},doIntersect:function(e){for(var t=!1,i=0;i<this._childNodes.length;i++)this._childNodes[i]&&(t=this._childNodes[i].doIntersect(e)||t);return t},postMessage:function(e,t){this._vf[e]=t;var i=this._fieldWatchers[e],o=this;i&&Array.forEach(i,function(e){e.call(o,t)})},updateField:function(e,t){var i=this._vf[e];if(void 0===i&&(i={},this._vf[e]=i),null!==i){try{this._vf[e].setValueByStr(t)}catch(o){try{switch((typeof this._vf[e]).toString()){case"number":this._vf[e]=+t;break;case"boolean":this._vf[e]="true"===t.toLowerCase();break;case"string":this._vf[e]=t}}catch(s){x3dom.debug.logError("updateField: setValueByStr() NYI for "+typeof i)}}this.fieldChanged(e)}},setupRoute:function(e,t,i){var o,s,n="set_",r="_changed";this._vf[e]||(o=e.indexOf(n),0===o?(s=e.substr(n.length,e.length-1),this._vf[s]&&(e=s)):(o=e.indexOf(r),o>0&&(s=e.substr(0,e.length-r.length),this._vf[s]&&(e=s)))),t._vf[i]||(o=i.indexOf(n),0===o?(s=i.substr(n.length,i.length-1),t._vf[s]&&(i=s)):(o=i.indexOf(r),o>0&&(s=i.substr(0,i.length-r.length),t._vf[s]&&(i=s)))),this._fieldWatchers[e]||(this._fieldWatchers[e]=[]),this._fieldWatchers[e].push(function(e){t.postMessage(i,e)}),t._fieldWatchers[i]||(t._fieldWatchers[i]=[]),t._fieldWatchers[i].push(function(e){t._vf[i]=e,t.fieldChanged(i)})},fieldChanged:function(){},nodeChanged:function(){},addField_SFInt32:function(e,t,i){this._vf[t]=e&&e.xmlNode.hasAttribute(t)?parseInt(e.xmlNode.getAttribute(t),10):i},addField_SFFloat:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?+e.xmlNode.getAttribute(t):i},addField_SFDouble:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?+e.xmlNode.getAttribute(t):i},addField_SFTime:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?+e.xmlNode.getAttribute(t):i},addField_SFBool:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?"true"===e.xmlNode.getAttribute(t).toLowerCase():i},addField_SFString:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?e.xmlNode.getAttribute(t):i},addField_SFColor:function(e,t,i,o,s){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFColor.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFColor(i,o,s)},addField_SFColorRGBA:function(e,t,i,o,s,n){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFColorRGBA.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFColorRGBA(i,o,s,n)},addField_SFVec2f:function(e,t,i,o){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFVec2f.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFVec2f(i,o)},addField_SFVec3f:function(e,t,i,o,s){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFVec3f.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFVec3f(i,o,s)},addField_SFVec3d:function(e,t,i,o,s){this.addField_SFVec3f(e,t,i,o,s)},addField_SFRotation:function(e,t,i,o,s,n){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.Quaternion.parseAxisAngle(e.xmlNode.getAttribute(t)):x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(i,o,s),n)},addField_SFMatrix4f:function(e,t,i,o,s,n,r,a,d,h,l,_,f,u,c,m,p,g){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFMatrix4f.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFMatrix4f(i,o,s,n,r,a,d,h,l,_,f,u,c,m,p,g)},addField_SFImage:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFImage.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFImage(i)},addField_MFString:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFString.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFString(i)},addField_MFInt32:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFInt32.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFInt32(i)},addField_MFFloat:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFFloat.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFFloat(i)},addField_MFDouble:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFFloat.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFFloat(i)},addField_MFColor:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFColor.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFColor(i)},addField_MFColorRGBA:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFColorRGBA.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFColorRGBA(i)},addField_MFVec2f:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFVec2f.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFVec2f(i)},addField_MFVec3f:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFVec3f.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFVec3f(i)},addField_MFVec3d:function(e,t,i){this.addField_MFVec3f(e,t,i)},addField_MFRotation:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFRotation.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFRotation(i)},addField_SFNode:function(e,t){this._cf[e]=new x3dom.fields.SFNode(t)},addField_MFNode:function(e,t){this._cf[e]=new x3dom.fields.MFNode(t)}})),x3dom.registerNodeType("X3DMetadataObject","Core",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.X3DMetadataObject.superClass.call(this,e),this.addField_SFString(e,"name",""),this.addField_SFString(e,"reference","")})),x3dom.registerNodeType("MetadataDouble","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(e){x3dom.nodeTypes.MetadataDouble.superClass.call(this,e),this.addField_MFDouble(e,"value",[])})),x3dom.registerNodeType("MetadataFloat","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(e){x3dom.nodeTypes.MetadataFloat.superClass.call(this,e),this.addField_MFFloat(e,"value",[])})),x3dom.registerNodeType("MetadataInteger","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(e){x3dom.nodeTypes.MetadataInteger.superClass.call(this,e),this.addField_MFInt32(e,"value",[])})),x3dom.registerNodeType("MetadataSet","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(e){x3dom.nodeTypes.MetadataSet.superClass.call(this,e),this.addField_MFNode("value",x3dom.nodeTypes.X3DMetadataObject)})),x3dom.registerNodeType("MetadataString","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(e){x3dom.nodeTypes.MetadataString.superClass.call(this,e),this.addField_MFString(e,"value",[])})),x3dom.registerNodeType("Field","Core",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.Field.superClass.call(this,e),this.addField_SFString(e,"name",""),this.addField_SFString(e,"type",""),this.addField_SFString(e,"value","")},{fieldChanged:function(e){var t=this;"value"===e&&Array.forEach(this._parentNodes,function(e){e.fieldChanged(t._vf.name)})}})),x3dom.registerNodeType("X3DChildNode","Core",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.X3DChildNode.superClass.call(this,e)})),x3dom.registerNodeType("X3DBindableNode","Core",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DBindableNode.superClass.call(this,e),this.addField_SFBool(e,"set_bind",!1),this.addField_SFString(e,"description",""),this.addField_SFBool(e,"isActive",!1),this._autoGen=e.autoGen?!0:!1,e&&e.doc._bindableBag?this._stack=e.doc._bindableBag.addBindable(this):(this._stack=null,x3dom.debug.logError("Could not find bindableBag for registration "+this.typeName()))},{initDefault:function(){},bind:function(e){this._stack?e?this._stack.push(this):this._stack.pop(this):x3dom.debug.logError("No BindStack in Bindable\n")},activate:function(){x3dom.debug.logInfo("activate Bindable "+this._DEF),this.postMessage("isActive",!0)},deactivate:function(){x3dom.debug.logInfo("deactivate Bindable "+this._DEF),this.postMessage("isActive",!1)},fieldChanged:function(e){"set_bind"===e&&this.bind(this._vf.set_bind)},nodeChanged:function(){}})),x3dom.registerNodeType("WorldInfo","Core",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.WorldInfo.superClass.call(this,e),this.addField_MFString(e,"info",[]),this.addField_SFString(e,"title",""),x3dom.debug.logInfo(this._vf.info),x3dom.debug.logInfo(this._vf.title)},{})),x3dom.registerNodeType("X3DSensorNode","Core",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DSensorNode.superClass.call(this,e)})),x3dom.registerNodeType("Param","Core",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.Param.superClass.call(this,e)},{nodeChanged:function(){x3dom.debug.logWarning('DEPRECATED 1.3: Param element needs to be child of X3D element [<a href="http://x3dom.org/docs/latest/configuration.html">DOCS</a>]')}})),x3dom.registerNodeType("X3DGroupingNode","Grouping",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DGroupingNode.superClass.call(this,e),this.addField_SFBool(e,"render",!0),this.addField_MFNode("children",x3dom.nodeTypes.X3DChildNode)},{collectDrawableObjects:function(e,t){if(this._vf.render)for(var i=0;i<this._childNodes.length;i++)if(this._childNodes[i]){var o=this._childNodes[i].transformMatrix(e);this._childNodes[i].collectDrawableObjects(o,t)}}})),x3dom.registerNodeType("Switch","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.Switch.superClass.call(this,e),this.addField_SFInt32(e,"whichChoice",-1)},{getVolume:function(e,t,i){return this._vf.whichChoice<0||this._vf.whichChoice>=this._childNodes.length?!1:this._childNodes[this._vf.whichChoice]?this._childNodes[this._vf.whichChoice].getVolume(e,t,i):!1},find:function(e){if(this._vf.whichChoice<0||this._vf.whichChoice>=this._childNodes.length)return null;if(this._childNodes[this._vf.whichChoice]){if(this._childNodes[this._vf.whichChoice].constructor==e)return this._childNodes[this._vf.whichChoice];var t=this._childNodes[this._vf.whichChoice].find(e);if(t)return t}return null},findAll:function(e){if(this._vf.whichChoice<0||this._vf.whichChoice>=this._childNodes.length)return[];var t=[];return this._childNodes[this._vf.whichChoice]&&(this._childNodes[this._vf.whichChoice].constructor==e&&t.push(this._childNodes[this._vf.whichChoice]),t=t.concat(this._childNodes[this._vf.whichChoice].findAll(e))),t},collectDrawableObjects:function(e,t){if(!(this._vf.whichChoice<0||this._vf.whichChoice>=this._childNodes.length)&&this._childNodes[this._vf.whichChoice]){var i=this._childNodes[this._vf.whichChoice].transformMatrix(e);this._childNodes[this._vf.whichChoice].collectDrawableObjects(i,t)}},doIntersect:function(e){return this._vf.whichChoice<0||this._vf.whichChoice>=this._childNodes.length?!1:this._childNodes[this._vf.whichChoice]?this._childNodes[this._vf.whichChoice].doIntersect(e):!1}})),x3dom.registerNodeType("X3DTransformNode","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.X3DTransformNode.superClass.call(this,e),e.doc._nodeBag.trans.push(this),this._trafo=null},{tick:function(){if(this._xmlNode&&(this._xmlNode.transform||this._xmlNode.hasAttribute("transform")||this._listeners.transform)){var e=this.getCurrentTransform(),t={target:{},type:"transform",worldX:e._03,worldY:e._13,worldZ:e._23,stopPropagation:function(){this.cancelBubble=!0}},i=this._xmlNode[t.type];if("function"==typeof i)i.call(this._xmlNode,t);else{var o=this._xmlNode.getAttribute(t.type),s=new Function("event",o);s.call(this._xmlNode,t)}var n=this._listeners[t.type];if(n)for(var r=0;r<n.length;r++)n[r].call(this._xmlNode,t)}var a=x3dom.getStyle(this._xmlNode,"-webkit-transform");return a&&"none"!=a?(this._trafo.setValueByStr(a),!0):!1},transformMatrix:function(e){return e.mult(this._trafo)},getVolume:function(e,t,i){for(var o=x3dom.fields.SFVec3f.MAX(),s=x3dom.fields.SFVec3f.MIN(),n=!1,r=0,a=this._childNodes.length;a>r;r++)if(this._childNodes[r]){var d=x3dom.fields.SFVec3f.MAX(),h=x3dom.fields.SFVec3f.MIN();n=this._childNodes[r].getVolume(d,h,i)||n,n&&(o.x>d.x&&(o.x=d.x),o.y>d.y&&(o.y=d.y),o.z>d.z&&(o.z=d.z),s.x<h.x&&(s.x=h.x),s.y<h.y&&(s.y=h.y),s.z<h.z&&(s.z=h.z))}return n&&(o=this._trafo.multMatrixPnt(o),s=this._trafo.multMatrixPnt(s),e.x=o.x<s.x?o.x:s.x,e.y=o.y<s.y?o.y:s.y,e.z=o.z<s.z?o.z:s.z,t.x=s.x>o.x?s.x:o.x,t.y=s.y>o.y?s.y:o.y,t.z=s.z>o.z?s.z:o.z),n},doIntersect:function(e){var t=!1,i=this._trafo.inverse(),o=new x3dom.fields.SFVec3f(e.pos.x,e.pos.y,e.pos.z),s=new x3dom.fields.SFVec3f(e.dir.x,e.dir.y,e.dir.z);e.pos=i.multMatrixPnt(e.pos),e.dir=i.multMatrixVec(e.dir),e.hitObject&&(e.dist*=e.dir.length());for(var n=0;n<this._childNodes.length;n++)this._childNodes[n]&&(t=this._childNodes[n].doIntersect(e)||t);return e.pos.setValues(o),e.dir.setValues(s),t&&(e.hitPoint=this._trafo.multMatrixPnt(e.hitPoint),e.dist*=e.dir.length()),t},parentRemoved:function(){var e,t;if(0===this._parentNodes.length){var i=this.findX3DDoc();for(e=0,t=i._nodeBag.trans.length;t>e;e++)i._nodeBag.trans[e]===this&&i._nodeBag.trans.splice(e,1)}for(e=0,t=this._childNodes.length;t>e;e++)this._childNodes[e]&&this._childNodes[e].parentRemoved(this)}})),x3dom.registerNodeType("Transform","Grouping",defineClass(x3dom.nodeTypes.X3DTransformNode,function(e){x3dom.nodeTypes.Transform.superClass.call(this,e),this.addField_SFVec3f(e,"center",0,0,0),this.addField_SFVec3f(e,"translation",0,0,0),this.addField_SFRotation(e,"rotation",0,0,1,0),this.addField_SFVec3f(e,"scale",1,1,1),this.addField_SFRotation(e,"scaleOrientation",0,0,1,0),this._trafo=x3dom.fields.SFMatrix4f.translation(this._vf.translation.add(this._vf.center)).mult(this._vf.rotation.toMatrix()).mult(this._vf.scaleOrientation.toMatrix()).mult(x3dom.fields.SFMatrix4f.scale(this._vf.scale)).mult(this._vf.scaleOrientation.toMatrix().inverse()).mult(x3dom.fields.SFMatrix4f.translation(this._vf.center.negate()))},{fieldChanged:function(){this._trafo=x3dom.fields.SFMatrix4f.translation(this._vf.translation.add(this._vf.center)).mult(this._vf.rotation.toMatrix()).mult(this._vf.scaleOrientation.toMatrix()).mult(x3dom.fields.SFMatrix4f.scale(this._vf.scale)).mult(this._vf.scaleOrientation.toMatrix().inverse()).mult(x3dom.fields.SFMatrix4f.translation(this._vf.center.negate()))}})),x3dom.registerNodeType("MatrixTransform","Grouping",defineClass(x3dom.nodeTypes.X3DTransformNode,function(e){x3dom.nodeTypes.MatrixTransform.superClass.call(this,e),this.addField_SFMatrix4f(e,"matrix",1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this._trafo=this._vf.matrix},{})),x3dom.registerNodeType("Group","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.Group.superClass.call(this,e)},{})),x3dom.registerNodeType("StaticGroup","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.StaticGroup.superClass.call(this,e),x3dom.debug.logWarning("StaticGroup NYI")})),x3dom.registerNodeType("Scene","Core",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.Scene.superClass.call(this,e),this.addField_SFString(e,"pickMode","idBuf")},{})),x3dom.BindableStack=function(e,t,i,o){this._doc=e,this._type=t,this._defaultType=i,this._defaultRoot=0,this._getter=o,this._bindBag=[],this._bindStack=[]},x3dom.BindableStack.prototype.top=function(){return this._bindStack.length>=0?this._bindStack[this._bindStack.length-1]:null},x3dom.BindableStack.prototype.push=function(e){var t=this.top();t!==e&&(t&&t.deactivate(),this._bindStack.push(e),e.activate(t))},x3dom.BindableStack.prototype.replaceTop=function(e){var t=this.top();t!==e&&t&&(t.deactivate(),this._bindStack[this._bindStack.length-1]=e,e.activate(t))},x3dom.BindableStack.prototype.pop=function(e){var t;return e&&(t=this.top(),e!==t)?null:(t=this._bindStack.pop(),t&&t.deactivate(),t)},x3dom.BindableStack.prototype.switchTo=function(e){var t=this.getActive(),i=this._bindBag.length,o=0,s=0,n=-1;if(!(1>=i)){switch(e){case"first":o=this._bindBag[0];break;case"last":o=this._bindBag[i-1];break;default:for(s=0;i>s;s++)if(this._bindBag[s]==t){n=s;break}if(n>=0)for(s=n;!o&&(s="next"==e?i-1>s?s+1:0:s>0?s-1:i-1,s!=n);)this._bindBag[s]._vf.description.length>=0&&(o=this._bindBag[s])}o?this.replaceTop(o):x3dom.debug.logWarning("Cannot switch bindable; no other bindable with description found.")}},x3dom.BindableStack.prototype.getActive=function(){if(0===this._bindStack.length){if(0===this._bindBag.length){x3dom.debug.logInfo("create new "+this._defaultType._typeName+" for "+this._type._typeName+"-stack");var e=new this._defaultType({doc:this._doc,autoGen:!0});e&&(this._defaultRoot?(this._defaultRoot.addChild(e),e._nameSpace=this._defaultRoot._nameSpace):x3dom.debug.logError("stack without defaultRoot"),e.initDefault(),this._bindBag.push(e))}else x3dom.debug.logInfo("activate first "+this._type._typeName+" for "+this._type._typeName+"-stack");this._bindStack.push(this._bindBag[0]),this._bindBag[0].activate()}return this._bindStack[this._bindStack.length-1]},x3dom.BindableBag=function(e){this._stacks=[],this.addType("X3DViewpointNode","Viewpoint","getViewpoint",e),this.addType("X3DNavigationInfoNode","NavigationInfo","getNavigationInfo",e),this.addType("X3DBackgroundNode","Background","getBackground",e),this.addType("X3DFogNode","Fog","getFog",e)},x3dom.BindableBag.prototype.addType=function(e,t,i,o){var s,n=x3dom.nodeTypes[e],r=x3dom.nodeTypes[t];n&&r?(s=new x3dom.BindableStack(o,n,r,i),this._stacks.push(s)):x3dom.debug.logWarning("Invalid Bindable type/defaultType:"+e+"/"+r)},x3dom.BindableBag.prototype.setRefNode=function(e){Array.forEach(this._stacks,function(t){t._defaultRoot=e,e[t._getter]=function(){return t.getActive()}})},x3dom.BindableBag.prototype.addBindable=function(e){for(var t=0,i=this._stacks.length;i>t;t++)if(x3dom.isa(e,this._stacks[t]._type))return x3dom.debug.logInfo("register bindable "+e.typeName()),this._stacks[t]._bindBag.push(e),this._stacks[t];return x3dom.debug.logError(e.typeName()+" is not a valid bindable"),null},x3dom.registerNodeType("X3DGeometryNode","Rendering",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.X3DGeometryNode.superClass.call(this,e),this.addField_SFBool(e,"solid",!0),this.addField_SFBool(e,"ccw",!0),this._mesh=new x3dom.Mesh(this),this._pickable=!0},{getVolume:function(e,t,i){return this._mesh.getBBox(e,t,i),!0},getCenter:function(){return this._mesh.getCenter()},doIntersect:function(e){return this._pickable?this._mesh.doIntersect(e):!1},getColorTexture:function(){return null},getColorTextureURL:function(){return null}})),x3dom.registerNodeType("Mesh","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.Mesh.superClass.call(this,e),this.addField_SFString(e,"primType","triangle"),this.addField_MFInt32(e,"index",[]),this.addField_MFNode("vertexAttributes",x3dom.nodeTypes.X3DVertexAttributeNode)},{nodeChanged:function(){var e,t=(new Date).getTime(),i=this._cf.vertexAttributes.nodes.length;for(e=0;i>e;e++){var o=this._cf.vertexAttributes.nodes[e]._vf.name;switch(o.toLowerCase()){case"position":this._mesh._positions[0]=this._cf.vertexAttributes.nodes[e]._vf.value.toGL();break;case"normal":this._mesh._normals[0]=this._cf.vertexAttributes.nodes[e]._vf.value.toGL();break;case"texcoord":this._mesh._texCoords[0]=this._cf.vertexAttributes.nodes[e]._vf.value.toGL();break;case"color":this._mesh._colors[0]=this._cf.vertexAttributes.nodes[e]._vf.value.toGL();break;default:this._mesh._dynamicFields[o]={},this._mesh._dynamicFields[o].numComponents=this._cf.vertexAttributes.nodes[e]._vf.numComponents,this._mesh._dynamicFields[o].value=this._cf.vertexAttributes.nodes[e]._vf.value.toGL()}}this._mesh._indices[0]=this._vf.index.toGL(),this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3;var s=(new Date).getTime()-t;x3dom.debug.logWarning("Mesh load time: "+s+" ms")}})),x3dom.registerNodeType("PointSet","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.PointSet.superClass.call(this,e),this.addField_SFNode("coord",x3dom.nodeTypes.Coordinate),this.addField_SFNode("color",x3dom.nodeTypes.X3DColorNode),this._pickable=!1},{nodeChanged:function(){var e=(new Date).getTime(),t=this._cf.coord.node;x3dom.debug.assert(t);var i=t._vf.point,o=3,s=this._cf.color.node,n=new x3dom.fields.MFColor;if(s)n=s._vf.color,x3dom.debug.assert(i.length==n.length),x3dom.isa(s,x3dom.nodeTypes.ColorRGBA)&&(o=4);else for(var r=0,a=i.length;a>r;r++)n.push(1);this._mesh._numColComponents=o,this._mesh._indices[0]=[],this._mesh._positions[0]=i.toGL(),this._mesh._colors[0]=n.toGL(),this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._lit=!1,this._mesh._invalidate=!0,this._mesh._numCoords=this._mesh._positions[0].length/3;(new Date).getTime()-e},fieldChanged:function(e){var t,i,o;if("coord"==e){for(t=this._cf.coord.node._vf.point,o=t.length,this._mesh._positions[0]=[],i=0;o>i;i++)this._mesh._positions[0].push(t[i].x),this._mesh._positions[0].push(t[i].y),this._mesh._positions[0].push(t[i].z);this._mesh._invalidate=!0,Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0})}else if("color"==e){for(t=this._cf.color.node._vf.color,o=t.length,this._mesh._colors[0]=[],i=0;o>i;i++)this._mesh._colors[0].push(t[i].r),this._mesh._colors[0].push(t[i].g),this._mesh._colors[0].push(t[i].b);Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0})}}})),x3dom.registerNodeType("X3DComposedGeometryNode","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.X3DComposedGeometryNode.superClass.call(this,e),this.addField_SFBool(e,"colorPerVertex",!0),this.addField_SFBool(e,"normalPerVertex",!0),this.addField_MFNode("attrib",x3dom.nodeTypes.X3DVertexAttributeNode),this.addField_SFNode("coord",x3dom.nodeTypes.X3DCoordinateNode),this.addField_SFNode("normal",x3dom.nodeTypes.Normal),this.addField_SFNode("color",x3dom.nodeTypes.X3DColorNode),this.addField_SFNode("texCoord",x3dom.nodeTypes.X3DTextureCoordinateNode)},{handleAttribs:function(){var e,t=this._cf.attrib.nodes.length;for(e=0;t>e;e++){var i=this._cf.attrib.nodes[e]._vf.name;
switch(i.toLowerCase()){case"position":this._mesh._positions[0]=this._cf.attrib.nodes[e]._vf.value.toGL();break;case"normal":this._mesh._normals[0]=this._cf.attrib.nodes[e]._vf.value.toGL();break;case"texcoord":this._mesh._texCoords[0]=this._cf.attrib.nodes[e]._vf.value.toGL();break;case"color":this._mesh._colors[0]=this._cf.attrib.nodes[e]._vf.value.toGL();break;default:this._mesh._dynamicFields[i]={},this._mesh._dynamicFields[i].numComponents=this._cf.attrib.nodes[e]._vf.numComponents,this._mesh._dynamicFields[i].value=this._cf.attrib.nodes[e]._vf.value.toGL()}}}})),x3dom.registerNodeType("IndexedLineSet","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.IndexedLineSet.superClass.call(this,e),this.addField_SFBool(e,"colorPerVertex",!0),this.addField_MFNode("attrib",x3dom.nodeTypes.X3DVertexAttributeNode),this.addField_SFNode("coord",x3dom.nodeTypes.X3DCoordinateNode),this.addField_SFNode("color",x3dom.nodeTypes.X3DColorNode),this.addField_MFInt32(e,"coordIndex",[]),this.addField_MFInt32(e,"colorIndex",[]),this._pickable=!1},{nodeChanged:function(){var e=(new Date).getTime(),t=this._vf.coordIndex,i=this._vf.colorIndex,o=!1,s=!1,n=this._vf.colorPerVertex;i.length>0&&(s=!0);var r,a,d=this._cf.coord.node;x3dom.debug.assert(d),r=d.getPoints();var h=3,l=this._cf.color.node;l?(o=!0,a=l._vf.color,x3dom.isa(l,x3dom.nodeTypes.ColorRGBA)&&(h=4)):o=!1,this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._colors[0]=[];var _,f,u,c,m,p,g,x;if(o&&s)for(f=0,u=0,c=0,_=0;_<t.length;++_)if(-1!==t[_])switch(s&&x3dom.debug.assert(-1!=i[_]),f){case 0:m=+t[_],g=s&&n?+i[_]:m,f=1;break;case 1:p=+t[_],x=s&&n?+i[_]:s&&!n?+i[c]:p,this._mesh._indices[0].push(u++,u++),this._mesh._positions[0].push(r[m].x),this._mesh._positions[0].push(r[m].y),this._mesh._positions[0].push(r[m].z),this._mesh._positions[0].push(r[p].x),this._mesh._positions[0].push(r[p].y),this._mesh._positions[0].push(r[p].z),o&&(n||(g=x),this._mesh._colors[0].push(a[g].r),this._mesh._colors[0].push(a[g].g),this._mesh._colors[0].push(a[g].b),this._mesh._colors[0].push(a[x].r),this._mesh._colors[0].push(a[x].g),this._mesh._colors[0].push(a[x].b)),f=2,c++;break;case 3:m=p,g=x,p=+t[_],x=s&&n?+i[_]:s&&!n?+i[c]:p,this._mesh._indices[0].push(u++,u++),this._mesh._positions[0].push(r[m].x),this._mesh._positions[0].push(r[m].y),this._mesh._positions[0].push(r[m].z),this._mesh._positions[0].push(r[p].x),this._mesh._positions[0].push(r[p].y),this._mesh._positions[0].push(r[p].z),o&&(n||(g=x),this._mesh._colors[0].push(a[g].r),this._mesh._colors[0].push(a[g].g),this._mesh._colors[0].push(a[g].b),this._mesh._colors[0].push(a[x].r),this._mesh._colors[0].push(a[x].g),this._mesh._colors[0].push(a[x].b)),c++}else f=0;else{for(f=0,_=0;_<t.length;++_)if(-1!==t[_])switch(f){case 0:m=+t[_],f=1;break;case 1:p=+t[_],f=2,this._mesh._indices[0].push(m,p);break;case 2:m=p,p=+t[_],this._mesh._indices[0].push(m,p)}else f=0;this._mesh._positions[0]=r.toGL(),o&&(this._mesh._colors[0]=a.toGL(),this._mesh._numColComponents=h)}this._mesh._invalidate=!0,this._mesh._numCoords=this._mesh._positions[0].length/3;(new Date).getTime()-e},fieldChanged:function(e){var t,i,o;if("coord"==e){for(t=this._cf.coord.node._vf.point,o=t.length,this._mesh._positions[0]=[],i=0;o>i;i++)this._mesh._positions[0].push(t[i].x),this._mesh._positions[0].push(t[i].y),this._mesh._positions[0].push(t[i].z);this._mesh._invalidate=!0,Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0})}else if("color"==e){for(t=this._cf.color.node._vf.color,o=t.length,this._mesh._colors[0]=[],i=0;o>i;i++)this._mesh._colors[0].push(t[i].r),this._mesh._colors[0].push(t[i].g),this._mesh._colors[0].push(t[i].b);Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0})}}})),x3dom.registerNodeType("IndexedTriangleSet","Rendering",defineClass(x3dom.nodeTypes.X3DComposedGeometryNode,function(e){x3dom.nodeTypes.IndexedTriangleSet.superClass.call(this,e),this.addField_MFInt32(e,"index",[])},{nodeChanged:function(){var e=(new Date).getTime();this.handleAttribs();var t,i,o,s,n=(this._vf.normalPerVertex,this._vf.index),r=!1,a=!1,d=!1,h=this._cf.coord.node;x3dom.debug.assert(h),t=h._vf.point;var l=this._cf.normal.node;l?(r=!0,i=l._vf.vector):r=!1;var _="",f=2,u=this._cf.texCoord.node;u?u._vf.point?(a=!0,o=u._vf.point,x3dom.isa(u,x3dom.nodeTypes.TextureCoordinate3D)&&(f=3)):u._vf.mode&&(_=u._vf.mode):a=!1;var c=3,m=this._cf.color.node;m?(d=!0,s=m._vf.color,x3dom.isa(m,x3dom.nodeTypes.ColorRGBA)&&(c=4)):d=!1,this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];for(var p,g,x,v,y,b,T,F,w,C,E,S,M,N,A,I,R;t.length%3>0;)t.push(t.length-1);if(y=t.length,t.length>65535){for(g=0,x=0,v=0,this._mesh._multiIndIndices=[],this._mesh._posSize=t.length,p=0;p<n.length;++p)switch(p>0&&p%3===0&&(g=0,v++),g){case 0:b=+n[p],w=b,S=b,A=b,g=1;break;case 1:T=+n[p],C=T,M=T,I=T,g=2;break;case 2:F=+n[p],E=F,N=F,R=F,g=3,this._mesh._indices[0].push(x++,x++,x++),this._mesh._positions[0].push(t[b].x),this._mesh._positions[0].push(t[b].y),this._mesh._positions[0].push(t[b].z),this._mesh._positions[0].push(t[T].x),this._mesh._positions[0].push(t[T].y),this._mesh._positions[0].push(t[T].z),this._mesh._positions[0].push(t[F].x),this._mesh._positions[0].push(t[F].y),this._mesh._positions[0].push(t[F].z),r?(this._mesh._normals[0].push(i[w].x),this._mesh._normals[0].push(i[w].y),this._mesh._normals[0].push(i[w].z),this._mesh._normals[0].push(i[C].x),this._mesh._normals[0].push(i[C].y),this._mesh._normals[0].push(i[C].z),this._mesh._normals[0].push(i[E].x),this._mesh._normals[0].push(i[E].y),this._mesh._normals[0].push(i[E].z)):this._mesh._multiIndIndices.push(b,T,F),d&&(this._mesh._colors[0].push(s[A].r),this._mesh._colors[0].push(s[A].g),this._mesh._colors[0].push(s[A].b),4===c&&this._mesh._colors[0].push(s[A].a),this._mesh._colors[0].push(s[I].r),this._mesh._colors[0].push(s[I].g),this._mesh._colors[0].push(s[I].b),4===c&&this._mesh._colors[0].push(s[I].a),this._mesh._colors[0].push(s[R].r),this._mesh._colors[0].push(s[R].g),this._mesh._colors[0].push(s[R].b),4===c&&this._mesh._colors[0].push(s[R].a)),a&&(this._mesh._texCoords[0].push(o[S].x),this._mesh._texCoords[0].push(o[S].y),3===f&&this._mesh._texCoords[0].push(o[S].z),this._mesh._texCoords[0].push(o[M].x),this._mesh._texCoords[0].push(o[M].y),3===f&&this._mesh._texCoords[0].push(o[M].z),this._mesh._texCoords[0].push(o[N].x),this._mesh._texCoords[0].push(o[N].y),3===f&&this._mesh._texCoords[0].push(o[N].z))}r||this._mesh.calcNormals(Math.PI),a||this._mesh.calcTexCoords(_),this._mesh.splitMesh()}else this._mesh._indices[0]=n.toGL(),this._mesh._positions[0]=t.toGL(),r?this._mesh._normals[0]=i.toGL():this._mesh.calcNormals(Math.PI),a?(this._mesh._texCoords[0]=o.toGL(),this._mesh._numTexComponents=f):this._mesh.calcTexCoords(_),d&&(this._mesh._colors[0]=s.toGL(),this._mesh._numColComponents=c);for(this._mesh._invalidate=!0,this._mesh._numFaces=0,this._mesh._numCoords=0,p=0;p<this._mesh._indices.length;p++)this._mesh._numFaces+=this._mesh._indices[p].length/3,this._mesh._numCoords+=this._mesh._positions[p].length/3;(new Date).getTime()-e},fieldChanged:function(e){var t,i,o;if("coord"==e){for(t=this._cf.coord.node._vf.point,o=t.length,this._mesh._positions[0]=[],i=0;o>i;i++)this._mesh._positions[0].push(t[i].x),this._mesh._positions[0].push(t[i].y),this._mesh._positions[0].push(t[i].z);this._mesh._invalidate=!0,Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0})}else if("color"==e){for(t=this._cf.color.node._vf.color,o=t.length,this._mesh._colors[0]=[],i=0;o>i;i++)this._mesh._colors[0].push(t[i].r),this._mesh._colors[0].push(t[i].g),this._mesh._colors[0].push(t[i].b);Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0})}}})),x3dom.registerNodeType("IndexedTriangleStripSet","Rendering",defineClass(x3dom.nodeTypes.X3DComposedGeometryNode,function(e){x3dom.nodeTypes.IndexedTriangleStripSet.superClass.call(this,e),this.addField_MFInt32(e,"index",[])},{nodeChanged:function(){x3dom.debug.logError("========== IndexedTriangleStripSet is not implemented ==========")}})),x3dom.registerNodeType("X3DGeometricPropertyNode","Rendering",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.X3DGeometricPropertyNode.superClass.call(this,e)})),x3dom.registerNodeType("X3DCoordinateNode","Rendering",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(e){x3dom.nodeTypes.X3DCoordinateNode.superClass.call(this,e)},{fieldChanged:function(){Array.forEach(this._parentNodes,function(e){e.fieldChanged("coord")})},parentAdded:function(e){e._mesh&&e._cf.coord.node!==this&&e.fieldChanged("coord")}})),x3dom.registerNodeType("Coordinate","Rendering",defineClass(x3dom.nodeTypes.X3DCoordinateNode,function(e){x3dom.nodeTypes.Coordinate.superClass.call(this,e),this.addField_MFVec3f(e,"point",[])},{getPoints:function(){return this._vf.point}})),x3dom.registerNodeType("Normal","Rendering",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(e){x3dom.nodeTypes.Normal.superClass.call(this,e),this.addField_MFVec3f(e,"vector",[])},{fieldChanged:function(){Array.forEach(this._parentNodes,function(e){e.fieldChanged("normal")})},parentAdded:function(e){e._mesh&&e._cf.normal.node!==this&&e.fieldChanged("normal")}})),x3dom.registerNodeType("X3DColorNode","Rendering",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(e){x3dom.nodeTypes.X3DColorNode.superClass.call(this,e)},{fieldChanged:function(){Array.forEach(this._parentNodes,function(e){e.fieldChanged("color")})},parentAdded:function(e){e._mesh&&e._cf.color.node!==this&&e.fieldChanged("color")}})),x3dom.registerNodeType("Color","Rendering",defineClass(x3dom.nodeTypes.X3DColorNode,function(e){x3dom.nodeTypes.Color.superClass.call(this,e),this.addField_MFColor(e,"color",[])})),x3dom.registerNodeType("ColorRGBA","Rendering",defineClass(x3dom.nodeTypes.X3DColorNode,function(e){x3dom.nodeTypes.ColorRGBA.superClass.call(this,e),this.addField_MFColorRGBA(e,"color",[])})),x3dom.registerNodeType("X3DAppearanceNode","Shape",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.X3DAppearanceNode.superClass.call(this,e)})),x3dom.registerNodeType("Appearance","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceNode,function(e){x3dom.nodeTypes.Appearance.superClass.call(this,e),this.addField_SFNode("material",x3dom.nodeTypes.X3DMaterialNode),this.addField_SFNode("texture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("textureTransform",x3dom.nodeTypes.X3DTextureTransformNode),this.addField_SFNode("blendMode",x3dom.nodeTypes.BlendMode),this.addField_SFNode("depthMode",x3dom.nodeTypes.DepthMode),this.addField_MFNode("shaders",x3dom.nodeTypes.X3DShaderNode),this._shader=null},{nodeChanged:function(){this._cf.material.node||this.addChild(x3dom.nodeTypes.Material.defaultNode()),this._cf.shaders.nodes.length&&(this._shader=this._cf.shaders.nodes[0])},texTransformMatrix:function(){return null===this._cf.textureTransform.node?x3dom.fields.SFMatrix4f.identity():this._cf.textureTransform.node.texTransformMatrix()}})),x3dom.nodeTypes.Appearance.defaultNode=function(){return x3dom.nodeTypes.Appearance._defaultNode||(x3dom.nodeTypes.Appearance._defaultNode=new x3dom.nodeTypes.Appearance,x3dom.nodeTypes.Appearance._defaultNode.nodeChanged()),x3dom.nodeTypes.Appearance._defaultNode},x3dom.registerNodeType("X3DAppearanceChildNode","Shape",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.X3DAppearanceChildNode.superClass.call(this,e)})),x3dom.registerNodeType("BlendMode","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(e){x3dom.nodeTypes.BlendMode.superClass.call(this,e),this.addField_SFString(e,"srcFactor","src_alpha"),this.addField_SFString(e,"destFactor","one_minus_src_alpha"),this.addField_SFColor(e,"color",1,1,1),this.addField_SFFloat(e,"colorTransparency",0),this.addField_SFString(e,"alphaFunc","none"),this.addField_SFFloat(e,"alphaFuncValue",0),this.addField_SFString(e,"equation","none")})),x3dom.registerNodeType("DepthMode","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(e){x3dom.nodeTypes.DepthMode.superClass.call(this,e),this.addField_SFBool(e,"enableDepthTest",!0),this.addField_SFString(e,"depthFunc","none"),this.addField_SFBool(e,"readOnly",!1),this.addField_SFFloat(e,"zNearRange",-1),this.addField_SFFloat(e,"zFarRange",-1)})),x3dom.registerNodeType("X3DMaterialNode","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(e){x3dom.nodeTypes.X3DMaterialNode.superClass.call(this,e)})),x3dom.registerNodeType("Material","Shape",defineClass(x3dom.nodeTypes.X3DMaterialNode,function(e){x3dom.nodeTypes.Material.superClass.call(this,e),this.addField_SFFloat(e,"ambientIntensity",.2),this.addField_SFColor(e,"diffuseColor",.8,.8,.8),this.addField_SFColor(e,"emissiveColor",0,0,0),this.addField_SFFloat(e,"shininess",.2),this.addField_SFColor(e,"specularColor",0,0,0),this.addField_SFFloat(e,"transparency",0)},{fieldChanged:function(e){("ambientIntensity"==e||"diffuseColor"==e||"emissiveColor"==e||"shininess"==e||"specularColor"==e||"transparency"==e)&&Array.forEach(this._parentNodes,function(e){Array.forEach(e._parentNodes,function(e){e._dirty.material=!0})})}})),x3dom.nodeTypes.Material.defaultNode=function(){return x3dom.nodeTypes.Material._defaultNode||(x3dom.nodeTypes.Material._defaultNode=new x3dom.nodeTypes.Material,x3dom.nodeTypes.Material._defaultNode.nodeChanged()),x3dom.nodeTypes.Material._defaultNode},x3dom.registerNodeType("X3DShapeNode","Shape",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DShapeNode.superClass.call(this,e),this.addField_SFNode("appearance",x3dom.nodeTypes.X3DAppearanceNode),this.addField_SFNode("geometry",x3dom.nodeTypes.X3DGeometryNode),this._objectID=0,this._dirty={positions:!0,normals:!0,texcoords:!0,colors:!0,indexes:!0,texture:!0,material:!0,text:!0,shader:!0}},{collectDrawableObjects:function(e,t){null!==t&&t.push([e,this])},getVolume:function(e,t,i){return this._cf.geometry.node?this._cf.geometry.node.getVolume(e,t,i):!1},getCenter:function(){return this._cf.geometry.node?this._cf.geometry.node.getCenter():new x3dom.fields.SFVec3f(0,0,0)},doIntersect:function(e){return this._cf.geometry.node.doIntersect(e)},isSolid:function(){return this._cf.geometry.node._vf.solid},isCCW:function(){return this._cf.geometry.node._vf.ccw},setAllDirty:function(){this._dirty.positions=!0,this._dirty.normals=!0,this._dirty.texcoords=!0,this._dirty.colors=!0,this._dirty.indexes=!0,this._dirty.texture=!0,this._dirty.material=!0,this._dirty.text=!0,this._dirty.shader=!0}})),x3dom.registerNodeType("Shape","Shape",defineClass(x3dom.nodeTypes.X3DShapeNode,function(e){x3dom.nodeTypes.Shape.superClass.call(this,e)},{nodeChanged:function(){this._cf.appearance.node||this.addChild(x3dom.nodeTypes.Appearance.defaultNode()),this._cf.geometry.node?!this._objectID&&this._cf.geometry.node._pickable&&(this._objectID=++x3dom.nodeTypes.Shape.objectID,x3dom.nodeTypes.Shape.idMap.nodeID[this._objectID]=this):x3dom.debug.logError("No geometry given in Shape/"+this._DEF)},parentRemoved:function(){if(0===this._parentNodes.length&&this._webgl){for(var e=this.findX3DDoc(),t=e.ctx.ctx3d,i=this._webgl.shader,o=0;void 0!==this._webgl.texture&&o<this._webgl.texture.length;o++)this._webgl.texture[o]&&t.deleteTexture(this._webgl.texture[o]);for(var s=0;s<this._webgl.positions.length;s++)void 0!==i.position&&(t.deleteBuffer(this._webgl.buffers[5*s+1]),t.deleteBuffer(this._webgl.buffers[5*s+0])),void 0!==i.normal&&t.deleteBuffer(this._webgl.buffers[5*s+2]),void 0!==i.texcoord&&t.deleteBuffer(this._webgl.buffers[5*s+3]),void 0!==i.color&&t.deleteBuffer(this._webgl.buffers[5*s+4]);for(var n=0;n<this._webgl.dynamicFields.length;n++){var r=this._webgl.dynamicFields[n];void 0!==i[r.name]&&t.deleteBuffer(r.buf)}this._webgl=null}}})),x3dom.nodeTypes.Shape.objectID=0,x3dom.nodeTypes.Shape.idMap={nodeID:{},remove:function(e){for(var t in this.nodeID)if(this.nodeID.hasOwnProperty(t)){var i=this.nodeID[t];i._objectID&&e._objectID&&i._objectID===e._objectID&&(delete this.nodeID[t],x3dom.debug.logInfo("Unreg "+i._objectID))}}},x3dom.registerNodeType("X3DLightNode","Lighting",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DLightNode.superClass.call(this,e),e.doc._nodeBag.lights.push(this),this._lightID=0,this._dirty=!0,this.addField_SFFloat(e,"ambientIntensity",0),this.addField_SFColor(e,"color",1,1,1),this.addField_SFFloat(e,"intensity",1),this.addField_SFBool(e,"global",!1),this.addField_SFBool(e,"on",!0),this.addField_SFFloat(e,"shadowIntensity",0)},{getViewMatrix:function(){return x3dom.fields.SFMatrix4f.identity},nodeChanged:function(){this._lightID||(this._lightID=++x3dom.nodeTypes.X3DLightNode.lightID)},fieldChanged:function(){this._dirty=!0},parentRemoved:function(){if(0===this._parentNodes.length)for(var e=this.findX3DDoc(),t=0,i=e._nodeBag.lights.length;i>t;t++)e._nodeBag.lights[t]===this&&e._nodeBag.lights.splice(t,1)}})),x3dom.nodeTypes.X3DLightNode.lightID=0,x3dom.registerNodeType("DirectionalLight","Lighting",defineClass(x3dom.nodeTypes.X3DLightNode,function(e){x3dom.nodeTypes.DirectionalLight.superClass.call(this,e),this.addField_SFVec3f(e,"direction",0,0,-1)},{getViewMatrix:function(e){var t=this._vf.direction.normalize(),i=x3dom.fields.Quaternion.rotateFromTo(new x3dom.fields.SFVec3f(0,0,-1),t);return i.toMatrix().transpose().mult(x3dom.fields.SFMatrix4f.translation(e.negate()))}})),x3dom.registerNodeType("PointLight","Lighting",defineClass(x3dom.nodeTypes.X3DLightNode,function(e){x3dom.nodeTypes.PointLight.superClass.call(this,e),this.addField_SFVec3f(e,"attenuation",1,0,0),this.addField_SFVec3f(e,"location",0,0,0),this.addField_SFFloat(e,"radius",100),this._vf.global=!0},{getViewMatrix:function(e){var t=this._vf.location,i=x3dom.fields.Quaternion.rotateFromTo(new x3dom.fields.SFVec3f(0,0,-1),e);return i.toMatrix().transpose().mult(x3dom.fields.SFMatrix4f.translation(t.negate()))}})),x3dom.registerNodeType("SpotLight","Lighting",defineClass(x3dom.nodeTypes.X3DLightNode,function(e){x3dom.nodeTypes.SpotLight.superClass.call(this,e),this.addField_SFVec3f(e,"direction",0,0,-1),this.addField_SFVec3f(e,"attenuation",1,0,0),this.addField_SFVec3f(e,"location",0,0,0),this.addField_SFFloat(e,"radius",100),this.addField_SFFloat(e,"beamWidth",1.5707963),this.addField_SFFloat(e,"cutOffAngle",1.5707963),this._vf.global=!0},{getViewMatrix:function(){var e=this._vf.location,t=this._vf.direction.normalize(),i=x3dom.fields.Quaternion.rotateFromTo(new x3dom.fields.SFVec3f(0,0,-1),t);return i.toMatrix().transpose().mult(x3dom.fields.SFMatrix4f.translation(e.negate()))}})),x3dom.registerNodeType("X3DFollowerNode","Followers",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DFollowerNode.superClass.call(this,e),e.doc._nodeBag.followers.push(this),this.addField_SFBool(e,"isActive",!1)},{nodeChanged:function(){},fieldChanged:function(){},parentRemoved:function(){if(0===this._parentNodes.length)for(var e=this.findX3DDoc(),t=0,i=e._nodeBag.followers.length;i>t;t++)e._nodeBag.followers[t]===this&&e._nodeBag.followers.splice(t,1)},tick:function(){return!1},stepResponse:function(e){return 0>=e?0:e>=this._vf.duration?1:this.stepResponseCore(e/this._vf.duration)},stepResponseCore:function(e){return.5-.5*Math.cos(e*Math.PI)}})),x3dom.registerNodeType("X3DChaserNode","Followers",defineClass(x3dom.nodeTypes.X3DFollowerNode,function(e){x3dom.nodeTypes.X3DChaserNode.superClass.call(this,e),this.addField_SFTime(e,"duration",0),this._initDone=!1,this._stepTime=0,this._currTime=0,this._bufferEndTime=0,this._numSupports=60},{nodeChanged:function(){},fieldChanged:function(){}})),x3dom.registerNodeType("X3DDamperNode","Followers",defineClass(x3dom.nodeTypes.X3DFollowerNode,function(e){x3dom.nodeTypes.X3DDamperNode.superClass.call(this,e),this.addField_SFTime(e,"tau",0),this.addField_SFFloat(e,"tolerance",-1),this.addField_SFInt32(e,"order",0),this._eps=this._vf.tolerance<0?.001:this._vf.tolerance,this._lastTick=0},{nodeChanged:function(){},fieldChanged:function(e){"tolerance"===e&&(this._eps=this._vf.tolerance<0?.001:this._vf.tolerance)}})),x3dom.registerNodeType("ColorChaser","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,function(e){x3dom.nodeTypes.ColorChaser.superClass.call(this,e),this.addField_SFColor(e,"initialDestination",.8,.8,.8),this.addField_SFColor(e,"initialValue",.8,.8,.8),this.addField_SFColor(e,"set_value",0,0,0),this.addField_SFColor(e,"set_destination",0,0,0),this._buffer=new x3dom.fields.MFColor,this._previousValue=new x3dom.fields.SFColor(0,0,0),this._value=new x3dom.fields.SFColor(0,0,0)},{nodeChanged:function(){this.initialize()},fieldChanged:function(e){if(e.indexOf("set_destination")>=0)this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(e.indexOf("set_value")>=0){this.initialize(),this._previousValue.setValues(this._vf.set_value);for(var t=1;t<this._buffer.length;t++)this._buffer[t].setValues(this._vf.set_value);this.postMessage("value_changed",this._vf.set_value),this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0,this._vf.set_destination=this._vf.initialDestination,this._buffer.length=this._numSupports,this._buffer[0]=this._vf.initialDestination;for(var e=1;e<this._buffer.length;e++)this._buffer[e]=this._vf.initialValue;this._previousValue=this._vf.initialValue,this._stepTime=this._vf.duration/this._numSupports;var t=!this._buffer[0].equals(this._buffer[1],x3dom.fields.Eps);this._vf.isActive!==t&&this.postMessage("isActive",t)}},tick:function(e){if(this.initialize(),this._currTime=e,!this._bufferEndTime)return this._bufferEndTime=e,this._value=this._vf.initialValue,this.postMessage("value_changed",this._value),!0;var t=this.updateBuffer(e),i=this._previousValue,o=this._buffer[this._buffer.length-1].subtract(this._previousValue),s=o.multiply(this.stepResponse((this._buffer.length-1+t)*this._stepTime));i=i.add(s);for(var n=this._buffer.length-2;n>=0;n--)o=this._buffer[n].subtract(this._buffer[n+1]),s=o.multiply(this.stepResponse((n+t)*this._stepTime)),i=i.add(s);return i.equals(this._value,x3dom.fields.Eps)?this.postMessage("isActive",!1):(this._value.setValues(i),this.postMessage("value_changed",this._value)),this._vf.isActive},updateBuffer:function(e){var t,i,o,s=(e-this._bufferEndTime)/this._stepTime;if(s>=1){if(i=Math.floor(s),s-=i,i<this._buffer.length){for(this._previousValue=this._buffer[this._buffer.length-i],t=this._buffer.length-1;t>=i;t--)this._buffer[t]=this._buffer[t-i];for(t=0;i>t;t++)o=t/i,this._buffer[t]=this._buffer[i].multiply(o).add(this._vf.set_destination.multiply(1-o))}else for(this._previousValue=i==this._buffer.length?this._buffer[0]:this._vf.set_destination,t=0;t<this._buffer.length;t++)this._buffer[t]=this._vf.set_destination;this._bufferEndTime+=i*this._stepTime}return s}})),x3dom.registerNodeType("ColorDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(e){x3dom.nodeTypes.ColorDamper.superClass.call(this,e),this.addField_SFColor(e,"initialDestination",.8,.8,.8),this.addField_SFColor(e,"initialValue",.8,.8,.8),this.addField_SFColor(e,"set_value",0,0,0),this.addField_SFColor(e,"set_destination",0,0,0),this._value0=new x3dom.fields.SFColor(0,0,0),this._value1=new x3dom.fields.SFColor(0,0,0),this._value2=new x3dom.fields.SFColor(0,0,0),this._value3=new x3dom.fields.SFColor(0,0,0),this._value4=new x3dom.fields.SFColor(0,0,0),this._value5=new x3dom.fields.SFColor(0,0,0),this.initialize()},{nodeChanged:function(){},fieldChanged:function(e){e.indexOf("set_destination")>=0?this._value0.equals(this._vf.set_destination,this._eps)||(this._value0=this._vf.set_destination,this._vf.isActive||this.postMessage("isActive",!0)):e.indexOf("set_value")>=0&&(this._value1.setValues(this._vf.set_value),this._value2.setValues(this._vf.set_value),this._value3.setValues(this._vf.set_value),this._value4.setValues(this._vf.set_value),this._value5.setValues(this._vf.set_value),this._lastTick=0,this.postMessage("value_changed",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0.setValues(this._vf.initialDestination),this._value1.setValues(this._vf.initialValue),this._value2.setValues(this._vf.initialValue),this._value3.setValues(this._vf.initialValue),this._value4.setValues(this._vf.initialValue),this._value5.setValues(this._vf.initialValue),this._lastTick=0;var e=!this._value0.equals(this._value1,this._eps);this._vf.isActive!==e&&this.postMessage("isActive",e)},distance:function(e,t){var i=e.subtract(t);return Math.sqrt(i.r*i.r+i.g*i.g+i.b*i.b)},tick:function(e){if(!this._lastTick)return this._lastTick=e,!1;var t=e-this._lastTick,i=Math.exp(-t/this._vf.tau);this._value1=this._vf.order>0&&this._vf.tau?this._value0.add(this._value1.subtract(this._value0).multiply(i)):new x3dom.fields.SFColor(this._value0.r,this._value0.g,this._value0.b),this._value2=this._vf.order>1&&this._vf.tau?this._value1.add(this._value2.subtract(this._value1).multiply(i)):new x3dom.fields.SFColor(this._value1.r,this._value1.g,this._value1.b),this._value3=this._vf.order>2&&this._vf.tau?this._value2.add(this._value3.subtract(this._value2).multiply(i)):new x3dom.fields.SFColor(this._value2.r,this._value2.g,this._value2.b),this._value4=this._vf.order>3&&this._vf.tau?this._value3.add(this._value4.subtract(this._value3).multiply(i)):new x3dom.fields.SFColor(this._value3.r,this._value3.g,this._value3.b),this._value5=this._vf.order>4&&this._vf.tau?this._value4.add(this._value5.subtract(this._value4).multiply(i)):new x3dom.fields.SFColor(this._value4.r,this._value4.g,this._value4.b);var o=this.distance(this._value1,this._value0);if(this._vf.order>1){var s=this.distance(this._value2,this._value1);s>o&&(o=s)}if(this._vf.order>2){var n=this.distance(this._value3,this._value2);n>o&&(o=n)}if(this._vf.order>3){var r=this.distance(this._value4,this._value3);r>o&&(o=r)}if(this._vf.order>4){var a=this.distance(this._value5,this._value4);a>o&&(o=a)}return o<this._eps?(this._value1.setValues(this._value0),this._value2.setValues(this._value0),this._value3.setValues(this._value0),this._value4.setValues(this._value0),this._value5.setValues(this._value0),this.postMessage("value_changed",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1):(this.postMessage("value_changed",this._value5),this._lastTick=e,!0)}})),x3dom.registerNodeType("OrientationChaser","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,function(e){x3dom.nodeTypes.OrientationChaser.superClass.call(this,e),this.addField_SFRotation(e,"initialDestination",0,1,0,0),this.addField_SFRotation(e,"initialValue",0,1,0,0),this.addField_SFRotation(e,"set_value",0,1,0,0),this.addField_SFRotation(e,"set_destination",0,1,0,0),this._numSupports=30,this._buffer=new x3dom.fields.MFRotation,this._previousValue=new x3dom.fields.Quaternion(0,1,0,0),this._value=new x3dom.fields.Quaternion(0,1,0,0)},{nodeChanged:function(){this.initialize()},fieldChanged:function(e){if(e.indexOf("set_destination")>=0)this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(e.indexOf("set_value")>=0){this.initialize(),this._previousValue.setValues(this._vf.set_value);for(var t=1;t<this._buffer.length;t++)this._buffer[t].setValues(this._vf.set_value);this.postMessage("value_changed",this._vf.set_value),this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0,this._vf.set_destination=this._vf.initialDestination,this._buffer.length=this._numSupports,this._buffer[0]=this._vf.initialDestination;for(var e=1;e<this._buffer.length;e++)this._buffer[e]=this._vf.initialValue;this._previousValue=this._vf.initialValue,this._stepTime=this._vf.duration/this._numSupports;var t=!this._buffer[0].equals(this._buffer[1],x3dom.fields.Eps);this._vf.isActive!==t&&this.postMessage("isActive",t)}},tick:function(e){if(this.initialize(),this._currTime=e,!this._bufferEndTime)return this._bufferEndTime=e,this._value=this._vf.initialValue,this.postMessage("value_changed",this._value),!0;var t=this.updateBuffer(e),i=this._previousValue,o=this._previousValue.inverse().multiply(this._buffer[this._buffer.length-1]);i=i.slerp(i.multiply(o),this.stepResponse((this._buffer.length-1+t)*this._stepTime));for(var s=this._buffer.length-2;s>=0;s--)o=this._buffer[s+1].inverse().multiply(this._buffer[s]),i=i.slerp(i.multiply(o),this.stepResponse((s+t)*this._stepTime));return i.equals(this._value,x3dom.fields.Eps)?this.postMessage("isActive",!1):(i=i.normalize(i),this._value.setValues(i),this.postMessage("value_changed",this._value)),this._vf.isActive},updateBuffer:function(e){var t,i,o,s=(e-this._bufferEndTime)/this._stepTime;if(s>=1){if(i=Math.floor(s),s-=i,i<this._buffer.length){for(this._previousValue=this._buffer[this._buffer.length-i],t=this._buffer.length-1;t>=i;t--)this._buffer[t]=this._buffer[t-i];for(t=0;i>t;t++)o=t/i,this._buffer[t]=this._vf.set_destination.slerp(this._buffer[i],o)}else for(this._previousValue=i==this._buffer.length?this._buffer[0]:this._vf.set_destination,t=0;t<this._buffer.length;t++)this._buffer[t]=this._vf.set_destination;this._bufferEndTime+=i*this._stepTime}return s}})),x3dom.registerNodeType("OrientationDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(e){x3dom.nodeTypes.OrientationDamper.superClass.call(this,e),this.addField_SFRotation(e,"initialDestination",0,1,0,0),this.addField_SFRotation(e,"initialValue",0,1,0,0),this.addField_SFRotation(e,"set_value",0,1,0,0),this.addField_SFRotation(e,"set_destination",0,1,0,0),this._value0=new x3dom.fields.Quaternion(0,1,0,0),this._value1=new x3dom.fields.Quaternion(0,1,0,0),this._value2=new x3dom.fields.Quaternion(0,1,0,0),this._value3=new x3dom.fields.Quaternion(0,1,0,0),this._value4=new x3dom.fields.Quaternion(0,1,0,0),this._value5=new x3dom.fields.Quaternion(0,1,0,0),this.initialize()},{nodeChanged:function(){},fieldChanged:function(e){e.indexOf("set_destination")>=0?this._value0.equals(this._vf.set_destination,this._eps)||(this._value0=this._vf.set_destination,this._vf.isActive||this.postMessage("isActive",!0)):e.indexOf("set_value")>=0&&(this._value1.setValues(this._vf.set_value),this._value2.setValues(this._vf.set_value),this._value3.setValues(this._vf.set_value),this._value4.setValues(this._vf.set_value),this._value5.setValues(this._vf.set_value),this._lastTick=0,this.postMessage("value_changed",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0.setValues(this._vf.initialDestination),this._value1.setValues(this._vf.initialValue),this._value2.setValues(this._vf.initialValue),this._value3.setValues(this._vf.initialValue),this._value4.setValues(this._vf.initialValue),this._value5.setValues(this._vf.initialValue),this._lastTick=0;var e=!this._value0.equals(this._value1,this._eps);this._vf.isActive!==e&&this.postMessage("isActive",e)},tick:function(e){if(!this._lastTick)return this._lastTick=e,!1;var t=e-this._lastTick,i=Math.exp(-t/this._vf.tau);this._value1=this._vf.order>0&&this._vf.tau?this._value0.slerp(this._value1,i):new x3dom.fields.Quaternion(this._value0.x,this._value0.y,this._value0.z,this._value0.w),this._value2=this._vf.order>1&&this._vf.tau?this._value1.slerp(this._value2,i):new x3dom.fields.Quaternion(this._value1.x,this._value1.y,this._value1.z,this._value1.w),this._value3=this._vf.order>2&&this._vf.tau?this._value2.slerp(this._value3,i):new x3dom.fields.Quaternion(this._value2.x,this._value2.y,this._value2.z,this._value2.w),this._value4=this._vf.order>3&&this._vf.tau?this._value3.slerp(this._value4,i):new x3dom.fields.Quaternion(this._value3.x,this._value3.y,this._value3.z,this._value3.w),this._value5=this._vf.order>4&&this._vf.tau?this._value4.slerp(this._value5,i):new x3dom.fields.Quaternion(this._value4.x,this._value4.y,this._value4.z,this._value4.w);var o=Math.abs(this._value1.inverse().multiply(this._value0).angle());
if(this._vf.order>1){var s=Math.abs(this._value2.inverse().multiply(this._value1).angle());s>o&&(o=s)}if(this._vf.order>2){var n=Math.abs(this._value3.inverse().multiply(this._value2).angle());n>o&&(o=n)}if(this._vf.order>3){var r=Math.abs(this._value4.inverse().multiply(this._value3).angle());r>o&&(o=r)}if(this._vf.order>4){var a=Math.abs(this._value5.inverse().multiply(this._value4).angle());a>o&&(o=a)}return o<this._eps?(this._value1.setValues(this._value0),this._value2.setValues(this._value0),this._value3.setValues(this._value0),this._value4.setValues(this._value0),this._value5.setValues(this._value0),this.postMessage("value_changed",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1):(this.postMessage("value_changed",this._value5),this._lastTick=e,!0)}})),x3dom.registerNodeType("PositionChaser","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,function(e){x3dom.nodeTypes.PositionChaser.superClass.call(this,e),this.addField_SFVec3f(e,"initialDestination",0,0,0),this.addField_SFVec3f(e,"initialValue",0,0,0),this.addField_SFVec3f(e,"set_value",0,0,0),this.addField_SFVec3f(e,"set_destination",0,0,0),this._buffer=new x3dom.fields.MFVec3f,this._previousValue=new x3dom.fields.SFVec3f(0,0,0),this._value=new x3dom.fields.SFVec3f(0,0,0)},{nodeChanged:function(){this.initialize()},fieldChanged:function(e){if(e.indexOf("set_destination")>=0)this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(e.indexOf("set_value")>=0){this.initialize(),this._previousValue.setValues(this._vf.set_value);for(var t=1;t<this._buffer.length;t++)this._buffer[t].setValues(this._vf.set_value);this.postMessage("value_changed",this._vf.set_value),this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0,this._vf.set_destination=this._vf.initialDestination,this._buffer.length=this._numSupports,this._buffer[0]=this._vf.initialDestination;for(var e=1;e<this._buffer.length;e++)this._buffer[e]=this._vf.initialValue;this._previousValue=this._vf.initialValue,this._stepTime=this._vf.duration/this._numSupports;var t=!this._buffer[0].equals(this._buffer[1],x3dom.fields.Eps);this._vf.isActive!==t&&this.postMessage("isActive",t)}},tick:function(e){if(this.initialize(),this._currTime=e,!this._bufferEndTime)return this._bufferEndTime=e,this._value=this._vf.initialValue,this.postMessage("value_changed",this._value),!0;var t=this.updateBuffer(e),i=this._previousValue,o=this._buffer[this._buffer.length-1].subtract(this._previousValue),s=o.multiply(this.stepResponse((this._buffer.length-1+t)*this._stepTime));i=i.add(s);for(var n=this._buffer.length-2;n>=0;n--)o=this._buffer[n].subtract(this._buffer[n+1]),s=o.multiply(this.stepResponse((n+t)*this._stepTime)),i=i.add(s);return i.equals(this._value,x3dom.fields.Eps)?this.postMessage("isActive",!1):(this._value.setValues(i),this.postMessage("value_changed",this._value)),this._vf.isActive},updateBuffer:function(e){var t,i,o,s=(e-this._bufferEndTime)/this._stepTime;if(s>=1){if(i=Math.floor(s),s-=i,i<this._buffer.length){for(this._previousValue=this._buffer[this._buffer.length-i],t=this._buffer.length-1;t>=i;t--)this._buffer[t]=this._buffer[t-i];for(t=0;i>t;t++)o=t/i,this._buffer[t]=this._buffer[i].multiply(o).add(this._vf.set_destination.multiply(1-o))}else for(this._previousValue=i==this._buffer.length?this._buffer[0]:this._vf.set_destination,t=0;t<this._buffer.length;t++)this._buffer[t]=this._vf.set_destination;this._bufferEndTime+=i*this._stepTime}return s}})),x3dom.registerNodeType("PositionChaser2D","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,function(e){x3dom.nodeTypes.PositionChaser2D.superClass.call(this,e),this.addField_SFVec2f(e,"initialDestination",0,0),this.addField_SFVec2f(e,"initialValue",0,0),this.addField_SFVec2f(e,"set_value",0,0),this.addField_SFVec2f(e,"set_destination",0,0),this._buffer=new x3dom.fields.MFVec2f,this._previousValue=new x3dom.fields.SFVec2f(0,0),this._value=new x3dom.fields.SFVec2f(0,0)},{nodeChanged:function(){this.initialize()},fieldChanged:function(e){if(e.indexOf("set_destination")>=0)this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(e.indexOf("set_value")>=0){this.initialize(),this._previousValue.setValues(this._vf.set_value);for(var t=1;t<this._buffer.length;t++)this._buffer[t].setValues(this._vf.set_value);this.postMessage("value_changed",this._vf.set_value),this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0,this._vf.set_destination=this._vf.initialDestination,this._buffer.length=this._numSupports,this._buffer[0]=this._vf.initialDestination;for(var e=1;e<this._buffer.length;e++)this._buffer[e]=this._vf.initialValue;this._previousValue=this._vf.initialValue,this._stepTime=this._vf.duration/this._numSupports;var t=!this._buffer[0].equals(this._buffer[1],x3dom.fields.Eps);this._vf.isActive!==t&&this.postMessage("isActive",t)}},tick:function(e){if(this.initialize(),this._currTime=e,!this._bufferEndTime)return this._bufferEndTime=e,this._value=this._vf.initialValue,this.postMessage("value_changed",this._value),!0;var t=this.updateBuffer(e),i=this._previousValue,o=this._buffer[this._buffer.length-1].subtract(this._previousValue),s=o.multiply(this.stepResponse((this._buffer.length-1+t)*this._stepTime));i=i.add(s);for(var n=this._buffer.length-2;n>=0;n--)o=this._buffer[n].subtract(this._buffer[n+1]),s=o.multiply(this.stepResponse((n+t)*this._stepTime)),i=i.add(s);return i.equals(this._value,x3dom.fields.Eps)?this.postMessage("isActive",!1):(this._value.setValues(i),this.postMessage("value_changed",this._value)),this._vf.isActive},updateBuffer:function(e){var t,i,o,s=(e-this._bufferEndTime)/this._stepTime;if(s>=1){if(i=Math.floor(s),s-=i,i<this._buffer.length){for(this._previousValue=this._buffer[this._buffer.length-i],t=this._buffer.length-1;t>=i;t--)this._buffer[t]=this._buffer[t-i];for(t=0;i>t;t++)o=t/i,this._buffer[t]=this._buffer[i].multiply(o).add(this._vf.set_destination.multiply(1-o))}else for(this._previousValue=i==this._buffer.length?this._buffer[0]:this._vf.set_destination,t=0;t<this._buffer.length;t++)this._buffer[t]=this._vf.set_destination;this._bufferEndTime+=i*this._stepTime}return s}})),x3dom.registerNodeType("PositionDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(e){x3dom.nodeTypes.PositionDamper.superClass.call(this,e),this.addField_SFVec3f(e,"initialDestination",0,0,0),this.addField_SFVec3f(e,"initialValue",0,0,0),this.addField_SFVec3f(e,"set_value",0,0,0),this.addField_SFVec3f(e,"set_destination",0,0,0),this._value0=new x3dom.fields.SFVec3f(0,0,0),this._value1=new x3dom.fields.SFVec3f(0,0,0),this._value2=new x3dom.fields.SFVec3f(0,0,0),this._value3=new x3dom.fields.SFVec3f(0,0,0),this._value4=new x3dom.fields.SFVec3f(0,0,0),this._value5=new x3dom.fields.SFVec3f(0,0,0),this.initialize()},{nodeChanged:function(){},fieldChanged:function(e){e.indexOf("set_destination")>=0?this._value0.equals(this._vf.set_destination,this._eps)||(this._value0=this._vf.set_destination,this._vf.isActive||this.postMessage("isActive",!0)):e.indexOf("set_value")>=0&&(this._value1.setValues(this._vf.set_value),this._value2.setValues(this._vf.set_value),this._value3.setValues(this._vf.set_value),this._value4.setValues(this._vf.set_value),this._value5.setValues(this._vf.set_value),this._lastTick=0,this.postMessage("value_changed",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0.setValues(this._vf.initialDestination),this._value1.setValues(this._vf.initialValue),this._value2.setValues(this._vf.initialValue),this._value3.setValues(this._vf.initialValue),this._value4.setValues(this._vf.initialValue),this._value5.setValues(this._vf.initialValue),this._lastTick=0;var e=!this._value0.equals(this._value1,this._eps);this._vf.isActive!==e&&this.postMessage("isActive",e)},tick:function(e){if(!this._lastTick)return this._lastTick=e,!1;var t=e-this._lastTick,i=Math.exp(-t/this._vf.tau);this._value1=this._vf.order>0&&this._vf.tau?this._value0.add(this._value1.subtract(this._value0).multiply(i)):new x3dom.fields.SFVec3f(this._value0.x,this._value0.y,this._value0.z),this._value2=this._vf.order>1&&this._vf.tau?this._value1.add(this._value2.subtract(this._value1).multiply(i)):new x3dom.fields.SFVec3f(this._value1.x,this._value1.y,this._value1.z),this._value3=this._vf.order>2&&this._vf.tau?this._value2.add(this._value3.subtract(this._value2).multiply(i)):new x3dom.fields.SFVec3f(this._value2.x,this._value2.y,this._value2.z),this._value4=this._vf.order>3&&this._vf.tau?this._value3.add(this._value4.subtract(this._value3).multiply(i)):new x3dom.fields.SFVec3f(this._value3.x,this._value3.y,this._value3.z),this._value5=this._vf.order>4&&this._vf.tau?this._value4.add(this._value5.subtract(this._value4).multiply(i)):new x3dom.fields.SFVec3f(this._value4.x,this._value4.y,this._value4.z);var o=this._value1.subtract(this._value0).length();if(this._vf.order>1){var s=this._value2.subtract(this._value1).length();s>o&&(o=s)}if(this._vf.order>2){var n=this._value3.subtract(this._value2).length();n>o&&(o=n)}if(this._vf.order>3){var r=this._value4.subtract(this._value3).length();r>o&&(o=r)}if(this._vf.order>4){var a=this._value5.subtract(this._value4).length();a>o&&(o=a)}return o<this._eps?(this._value1.setValues(this._value0),this._value2.setValues(this._value0),this._value3.setValues(this._value0),this._value4.setValues(this._value0),this._value5.setValues(this._value0),this.postMessage("value_changed",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1):(this.postMessage("value_changed",this._value5),this._lastTick=e,!0)}})),x3dom.registerNodeType("PositionDamper2D","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(e){x3dom.nodeTypes.PositionDamper2D.superClass.call(this,e),this.addField_SFVec2f(e,"initialDestination",0,0),this.addField_SFVec2f(e,"initialValue",0,0),this.addField_SFVec2f(e,"set_value",0,0),this.addField_SFVec2f(e,"set_destination",0,0),this._value0=new x3dom.fields.SFVec2f(0,0),this._value1=new x3dom.fields.SFVec2f(0,0),this._value2=new x3dom.fields.SFVec2f(0,0),this._value3=new x3dom.fields.SFVec2f(0,0),this._value4=new x3dom.fields.SFVec2f(0,0),this._value5=new x3dom.fields.SFVec2f(0,0),this.initialize()},{nodeChanged:function(){},fieldChanged:function(e){e.indexOf("set_destination")>=0?this._value0.equals(this._vf.set_destination,this._eps)||(this._value0=this._vf.set_destination,this._vf.isActive||this.postMessage("isActive",!0)):e.indexOf("set_value")>=0&&(this._value1.setValues(this._vf.set_value),this._value2.setValues(this._vf.set_value),this._value3.setValues(this._vf.set_value),this._value4.setValues(this._vf.set_value),this._value5.setValues(this._vf.set_value),this._lastTick=0,this.postMessage("value_changed",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0.setValues(this._vf.initialDestination),this._value1.setValues(this._vf.initialValue),this._value2.setValues(this._vf.initialValue),this._value3.setValues(this._vf.initialValue),this._value4.setValues(this._vf.initialValue),this._value5.setValues(this._vf.initialValue),this._lastTick=0;var e=!this._value0.equals(this._value1,this._eps);this._vf.isActive!==e&&this.postMessage("isActive",e)},tick:function(e){if(!this._lastTick)return this._lastTick=e,!1;var t=e-this._lastTick,i=Math.exp(-t/this._vf.tau);this._value1=this._vf.order>0&&this._vf.tau?this._value0.add(this._value1.subtract(this._value0).multiply(i)):new x3dom.fields.SFVec2f(this._value0.x,this._value0.y,this._value0.z),this._value2=this._vf.order>1&&this._vf.tau?this._value1.add(this._value2.subtract(this._value1).multiply(i)):new x3dom.fields.SFVec2f(this._value1.x,this._value1.y,this._value1.z),this._value3=this._vf.order>2&&this._vf.tau?this._value2.add(this._value3.subtract(this._value2).multiply(i)):new x3dom.fields.SFVec2f(this._value2.x,this._value2.y,this._value2.z),this._value4=this._vf.order>3&&this._vf.tau?this._value3.add(this._value4.subtract(this._value3).multiply(i)):new x3dom.fields.SFVec2f(this._value3.x,this._value3.y,this._value3.z),this._value5=this._vf.order>4&&this._vf.tau?this._value4.add(this._value5.subtract(this._value4).multiply(i)):new x3dom.fields.SFVec2f(this._value4.x,this._value4.y,this._value4.z);var o=this._value1.subtract(this._value0).length();if(this._vf.order>1){var s=this._value2.subtract(this._value1).length();s>o&&(o=s)}if(this._vf.order>2){var n=this._value3.subtract(this._value2).length();n>o&&(o=n)}if(this._vf.order>3){var r=this._value4.subtract(this._value3).length();r>o&&(o=r)}if(this._vf.order>4){var a=this._value5.subtract(this._value4).length();a>o&&(o=a)}return o<this._eps?(this._value1.setValues(this._value0),this._value2.setValues(this._value0),this._value3.setValues(this._value0),this._value4.setValues(this._value0),this._value5.setValues(this._value0),this.postMessage("value_changed",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1):(this.postMessage("value_changed",this._value5),this._lastTick=e,!0)}})),x3dom.registerNodeType("ScalarChaser","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,function(e){x3dom.nodeTypes.ScalarChaser.superClass.call(this,e),this.addField_SFFloat(e,"initialDestination",0),this.addField_SFFloat(e,"initialValue",0),this.addField_SFFloat(e,"set_value",0),this.addField_SFFloat(e,"set_destination",0),this._buffer=[],this._previousValue=0,this._value=0},{nodeChanged:function(){this.initialize()},fieldChanged:function(e){if(e.indexOf("set_destination")>=0)this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(e.indexOf("set_value")>=0){this.initialize(),this._previousValue=this._vf.set_value;for(var t=1;t<this._buffer.length;t++)this._buffer[t]=this._vf.set_value;this.postMessage("value_changed",this._vf.set_value),this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0,this._vf.set_destination=this._vf.initialDestination,this._buffer.length=this._numSupports,this._buffer[0]=this._vf.initialDestination;for(var e=1;e<this._buffer.length;e++)this._buffer[e]=this._vf.initialValue;this._previousValue=this._vf.initialValue,this._stepTime=this._vf.duration/this._numSupports;var t=Math.abs(this._buffer[0]-this._buffer[1])>=x3dom.fields.Eps;this._vf.isActive!==t&&this.postMessage("isActive",t)}},tick:function(e){if(this.initialize(),this._currTime=e,!this._bufferEndTime)return this._bufferEndTime=e,this._value=this._vf.initialValue,this.postMessage("value_changed",this._value),!0;var t=this.updateBuffer(e),i=this._previousValue,o=this._buffer[this._buffer.length-1]-this._previousValue,s=o*this.stepResponse((this._buffer.length-1+t)*this._stepTime);i+=s;for(var n=this._buffer.length-2;n>=0;n--)o=this._buffer[n]-this._buffer[n+1],s=o*this.stepResponse((n+t)*this._stepTime),i+=s;return Math.abs(i-this._value)>=x3dom.fields.Eps?(this._value=i,this.postMessage("value_changed",this._value)):this.postMessage("isActive",!1),this._vf.isActive},updateBuffer:function(e){var t,i,o,s=(e-this._bufferEndTime)/this._stepTime;if(s>=1){if(i=Math.floor(s),s-=i,i<this._buffer.length){for(this._previousValue=this._buffer[this._buffer.length-i],t=this._buffer.length-1;t>=i;t--)this._buffer[t]=this._buffer[t-i];for(t=0;i>t;t++)o=t/i,this._buffer[t]=this._buffer[i]*o+this._vf.set_destination*(1-o)}else for(this._previousValue=i==this._buffer.length?this._buffer[0]:this._vf.set_destination,t=0;t<this._buffer.length;t++)this._buffer[t]=this._vf.set_destination;this._bufferEndTime+=i*this._stepTime}return s}})),x3dom.registerNodeType("ScalarDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(e){x3dom.nodeTypes.ScalarDamper.superClass.call(this,e),this.addField_SFFloat(e,"initialDestination",0),this.addField_SFFloat(e,"initialValue",0),this.addField_SFFloat(e,"set_value",0),this.addField_SFFloat(e,"set_destination",0),this._value0=0,this._value1=0,this._value2=0,this._value3=0,this._value4=0,this._value5=0,this.initialize()},{nodeChanged:function(){},fieldChanged:function(e){e.indexOf("set_destination")>=0?Math.abs(this._value0-this._vf.set_destination)>=this._eps&&(this._value0=this._vf.set_destination,this._vf.isActive||this.postMessage("isActive",!0)):e.indexOf("set_value")>=0&&(this._value1=this._vf.set_value,this._value2=this._vf.set_value,this._value3=this._vf.set_value,this._value4=this._vf.set_value,this._value5=this._vf.set_value,this._lastTick=0,this.postMessage("value_changed",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0=this._vf.initialDestination,this._value1=this._vf.initialValue,this._value2=this._vf.initialValue,this._value3=this._vf.initialValue,this._value4=this._vf.initialValue,this._value5=this._vf.initialValue,this._lastTick=0;var e=Math.abs(this._value0-this._value1)>=this._eps;this._vf.isActive!==e&&this.postMessage("isActive",e)},tick:function(e){if(!this._lastTick)return this._lastTick=e,!1;var t=e-this._lastTick,i=Math.exp(-t/this._vf.tau);this._value1=this._vf.order>0&&this._vf.tau?this._value0+i*(this._value1-this._value0):this._value0,this._value2=this._vf.order>1&&this._vf.tau?this._value1+i*(this._value2-this._value1):this._value1,this._value3=this._vf.order>2&&this._vf.tau?this._value2+i*(this._value3-this._value2):this._value2,this._value4=this._vf.order>3&&this._vf.tau?this._value3+i*(this._value4-this._value3):this._value3,this._value5=this._vf.order>4&&this._vf.tau?this._value4+i*(this._value5-this._value4):this._value4;var o=Math.abs(this._value1-this._value0);if(this._vf.order>1){var s=Math.abs(this._value2-this._value1);s>o&&(o=s)}if(this._vf.order>2){var n=Math.abs(this._value3-this._value2);n>o&&(o=n)}if(this._vf.order>3){var r=Math.abs(this._value4-this._value3);r>o&&(o=r)}if(this._vf.order>4){var a=Math.abs(this._value5-this._value4);a>o&&(o=a)}return o<this._eps?(this._value1=this._value0,this._value2=this._value0,this._value3=this._value0,this._value4=this._value0,this._value5=this._value0,this.postMessage("value_changed",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1):(this.postMessage("value_changed",this._value5),this._lastTick=e,!0)}})),x3dom.registerNodeType("CoordinateDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(e){x3dom.nodeTypes.CoordinateDamper.superClass.call(this,e),this.addField_MFVec3f(e,"initialDestination",[]),this.addField_MFVec3f(e,"initialValue",[]),this.addField_MFVec3f(e,"set_value",[]),this.addField_MFVec3f(e,"set_destination",[]),x3dom.debug.logWarning("CoordinateDamper NYI")},{nodeChanged:function(){},fieldChanged:function(){}})),x3dom.registerNodeType("TexCoordDamper2D","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(e){x3dom.nodeTypes.TexCoordDamper2D.superClass.call(this,e),this.addField_MFVec2f(e,"initialDestination",[]),this.addField_MFVec2f(e,"initialValue",[]),this.addField_MFVec2f(e,"set_value",[]),this.addField_MFVec2f(e,"set_destination",[]),x3dom.debug.logWarning("TexCoordDamper2D NYI")},{nodeChanged:function(){},fieldChanged:function(){}})),x3dom.registerNodeType("X3DInterpolatorNode","Interpolation",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DInterpolatorNode.superClass.call(this,e),this.addField_MFFloat(e,"key",[]),this.addField_SFFloat(e,"set_fraction",0)},{linearInterp:function(e,t){if(e<=this._vf.key[0])return this._vf.keyValue[0];if(e>=this._vf.key[this._vf.key.length-1])return this._vf.keyValue[this._vf.key.length-1];for(var i=0;i<this._vf.key.length-1;++i)if(this._vf.key[i]<e&&e<=this._vf.key[i+1])return t(this._vf.keyValue[i],this._vf.keyValue[i+1],(e-this._vf.key[i])/(this._vf.key[i+1]-this._vf.key[i]));return this._vf.keyValue[0]}})),x3dom.registerNodeType("OrientationInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(e){x3dom.nodeTypes.OrientationInterpolator.superClass.call(this,e),this._vf.keyValue=e&&e.xmlNode.hasAttribute("keyValue")?x3dom.fields.MFRotation.parse(e.xmlNode.getAttribute("keyValue")):new x3dom.fields.MFRotation,this._fieldWatchers.fraction=this._fieldWatchers.set_fraction=[function(e){var t=this.linearInterp(e,function(e,t,i){return e.slerp(t,i)});this.postMessage("value_changed",t)}]})),x3dom.registerNodeType("PositionInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(e){x3dom.nodeTypes.PositionInterpolator.superClass.call(this,e),this._vf.keyValue=e&&e.xmlNode.hasAttribute("keyValue")?x3dom.fields.MFVec3f.parse(e.xmlNode.getAttribute("keyValue")):new x3dom.fields.MFVec3f,this._fieldWatchers.fraction=this._fieldWatchers.set_fraction=[function(e){var t=this.linearInterp(e,function(e,t,i){return e.multiply(1-i).add(t.multiply(i))});this.postMessage("value_changed",t)}]})),x3dom.registerNodeType("NormalInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(e){x3dom.nodeTypes.NormalInterpolator.superClass.call(this,e),this._vf.keyValue=e&&e.xmlNode.hasAttribute("keyValue")?x3dom.fields.MFVec3f.parse(e.xmlNode.getAttribute("keyValue")):new x3dom.fields.MFVec3f,this._fieldWatchers.fraction=this._fieldWatchers.set_fraction=[function(e){var t=this.linearInterp(e,function(e,t,i){return e.multiply(1-i).add(t.multiply(i)).normalize()});this.postMessage("value_changed",t)}]})),x3dom.registerNodeType("ColorInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(e){x3dom.nodeTypes.ColorInterpolator.superClass.call(this,e),this._vf.keyValue=e&&e.xmlNode.hasAttribute("keyValue")?x3dom.fields.MFColor.parse(e.xmlNode.getAttribute("keyValue")):new x3dom.fields.MFColor,this._fieldWatchers.fraction=this._fieldWatchers.set_fraction=[function(e){var t=this.linearInterp(e,function(e,t,i){return e.multiply(1-i).add(t.multiply(i))});this.postMessage("value_changed",t)}]})),x3dom.registerNodeType("ScalarInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(e){x3dom.nodeTypes.ScalarInterpolator.superClass.call(this,e),this._vf.keyValue=e&&e.xmlNode.hasAttribute("keyValue")?Array.map(e.xmlNode.getAttribute("keyValue").split(/\s+/),function(e){return+e}):new x3dom.fields.MFFloat,this._fieldWatchers.fraction=this._fieldWatchers.set_fraction=[function(e){var t=this.linearInterp(e,function(e,t,i){return(1-i)*e+i*t});this.postMessage("value_changed",t)}]})),x3dom.registerNodeType("CoordinateInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(e){if(x3dom.nodeTypes.CoordinateInterpolator.superClass.call(this,e),this._vf.keyValue=[],e&&e.xmlNode.hasAttribute("keyValue"))for(var t=x3dom.fields.MFVec3f.parse(e.xmlNode.getAttribute("keyValue")),i=this._vf.key.length>0?this._vf.key.length:1,o=t.length/i,s=0;i>s;s++){for(var n=new x3dom.fields.MFVec3f,r=0;o>r;r++)n.push(t[s*o+r]);this._vf.keyValue.push(n)}this._fieldWatchers.fraction=this._fieldWatchers.set_fraction=[function(e){var t=this.linearInterp(e,function(e,t,i){for(var o=new x3dom.fields.MFVec3f,s=0;s<e.length;s++)o.push(e[s].multiply(1-i).add(t[s].multiply(i)));return o});this.postMessage("value_changed",t)}]})),x3dom.registerNodeType("TimeSensor","Time",defineClass(x3dom.nodeTypes.X3DSensorNode,function(e){x3dom.nodeTypes.TimeSensor.superClass.call(this,e),e.doc._nodeBag.timer.push(this),this.addField_SFTime(e,"cycleInterval",1),this.addField_SFBool(e,"enabled",!0),this.addField_SFBool(e,"loop",!1),this.addField_SFTime(e,"startTime",0),this.addField_SFTime(e,"stopTime",0),this.addField_SFTime(e,"pauseTime",0),this.addField_SFTime(e,"resumeTime",0),this.addField_SFTime(e,"cycleTime",0),this.addField_SFFloat(e,"fraction_changed",0),this.addField_SFBool(e,"isActive",!1),this.addField_SFTime(e,"time",0),this.addField_SFBool(e,"first",!0),this.addField_SFFloat(e,"firstCycle",0),this._prevCycle=-1},{onframe:function(e){if(this._vf.enabled){var t,i,o,s=(e>=this._vf.startTime,e>=this._vf.pauseTime&&this._vf.pauseTime>this._vf.resumeTime,e>=this._vf.startTime);return s&&this._vf.cycleInterval>0&&(t=(e-this._vf.startTime)/this._vf.cycleInterval,i=Math.floor(t),1==this._vf.first&&(firstCycle=i),this._vf.first=!1,i-firstCycle>0&&0==this._vf.loop?o=1:(o=t-i,o<x3dom.fields.Eps&&e>this._vf.startTime&&(o=1))),s&&(this._vf.isActive||this.postMessage("isActive",!0),this.postMessage("fraction_changed",o),this.postMessage("time",e),this._prevCycle!=i)?(this._prevCycle=i,this.postMessage("cycleTime",e),void(this._vf.loop||this.postMessage("isActive",!1))):void 0}},fieldChanged:function(e){"enabled"==e&&!this._vf.enabled&&this._vf.isActive&&this.postMessage("isActive",!1)},parentRemoved:function(){if(0===this._parentNodes.length)for(var e=this.findX3DDoc(),t=0,i=e._nodeBag.timer.length;i>t;t++)e._nodeBag.timer[t]===this&&e._nodeBag.timer.splice(t,1)}})),x3dom.registerNodeType("X3DTimeDependentNode","Time",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DTimeDependentNode.superClass.call(this,e),this.addField_SFBool(e,"loop",!1)})),x3dom.registerNodeType("Anchor","Networking",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.Anchor.superClass.call(this,e),this.addField_MFString(e,"url",[])},{doIntersect:function(e){for(var t=!1,i=0;i<this._childNodes.length;i++)this._childNodes[i]&&(t=this._childNodes[i].doIntersect(e)||t);return t},handleTouch:function(){window.location=this._nameSpace.getURL(this._vf.url[0])}})),x3dom.registerNodeType("Inline","Networking",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.Inline.superClass.call(this,e),this.addField_MFString(e,"url",[]),this.addField_SFBool(e,"load",!0),this.addField_MFString(e,"nameSpaceName",[]),this.addField_SFBool(e,"mapDEFToID",!1),this.currentInline=e.xmlNode},{fieldChanged:function(e){if("url"==e){var t=this.nodeChanged();t=null}},nodeChanged:function(){var e=this,t=new window.XMLHttpRequest;return t.overrideMimeType&&t.overrideMimeType("text/xml"),this._nameSpace.doc.downloadCount+=1,t.onreadystatechange=function(){if(4!=t.readyState)return t;if(delete t.onreadystatechange,"Microsoft Internet Explorer"!=navigator.appName&&"parsererror"==t.responseXML.documentElement.localName)return e._nameSpace.doc.downloadCount-=1,x3dom.debug.logError("XML parser failed on "+e._vf.url+":\n"+t.responseXML.documentElement.textContent),t;if(200!==t.status)return e._nameSpace.doc.downloadCount-=1,x3dom.debug.logError("XMLHttpRequest requires a web server running!"),t;if(x3dom.debug.logInfo("Inline: downloading "+e._vf.url+" done."),"Microsoft Internet Explorer"!=navigator.appName)var i=t.responseXML;else var i=(new DOMParser).parseFromString(t.responseText,"text/xml");var o,s,n=i.getElementsByTagName("Scene")[0]||i.getElementsByTagName("scene")[0];n?(s=new x3dom.NodeNameSpace("",e._nameSpace.doc),s.setBaseURL(e._vf.url[0]),o=s.setupTree(n),0!=e._vf.nameSpaceName.length&&Array.forEach(n.childNodes,function(t){t instanceof Element&&(setNamespace(e._vf.nameSpaceName,t,e._vf.mapDEFToID),e.currentInline.appendChild(t))})):x3dom.debug.logWarning("no Scene in "+i.localName);for(var r=x3dom.getGlobal();0!==e._childNodes.length;)r._remover=e.removeChild(e._childNodes[0]);delete r._remover,e.addChild(o),e._nameSpace.doc.downloadCount-=1,e._nameSpace.doc.needRender=!0,x3dom.debug.logInfo("Inline: added "+e._vf.url+" to scene."),o=null,s=null,i=null,n=null},t.open("GET",encodeURI(this._nameSpace.getURL(this._vf.url[0])),!0),t.send(null),t}})),x3dom.registerNodeType("X3DBackgroundNode","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DBindableNode,function(e){x3dom.nodeTypes.X3DBackgroundNode.superClass.call(this,e),this._dirty=!0},{getSkyColor:function(){return new x3dom.fields.SFColor(0,0,0)},getTransparency:function(){return 0},getTexUrl:function(){return[]}})),x3dom.registerNodeType("X3DFogNode","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DBindableNode,function(e){x3dom.nodeTypes.X3DFogNode.superClass.call(this,e)},{})),x3dom.registerNodeType("Fog","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DFogNode,function(e){x3dom.nodeTypes.Fog.superClass.call(this,e),this.addField_SFColor(e,"color",1,1,1),this.addField_SFString(e,"fogType","LINEAR"),this.addField_SFFloat(e,"visibilityRange",0)},{})),x3dom.registerNodeType("Background","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DBackgroundNode,function(e){x3dom.nodeTypes.Background.superClass.call(this,e);var t=e.autoGen?1:0;this.addField_MFColor(e,"skyColor",[new x3dom.fields.SFColor(0,0,0)]),this.addField_MFFloat(e,"skyAngle",[]),this.addField_MFColor(e,"groundColor",[]),this.addField_MFFloat(e,"groundAngle",[]),this.addField_SFFloat(e,"transparency",t),this.addField_MFString(e,"backUrl",[]),this.addField_MFString(e,"bottomUrl",[]),this.addField_MFString(e,"frontUrl",[]),this.addField_MFString(e,"leftUrl",[]),this.addField_MFString(e,"rightUrl",[]),this.addField_MFString(e,"topUrl",[])},{fieldChanged:function(e){e.indexOf("Url")>0?this._dirty=!0:"set_bind"===e&&this.bind(this._vf.set_bind)},getSkyColor:function(){return this._vf.skyColor},getGroundColor:function(){return this._vf.groundColor},getTransparency:function(){return this._vf.transparency},getTexUrl:function(){return[this._nameSpace.getURL(this._vf.backUrl[0]),this._nameSpace.getURL(this._vf.frontUrl[0]),this._nameSpace.getURL(this._vf.bottomUrl[0]),this._nameSpace.getURL(this._vf.topUrl[0]),this._nameSpace.getURL(this._vf.leftUrl[0]),this._nameSpace.getURL(this._vf.rightUrl[0])]}})),x3dom.registerNodeType("X3DViewpointNode","Navigation",defineClass(x3dom.nodeTypes.X3DBindableNode,function(e){x3dom.nodeTypes.X3DViewpointNode.superClass.call(this,e)},{})),x3dom.registerNodeType("X3DNavigationInfoNode","Navigation",defineClass(x3dom.nodeTypes.X3DBindableNode,function(e){x3dom.nodeTypes.X3DNavigationInfoNode.superClass.call(this,e)},{})),x3dom.registerNodeType("Viewpoint","Navigation",defineClass(x3dom.nodeTypes.X3DViewpointNode,function(e){x3dom.nodeTypes.Viewpoint.superClass.call(this,e),this.addField_SFFloat(e,"fieldOfView",.785398),this.addField_SFVec3f(e,"position",0,0,10),this.addField_SFRotation(e,"orientation",0,0,0,1),this.addField_SFVec3f(e,"centerOfRotation",0,0,0),this.addField_SFFloat(e,"zNear",.1),this.addField_SFFloat(e,"zFar",1e5),this._viewMatrix=x3dom.fields.SFMatrix4f.translation(this._vf.position).mult(this._vf.orientation.toMatrix()).inverse(),this._projMatrix=null,this._lastAspect=1},{fieldChanged:function(e){"position"==e||"orientation"==e?this._viewMatrix=this._vf.orientation.toMatrix().transpose().mult(x3dom.fields.SFMatrix4f.translation(this._vf.position.negate())):"fieldOfView"==e||"zNear"==e||"zFar"==e?this._projMatrix=null:"set_bind"===e&&this.bind(this._vf.set_bind)},activate:function(e){e&&this._nameSpace.doc._viewarea.animateTo(this,e),x3dom.nodeTypes.X3DViewpointNode.prototype.activate.call(this,e),this._nameSpace.doc._viewarea._needNavigationMatrixUpdate=!0},deactivate:function(e){x3dom.nodeTypes.X3DViewpointNode.prototype.deactivate.call(this,e)},getCenterOfRotation:function(){return this._vf.centerOfRotation},getViewMatrix:function(){return this._viewMatrix},getFieldOfView:function(){return this._vf.fieldOfView},setView:function(e){var t=this.getCurrentTransform();t=t.inverse(),this._viewMatrix=t.mult(e)},resetView:function(){this._viewMatrix=x3dom.fields.SFMatrix4f.translation(this._vf.position).mult(this._vf.orientation.toMatrix()).inverse()},getTransformation:function(){return this.getCurrentTransform()},getProjectionMatrix:function(e){if(null==this._projMatrix){var t=this._vf.fieldOfView,i=this._vf.zFar,o=this._vf.zNear,s=1/Math.tan(t/2);this._projMatrix=new x3dom.fields.SFMatrix4f(s/e,0,0,0,0,s,0,0,0,0,(o+i)/(o-i),2*o*i/(o-i),0,0,-1,0),this._lastAspect=e}else this._lastAspect!==e&&(this._projMatrix._00=1/Math.tan(this._vf.fieldOfView/2)/e,this._lastAspect=e);return this._projMatrix
}})),x3dom.registerNodeType("NavigationInfo","Navigation",defineClass(x3dom.nodeTypes.X3DNavigationInfoNode,function(e){x3dom.nodeTypes.NavigationInfo.superClass.call(this,e),this.addField_SFBool(e,"headlight",!0),this.addField_MFString(e,"type",["EXAMINE","ANY"]),this.addField_MFFloat(e,"avatarSize",[.25,1.6,.75]),this.addField_SFFloat(e,"speed",1),this.addField_SFFloat(e,"visibilityLimit",0),this.addField_SFTime(e,"transitionTime",1),this.addField_MFString(e,"transitionType",["LINEAR"]),x3dom.debug.logInfo("NavType: "+this._vf.type[0].toLowerCase())},{fieldChanged:function(){},getType:function(){return this._vf.type[0].toLowerCase()},setType:function(e,t){var i=e.toLowerCase();switch(i){case"game":this._vf.type[0].toLowerCase()!==i&&(t?t.initMouseState():this._nameSpace.doc._viewarea.initMouseState())}this._vf.type[0]=i,x3dom.debug.logInfo("Switch to "+i+" mode.")}})),x3dom.registerNodeType("Billboard","Navigation",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.Billboard.superClass.call(this,e),this.addField_SFVec3f(e,"axisOfRotation",0,1,0),this._eye=new x3dom.fields.SFVec3f(0,0,0),this._eyeViewUp=new x3dom.fields.SFVec3f(0,0,0),this._eyeLook=new x3dom.fields.SFVec3f(0,0,0),this._viewAlignedMat=x3dom.fields.SFMatrix4f.identity()},{collectDrawableObjects:function(e,t){if(this._vf.render){var i=x3dom.fields.SFVec3f.MAX(),o=x3dom.fields.SFVec3f.MIN(),s=(this.getVolume(i,o,!0),x3dom.fields.SFMatrix4f.identity()),n=o.add(i).multiply(.5).add(new x3dom.fields.SFVec3f(0,0,0)),r=this._eye.subtract(n);if(this._vf.axisOfRotation.equals(new x3dom.fields.SFVec3f(0,0,0),x3dom.fields.Eps)){var a=x3dom.fields.Quaternion.rotateFromTo(r,new x3dom.fields.SFVec3f(0,0,1));s=a.toMatrix().transpose();var d=s.multMatrixPnt(new x3dom.fields.SFVec3f(0,1,0)).normalize(),h=s.multMatrixPnt(new x3dom.fields.SFVec3f(0,0,1)).normalize();if(!this._eyeViewUp.equals(new x3dom.fields.SFVec3f(0,0,0),x3dom.fields.Eps)){var l=x3dom.fields.Quaternion.rotateFromTo(this._eyeLook,h),_=l.toMatrix().transpose().multMatrixVec(d),f=x3dom.fields.Quaternion.rotateFromTo(this._eyeViewUp,_);s=l.toMatrix().transpose().mult(s),s=f.toMatrix().transpose().mult(s)}}else{var u=this._vf.axisOfRotation.cross(r);u=u.normalize(),this._eye.z<0&&(u=u.multiply(-1));var c=Math.asin(u.dot(new x3dom.fields.SFVec3f(0,0,1)));this._eye.z<0&&(c+=Math.PI),s=x3dom.fields.SFMatrix4f.parseRotation(this._vf.axisOfRotation.x+", "+this._vf.axisOfRotation.y+", "+this._vf.axisOfRotation.z+", "+-1*c)}for(var m=0;m<this._childNodes.length;m++)if(this._childNodes[m]){var p=this._childNodes[m].transformMatrix(e.mult(s));this._childNodes[m].collectDrawableObjects(p,t)}null!==t&&t.Billboards.push([e,this])}}})),x3dom.registerNodeType("Collision","Navigation",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.Collision.superClass.call(this,e),this.addField_SFBool(e,"enabled",!0),this.addField_SFNode("proxy",x3dom.nodeTypes.X3DGroupingNode)},{collectDrawableObjects:function(e,t){for(var i=0;i<this._childNodes.length;i++)if(this._childNodes[i]&&this._childNodes[i]!==this._cf.proxy.node){var o=this._childNodes[i].transformMatrix(e);this._childNodes[i].collectDrawableObjects(o,t)}}})),x3dom.registerNodeType("LOD","Navigation",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(e){x3dom.nodeTypes.LOD.superClass.call(this,e),this.addField_SFBool(e,"forceTransitions",!1),this.addField_SFVec3f(e,"center",0,0,0),this.addField_MFFloat(e,"range",[]),this._eye=new x3dom.fields.SFVec3f(0,0,0)},{collectDrawableObjects:function(e,t){for(var i=0,o=this._childNodes.length,s=x3dom.fields.SFVec3f.MAX(),n=x3dom.fields.SFVec3f.MIN(),r=(this.getVolume(s,n,!0),n.add(s).multiply(.5).add(this._vf.center)),a=r.subtract(this._eye).length();i<this._vf.range.length&&a>this._vf.range[i];)i++;if(i&&i>=o&&(i=o-1),o&&this._childNodes[i]){var d=this._childNodes[i].transformMatrix(e);this._childNodes[i].collectDrawableObjects(d,t)}null!==t&&t.LODs.push([e,this])}})),x3dom.registerNodeType("Text","Text",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.Text.superClass.call(this,e),this.addField_MFString(e,"string",[]),this.addField_MFFloat(e,"length",[]),this.addField_SFFloat(e,"maxExtent",0),this.addField_SFNode("fontStyle",x3dom.nodeTypes.X3DFontStyleNode)},{nodeChanged:function(){this._cf.fontStyle.node||this.addChild(x3dom.nodeTypes.FontStyle.defaultNode())},fieldChanged:function(e){("string"==e||"family"==e||"horizontal"==e||"justify"==e||"language"==e||"leftToRight"==e||"size"==e||"spacing"==e||"style"==e||"topToBottom"==e)&&Array.forEach(this._parentNodes,function(e){e._dirty.texture=!0,e._dirty.text=!0})}})),x3dom.registerNodeType("X3DFontStyleNode","Text",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.X3DFontStyleNode.superClass.call(this,e)})),x3dom.registerNodeType("FontStyle","Text",defineClass(x3dom.nodeTypes.X3DFontStyleNode,function(e){x3dom.nodeTypes.FontStyle.superClass.call(this,e),this.addField_MFString(e,"family",["SERIF"]),this.addField_SFBool(e,"horizontal",!0),this.addField_MFString(e,"justify",["BEGIN"]),this.addField_SFString(e,"language",""),this.addField_SFBool(e,"leftToRight",!0),this.addField_SFFloat(e,"size",1),this.addField_SFFloat(e,"spacing",1),this.addField_SFString(e,"style","PLAIN"),this.addField_SFBool(e,"topToBottom",!0)},{nodeChanged:function(){},fieldChanged:function(e){("family"==e||"horizontal"==e||"justify"==e||"language"==e||"leftToRight"==e||"size"==e||"spacing"==e||"style"==e||"topToBottom"==e)&&Array.forEach(this._parentNodes,function(t){t.fieldChanged(e)})}})),x3dom.nodeTypes.FontStyle.defaultNode=function(){return x3dom.nodeTypes.FontStyle._defaultNode||(x3dom.nodeTypes.FontStyle._defaultNode=new x3dom.nodeTypes.FontStyle,x3dom.nodeTypes.FontStyle._defaultNode.nodeChanged()),x3dom.nodeTypes.FontStyle._defaultNode},x3dom.registerNodeType("X3DSoundNode","Sound",defineClass(x3dom.nodeTypes.X3DChildNode,function(e){x3dom.nodeTypes.X3DSoundNode.superClass.call(this,e)})),x3dom.registerNodeType("Sound","Sound",defineClass(x3dom.nodeTypes.X3DSoundNode,function(e){x3dom.nodeTypes.Sound.superClass.call(this,e),this.addField_SFNode("source",x3dom.nodeTypes.X3DSoundSourceNode)},{nodeChanged:function(){if(!this._cf.source.node&&this._xmlNode){x3dom.debug.logInfo("No AudioClip child node given, searching for &lt;audio&gt; elements...");try{Array.forEach(this._xmlNode.childNodes,function(e){if(1===e.nodeType&&(x3dom.debug.logInfo("### Found &lt;"+e.nodeName+"&gt; tag."),"audio"===e.localName.toLowerCase())){var t=e.getAttribute("loop");t=t?"loop"===t.toLowerCase():!1;var i=e.cloneNode(!1);e.parentNode.removeChild(e),e=null,"Microsoft Internet Explorer"!=navigator.appName&&document.body.appendChild(i);var o=function(){i.play()},s=function(){t&&i.play()};i.addEventListener("canplaythrough",o,!0),i.addEventListener("ended",s,!0)}})}catch(e){}}}})),x3dom.registerNodeType("X3DSoundSourceNode","Sound",defineClass(x3dom.nodeTypes.X3DTimeDependentNode,function(e){x3dom.nodeTypes.X3DSoundSourceNode.superClass.call(this,e)})),x3dom.registerNodeType("AudioClip","Sound",defineClass(x3dom.nodeTypes.X3DSoundSourceNode,function(e){x3dom.nodeTypes.AudioClip.superClass.call(this,e),this.addField_MFString(e,"url",[]),this.addField_SFBool(e,"enabled",!0),this.addField_SFBool(e,"loop",!1),this._audio=null},{nodeChanged:function(){this._audio=document.createElement("audio"),this._audio.setAttribute("autobuffer","true"),"Microsoft Internet Explorer"!=navigator.appName&&document.body.appendChild(this._audio);for(var e=0;e<this._vf.url.length;e++){var t=this._nameSpace.getURL(this._vf.url[e]);x3dom.debug.logInfo("Adding sound file: "+t);var i=document.createElement("source");i.setAttribute("src",t),this._audio.appendChild(i)}var o=this,s=function(){o._audio.play()},n=function(){o._vf.loop===!0&&o._audio.play()};this._audio.addEventListener("canplaythrough",s,!0),this._audio.addEventListener("ended",n,!0)},fieldChanged:function(e){if("enabled"===e)this._vf.enabled===!0?this._audio.play():this._audio.pause();else if("loop"===e)this._vf.loop===!0&&this._audio.play();else if("url"===e){for(this._audio.pause();this._audio.hasChildNodes();)this._audio.removeChild(this._audio.firstChild);for(var t=0;t<this._vf.url.length;t++){var i=this._nameSpace.getURL(this._vf.url[t]);x3dom.debug.logInfo("Adding sound file: "+i);var o=document.createElement("source");o.setAttribute("src",i),this._audio.appendChild(o)}}}})),x3dom.registerNodeType("X3DTextureTransformNode","Texturing",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(e){x3dom.nodeTypes.X3DTextureTransformNode.superClass.call(this,e)})),x3dom.registerNodeType("TextureTransform","Texturing",defineClass(x3dom.nodeTypes.X3DTextureTransformNode,function(e){x3dom.nodeTypes.TextureTransform.superClass.call(this,e),this.addField_SFVec2f(e,"center",0,0),this.addField_SFFloat(e,"rotation",0),this.addField_SFVec2f(e,"scale",1,1),this.addField_SFVec2f(e,"translation",0,0);var t=new x3dom.fields.SFVec3f(-this._vf.center.x,-this._vf.center.y,1),i=new x3dom.fields.SFVec3f(this._vf.center.x,this._vf.center.y,0),o=new x3dom.fields.SFVec3f(this._vf.translation.x,this._vf.translation.y,0),s=new x3dom.fields.SFVec3f(this._vf.scale.x,this._vf.scale.y,0);this._trafo=x3dom.fields.SFMatrix4f.translation(t).mult(x3dom.fields.SFMatrix4f.scale(s)).mult(x3dom.fields.SFMatrix4f.rotationZ(this._vf.rotation)).mult(x3dom.fields.SFMatrix4f.translation(i.add(o)))},{fieldChanged:function(){var e=new x3dom.fields.SFVec3f(-this._vf.center.x,-this._vf.center.y,1),t=new x3dom.fields.SFVec3f(this._vf.center.x,this._vf.center.y,0),i=new x3dom.fields.SFVec3f(this._vf.translation.x,this._vf.translation.y,0),o=new x3dom.fields.SFVec3f(this._vf.scale.x,this._vf.scale.y,0);this._trafo=x3dom.fields.SFMatrix4f.translation(e).mult(x3dom.fields.SFMatrix4f.scale(o)).mult(x3dom.fields.SFMatrix4f.rotationZ(this._vf.rotation)).mult(x3dom.fields.SFMatrix4f.translation(t.add(i)))},texTransformMatrix:function(){return this._trafo}})),x3dom.registerNodeType("TextureProperties","Texturing",defineClass(x3dom.nodeTypes.X3DNode,function(e){x3dom.nodeTypes.TextureProperties.superClass.call(this,e),this.addField_SFFloat(e,"anisotropicDegree",1),this.addField_SFColorRGBA(e,"borderColor",0,0,0,0),this.addField_SFInt32(e,"borderWidth",0),this.addField_SFString(e,"boundaryModeS","REPEAT"),this.addField_SFString(e,"boundaryModeT","REPEAT"),this.addField_SFString(e,"boundaryModeR","REPEAT"),this.addField_SFString(e,"magnificationFilter","FASTEST"),this.addField_SFString(e,"minificationFilter","FASTEST"),this.addField_SFString(e,"textureCompression","FASTEST"),this.addField_SFFloat(e,"texturePriority",0),this.addField_SFBool(e,"generateMipMaps",!1)})),x3dom.registerNodeType("X3DTextureNode","Texturing",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(e){x3dom.nodeTypes.X3DTextureNode.superClass.call(this,e),this.addField_SFInt32(e,"origChannelCount",0),this.addField_MFString(e,"url",[]),this.addField_SFBool(e,"repeatS",!0),this.addField_SFBool(e,"repeatT",!0),this.addField_SFNode("textureProperties",x3dom.nodeTypes.TextureProperties),this.addField_SFBool(e,"scale",!0),this.addField_SFInt32(e,"priority",10),this._needPerFrameUpdate=!1,this._isCanvas=!1},{invalidateGLObject:function(){Array.forEach(this._parentNodes,function(e){Array.forEach(e._parentNodes,function(e){e._dirty.texture=!0})}),this._nameSpace.doc.needRender=!0},parentAdded:function(e){Array.forEach(e._parentNodes,function(e){e._dirty.texture=!0})},parentRemoved:function(e){e._cf.texture.node=null,Array.forEach(e._parentNodes,function(e){e._dirty.texture=!0})},nodeChanged:function(){},fieldChanged:function(e){"url"==e&&(this._complete=!1,Array.forEach(this._parentNodes,function(e){e.nodeChanged(),Array.forEach(e._parentNodes,function(e){e._dirty.texture=!0})}))},getTexture:function(e){return 0===e?this:null},size:function(){return 1}})),x3dom.registerNodeType("MultiTexture","Texturing",defineClass(x3dom.nodeTypes.X3DTextureNode,function(e){x3dom.nodeTypes.MultiTexture.superClass.call(this,e),this.addField_MFNode("texture",x3dom.nodeTypes.X3DTextureNode)},{getTexture:function(e){return e>=0&&e<this._cf.texture.nodes.length?this._cf.texture.nodes[e]:null},size:function(){return this._cf.texture.nodes.length}})),x3dom.registerNodeType("Texture","Texturing",defineClass(x3dom.nodeTypes.X3DTextureNode,function(e){x3dom.nodeTypes.Texture.superClass.call(this,e),this.addField_SFBool(e,"hideChildren",!0),this._video=null,this._intervalID=0,this._canvas=null},{nodeChanged:function(){if(!this._vf.url.length&&this._xmlNode){x3dom.debug.logInfo("No Texture URL given, searching for &lt;img&gt; elements...");var e=this;try{Array.forEach(this._xmlNode.childNodes,function(t){if(1===t.nodeType){var i=t.getAttribute("src");if(i){if(e._vf.url.push(i),x3dom.debug.logInfo(e._vf.url[e._vf.url.length-1]),"video"===t.localName){e._needPerFrameUpdate=!0,e._video=document.createElement("video"),e._video.setAttribute("autobuffer","true");var o=document.getElementsByTagName("body")[0];o.appendChild(e._video),e._video.style.display="none"}}else"canvas"===t.localName.toLowerCase()&&(e._needPerFrameUpdate=!0,e._isCanvas=!0,e._canvas=t);e._vf.hideChildren&&(t.style.display="none",t.style.visibility="hidden"),x3dom.debug.logInfo("### Found &lt;"+t.nodeName+"&gt; tag.")}})}catch(t){}}}})),x3dom.registerNodeType("RenderedTexture","Texturing",defineClass(x3dom.nodeTypes.X3DTextureNode,function(e){x3dom.nodeTypes.RenderedTexture.superClass.call(this,e),e.doc._nodeBag.renderTextures.push(this),this.addField_SFNode("viewpoint",x3dom.nodeTypes.X3DViewpointNode),this.addField_SFNode("background",x3dom.nodeTypes.X3DBackgroundNode),this.addField_SFNode("fog",x3dom.nodeTypes.X3DFogNode),this.addField_SFNode("scene",x3dom.nodeTypes.X3DNode),this.addField_MFNode("excludeNodes",x3dom.nodeTypes.X3DNode),this.addField_MFInt32(e,"dimensions",[128,128,4]),this.addField_SFString(e,"update","NONE"),x3dom.debug.assert(this._vf.dimensions.length>=3),this._clearParents=!0},{nodeChanged:function(){this._clearParents=!0},fieldChanged:function(e){"excludeNodes"==e&&(this._clearParents=!0)},getViewMatrix:function(){if(this._clearParents&&this._cf.excludeNodes.nodes.length){var e=this;Array.forEach(this._cf.excludeNodes.nodes,function(t){for(var i=0,o=t._parentNodes.length;o>i;i++)t._parentNodes[i]===e&&(t._parentNodes.splice(i,1),t.parentRemoved(e))}),this._clearParents=!1}var t=this._nameSpace.doc._scene.getViewpoint(),i=this._cf.viewpoint.node;if(null===i||i===t)return this._nameSpace.doc._viewarea.getViewMatrix();var o=i.getCurrentTransform();return o.mult(i.getViewMatrix())},getProjectionMatrix:function(){var e=this._nameSpace.doc._scene.getViewpoint(),t=this._cf.viewpoint.node;if(null===t||t===e)return this._nameSpace.doc._viewarea.getProjectionMatrix();var i=this._vf.dimensions[0],o=this._vf.dimensions[1];return t.getProjectionMatrix(i/o)},getWCtoCCMatrix:function(){var e=this.getViewMatrix(),t=this.getProjectionMatrix();return t.mult(e)},parentRemoved:function(){if(0===this._parentNodes.length)for(var e=this.findX3DDoc(),t=0,i=e._nodeBag.renderTextures.length;i>t;t++)e._nodeBag.renderTextures[t]===this&&e._nodeBag.renderTextures.splice(t,1);this._cf.scene.node&&this._cf.scene.node.parentRemoved(this)}})),x3dom.registerNodeType("PixelTexture","Texturing",defineClass(x3dom.nodeTypes.X3DTextureNode,function(e){x3dom.nodeTypes.PixelTexture.superClass.call(this,e),this.addField_SFImage(e,"image",0,0,0)},{fieldChanged:function(e){"image"==e&&this.invalidateGLObject()}})),x3dom.registerNodeType("ImageTexture","Texturing",defineClass(x3dom.nodeTypes.Texture,function(e){x3dom.nodeTypes.ImageTexture.superClass.call(this,e)},{})),x3dom.registerNodeType("MovieTexture","Texturing",defineClass(x3dom.nodeTypes.Texture,function(e){x3dom.nodeTypes.MovieTexture.superClass.call(this,e),this.addField_SFBool(e,"loop",!1),this.addField_SFFloat(e,"speed",1)},{})),x3dom.registerNodeType("X3DEnvironmentTextureNode","CubeMapTexturing",defineClass(x3dom.nodeTypes.X3DTextureNode,function(e){x3dom.nodeTypes.X3DEnvironmentTextureNode.superClass.call(this,e)},{getTexUrl:function(){return[]},getTexSize:function(){return-1}})),x3dom.registerNodeType("ComposedCubeMapTexture","CubeMapTexturing",defineClass(x3dom.nodeTypes.X3DEnvironmentTextureNode,function(e){x3dom.nodeTypes.ComposedCubeMapTexture.superClass.call(this,e),this.addField_SFNode("back",x3dom.nodeTypes.Texture),this.addField_SFNode("front",x3dom.nodeTypes.Texture),this.addField_SFNode("bottom",x3dom.nodeTypes.Texture),this.addField_SFNode("top",x3dom.nodeTypes.Texture),this.addField_SFNode("left",x3dom.nodeTypes.Texture),this.addField_SFNode("right",x3dom.nodeTypes.Texture)},{getTexUrl:function(){return[this._nameSpace.getURL(this._cf.back.node._vf.url[0]),this._nameSpace.getURL(this._cf.front.node._vf.url[0]),this._nameSpace.getURL(this._cf.bottom.node._vf.url[0]),this._nameSpace.getURL(this._cf.top.node._vf.url[0]),this._nameSpace.getURL(this._cf.left.node._vf.url[0]),this._nameSpace.getURL(this._cf.right.node._vf.url[0])]}})),x3dom.registerNodeType("GeneratedCubeMapTexture","CubeMapTexturing",defineClass(x3dom.nodeTypes.X3DEnvironmentTextureNode,function(e){x3dom.nodeTypes.GeneratedCubeMapTexture.superClass.call(this,e),this.addField_SFInt32(e,"size",128),this.addField_SFString(e,"update","NONE"),x3dom.debug.logWarning("GeneratedCubeMapTexture NYI")},{getTexSize:function(){return this._vf.size}})),x3dom.registerNodeType("X3DTextureCoordinateNode","Texturing",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(e){x3dom.nodeTypes.X3DTextureCoordinateNode.superClass.call(this,e)},{fieldChanged:function(){Array.forEach(this._parentNodes,function(e){e.fieldChanged("texCoord")})},parentAdded:function(e){e._mesh&&e._cf.texCoord.node!==this&&e.fieldChanged("texCoord")}})),x3dom.registerNodeType("TextureCoordinate3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTextureCoordinateNode,function(e){x3dom.nodeTypes.TextureCoordinate3D.superClass.call(this,e),this.addField_MFVec3f(e,"point",[])})),x3dom.registerNodeType("TextureCoordinate","Texturing",defineClass(x3dom.nodeTypes.X3DTextureCoordinateNode,function(e){x3dom.nodeTypes.TextureCoordinate.superClass.call(this,e),this.addField_MFVec2f(e,"point",[])})),x3dom.registerNodeType("TextureCoordinateGenerator","Texturing",defineClass(x3dom.nodeTypes.X3DTextureCoordinateNode,function(e){x3dom.nodeTypes.TextureCoordinateGenerator.superClass.call(this,e),this.addField_SFString(e,"mode","SPHERE"),this.addField_MFFloat(e,"parameter",[])})),x3dom.registerNodeType("Uniform","Shaders",defineClass(x3dom.nodeTypes.Field,function(e){x3dom.nodeTypes.Uniform.superClass.call(this,e)})),x3dom.registerNodeType("SurfaceShaderTexture","Shaders",defineClass(x3dom.nodeTypes.X3DTextureNode,function(e){x3dom.nodeTypes.SurfaceShaderTexture.superClass.call(this,e),this.addField_SFInt32(e,"textureCoordinatesId",0),this.addField_SFString(e,"channelMask","DEFAULT"),this.addField_SFBool(e,"isSRGB",!1),this.addField_SFNode("texture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("textureTransform",x3dom.nodeTypes.X3DTextureTransformNode)},{nodeChanged:function(){},fieldChanged:function(){}})),x3dom.registerNodeType("X3DShaderNode","Shaders",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(e){x3dom.nodeTypes.X3DShaderNode.superClass.call(this,e),this.addField_SFString(e,"language","")})),x3dom.registerNodeType("CommonSurfaceShader","Shaders",defineClass(x3dom.nodeTypes.X3DShaderNode,function(e){x3dom.nodeTypes.CommonSurfaceShader.superClass.call(this,e),this.addField_SFInt32(e,"tangentTextureCoordinatesId",-1),this.addField_SFInt32(e,"binormalTextureCoordinatesId",-1),this.addField_SFVec3f(e,"emissiveFactor",0,0,0),this.addField_SFInt32(e,"emissiveTextureId",-1),this.addField_SFInt32(e,"emissiveTextureCoordinatesId",0),this.addField_SFString(e,"emissiveTextureChannelMask","rgb"),this.addField_SFVec3f(e,"ambientFactor",.2,.2,.2),this.addField_SFInt32(e,"ambientTextureId",-1),this.addField_SFInt32(e,"ambientTextureCoordinatesId",0),this.addField_SFString(e,"ambientTextureChannelMask","rgb"),this.addField_SFVec3f(e,"diffuseFactor",.8,.8,.8),this.addField_SFInt32(e,"diffuseTextureId",-1),this.addField_SFInt32(e,"diffuseTextureCoordinatesId",0),this.addField_SFString(e,"diffuseTextureChannelMask","rgb"),this.addField_SFVec3f(e,"specularFactor",0,0,0),this.addField_SFInt32(e,"specularTextureId",-1),this.addField_SFInt32(e,"specularTextureCoordinatesId",0),this.addField_SFString(e,"specularTextureChannelMask","rgb"),this.addField_SFFloat(e,"shininessFactor",.2),this.addField_SFInt32(e,"shininessTextureId",-1),this.addField_SFInt32(e,"shininessTextureCoordinatesId",0),this.addField_SFString(e,"shininessTextureChannelMask","a"),this.addField_SFString(e,"normalFormat","UNORM"),this.addField_SFString(e,"normalSpace","TANGENT"),this.addField_SFInt32(e,"normalTextureId",-1),this.addField_SFInt32(e,"normalTextureCoordinatesId",0),this.addField_SFString(e,"normalTextureChannelMask","rgb"),this.addField_SFVec3f(e,"reflectionFactor",0,0,0),this.addField_SFInt32(e,"reflectionTextureId",-1),this.addField_SFInt32(e,"reflectionTextureCoordinatesId",0),this.addField_SFString(e,"reflectionTextureChannelMask","rgb"),this.addField_SFVec3f(e,"transmissionFactor",0,0,0),this.addField_SFInt32(e,"transmissionTextureId",-1),this.addField_SFInt32(e,"transmissionTextureCoordinatesId",0),this.addField_SFString(e,"transmissionTextureChannelMask","rgb"),this.addField_SFVec3f(e,"environmentFactor",1,1,1),this.addField_SFInt32(e,"environmentTextureId",-1),this.addField_SFInt32(e,"environmentTextureCoordinatesId",0),this.addField_SFString(e,"environmentTextureChannelMask","rgb"),this.addField_SFFloat(e,"relativeIndexOfRefraction",1),this.addField_SFFloat(e,"fresnelBlend",0),this.addField_SFNode("emissiveTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("ambientTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("diffuseTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("specularTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("shininessTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("normalTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("reflectionTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("transmissionTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("environmentTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFVec3f(e,"normalScale",2,2,2),this.addField_SFVec3f(e,"normalBias",-1,-1,-1),this.addField_SFFloat(e,"alphaFactor",1),this.addField_SFBool(e,"invertAlphaTexture",!1),this.addField_SFInt32(e,"alphaTextureId",-1),this.addField_SFInt32(e,"alphaTextureCoordinatesId",0),this.addField_SFString(e,"alphaTextureChannelMask","a"),this.addField_SFNode("alphaTexture",x3dom.nodeTypes.X3DTextureNode),this._dirty={}},{nodeChanged:function(){},fieldChanged:function(){},getDiffuseMap:function(){return this._cf.diffuseTexture.node?this._cf.diffuseTexture.node._cf.texture.node:null},getNormalMap:function(){return this._cf.normalTexture.node?this._cf.normalTexture.node._cf.texture.node:null},getAmbientMap:function(){return this._cf.ambientTexture.node?this._cf.ambientTexture.node._cf.texture.node:null},getSpecularMap:function(){return this._cf.specularTexture.node?this._cf.specularTexture.node._cf.texture.node:null},getShininessMap:function(){return this._cf.shininessTexture.node?this._cf.shininessTexture.node._cf.texture.node:null},getAlphaMap:function(){return this._cf.alphaTexture.node?this._cf.alphaTexture.node._cf.texture.node:null}})),x3dom.registerNodeType("ComposedShader","Shaders",defineClass(x3dom.nodeTypes.X3DShaderNode,function(e){x3dom.nodeTypes.ComposedShader.superClass.call(this,e),this.addField_MFNode("fields",x3dom.nodeTypes.Field),this.addField_MFNode("parts",x3dom.nodeTypes.ShaderPart),this._vertex=null,this._fragment=null,x3dom.debug.logInfo("Current ComposedShader node implementation limitations:\nVertex attributes (if given in the standard X3D fields 'coord', 'color', 'normal', 'texCoord'), matrices and texture are provided as follows...\n    attribute vec3 position;\n    attribute vec3 normal;\n    attribute vec2 texcoord;\n    attribute vec3 color;\n    uniform mat4 modelViewProjectionMatrix;\n    uniform mat4 modelViewMatrix;\n    uniform mat4 normalMatrix;\n    uniform mat4 viewMatrix;\n    uniform sampler2D tex;\n")},{nodeChanged:function(){var e,t=this._cf.parts.nodes.length;for(e=0;t>e;e++)"vertex"==this._cf.parts.nodes[e]._vf.type.toLowerCase()?this._vertex=this._cf.parts.nodes[e]:"fragment"==this._cf.parts.nodes[e]._vf.type.toLowerCase()&&(this._fragment=this._cf.parts.nodes[e]);var i={};for(t=this._cf.fields.nodes.length,e=0;t>e;e++){var o=this._cf.fields.nodes[e]._vf.name;i.xmlNode=this._cf.fields.nodes[e]._xmlNode,i.xmlNode.setAttribute(o,this._cf.fields.nodes[e]._vf.value);var s="this.addField_"+this._cf.fields.nodes[e]._vf.type+"(ctx, name);",n=new Function("ctx","name",s);n.call(this,i,o)}Array.forEach(this._parentNodes,function(e){Array.forEach(e._parentNodes,function(e){e._dirty.shader=!0})})},fieldChanged:function(e){var t,i=this._cf.fields.nodes.length;for(t=0;i>t;t++){var o=this._cf.fields.nodes[t]._vf.name;if(o===e){var s=this._cf.fields.nodes[t]._vf.value;try{this._vf[o].setValueByStr(s)}catch(n){try{switch((typeof this._vf[o]).toString()){case"number":this._vf[o]=+s;break;case"boolean":this._vf[o]="true"===s.toLowerCase();break;case"string":this._vf[o]=s}}catch(r){x3dom.debug.logError("setValueByStr() NYI for "+typeof this._vf[o])}}break}}},parentAdded:function(){this._parentNodes[0].nodeChanged()}})),x3dom.registerNodeType("ShaderPart","Shaders",defineClass(x3dom.nodeTypes.X3DNode,function(e){if(x3dom.nodeTypes.ShaderPart.superClass.call(this,e),this.addField_MFString(e,"url",[]),this.addField_SFString(e,"type","VERTEX"),x3dom.debug.assert("vertex"==this._vf.type.toLowerCase()||"fragment"==this._vf.type.toLowerCase()),!this._vf.url.length&&e.xmlNode){var t=this;try{t._vf.url.push(e.xmlNode.childNodes[1].nodeValue),e.xmlNode.removeChild(e.xmlNode.childNodes[1])}catch(i){Array.forEach(e.xmlNode.childNodes,function(e){4===e.nodeType&&t._vf.url.push(e.data),e.parentNode.removeChild(e)})}}},{nodeChanged:function(){},fieldChanged:function(){},parentAdded:function(){this._parentNodes[0].nodeChanged()}})),x3dom.registerNodeType("X3DVertexAttributeNode","Shaders",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(e){x3dom.nodeTypes.X3DVertexAttributeNode.superClass.call(this,e),this.addField_SFString(e,"name","")})),x3dom.registerNodeType("FloatVertexAttribute","Shaders",defineClass(x3dom.nodeTypes.X3DVertexAttributeNode,function(e){x3dom.nodeTypes.FloatVertexAttribute.superClass.call(this,e),this.addField_SFInt32(e,"numComponents",4),this.addField_MFFloat(e,"value",[])},{fieldChanged:function(){}})),x3dom.registerNodeType("Plane","Geometry3D",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.Plane.superClass.call(this,e),this.addField_SFVec2f(e,"size",2,2),this.addField_SFVec2f(e,"subdivision",1,1);var t=this._vf.size.x,i=this._vf.size.y,o=this._vf.subdivision.x,s=this._vf.subdivision.y,n="Plane_"+t+"-"+i+"-"+o+"-"+s;if(void 0!=x3dom.geoCache[n])x3dom.debug.logInfo("Using Plane from Cache"),this._mesh=x3dom.geoCache[n];else{var r=0,a=0,d=t/o,h=i/s;for(t/=2,i/=2,a=0;s>=a;a++)for(r=0;o>=r;r++)this._mesh._positions[0].push(r*d-t),this._mesh._positions[0].push(a*h-i),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push(r/o),this._mesh._texCoords[0].push(a/s);for(a=1;s>=a;a++)for(r=0;o>r;r++)this._mesh._indices[0].push((a-1)*(o+1)+r),this._mesh._indices[0].push((a-1)*(o+1)+r+1),this._mesh._indices[0].push(a*(o+1)+r),this._mesh._indices[0].push(a*(o+1)+r),this._mesh._indices[0].push((a-1)*(o+1)+r+1),this._mesh._indices[0].push(a*(o+1)+r+1);this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[n]=this._mesh}},{nodeChanged:function(){},fieldChanged:function(e){if("size"===e){this._mesh._positions[0]=[];var t=this._vf.size.x,i=this._vf.size.y,o=this._vf.subdivision.x,s=this._vf.subdivision.y,n=0,r=0,a=t/o,d=i/s;for(t/=2,i/=2,r=0;s>=r;r++)for(n=0;o>=n;n++)this._mesh._positions[0].push(n*a-t),this._mesh._positions[0].push(r*d-i),this._mesh._positions[0].push(0);this._mesh._invalidate=!0,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0})}else if("subdivision"===e){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];var t=this._vf.size.x,i=this._vf.size.y,o=this._vf.subdivision.x,s=this._vf.subdivision.y,n=0,r=0,a=t/o,d=i/s;for(t/=2,i/=2,r=0;s>=r;r++)for(n=0;o>=n;n++)this._mesh._positions[0].push(n*a-t),this._mesh._positions[0].push(r*d-i),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push(n/o),this._mesh._texCoords[0].push(r/s);for(r=1;s>=r;r++)for(n=0;o>n;n++)this._mesh._indices[0].push((r-1)*(o+1)+n),this._mesh._indices[0].push((r-1)*(o+1)+n+1),this._mesh._indices[0].push(r*(o+1)+n),this._mesh._indices[0].push(r*(o+1)+n),this._mesh._indices[0].push((r-1)*(o+1)+n+1),this._mesh._indices[0].push(r*(o+1)+n+1);this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(e){e.setAllDirty()})}}})),x3dom.registerNodeType("ElevationGrid","Geometry3D",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.ElevationGrid.superClass.call(this,e),this.addField_SFBool(e,"colorPerVertex",!0),this.addField_SFBool(e,"normalPerVertex",!0),this.addField_SFFloat(e,"creaseAngle",0),this.addField_MFNode("attrib",x3dom.nodeTypes.X3DVertexAttributeNode),this.addField_SFNode("normal",x3dom.nodeTypes.Normal),this.addField_SFNode("color",x3dom.nodeTypes.X3DColorNode),this.addField_SFNode("texCoord",x3dom.nodeTypes.X3DTextureCoordinateNode),this.addField_MFFloat(e,"height",[]),this.addField_SFInt32(e,"xDimension",0),this.addField_SFFloat(e,"xSpacing",1),this.addField_SFInt32(e,"zDimension",0),this.addField_SFFloat(e,"zSpacing",1)},{nodeChanged:function(){this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];var e=0,t=0,i=this._vf.xDimension-1,o=this._vf.zDimension-1,s=this._vf.height;x3dom.debug.assert(s.length===this._vf.xDimension*this._vf.zDimension);var n=null,r=null,a=null;this._cf.normal.node&&(n=this._cf.normal.node._vf.vector);var d=2;this._cf.texCoord.node&&this._cf.texCoord.node._vf.point&&(r=this._cf.texCoord.node._vf.point,x3dom.isa(this._cf.texCoord.node,x3dom.nodeTypes.TextureCoordinate3D)&&(d=3));var h=3;this._cf.color.node&&(a=this._cf.color.node._vf.color,x3dom.isa(this._cf.color.node,x3dom.nodeTypes.ColorRGBA)&&(h=4));var l=0;for(t=0;o>=t;t++)for(e=0;i>=e;e++)this._mesh._positions[0].push(e*this._vf.xSpacing),this._mesh._positions[0].push(s[l]),this._mesh._positions[0].push(t*this._vf.zSpacing),n&&(this._mesh._normals[0].push(n[l].x),this._mesh._normals[0].push(n[l].y),this._mesh._normals[0].push(n[l].z)),r?(this._mesh._texCoords[0].push(r[l].x),this._mesh._texCoords[0].push(r[l].y),3===d&&this._mesh._texCoords[0].push(r[l].z)):(this._mesh._texCoords[0].push(e/i),this._mesh._texCoords[0].push(t/o)),a&&(this._mesh._colors[0].push(a[l].r),this._mesh._colors[0].push(a[l].g),this._mesh._colors[0].push(a[l].b),4===h&&this._mesh._colors[0].push(a[l].a)),l++;for(t=1;o>=t;t++)for(e=0;i>e;e++)this._mesh._indices[0].push((t-1)*(i+1)+e),this._mesh._indices[0].push(t*(i+1)+e),this._mesh._indices[0].push((t-1)*(i+1)+e+1),this._mesh._indices[0].push(t*(i+1)+e),this._mesh._indices[0].push(t*(i+1)+e+1),this._mesh._indices[0].push((t-1)*(i+1)+e+1);
this._mesh.calcNormals(Math.PI),this._mesh._invalidate=!0,this._mesh._numTexComponents=d,this._mesh._numColComponents=h,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3},fieldChanged:function(e){if("height"==e){var t,i=this._mesh._positions[0].length/3,o=this._vf.height;for(t=0;i>t;t++)this._mesh._positions[0][3*t+1]=o[t];this._mesh._invalidate=!0,Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0})}}})),x3dom.registerNodeType("Box","Geometry3D",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.Box.superClass.call(this,e),this.addField_SFVec3f(e,"size",2,2,2);var t=this._vf.size.x,i=this._vf.size.y,o=this._vf.size.z,s="Box_"+t+"-"+i+"-"+o;void 0!=x3dom.geoCache[s]?(x3dom.debug.logInfo("Using Box from Cache"),this._mesh=x3dom.geoCache[s]):(t/=2,i/=2,o/=2,this._mesh._positions[0]=[-t,-i,-o,-t,i,-o,t,i,-o,t,-i,-o,-t,-i,o,-t,i,o,t,i,o,t,-i,o,-t,-i,-o,-t,-i,o,-t,i,o,-t,i,-o,t,-i,-o,t,-i,o,t,i,o,t,i,-o,-t,i,-o,-t,i,o,t,i,o,t,i,-o,-t,-i,-o,-t,-i,o,t,-i,o,t,-i,-o],this._mesh._normals[0]=[0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],this._mesh._texCoords[0]=[1,0,1,1,0,1,0,0,0,0,0,1,1,1,1,0,0,0,1,0,1,1,0,1,1,0,0,0,0,1,1,1,0,1,0,0,1,0,1,1,0,0,0,1,1,1,1,0],this._mesh._indices[0]=[0,1,2,2,3,0,4,7,5,5,7,6,8,9,10,10,11,8,12,14,13,14,12,15,16,17,18,18,19,16,20,22,21,22,20,23],this._mesh._invalidate=!0,this._mesh._numFaces=12,this._mesh._numCoords=24,x3dom.geoCache[s]=this._mesh)},{fieldChanged:function(e){if("size"===e){var t=this._vf.size.x/2,i=this._vf.size.y/2,o=this._vf.size.z/2;this._mesh._positions[0]=[-t,-i,-o,-t,i,-o,t,i,-o,t,-i,-o,-t,-i,o,-t,i,o,t,i,o,t,-i,o,-t,-i,-o,-t,-i,o,-t,i,o,-t,i,-o,t,-i,-o,t,-i,o,t,i,o,t,i,-o,-t,i,-o,-t,i,o,t,i,o,t,i,-o,-t,-i,-o,-t,-i,o,t,-i,o,t,-i,-o],Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0})}}})),x3dom.registerNodeType("Sphere","Geometry3D",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.Sphere.superClass.call(this,e),this.addField_SFFloat(e,"radius",e?1:1e4),this.addField_SFVec2f(e,"subdivision",24,24);var t=1,i=this._vf.radius,o=this._vf.subdivision.x,s=this._vf.subdivision.y,n="Sphere_"+i;if(void 0!=x3dom.geoCache[n])x3dom.debug.logInfo("Using Sphere from Cache"),this._mesh=x3dom.geoCache[n];else{if(e&&(t=e.doc.properties.getProperty("PrimitiveQuality","Medium")),x3dom.isNumber(t))t=parseFloat(t);else switch(t.toLowerCase()){case"low":t=.3;break;case"medium":t=.5;break;case"high":t=1}this._quality=t;var r,a,d,h,l,_,f,u,c,m,p,g,x,v=Math.floor(o*t),y=Math.floor(s*t);for(r=0;v>=r;r++)for(d=r*Math.PI/v,h=Math.sin(d),l=Math.cos(d),a=0;y>=a;a++)_=2*a*Math.PI/y,f=Math.sin(_),u=Math.cos(_),c=-u*h,m=-l,p=-f*h,g=.25-1*a/y,x=r/v,this._mesh._positions[0].push(i*c),this._mesh._positions[0].push(i*m),this._mesh._positions[0].push(i*p),this._mesh._normals[0].push(c),this._mesh._normals[0].push(m),this._mesh._normals[0].push(p),this._mesh._texCoords[0].push(g),this._mesh._texCoords[0].push(x);var b,T;for(r=0;v>r;r++)for(a=0;y>a;a++)b=r*(y+1)+a,T=b+y+1,this._mesh._indices[0].push(b),this._mesh._indices[0].push(T),this._mesh._indices[0].push(b+1),this._mesh._indices[0].push(T),this._mesh._indices[0].push(T+1),this._mesh._indices[0].push(b+1);this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[n]=this._mesh}},{fieldChanged:function(e){if("radius"===e){this._mesh._positions[0]=[],this._mesh._normals[0]=[];var t,i,o,s,n,r,a,d,h,l,_,f=this._vf.radius,u=this._vf.subdivision.x,c=this._vf.subdivision.y,m=this._quality,p=Math.floor(u*m),g=Math.floor(c*m);for(t=0;p>=t;t++)for(o=t*Math.PI/p,s=Math.sin(o),n=Math.cos(o),i=0;g>=i;i++)r=2*i*Math.PI/g,a=Math.sin(r),d=Math.cos(r),h=-d*s,l=-n,_=-a*s,this._mesh._positions[0].push(f*h),this._mesh._positions[0].push(f*l),this._mesh._positions[0].push(f*_);this._mesh._invalidate=!0,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0})}else if("subdivision"===e){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];var t,i,o,s,n,r,a,d,h,l,_,x,v,f=this._vf.radius,u=this._vf.subdivision.x,c=this._vf.subdivision.y,m=this._quality,p=Math.floor(u*m),g=Math.floor(c*m);for(t=0;p>=t;t++)for(o=t*Math.PI/p,s=Math.sin(o),n=Math.cos(o),i=0;g>=i;i++)r=2*i*Math.PI/g,a=Math.sin(r),d=Math.cos(r),h=-d*s,l=-n,_=-a*s,x=.25-1*i/g,v=t/p,this._mesh._positions[0].push(f*h),this._mesh._positions[0].push(f*l),this._mesh._positions[0].push(f*_),this._mesh._normals[0].push(h),this._mesh._normals[0].push(l),this._mesh._normals[0].push(_),this._mesh._texCoords[0].push(x),this._mesh._texCoords[0].push(v);var y,b;for(t=0;p>t;t++)for(i=0;g>i;i++)y=t*(g+1)+i,b=y+g+1,this._mesh._indices[0].push(y),this._mesh._indices[0].push(b),this._mesh._indices[0].push(y+1),this._mesh._indices[0].push(b),this._mesh._indices[0].push(b+1),this._mesh._indices[0].push(y+1);this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(e){e.setAllDirty()})}}})),x3dom.registerNodeType("Torus","Geometry3D",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.Torus.superClass.call(this,e),this.addField_SFFloat(e,"innerRadius",.5),this.addField_SFFloat(e,"outerRadius",1),this.addField_SFVec2f(e,"subdivision",24,24);var t=this._vf.innerRadius,i=this._vf.outerRadius,o=this._vf.subdivision.x,s=this._vf.subdivision.y,n="Torus_"+t+"_"+i;if(void 0!=x3dom.geoCache[n])x3dom.debug.logInfo("Using Torus from Cache"),this._mesh=x3dom.geoCache[n];else{var r,a,d,h,l=2*Math.PI/o,_=2*Math.PI/s;for(r=0,d=0;o>=r;r++,d+=l){var f=Math.cos(d),u=Math.sin(d);for(a=0,h=0;s>=a;a++,h+=_){var c=Math.cos(h),m=Math.sin(h),p=i+t*c;this._mesh._normals[0].push(f*c,-u*c,m),this._mesh._positions[0].push(f*p,-u*p,t*m),this._mesh._texCoords[0].push(-r/o,a/s)}}for(r=0;s>r;r++)for(a=0;o>a;a++)this._mesh._indices[0].push(a*(s+1)+r),this._mesh._indices[0].push(a*(s+1)+r+1),this._mesh._indices[0].push((a+1)*(s+1)+r),this._mesh._indices[0].push(a*(s+1)+r+1),this._mesh._indices[0].push((a+1)*(s+1)+r+1),this._mesh._indices[0].push((a+1)*(s+1)+r);this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[n]=this._mesh}},{fieldChanged:function(e){if("innerRadius"===e||"outerRadius"===e){this._mesh._positions[0]=[];var t,i,o,s,n=this._vf.innerRadius,r=this._vf.outerRadius,a=this._vf.subdivision.x,d=this._vf.subdivision.y,h=2*Math.PI/a,l=2*Math.PI/d;for(t=0,o=0;a>=t;t++,o+=h){var _=Math.cos(o),f=Math.sin(o);for(i=0,s=0;d>=i;i++,s+=l){var u=Math.cos(s),c=Math.sin(s),m=r+n*u;this._mesh._positions[0].push(_*m,-f*m,n*c)}}this._mesh._invalidate=!0,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0})}else if("subdivision"===e){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];var t,i,o,s,n=this._vf.innerRadius,r=this._vf.outerRadius,a=this._vf.subdivision.x,d=this._vf.subdivision.y,h=2*Math.PI/a,l=2*Math.PI/d;for(t=0,o=0;a>=t;t++,o+=h){var _=Math.cos(o),f=Math.sin(o);for(i=0,s=0;d>=i;i++,s+=l){var u=Math.cos(s),c=Math.sin(s),m=r+n*u;this._mesh._normals[0].push(_*u,-f*u,c),this._mesh._positions[0].push(_*m,-f*m,n*c),this._mesh._texCoords[0].push(-t/a,i/d)}}for(t=0;d>t;t++)for(i=0;a>i;i++)this._mesh._indices[0].push(i*(d+1)+t),this._mesh._indices[0].push(i*(d+1)+t+1),this._mesh._indices[0].push((i+1)*(d+1)+t),this._mesh._indices[0].push(i*(d+1)+t+1),this._mesh._indices[0].push((i+1)*(d+1)+t+1),this._mesh._indices[0].push((i+1)*(d+1)+t);this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(e){e.setAllDirty()})}}})),x3dom.registerNodeType("Cone","Geometry3D",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.Cone.superClass.call(this,e),this.addField_SFFloat(e,"bottomRadius",1),this.addField_SFFloat(e,"height",2),this.addField_SFBool(e,"bottom",!0),this.addField_SFFloat(e,"subdivision",32),this.addField_SFBool(e,"side",!0);var t=this._vf.subdivision,i="Cone_"+this._vf.bottomRadius+"_"+this._vf.height+"_"+this._vf.bottom+"_"+this._vf.side;if(void 0!=x3dom.geoCache[i])x3dom.debug.logInfo("Using Cone from Cache"),this._mesh=x3dom.geoCache[i];else{var o,s,n,r=this._vf.bottomRadius,a=this._vf.height,d=2*Math.PI/t,h=r/a,l=1/Math.sqrt(1+h*h),_=0,f=0;if(this._vf.side)for(_=0,f=0;t>=_;_++)o=_*d,s=Math.sin(o),n=-Math.cos(o),this._mesh._positions[0].push(0,a/2,0),this._mesh._normals[0].push(s/l,h/l,n/l),this._mesh._texCoords[0].push(1-_/t,1),this._mesh._positions[0].push(s*r,-a/2,n*r),this._mesh._normals[0].push(s/l,h/l,n/l),this._mesh._texCoords[0].push(1-_/t,0),_>0&&(this._mesh._indices[0].push(f+0),this._mesh._indices[0].push(f+2),this._mesh._indices[0].push(f+1),this._mesh._indices[0].push(f+1),this._mesh._indices[0].push(f+2),this._mesh._indices[0].push(f+3),f+=2);if(this._vf.bottom&&r>0){var u=this._mesh._positions[0].length/3;for(_=t-1;_>=0;_--)o=_*d,s=r*Math.sin(o),n=-r*Math.cos(o),this._mesh._positions[0].push(s,-a/2,n),this._mesh._normals[0].push(0,-1,0),this._mesh._texCoords[0].push(s/r/2+.5,n/r/2+.5);var c=u+1;for(_=2;t>_;_++)this._mesh._indices[0].push(c),this._mesh._indices[0].push(u),c=u+_,this._mesh._indices[0].push(c)}this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[i]=this._mesh}},{fieldChanged:function(e){if("bottomRadius"===e||"height"===e){this._mesh._positions[0]=[];var t,i,o,s=this._vf.bottomRadius,n=this._vf.height,r=this._vf.subdivision,a=2*Math.PI/r,d=s/n,h=1/Math.sqrt(1+d*d);if(this._vf.side)for(var l=0;r>=l;l++)t=l*a,i=Math.sin(t),o=-Math.cos(t),this._mesh._positions[0].push(0,n/2,0),this._mesh._positions[0].push(i*s,-n/2,o*s);if(this._vf.bottom&&s>0)for(var _=this._mesh._positions[0].length/3,l=r-1;l>=0;l--)t=l*a,i=s*Math.sin(t),o=-s*Math.cos(t),this._mesh._positions[0].push(i,-n/2,o);this._mesh._invalidate=!0,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0})}else if("subdivision"===e||"bottom"===e){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];var t,i,o,s=this._vf.bottomRadius,n=this._vf.height,r=this._vf.subdivision,a=2*Math.PI/r,d=s/n,h=1/Math.sqrt(1+d*d),l=0,f=0;if(this._vf.side)for(l=0,f=0;r>=l;l++)t=l*a,i=Math.sin(t),o=-Math.cos(t),this._mesh._positions[0].push(0,n/2,0),this._mesh._normals[0].push(i/h,d/h,o/h),this._mesh._texCoords[0].push(1-l/r,1),this._mesh._positions[0].push(i*s,-n/2,o*s),this._mesh._normals[0].push(i/h,d/h,o/h),this._mesh._texCoords[0].push(1-l/r,0),l>0&&(this._mesh._indices[0].push(f+0),this._mesh._indices[0].push(f+2),this._mesh._indices[0].push(f+1),this._mesh._indices[0].push(f+1),this._mesh._indices[0].push(f+2),this._mesh._indices[0].push(f+3),f+=2);if(this._vf.bottom&&s>0){var _=this._mesh._positions[0].length/3;for(l=r-1;l>=0;l--)t=l*a,i=s*Math.sin(t),o=-s*Math.cos(t),this._mesh._positions[0].push(i,-n/2,o),this._mesh._normals[0].push(0,-1,0),this._mesh._texCoords[0].push(i/s/2+.5,o/s/2+.5);var u=_+1;for(l=2;r>l;l++)this._mesh._indices[0].push(u),this._mesh._indices[0].push(_),u=_+l,this._mesh._indices[0].push(u)}this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(e){e.setAllDirty()})}}})),x3dom.registerNodeType("Cylinder","Geometry3D",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.Cylinder.superClass.call(this,e),this.addField_SFFloat(e,"radius",1),this.addField_SFFloat(e,"height",2),this.addField_SFBool(e,"bottom",!0),this.addField_SFBool(e,"top",!0),this.addField_SFFloat(e,"subdivision",32),this.addField_SFBool(e,"side",!0);var t=this._vf.subdivision,i="Cylinder_"+this._vf.radius+"_"+this._vf.height+"_"+this._vf.bottom+"_"+this._vf.top+"_"+this._vf.side;if(void 0!=x3dom.geoCache[i])x3dom.debug.logInfo("Using Cylinder from Cache"),this._mesh=x3dom.geoCache[i];else{var o,s,n,r=this._vf.radius,a=this._vf.height,d=2*Math.PI/t,h=0,l=0;if(this._vf.side)for(h=0,l=0;t>=h;h++)o=h*d,s=Math.sin(o),n=-Math.cos(o),this._mesh._positions[0].push(s*r,-a/2,n*r),this._mesh._normals[0].push(s,0,n),this._mesh._texCoords[0].push(1-h/t,0),this._mesh._positions[0].push(s*r,a/2,n*r),this._mesh._normals[0].push(s,0,n),this._mesh._texCoords[0].push(1-h/t,1),h>0&&(this._mesh._indices[0].push(l+0),this._mesh._indices[0].push(l+1),this._mesh._indices[0].push(l+2),this._mesh._indices[0].push(l+2),this._mesh._indices[0].push(l+1),this._mesh._indices[0].push(l+3),l+=2);if(r>0){var _,f=this._mesh._positions[0].length/3;if(this._vf.top){for(h=t-1;h>=0;h--)o=h*d,s=r*Math.sin(o),n=-r*Math.cos(o),this._mesh._positions[0].push(s,a/2,n),this._mesh._normals[0].push(0,1,0),this._mesh._texCoords[0].push(s/r/2+.5,-n/r/2+.5);for(_=f+1,h=2;t>h;h++)this._mesh._indices[0].push(f),this._mesh._indices[0].push(_),_=f+h,this._mesh._indices[0].push(_);f=this._mesh._positions[0].length/3}if(this._vf.bottom){for(h=t-1;h>=0;h--)o=h*d,s=r*Math.sin(o),n=-r*Math.cos(o),this._mesh._positions[0].push(s,-a/2,n),this._mesh._normals[0].push(0,-1,0),this._mesh._texCoords[0].push(s/r/2+.5,n/r/2+.5);for(_=f+1,h=2;t>h;h++)this._mesh._indices[0].push(_),this._mesh._indices[0].push(f),_=f+h,this._mesh._indices[0].push(_)}}this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[i]=this._mesh}},{fieldChanged:function(e){if("radius"===e||"height"===e){this._mesh._positions[0]=[];var t,i,o,s=this._vf.radius,n=this._vf.height,r=this._vf.subdivision,a=2*Math.PI/r,d=0;if(this._vf.side)for(d=0;r>=d;d++)t=d*a,i=Math.sin(t),o=-Math.cos(t),this._mesh._positions[0].push(i*s,-n/2,o*s),this._mesh._positions[0].push(i*s,n/2,o*s);if(s>0){var h,l=this._mesh._positions[0].length/3;if(this._vf.top)for(d=r-1;d>=0;d--)t=d*a,i=s*Math.sin(t),o=-s*Math.cos(t),this._mesh._positions[0].push(i,n/2,o)}if(this._vf.bottom)for(d=r-1;d>=0;d--)t=d*a,i=s*Math.sin(t),o=-s*Math.cos(t),this._mesh._positions[0].push(i,-n/2,o);this._mesh._invalidate=!0,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0})}else if("subdivision"===e||"bottom"===e||"top"===e){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];var t,i,o,s=this._vf.radius,n=this._vf.height,r=this._vf.subdivision,a=2*Math.PI/r,d=0,_=0;if(this._vf.side)for(d=0,_=0;r>=d;d++)t=d*a,i=Math.sin(t),o=-Math.cos(t),this._mesh._positions[0].push(i*s,-n/2,o*s),this._mesh._normals[0].push(i,0,o),this._mesh._texCoords[0].push(1-d/r,0),this._mesh._positions[0].push(i*s,n/2,o*s),this._mesh._normals[0].push(i,0,o),this._mesh._texCoords[0].push(1-d/r,1),d>0&&(this._mesh._indices[0].push(_+0),this._mesh._indices[0].push(_+1),this._mesh._indices[0].push(_+2),this._mesh._indices[0].push(_+2),this._mesh._indices[0].push(_+1),this._mesh._indices[0].push(_+3),_+=2);if(s>0){var h,l=this._mesh._positions[0].length/3;if(this._vf.top){for(d=r-1;d>=0;d--)t=d*a,i=s*Math.sin(t),o=-s*Math.cos(t),this._mesh._positions[0].push(i,n/2,o),this._mesh._normals[0].push(0,1,0),this._mesh._texCoords[0].push(i/s/2+.5,-o/s/2+.5);for(h=l+1,d=2;r>d;d++)this._mesh._indices[0].push(l),this._mesh._indices[0].push(h),h=l+d,this._mesh._indices[0].push(h);l=this._mesh._positions[0].length/3}if(this._vf.bottom){for(d=r-1;d>=0;d--)t=d*a,i=s*Math.sin(t),o=-s*Math.cos(t),this._mesh._positions[0].push(i,-n/2,o),this._mesh._normals[0].push(0,-1,0),this._mesh._texCoords[0].push(i/s/2+.5,o/s/2+.5);for(h=l+1,d=2;r>d;d++)this._mesh._indices[0].push(h),this._mesh._indices[0].push(l),h=l+d,this._mesh._indices[0].push(h)}}this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,Array.forEach(this._parentNodes,function(e){e.setAllDirty()})}}})),x3dom.registerNodeType("ImageGeometry","Geometry3D",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(e){x3dom.nodeTypes.ImageGeometry.superClass.call(this,e);for(var t=-5,i=-4,o=0;o<e.xmlNode.childNodes.length;o++)"imagetexture"==e.xmlNode.childNodes[o].localName&&("coord"==e.xmlNode.childNodes[o].getAttribute("containerField")?(e.xmlNode.childNodes[o].setAttribute("priority",t),t+=10):"normal"==e.xmlNode.childNodes[o].getAttribute("containerField")?(e.xmlNode.childNodes[o].setAttribute("priority",i),i+=10):"texCoord"==e.xmlNode.childNodes[o].getAttribute("containerField")?e.xmlNode.childNodes[o].setAttribute("priority","-3"):"color"==e.xmlNode.childNodes[o].getAttribute("containerField")&&e.xmlNode.childNodes[o].setAttribute("priority","-2"));if(this.addField_SFVec3f(e,"position",0,0,0),this.addField_SFVec3f(e,"size",0,0,0),this.addField_MFFloat(e,"vertexCount",[0]),this.addField_MFString(e,"primType",["TRIANGLES"]),this.addField_SFFloat(e,"numColorComponents",3),this.addField_SFNode("index",x3dom.nodeTypes.X3DTextureNode),this.addField_MFNode("coord",x3dom.nodeTypes.X3DTextureNode),this.addField_MFNode("normal",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("texCoord",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("color",x3dom.nodeTypes.X3DTextureNode),this._mesh._numColComponents=this._vf.numColorComponents,"webgl"==x3dom.caps.BACKEND&&x3dom.caps.MAX_VERTEX_TEXTURE_IMAGE_UNITS>0){var s="ImageGeometry";if(void 0!=x3dom.geoCache[s])x3dom.debug.logInfo("Using ImageGeometry-Mesh from Cache"),this._mesh=x3dom.geoCache[s];else{for(var n=0;256>n;n++)for(var r=0;256>r;r++){var a=256*n+r;if(65535==a)break;this._mesh._positions[0].push(r/256,n/256,0),this._mesh._indices[0].push(256*n+r)}this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[s]=this._mesh}}},{nodeChanged:function(){Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0,e._dirty.normals=!0,e._dirty.texcoords=!0})},getMin:function(){return this._vf.position.subtract(this._vf.size.multiply(.5))},getMax:function(){return this._vf.position.add(this._vf.size.multiply(.5))},getVolume:function(e,t){return e.setValues(this.getMin()),t.setValues(this.getMax()),!0},getCenter:function(){return this._vf.position},numCoordinateTextures:function(){return this._cf.coord.nodes.length},getIndexTexture:function(){return this._cf.index.node?this._cf.index.node:null},getIndexTextureURL:function(){return this._cf.index.node?this._cf.index.node._vf.url:null},getCoordinateTexture:function(e){return this._cf.coord.nodes[e]?this._cf.coord.nodes[e]:null},getCoordinateTextureURL:function(e){return this._cf.coord.nodes[e]?this._cf.coord.nodes[e]._vf.url:null},getNormalTexture:function(e){return this._cf.normal.nodes[e]?this._cf.normal.nodes[e]:null},getNormalTextureURL:function(e){return this._cf.normal.nodes[e]?this._cf.normal.nodes[e]._vf.url:null},getTexCoordTexture:function(){return this._cf.texCoord.node?this._cf.texCoord.node:null},getTexCoordTextureURL:function(){return this._cf.texCoord.node?this._cf.texCoord.node._vf.url:null},getColorTexture:function(){return this._cf.color.node?this._cf.color.node:null},getColorTextureURL:function(){return this._cf.color.node?this._cf.color.node._vf.url:null}})),x3dom.registerNodeType("IndexedFaceSet","Geometry3D",defineClass(x3dom.nodeTypes.X3DComposedGeometryNode,function(e){x3dom.nodeTypes.IndexedFaceSet.superClass.call(this,e),this.addField_SFFloat(e,"creaseAngle",0),this.addField_MFInt32(e,"coordIndex",[]),this.addField_MFInt32(e,"normalIndex",[]),this.addField_MFInt32(e,"colorIndex",[]),this.addField_MFInt32(e,"texCoordIndex",[]),this.addField_SFBool(e,"convex",!0)},{nodeChanged:function(){var e=(new Date).getTime();this.handleAttribs();var t=this._vf.coordIndex,i=this._vf.normalIndex,o=this._vf.texCoordIndex,s=this._vf.colorIndex,n=!1,r=!1,a=!1,d=!1,h=!1,l=!1,_=this._vf.colorPerVertex,f=this._vf.normalPerVertex;i.length>0&&(r=!0),o.length>0&&(d=!0),s.length>0&&(l=!0);var u,c,m,p,g=this._cf.coord.node;x3dom.debug.assert(g),u=g.getPoints();var x=this._cf.normal.node;x?(n=!0,c=x._vf.vector):n=!1;var v="",y=2,b=this._cf.texCoord.node;b?b._vf.point?(a=!0,m=b._vf.point,x3dom.isa(b,x3dom.nodeTypes.TextureCoordinate3D)&&(y=3)):b._vf.mode&&(v=b._vf.mode):a=!1,this._mesh._numTexComponents=y;var T=3,F=this._cf.color.node;F?(h=!0,p=F._vf.color,x3dom.isa(F,x3dom.nodeTypes.ColorRGBA)&&(T=4)):h=!1,this._mesh._numColComponents=T,this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];var w,C,E,S,M,N,A,I,R,D,L,V,P,k,X,B;if(this._vf.creaseAngle<=x3dom.fields.Eps||u.length/3>65535||n&&r||a&&d||h&&l){if(this._vf.convex)for(C=0,E=0,S=0,this._mesh._multiIndIndices=[],this._mesh._posSize=u.length,w=0;w<t.length;++w)if(-1!=t[w])switch(r&&x3dom.debug.assert(-1!=i[w]),d&&x3dom.debug.assert(-1!=o[w]),l&&x3dom.debug.assert(-1!=s[w]),C){case 0:M=+t[w],I=r&&f?+i[w]:r&&!f?+i[S]:M,L=d?+o[w]:M,k=l&&_?+s[w]:l&&!_?+s[S]:M,C=1;break;case 1:N=+t[w],R=r&&f?+i[w]:r&&!f?+i[S]:N,V=d?+o[w]:N,X=l&&_?+s[w]:l&&!_?+s[S]:N,C=2;break;case 2:A=+t[w],D=r&&f?+i[w]:r&&!f?+i[S]:A,P=d?+o[w]:A,B=l&&_?+s[w]:l&&!_?+s[S]:A,C=3,this._mesh._indices[0].push(E++,E++,E++),this._mesh._positions[0].push(u[M].x),this._mesh._positions[0].push(u[M].y),this._mesh._positions[0].push(u[M].z),this._mesh._positions[0].push(u[N].x),this._mesh._positions[0].push(u[N].y),this._mesh._positions[0].push(u[N].z),this._mesh._positions[0].push(u[A].x),this._mesh._positions[0].push(u[A].y),this._mesh._positions[0].push(u[A].z),n?(this._mesh._normals[0].push(c[I].x),this._mesh._normals[0].push(c[I].y),this._mesh._normals[0].push(c[I].z),this._mesh._normals[0].push(c[R].x),this._mesh._normals[0].push(c[R].y),this._mesh._normals[0].push(c[R].z),this._mesh._normals[0].push(c[D].x),this._mesh._normals[0].push(c[D].y),this._mesh._normals[0].push(c[D].z)):this._mesh._multiIndIndices.push(M,N,A),h&&(this._mesh._colors[0].push(p[k].r),this._mesh._colors[0].push(p[k].g),this._mesh._colors[0].push(p[k].b),4===T&&this._mesh._colors[0].push(p[k].a),this._mesh._colors[0].push(p[X].r),this._mesh._colors[0].push(p[X].g),this._mesh._colors[0].push(p[X].b),4===T&&this._mesh._colors[0].push(p[X].a),this._mesh._colors[0].push(p[B].r),this._mesh._colors[0].push(p[B].g),this._mesh._colors[0].push(p[B].b),4===T&&this._mesh._colors[0].push(p[B].a)),a&&(this._mesh._texCoords[0].push(m[L].x),this._mesh._texCoords[0].push(m[L].y),3===y&&this._mesh._texCoords[0].push(m[L].z),this._mesh._texCoords[0].push(m[V].x),this._mesh._texCoords[0].push(m[V].y),3===y&&this._mesh._texCoords[0].push(m[V].z),this._mesh._texCoords[0].push(m[P].x),this._mesh._texCoords[0].push(m[P].y),3===y&&this._mesh._texCoords[0].push(m[P].z));break;case 3:N=A,V=P,f&&(R=D),_&&(X=B),A=+t[w],r&&f?D=+i[w]:r&&!f||(D=A),P=d?+o[w]:A,l&&_?B=+s[w]:l&&!_||(B=A),this._mesh._indices[0].push(E++,E++,E++),this._mesh._positions[0].push(u[M].x),this._mesh._positions[0].push(u[M].y),this._mesh._positions[0].push(u[M].z),this._mesh._positions[0].push(u[N].x),this._mesh._positions[0].push(u[N].y),this._mesh._positions[0].push(u[N].z),this._mesh._positions[0].push(u[A].x),this._mesh._positions[0].push(u[A].y),this._mesh._positions[0].push(u[A].z),n?(this._mesh._normals[0].push(c[I].x),this._mesh._normals[0].push(c[I].y),this._mesh._normals[0].push(c[I].z),this._mesh._normals[0].push(c[R].x),this._mesh._normals[0].push(c[R].y),this._mesh._normals[0].push(c[R].z),this._mesh._normals[0].push(c[D].x),this._mesh._normals[0].push(c[D].y),this._mesh._normals[0].push(c[D].z)):this._mesh._multiIndIndices.push(M,N,A),h&&(this._mesh._colors[0].push(p[k].r),this._mesh._colors[0].push(p[k].g),this._mesh._colors[0].push(p[k].b),4===T&&this._mesh._colors[0].push(p[k].a),this._mesh._colors[0].push(p[X].r),this._mesh._colors[0].push(p[X].g),this._mesh._colors[0].push(p[X].b),4===T&&this._mesh._colors[0].push(p[X].a),this._mesh._colors[0].push(p[B].r),this._mesh._colors[0].push(p[B].g),this._mesh._colors[0].push(p[B].b),4===T&&this._mesh._colors[0].push(p[B].a)),a&&(this._mesh._texCoords[0].push(m[L].x),this._mesh._texCoords[0].push(m[L].y),3===y&&this._mesh._texCoords[0].push(m[L].z),this._mesh._texCoords[0].push(m[V].x),this._mesh._texCoords[0].push(m[V].y),3===y&&this._mesh._texCoords[0].push(m[V].z),this._mesh._texCoords[0].push(m[P].x),this._mesh._texCoords[0].push(m[P].y),3===y&&this._mesh._texCoords[0].push(m[P].z))}else C=0,S++;else{var U=new x3dom.DoublyLinkedList,G=new Object;E=0;for(var w=0;w<t.length;++w)if(-1!=t[w])n&&(G.normals=r&&f?c[i[w]]:r&&!f?c[i[S]]:c[t[w]]),h&&(G.colors=l&&_?p[s[w]]:l&&!_?p[s[S]]:p[t[w]]),a&&(G.texCoords=d?m[o[w]]:m[t[w]]),U.appendNode(new x3dom.DoublyLinkedList.ListNode(u[t[w]],t[w],G.normals,G.colors,G.texCoords));else{for(var z=x3dom.EarClipping.getMultiIndexes(U),O=0;O<z.indices.length;O++)this._mesh._indices[0].push(E),E++,this._mesh._positions[0].push(z.point[O].x,z.point[O].y,z.point[O].z),n&&this._mesh._normals[0].push(z.normals[O].x,z.normals[O].y,z.normals[O].z),h&&(this._mesh._colors[0].push(z.colors[O].r,z.colors[O].g,z.colors[O].b),4===T&&this._mesh._colors[0].push(z.colors[O].a)),a&&(this._mesh._texCoords[0].push(z.texCoords[O].x,z.texCoords[O].y),3===y&&this._mesh._texCoords[0].push(z.texCoords[O].z));U=new x3dom.DoublyLinkedList,S++}}n||this._mesh.calcNormals(this._vf.creaseAngle),a||this._mesh.calcTexCoords(v),this._mesh.splitMesh()}else{if(C=0,this._vf.convex)for(w=0;w<t.length;++w)if(-1!=t[w])switch(C){case 0:I=+t[w],C=1;break;case 1:R=+t[w],C=2;break;case 2:D=+t[w],C=3,this._mesh._indices[0].push(I,R,D);break;case 3:R=D,D=+t[w],this._mesh._indices[0].push(I,R,D)}else C=0;else for(var U=new x3dom.DoublyLinkedList,w=0;w<t.length;++w)if(-1!=t[w])U.appendNode(new x3dom.DoublyLinkedList.ListNode(u[t[w]],t[w]));else{for(var j=x3dom.EarClipping.getIndexes(U),O=0;O<j.length;O++)this._mesh._indices[0].push(j[O]);U=new x3dom.DoublyLinkedList}this._mesh._positions[0]=u.toGL(),n?this._mesh._normals[0]=c.toGL():this._mesh.calcNormals(this._vf.creaseAngle),a?(this._mesh._texCoords[0]=m.toGL(),this._mesh._numTexComponents=y):this._mesh.calcTexCoords(v),h&&(this._mesh._colors[0]=p.toGL(),this._mesh._numColComponents=T)}for(this._mesh._invalidate=!0,this._mesh._numFaces=0,this._mesh._numCoords=0,w=0;w<this._mesh._indices.length;w++)this._mesh._numFaces+=this._mesh._indices[w].length/3,this._mesh._numCoords+=this._mesh._positions[w].length/3;(new Date).getTime()-e},fieldChanged:function(e){var t,i=this._cf.coord.node._vf.point,o=i.length;if(this._vf.creaseAngle<=x3dom.fields.Eps||o/3>65535)return x3dom.debug.logWarning("Ipol with creaseAngle == 0, too many coords, or multi-index!"),this.nodeChanged(),Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0}),void Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0});if("coord"==e){for(i=this._cf.coord.node._vf.point,o=i.length,this._mesh._positions[0]=[],t=0;o>t;t++)this._mesh._positions[0].push(i[t].x),this._mesh._positions[0].push(i[t].y),this._mesh._positions[0].push(i[t].z);this._mesh._invalidate=!0,Array.forEach(this._parentNodes,function(e){e._dirty.positions=!0})}else if("color"==e){for(i=this._cf.color.node._vf.color,o=i.length,this._mesh._colors[0]=[],t=0;o>t;t++)this._mesh._colors[0].push(i[t].r),this._mesh._colors[0].push(i[t].g),this._mesh._colors[0].push(i[t].b);Array.forEach(this._parentNodes,function(e){e._dirty.colors=!0})}else if("normal"==e){i=this._cf.normal.node._vf.vector,o=i.length,this._mesh._normals[0]=[];for(var t=0;o>t;t++)this._mesh._normals[0].push(i[t].x),this._mesh._normals[0].push(i[t].y),this._mesh._normals[0].push(i[t].z);this._mesh._invalidate=!0,Array.forEach(this._parentNodes,function(e){e.setAllDirty()})}else if("texCoord"==e){for(i=this._cf.texCoord.node._vf.point,o=i.length,this._mesh._texCoords[0]=[],t=0;o>t;t++)this._mesh._texCoords[0].push(i[t].x),this._mesh._texCoords[0].push(i[t].y);this._mesh._invalidate=!0,Array.forEach(this._parentNodes,function(e){e.setAllDirty()})}}})),x3dom.versionInfo={version:"1.3.0",revision:"e545d12e73c319f792958154e42219c7818ba1a4",date:"Fri Dec 23 15:53:12 2011 +0100"};